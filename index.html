<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholar Craft | SSCI 論文寫作輔助工具</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 寫作區專注模式 */
        .editor-area:focus { outline: none; border-color: #6366f1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex">

    <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-20">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-graduation-cap text-indigo-400"></i>
                ScholarCraft
            </h1>
            <p class="text-xs text-slate-400 mt-1">SSCI Q1 Writing Coach</p>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('setup')" id="nav-setup" class="nav-item w-full text-left px-4 py-3 rounded-lg bg-indigo-600 text-white transition-all flex items-center gap-3">
                <i class="fa-solid fa-chess-board"></i> 1. 主題設定 (Topic Setup)
            </button>
            <button onclick="switchTab('data')" id="nav-data" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 transition-all flex items-center gap-3">
                <i class="fa-solid fa-database"></i> 2. 文獻解析 (Data Aanalysis)
            </button>
            <button onclick="switchTab('write')" id="nav-write" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 transition-all flex items-center gap-3">
                <i class="fa-solid fa-pen-nib"></i> 3. 結構化寫作 (Structural Writing)
            </button>
        </nav>

        <div class="p-4 border-t border-slate-700">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold">U</div>
                <div>
                    <p class="text-sm font-medium">User</p>
                    <p class="text-xs text-slate-400">Free Plan</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 relative overflow-hidden flex flex-col">
        
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8">
            <h2 id="page-title" class="text-lg font-semibold text-slate-700">主題設定 (The Topic Orientation)</h2>
            <div class="flex gap-3">
                <button class="px-4 py-2 text-sm text-slate-600 hover:text-indigo-600 transition-colors">
                    <i class="fa-regular fa-circle-question"></i> 幫助
                </button>
                <button class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700 shadow-sm transition-all">
                    <i class="fa-solid fa-cloud-arrow-up"></i> 儲存專案
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto bg-slate-50 p-8 relative">

            <div id="view-setup" class="max-w-3xl mx-auto space-y-6 animate-fade-in">
                <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xl">
                            <i class="fa-solid fa-crosshairs"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800">研究變項設定 (Variable Canvas)</h3>
                            <p class="text-slate-500 text-sm">請填寫以下欄位。</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-slate-700">自變項 (Independent Variable)</label>
                            <input type="text" id="iv-input" placeholder="例如：生成式AI輔助PBL教學" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none">
                            <p class="text-xs text-slate-400">你的介入措施或教學法。</p>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-slate-700">依變項 (Dependent Variable)</label>
                            <input type="text" id="dv-input" placeholder="例如：學生的批判性思考與論證品質" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none">
                            <p class="text-xs text-slate-400">你想要觀察或測量的結果。</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 space-y-2">
                        <label class="text-sm font-semibold text-slate-700">研究主題/領域 (Research Topic)</label>
                        <input type="text" id="topic-input" placeholder="例如：科學教育中的數位學習工具應用" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none">
                    </div>
                </div>

                <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100 flex justify-between items-center">
                    <div>
                        <h4 class="font-semibold text-indigo-900">準備好進入下一步了嗎？</h4>
                        <p class="text-sm text-indigo-700">系統將根據這些變項來檢索文獻與生成大綱。</p>
                    </div>
                    <button onclick="switchTab('data')" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all shadow-md font-medium">
                        下一步：上傳資料 <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <div id="view-data" class="hidden max-w-5xl mx-auto space-y-6">
                <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 text-center">
                    <div class="border-2 border-dashed border-slate-300 rounded-xl p-10 hover:bg-slate-50 transition-colors cursor-pointer" onclick="document.getElementById('file-upload').click()">
                        <i class="fa-solid fa-file-excel text-4xl text-green-600 mb-4"></i>
                        <h3 class="text-lg font-bold text-slate-700">上傳 WoS 文獻資料 (XLSX)</h3>
                        <p class="text-slate-500 mt-2">支援從 Web of Science 下載的 Excel 檔案。系統將自動解析摘要與關鍵字。</p>
                        <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleFileUpload(event)">
                    </div>
                </div>

                <div id="data-preview-container" class="hidden bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700">已解析文獻預覽 (<span id="record-count">0</span> 筆)</h3>
                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">解析成功</span>
                    </div>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3">Authors</th>
                                    <th class="px-6 py-3">Year</th>
                                    <th class="px-6 py-3">Title</th>
                                    <th class="px-6 py-3">Abstract Preview</th>
                                </tr>
                            </thead>
                            <tbody id="literature-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="flex justify-end">
                     <button onclick="switchTab('write')" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all shadow-md font-medium">
                        下一步：開始寫作 <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <div id="view-write" class="hidden h-full flex flex-col">
                <div class="flex gap-6 h-full">
                    
                    <div class="w-1/3 flex flex-col glass-panel rounded-xl shadow-sm overflow-hidden border border-indigo-100">
                        <div class="p-4 bg-indigo-600 text-white flex justify-between items-center">
                            <span class="font-bold"><i class="fa-solid fa-robot mr-2"></i>AI Coach (Master Level)</span>
                            <select id="phase-selector" class="text-xs text-slate-800 bg-white rounded px-2 py-1 outline-none" onchange="updatePromptContext()">
                                <option value="outline">Phase 0: 大綱生成</option>
                                <option value="title">Phase 1: 題目策略</option>
                                <option value="abstract">Phase 2: 摘要 (SMFC)</option>
                                <option value="intro">Phase 3: 緒論 (缺口)</option>
                                <option value="method">Phase 4: 研究方法</option>
                                <option value="results">Phase 5: 研究結果</option>
                                <option value="discuss">Phase 6: 討論 (理論對話)</option>
                            </select>
                        </div>
                        
                        <div id="chat-history" class="flex-1 p-4 overflow-y-auto space-y-4 bg-slate-50">
                            <div class="flex gap-3">
                                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex-shrink-0 flex items-center justify-center"><i class="fa-solid fa-robot"></i></div>
                                <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm text-sm text-slate-700 border border-slate-200">
                                    <p>你好！我是你的 SSCI 寫作教練。我已讀取你的文獻池。我們從<strong>大綱生成</strong>開始嗎？還是你想先優化<strong>題目</strong>？</p>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-white border-t border-slate-200">
                            <div class="relative">
                                <textarea id="ai-input" placeholder="輸入指令或詢問寫作建議..." class="w-full pl-4 pr-12 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none resize-none text-sm" rows="2"></textarea>
                                <button onclick="simulateAIGeneration()" class="absolute right-2 bottom-2 p-2 text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors">
                                    <i class="fa-solid fa-paper-plane"></i>
                                </button>
                            </div>
                            <p class="text-xs text-slate-400 mt-2 text-center">AI 將依據上傳的文獻進行精確引用生成。</p>
                        </div>
                    </div>

                    <div class="w-2/3 flex flex-col bg-white rounded-xl shadow-sm border border-slate-200">
                        <div class="p-3 border-b border-slate-100 flex items-center gap-2 text-slate-600">
                            <button class="p-2 hover:bg-slate-100 rounded"><i class="fa-solid fa-bold"></i></button>
                            <button class="p-2 hover:bg-slate-100 rounded"><i class="fa-solid fa-italic"></i></button>
                            <button class="p-2 hover:bg-slate-100 rounded"><i class="fa-solid fa-list-ul"></i></button>
                            <div class="h-4 w-px bg-slate-300 mx-2"></div>
                            <button class="p-2 hover:bg-slate-100 rounded text-xs font-semibold">H1</button>
                            <button class="p-2 hover:bg-slate-100 rounded text-xs font-semibold">H2</button>
                            <div class="flex-1"></div>
                            <span class="text-xs text-slate-400">自動儲存中...</span>
                        </div>
                        
                        <div id="editor" contenteditable="true" class="editor-area flex-1 p-8 text-lg text-slate-800 leading-relaxed overflow-y-auto outline-none" placeholder="在此開始寫作...">
                            <h1 class="text-3xl font-bold mb-4">在此輸入你的論文標題...</h1>
                            <p class="text-slate-400 italic mb-6">點擊左側 AI Coach 開始生成內容...</p>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </main>

    <script>
        // Store uploaded data
        let literatureData = [];
        let projectInfo = { iv: '', dv: '', topic: '' };

        // 1. Tab Switching Logic
        function switchTab(tabId) {
            // Hide all views
            ['setup', 'data', 'write'].forEach(id => {
                document.getElementById(`view-${id}`).classList.add('hidden');
                const navBtn = document.getElementById(`nav-${id}`);
                navBtn.classList.remove('bg-indigo-600', 'text-white');
                navBtn.classList.add('text-slate-300', 'hover:bg-slate-800');
            });

            // Show selected view
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`nav-${tabId}`);
            activeBtn.classList.remove('text-slate-300', 'hover:bg-slate-800');
            activeBtn.classList.add('bg-indigo-600', 'text-white');

            // Save Project Info if leaving setup
            if (tabId !== 'setup') {
                projectInfo.iv = document.getElementById('iv-input').value;
                projectInfo.dv = document.getElementById('dv-input').value;
                projectInfo.topic = document.getElementById('topic-input').value;
            }

            // Update Header Title
            const titles = {
                'setup': '主題設定 (The Topic Setup)',
                'data': '文獻解析 (Data Analysis)',
                'write': '結構化寫作 (Structural Writing)'
            };
            document.getElementById('page-title').innerText = titles[tabId];
        }

        // 2. File Upload & Parsing Logic (SheetJS)
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Assuming data is in the first sheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                literatureData = jsonData;

                // Update UI
                document.getElementById('record-count').innerText = jsonData.length;
                document.getElementById('data-preview-container').classList.remove('hidden');
                
                renderTablePreview(jsonData.slice(0, 5)); // Show first 5 rows
                
                // Add system message to chat
                addChatMessage('system', `已成功載入 ${jsonData.length} 筆文獻。我已準備好進行檢索與引用生成。`);
            };
            reader.readAsArrayBuffer(file);
        }

        function renderTablePreview(rows) {
            const tbody = document.getElementById('literature-table-body');
            tbody.innerHTML = '';
            
            rows.forEach(row => {
                // Try to find standard columns (adapt based on WoS export)
                const author = row['Authors'] || row['Author Full Names'] || 'Unknown';
                const year = row['Publication Year'] || row['Year'] || 'N/A';
                const title = row['Article Title'] || row['Title'] || 'No Title';
                const abstract = row['Abstract'] || 'No Abstract';
                
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b border-slate-100 hover:bg-slate-50 transition-colors';
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-900 truncate max-w-xs">${author}</td>
                    <td class="px-6 py-4">${year}</td>
                    <td class="px-6 py-4 truncate max-w-xs" title="${title}">${title}</td>
                    <td class="px-6 py-4 truncate max-w-xs text-xs text-slate-500">${abstract.substring(0, 50)}...</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 3. AI Simulation Logic (Backend Interface)
        function addChatMessage(role, text) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = 'flex gap-3 animate-fade-in';
            
            if (role === 'system') {
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex-shrink-0 flex items-center justify-center"><i class="fa-solid fa-robot"></i></div>
                    <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm text-sm text-slate-700 border border-slate-200">
                        <p>${text}</p>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="flex-1"></div>
                    <div class="bg-indigo-600 p-3 rounded-lg rounded-tr-none shadow-sm text-sm text-white max-w-[80%]">
                        <p>${text}</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex-shrink-0 flex items-center justify-center font-bold">U</div>
                `;
            }
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        function simulateAIGeneration() {
            const inputField = document.getElementById('ai-input');
            const userText = inputField.value;
            if (!userText.trim()) return;

            // 1. Show User Message
            addChatMessage('user', userText);
            inputField.value = '';

            // 2. Simulate Processing (Loading)
            const loadingId = 'loading-' + Date.now();
            const history = document.getElementById('chat-history');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex gap-3 items-center text-slate-400 text-xs ml-11';
            loadingDiv.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> 正在檢索文獻與生成內容 (呼叫 Gemini API)...`;
            history.appendChild(loadingDiv);
            
            // 3. Simulate Response (After 1.5s)
            setTimeout(() => {
                document.getElementById(loadingId).remove();
                
                const phase = document.getElementById('phase-selector').value;
                let responseText = "";
                let editorContent = "";

                // Logic to simulate context-aware generation based on "Master Level Prompt"
                if (phase === 'outline') {
                    responseText = "根據您的研究主題與文獻，我為您生成了一份符合 SSCI 標準的大綱。請查看右側編輯區。注意我在文獻探討部分建議了 'Theoretical Gap' 的寫法。";
                    editorContent = `
<h2>1. Introduction</h2>
<p><strong>Background:</strong> The rapid integration of ${projectInfo.iv || '[自變項]'} in education...</p>
<p><strong>Research Gap:</strong> While previous studies (Smith, 2023; Doe, 2022) focused on [Method], they failed to explain [Theory]. This creates a critical theoretical gap...</p>
<h2>2. Literature Review</h2>
<h3>2.1 Theoretical Framework</h3>
<h3>2.2 ${projectInfo.iv} in Education</h3>
<h2>3. Methodology</h2>
`;
                } else if (phase === 'abstract') {
                     responseText = "這是依據 SMFC 架構生成的摘要。我強調了研究的張力與理論貢獻。";
                     editorContent = `
<p><strong>Abstract</strong></p>
<p><strong>(S)</strong> Despite the growing popularity of ${projectInfo.iv}, current constructivist models fail to account for... <strong>(M)</strong> This study adopted a quasi-experimental design with 120 students... <strong>(F)</strong> Results indicate that the experimental group (M=85.2, SD=12.1) significantly outperformed... <strong>(C)</strong> These findings extend the Cognitive Load Theory by demonstrating...</p>
`;
                } else {
                    responseText = `收到指令："${userText}"。我已從您的 ${literatureData.length} 筆文獻中檢索相關內容，並生成了對應段落。請注意，我將 "Shortage" 修正為 "Limitation" 以符合 Q1 期刊標準。`;
                    editorContent = `<p>（此處為 AI 生成的內容，並包含精確引用，例如：[Author, Year]...）</p>`;
                }

                addChatMessage('system', responseText);
                
                // Append to editor
                const editor = document.getElementById('editor');
                editor.innerHTML += editorContent;
                // Scroll editor to bottom
                editor.scrollTop = editor.scrollHeight;

            }, 1500);
        }

        // Initialize with Setup Tab
        switchTab('setup');

    </script>
</body>
</html>
