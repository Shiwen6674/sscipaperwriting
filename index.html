<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScholarCraft | SSCI è«–æ–‡å¯«ä½œè¼”åŠ©å·¥å…·</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .serif-font { font-family: 'Noto Serif TC', serif; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        .editor-area:focus { outline: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- å„ªåŒ–å¾Œçš„æ–‡ç« é–±è®€æ¨£å¼ (Typography) --- */
        .prose h2 { font-size: 1.5em; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.8em; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.3em; }
        .prose h3 { font-size: 1.25em; font-weight: 600; margin-top: 1.2em; margin-bottom: 0.6em; color: #334155; }
        .prose p { margin-bottom: 1.2em; line-height: 1.8; text-align: justify; color: #374151; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1.2em; }
        .prose li { margin-bottom: 0.5em; line-height: 1.6; }
        .prose strong { color: #0f172a; font-weight: 600; }
        .prose blockquote { border-left: 4px solid #6366f1; padding-left: 1em; color: #4b5563; font-style: italic; margin-bottom: 1.2em; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex">

    <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-20 transition-all">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-graduation-cap text-indigo-400"></i>
                ScholarCraft
            </h1>
            <p class="text-xs text-slate-400 mt-1">SSCI Q1 Writing Coach</p>
        </div>

        <div class="px-4 pt-4">
            <div class="relative">
                <select id="global-lang-selector" onchange="changeUILanguage()" class="w-full bg-slate-800 text-xs text-slate-300 border border-slate-600 rounded px-2 py-1.5 focus:outline-none focus:border-indigo-500 cursor-pointer">
                    <option value="zh-TW">ğŸŒ ç¹é«”ä¸­æ–‡ (Traditional Chinese)</option>
                    <option value="en-US">ğŸŒ English (US)</option>
                </select>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('setup')" id="nav-setup" class="nav-item w-full text-left px-4 py-3 rounded-lg bg-indigo-600 text-white transition-all flex items-center gap-3 shadow-lg shadow-indigo-900/50">
                <i class="fa-solid fa-chess-board w-5 text-center"></i> <span data-i18n="nav_setup">1. ä¸»é¡Œè¨­å®š</span>
            </button>
            <button onclick="switchTab('data')" id="nav-data" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 transition-all flex items-center gap-3">
                <i class="fa-solid fa-database w-5 text-center"></i> <span data-i18n="nav_data">2. æ–‡ç»è§£æ</span>
            </button>
            <button onclick="switchTab('write')" id="nav-write" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 transition-all flex items-center gap-3">
                <i class="fa-solid fa-pen-nib w-5 text-center"></i> <span data-i18n="nav_write">3. çµæ§‹åŒ–å¯«ä½œ</span>
            </button>
        </nav>
        <div class="p-4 border-t border-slate-700">
            <div class="flex items-center gap-3 px-2">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center font-bold text-xs shadow-md">U</div>
                <div>
                    <p class="text-sm font-medium">Researcher</p>
                    <p class="text-xs text-slate-400">Connected</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 relative overflow-hidden flex flex-col">
        
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-10">
            <h2 id="page-title" class="text-lg font-semibold text-slate-700" data-i18n="title_setup">ä¸»é¡Œè¨­å®š</h2>
            <div class="flex gap-3">
                <span class="text-xs text-slate-400 flex items-center gap-1"><i class="fa-solid fa-circle text-green-500 text-[8px]"></i> System Ready</span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50 p-6 relative">

            <div id="view-setup" class="max-w-4xl mx-auto space-y-6 animate-fade-in">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-5 mb-8 border-b border-slate-100 pb-6">
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl shadow-inner">
                            <i class="fa-solid fa-sliders"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800" data-i18n="setup_canvas_title">ç ”ç©¶è®Šé …ç•«å¸ƒ (Variable Canvas)</h3>
                            <p class="text-slate-500 text-sm mt-1" data-i18n="setup_canvas_desc">æ¸…æ™°å®šç¾©è®Šé …æ˜¯ SSCI é¡Œç›®çš„æ ¸å¿ƒã€‚ç³»çµ±å°‡ä¾æ­¤æ§åˆ¶ AI çš„å¯«ä½œæ–¹å‘ã€‚</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-3">
                            <label class="text-sm font-bold text-slate-700 flex justify-between">
                                <span data-i18n="setup_iv">è‡ªè®Šé … (Independent Variable)</span>
                                <span class="text-xs font-normal text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">Intervention</span>
                            </label>
                            <input type="text" id="iv-input" placeholder="e.g., Generative AI in PBL" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all outline-none text-slate-700">
                        </div>
                        <div class="space-y-3">
                            <label class="text-sm font-bold text-slate-700 flex justify-between">
                                <span data-i18n="setup_dv">ä¾è®Šé … (Dependent Variable)</span>
                                <span class="text-xs font-normal text-teal-600 bg-teal-50 px-2 py-0.5 rounded">Outcome</span>
                            </label>
                            <input type="text" id="dv-input" placeholder="e.g., Argumentation Quality" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all outline-none text-slate-700">
                        </div>
                    </div>
                    <div class="mt-8 space-y-3">
                        <label class="text-sm font-bold text-slate-700" data-i18n="setup_topic">å®Œæ•´ç ”ç©¶ä¸»é¡Œ (Research Topic)</label>
                        <input type="text" id="topic-input" placeholder="e.g., Effectiveness of Digital Tools in Science Education" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all outline-none text-slate-700">
                    </div>
                </div>
                <div class="flex justify-end pt-4">
                    <button onclick="switchTab('data')" class="group px-6 py-3 bg-slate-900 text-white rounded-xl hover:bg-indigo-600 transition-all shadow-lg font-medium flex items-center gap-2">
                        <span data-i18n="btn_next_data">ä¸‹ä¸€æ­¥ï¼šä¸Šå‚³æ–‡ç»</span> <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>

            <div id="view-data" class="hidden max-w-6xl mx-auto space-y-6">
                <div class="bg-white p-10 rounded-2xl shadow-sm border border-slate-200 text-center transition-all">
                    <div id="upload-zone" class="border-2 border-dashed border-slate-300 rounded-xl p-12 hover:bg-indigo-50/50 hover:border-indigo-400 transition-all cursor-pointer group" onclick="document.getElementById('file-upload').click()">
                        <div class="w-16 h-16 bg-green-50 text-green-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-file-csv"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-700 group-hover:text-indigo-700" data-i18n="data_upload_title">é»æ“Šä¸Šå‚³ WoS æ–‡ç»è³‡æ–™ (Excel/CSV)</h3>
                        <p class="text-slate-500 mt-3 max-w-md mx-auto" data-i18n="data_upload_desc">ç³»çµ±å°‡è‡ªå‹•è§£æï¼šAuthors, Year, Title, Journal, DOI, Abstract</p>
                        <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleFileUpload(event)">
                    </div>
                </div>
                <div id="data-preview-container" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[600px]">
                    <div class="p-4 border-b border-slate-200 bg-slate-50/50 flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-slate-700" data-i18n="data_preview_title">æ–‡ç»æ± é è¦½</h3>
                            <span class="text-xs font-mono bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full" id="record-count">0 records</span>
                        </div>
                        <span class="text-xs text-green-600 flex items-center gap-1"><i class="fa-solid fa-check-circle"></i> Cloud Synced</span>
                    </div>
                    <div class="overflow-auto custom-scrollbar flex-1">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 py-4 font-semibold w-10 text-center text-slate-400">No.</th>
                                    <th class="px-4 py-4 font-semibold min-w-[150px]">Authors</th>
                                    <th class="px-4 py-4 font-semibold w-16">Year</th>
                                    <th class="px-4 py-4 font-semibold min-w-[200px]">Title</th>
                                    <th class="px-4 py-4 font-semibold min-w-[150px] text-indigo-600">Journal</th>
                                    <th class="px-4 py-4 font-semibold w-24">Vol(Issue)</th>
                                    <th class="px-4 py-4 font-semibold w-24">Pages</th>
                                    <th class="px-4 py-4 font-semibold min-w-[150px]">DOI</th>
                                    <th class="px-4 py-4 font-semibold text-center w-20">Action</th>
                                </tr>
                            </thead>
                            <tbody id="literature-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
                <div class="flex justify-end pt-2">
                     <button onclick="switchTab('write')" class="group px-6 py-3 bg-slate-900 text-white rounded-xl hover:bg-indigo-600 transition-all shadow-lg font-medium flex items-center gap-2">
                        <span data-i18n="btn_next_write">é€²å…¥å¯«ä½œæ¨¡å¼</span> <i class="fa-solid fa-pen-nib group-hover:rotate-12 transition-transform"></i>
                    </button>
                </div>
            </div>

            <div id="view-write" class="hidden h-full flex flex-col animate-fade-in">
                <div class="flex gap-6 h-full pb-2">
                    
                    <div class="w-[400px] flex flex-col glass-panel rounded-2xl shadow-sm overflow-hidden border border-indigo-100 shrink-0">
                        <div class="p-4 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white flex flex-col gap-3 shadow-md z-10">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-sm tracking-wide"><i class="fa-solid fa-robot mr-2"></i>SSCI AI Coach</span>
                                <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded text-white/90">Master Level</span>
                            </div>

                            <div class="relative">
                                <select id="phase-selector" onchange="updateWordCount()" class="w-full text-xs text-slate-800 bg-white rounded-lg pl-3 pr-8 py-2.5 outline-none font-medium appearance-none shadow-sm cursor-pointer hover:bg-indigo-50 transition-colors">
                                    <option value="outline">Phase 0: å¤§ç¶±ç”Ÿæˆ (Outline)</option>
                                    <option value="title">Phase 1: é¡Œç›®ç­–ç•¥ (Title)</option>
                                    <option value="abstract">Phase 2: æ‘˜è¦ (Abstract)</option>
                                    <option value="intro">Phase 3: ç·’è«– (Introduction)</option>
                                    <option value="lit_review">Phase 4: æ–‡ç»æ¢è¨ (Lit. Review)</option>
                                    <option value="method">Phase 5: ç ”ç©¶æ–¹æ³• (Methodology)</option>
                                    <option value="results">Phase 6: ç ”ç©¶ç™¼ç¾ (Findings)</option>
                                    <option value="discuss">Phase 7: è¨è«– (Discussion)</option>
                                    <option value="conclusion">Phase 8: çµè«– (Conclusions)</option>
                                </select>
                                <div class="absolute right-3 top-2.5 text-slate-500 pointer-events-none"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                            </div>
                        </div>
                        
                        <div id="chat-history" class="flex-1 p-4 overflow-y-auto custom-scrollbar space-y-5 bg-slate-50/50">
                            <div class="flex gap-3 animate-fade-in">
                                <div class="w-8 h-8 rounded-full bg-white border border-indigo-100 text-indigo-600 flex-shrink-0 flex items-center justify-center shadow-sm"><i class="fa-solid fa-robot"></i></div>
                                <div class="bg-white p-3.5 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 border border-slate-100 leading-relaxed">
                                    <p data-i18n="ai_welcome">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ SSCI å¯«ä½œæ•™ç·´ã€‚è«‹é¸æ“‡ä¸Šæ–¹å¯«ä½œéšæ®µï¼Œä¸¦è¼¸å…¥æŒ‡ä»¤é–‹å§‹ã€‚</p>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-white border-t border-slate-100">
                            <div class="relative group">
                                <textarea id="ai-input" placeholder="è¼¸å…¥æŒ‡ä»¤æˆ–æŒ‰ Enter ç›´æ¥ç”Ÿæˆ..." class="w-full pl-4 pr-12 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none resize-none text-sm transition-all shadow-inner" rows="2" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); simulateAIGeneration(); }"></textarea>
                                <button onclick="simulateAIGeneration()" class="absolute right-2 bottom-2.5 p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fa-solid fa-paper-plane text-xs"></i>
                                </button>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 text-center flex items-center justify-center gap-1">
                                <i class="fa-solid fa-bolt text-amber-400"></i> Powered by Gemini 2.0 Flash with RAG
                            </p>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-2 border-b border-slate-100 flex items-center gap-1 text-slate-600 bg-slate-50/50">
                            <button class="p-2 hover:bg-white hover:shadow-sm hover:text-indigo-600 rounded transition-all" title="Bold"><i class="fa-solid fa-bold"></i></button>
                            <button class="p-2 hover:bg-white hover:shadow-sm hover:text-indigo-600 rounded transition-all" title="Italic"><i class="fa-solid fa-italic"></i></button>
                            <button class="p-2 hover:bg-white hover:shadow-sm hover:text-indigo-600 rounded transition-all" title="List"><i class="fa-solid fa-list-ul"></i></button>
                            <div class="h-4 w-px bg-slate-300 mx-2"></div>
                            
                            <div class="flex items-center gap-3 px-2 text-xs font-mono bg-white border border-slate-200 rounded-md py-1 shadow-sm">
                                <span class="text-indigo-600 font-bold" id="phase-word-count">Phase: 0</span>
                                <span class="text-slate-300">|</span>
                                <span class="text-slate-600" id="total-word-count">Total: 0</span>
                            </div>

                            <div class="flex-1"></div>
                            <button class="px-3 py-1 bg-indigo-50 text-indigo-600 text-xs rounded-full font-medium hover:bg-indigo-100 transition-colors">
                                <i class="fa-solid fa-download mr-1"></i> <span data-i18n="btn_export">Export</span>
                            </button>
                        </div>
                        
                        <div id="editor" contenteditable="true" oninput="updateWordCount()" class="editor-area flex-1 p-12 text-lg text-slate-800 leading-relaxed overflow-y-auto custom-scrollbar outline-none serif-font prose max-w-none">
                            <h1 class="text-3xl font-bold mb-6 text-slate-900 font-sans">Untitled Manuscript</h1>
                            <p class="text-slate-400 italic">åœ¨æ­¤é–‹å§‹å¯«ä½œï¼Œæˆ–ç­‰å¾…å·¦å´ AI æ•™ç·´ç”Ÿæˆå…§å®¹...</p>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </main>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxzuSB40CJ_8VgEG5HsZR0QBqShK5TMKQAHHkQf_ww4gGy90uWZUoLjiuwbBpT4BkJoKQ/exec"; 
        
        let literatureData = [];
        let projectInfo = { iv: '', dv: '', topic: '' };
        let isProcessing = false;

        // --- UI Translation Dictionary ---
        const translations = {
            'zh-TW': {
                'nav_setup': '1. ä¸»é¡Œè¨­å®š',
                'nav_data': '2. æ–‡ç»è§£æ',
                'nav_write': '3. çµæ§‹åŒ–å¯«ä½œ',
                'title_setup': 'ä¸»é¡Œè¨­å®š (The Topic Orientation)',
                'setup_canvas_title': 'ç ”ç©¶è®Šé …ç•«å¸ƒ (Variable Canvas)',
                'setup_canvas_desc': 'æ¸…æ™°å®šç¾©è®Šé …æ˜¯ SSCI é¡Œç›®çš„æ ¸å¿ƒã€‚ç³»çµ±å°‡ä¾æ­¤æ§åˆ¶ AI çš„å¯«ä½œæ–¹å‘ã€‚',
                'setup_iv': 'è‡ªè®Šé … (Independent Variable)',
                'setup_dv': 'ä¾è®Šé … (Dependent Variable)',
                'setup_topic': 'å®Œæ•´ç ”ç©¶ä¸»é¡Œ (Research Topic)',
                'btn_next_data': 'ä¸‹ä¸€æ­¥ï¼šä¸Šå‚³æ–‡ç»',
                'data_upload_title': 'é»æ“Šä¸Šå‚³ WoS æ–‡ç»è³‡æ–™ (Excel/CSV)',
                'data_upload_desc': 'ç³»çµ±å°‡è‡ªå‹•è§£æï¼šAuthors, Year, Title, Journal, DOI, Abstract',
                'data_preview_title': 'æ–‡ç»æ± é è¦½',
                'btn_next_write': 'é€²å…¥å¯«ä½œæ¨¡å¼',
                'ai_welcome': 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ SSCI å¯«ä½œæ•™ç·´ã€‚è«‹é¸æ“‡ä¸Šæ–¹å¯«ä½œéšæ®µï¼Œä¸¦è¼¸å…¥æŒ‡ä»¤é–‹å§‹ã€‚',
                'btn_export': 'åŒ¯å‡º'
            },
            'en-US': {
                'nav_setup': '1. Setup',
                'nav_data': '2. Analysis',
                'nav_write': '3. Writing',
                'title_setup': 'Topic Orientation',
                'setup_canvas_title': 'Variable Canvas',
                'setup_canvas_desc': 'Define your variables clearly. This guides the AI in generating SSCI-level content.',
                'setup_iv': 'Independent Variable (IV)',
                'setup_dv': 'Dependent Variable (DV)',
                'setup_topic': 'Research Topic',
                'btn_next_data': 'Next: Upload Data',
                'data_upload_title': 'Upload WoS Export (Excel/CSV)',
                'data_upload_desc': 'Auto-parsing: Authors, Year, Title, Journal, DOI, Abstract',
                'data_preview_title': 'Literature Pool',
                'btn_next_write': 'Start Writing',
                'ai_welcome': 'Hello! I am your SSCI Writing Coach. Select a phase above and type a command to start.',
                'btn_export': 'Export'
            }
        };

        // --- 1. API Helper ---
        async function callBackendAPI(payload) {
            try {
                const response = await fetch(GAS_API_URL, {
                    method: "POST",
                    body: JSON.stringify(payload),
                    headers: { "Content-Type": "text/plain;charset=utf-8" } 
                });
                return await response.json();
            } catch (error) {
                console.error("API Error:", error);
                return { status: "error", message: "é€£ç·šå¤±æ•— (API Error)ã€‚" };
            }
        }

        // --- 2. Tab Navigation & Auto-save ---
        async function switchTab(tabId) {
            ['setup', 'data', 'write'].forEach(id => {
                document.getElementById(`view-${id}`).classList.add('hidden');
                const navBtn = document.getElementById(`nav-${id}`);
                navBtn.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-900/50');
                navBtn.classList.add('text-slate-300', 'hover:bg-slate-800');
            });

            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`nav-${tabId}`);
            activeBtn.classList.remove('text-slate-300', 'hover:bg-slate-800');
            activeBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-900/50');

            if (tabId !== 'setup') {
                const newIv = document.getElementById('iv-input').value;
                const newDv = document.getElementById('dv-input').value;
                const newTopic = document.getElementById('topic-input').value;

                if (newIv !== projectInfo.iv || newDv !== projectInfo.dv || newTopic !== projectInfo.topic) {
                    projectInfo = { iv: newIv, dv: newDv, topic: newTopic };
                    callBackendAPI({ action: "save_settings", data: projectInfo });
                }
            }
        }

        // --- 3. Language Switcher Logic ---
        function changeUILanguage() {
            const lang = document.getElementById('global-lang-selector').value;
            const texts = translations[lang];
            
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (texts[key]) el.innerText = texts[key];
            });

            // Update Placeholder inputs separately
            if (lang === 'zh-TW') {
                document.getElementById('ai-input').placeholder = "è¼¸å…¥æŒ‡ä»¤æˆ–æŒ‰ Enter ç›´æ¥ç”Ÿæˆ...";
            } else {
                document.getElementById('ai-input').placeholder = "Enter command or press Enter to generate...";
            }
        }

        // --- 4. File Upload & Table ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadZone = document.getElementById('upload-zone');
            const originalContent = uploadZone.innerHTML;
            uploadZone.innerHTML = `<div class="animate-pulse"><i class="fa-solid fa-spinner fa-spin text-4xl text-indigo-600 mb-4"></i><h3 class="text-lg font-bold text-slate-700">Processing...</h3></div>`;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    literatureData = jsonData;
                    document.getElementById('record-count').innerText = `${jsonData.length} records`;
                    document.getElementById('data-preview-container').classList.remove('hidden');
                    renderTablePreview(jsonData); 
                    
                    const response = await callBackendAPI({ action: "upload_literature", data: jsonData });
                    if (response.status === 'success') addChatMessage('system', `âœ… Uploaded ${jsonData.length} references.`);
                    else addChatMessage('system', `âŒ Upload Failed: ${response.message}`);
                } catch (err) {
                    alert("Parsing Error");
                } finally {
                    uploadZone.innerHTML = originalContent;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderTablePreview(rows) {
            const tbody = document.getElementById('literature-table-body');
            tbody.innerHTML = '';
            rows.forEach((row, index) => {
                // (Existing table rendering logic...)
                const authorRaw = row['Author Full Names'] || row['Authors'] || 'Unknown';
                const authorDisplay = authorRaw.length > 40 ? authorRaw.split(';')[0] + ' et al.' : authorRaw;
                const year = row['Publication Year'] || row['PY'] || 'N/A';
                const title = row['Article Title'] || row['TI'] || 'No Title';
                const journal = row['Source Title'] || row['SO'] || 'Unknown Journal';
                const volume = row['Volume'] || '';
                const issue = row['Issue'] || '';
                let volIssue = volume ? `${volume}` : '';
                if (issue) volIssue += `(${issue})`;
                let pages = '';
                if (row['Start Page'] && row['End Page']) pages = `${row['Start Page']}-${row['End Page']}`;
                else if (row['Article Number']) pages = `Art. ${row['Article Number']}`;
                const doi = row['DOI'] || '';
                const abstract = row['Abstract'] || 'No Abstract available.';
                const keywords = row['Author Keywords'] || '';

                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b border-slate-50 hover:bg-indigo-50/30 transition-colors cursor-pointer group';
                tr.onclick = () => toggleDetails(index); 
                tr.innerHTML = `
                    <td class="px-4 py-4 font-mono text-slate-400 text-center w-12">${index + 1}</td>
                    <td class="px-4 py-4 font-medium text-slate-900 truncate max-w-[150px]" title="${authorRaw}">${authorDisplay}</td>
                    <td class="px-4 py-4 text-slate-500">${year}</td>
                    <td class="px-4 py-4 truncate max-w-[200px] font-medium text-slate-700 group-hover:text-indigo-700 transition-colors" title="${title}">${title}</td>
                    <td class="px-4 py-4 truncate max-w-[150px] text-indigo-600 italic font-serif" title="${journal}">${journal}</td>
                    <td class="px-4 py-4 text-slate-600 whitespace-nowrap">${volIssue}</td>
                    <td class="px-4 py-4 text-slate-600 whitespace-nowrap">${pages}</td>
                    <td class="px-4 py-4 text-slate-600 truncate max-w-[150px]" title="${doi}">${doi}</td>
                    <td class="px-4 py-4 text-center">
                        <button class="text-xs bg-slate-100 text-slate-500 group-hover:bg-white group-hover:text-indigo-600 group-hover:shadow-sm px-3 py-1.5 rounded-full transition-all">Detail</button>
                    </td>
                `;
                tbody.appendChild(tr);
                const trDetail = document.createElement('tr');
                trDetail.id = `detail-${index}`;
                trDetail.className = 'hidden bg-slate-50/50 border-b border-slate-100 shadow-inner';
                trDetail.innerHTML = `
                    <td colspan="9" class="p-6">
                        <div class="flex flex-col gap-4">
                            <div class="flex flex-wrap gap-2 text-xs font-mono">
                                ${doi ? `<a href="https://doi.org/${doi}" target="_blank" class="px-2 py-1 bg-blue-50 border border-blue-200 rounded text-blue-600 hover:underline">DOI: ${doi}</a>` : ''}
                                ${keywords ? `<span class="px-2 py-1 bg-amber-50 border border-amber-200 rounded text-amber-700">Keywords: ${keywords}</span>` : ''}
                            </div>
                            <div class="text-sm text-slate-700 leading-relaxed bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                <div class="font-bold text-slate-900 mb-2 flex items-center gap-2 text-xs uppercase tracking-wider"><i class="fa-solid fa-align-left text-indigo-500"></i> Abstract</div>
                                ${abstract}
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(trDetail);
            });
        }

        function toggleDetails(index) {
            const row = document.getElementById(`detail-${index}`);
            if (row.classList.contains('hidden')) row.classList.remove('hidden');
            else row.classList.add('hidden');
        }

        // --- 5. Word Count ---
        function updateWordCount() {
            const editor = document.getElementById('editor');
            const fullText = editor.innerText || "";
            const totalCount = countWords(fullText);
            document.getElementById('total-word-count').innerText = `Total: ${totalCount}`;

            const currentPhase = document.getElementById('phase-selector').value;
            const phaseBlocks = editor.querySelectorAll(`div[data-phase="${currentPhase}"]`);
            let phaseText = "";
            phaseBlocks.forEach(block => phaseText += block.innerText + " ");
            const phaseCount = countWords(phaseText);
            document.getElementById('phase-word-count').innerText = `Phase: ${phaseCount}`;
        }

        function countWords(str) {
            const cleanStr = str.trim();
            if (cleanStr === "") return 0;
            // ä¸­æ–‡ç®—å­—æ•¸ï¼Œè‹±æ–‡ç®—å–®è©
            if (/[\u4e00-\u9fa5]/.test(cleanStr)) {
                return cleanStr.replace(/\s+/g, '').length;
            }
            return cleanStr.split(/\s+/).length; 
        }

        // --- 6. AI & Formatting Logic (Text Wall Fix) ---
        function formatAIOutput(markdown) {
            // é€™æ˜¯è§£æ±ºæ–‡å­—æ“ åœ¨ä¸€èµ·çš„æ ¸å¿ƒï¼šå°‡ Markdown è½‰ç‚ºå¸¶æ¨£å¼çš„ HTML
            let html = markdown
                // Headers
                .replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold mt-6 mb-3 text-slate-700">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-2xl font-bold mt-8 mb-4 pb-2 border-b border-slate-200 text-slate-800">$1</h2>')
                // Bold
                .replace(/\*\*(.*?)\*\*/gim, '<strong class="font-bold text-slate-900">$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/gim, '<em class="italic">$1</em>')
                // Lists (Bullet) - ç°¡å–®è™•ç†ï¼Œå°‡ * é–‹é ­çš„è¡Œè½‰ç‚º li
                .replace(/^\* (.*$)/gim, '<li class="ml-6 list-disc mb-2 pl-1">$1</li>')
                // Lists (Number) - ç°¡å–®è™•ç† 1. é–‹é ­
                .replace(/^\d+\. (.*$)/gim, '<li class="ml-6 list-decimal mb-2 pl-1">$1</li>');

            // æœ€é‡è¦ï¼šè™•ç†æ›è¡Œã€‚å°‡é€£çºŒæ›è¡Œ (\n\n) è¦–ç‚ºæ®µè½ï¼Œå–®ä¸€æ›è¡Œ (\n) è¦–ç‚º <br>
            // ç­–ç•¥ï¼šå…ˆç”¨ \n\n åˆ‡å‰²æˆæ®µè½é™£åˆ—
            let paragraphs = html.split(/\n\n+/);
            
            let formattedHtml = paragraphs.map(para => {
                para = para.trim();
                if (!para) return '';
                // å¦‚æœæ®µè½æœ¬èº«å·²ç¶“æ˜¯æ¨™é¡Œæˆ–åˆ—è¡¨ï¼Œå°±ä¸åŒ… <p>
                if (para.startsWith('<h') || para.startsWith('<li')) return para;
                // å¦å‰‡åŒ…è£æˆ <p> ä¸¦è™•ç†å…§éƒ¨çš„å–®è¡Œæ›è¡Œ
                return `<p class="mb-5 leading-relaxed text-justify text-slate-700">${para.replace(/\n/g, '<br>')}</p>`;
            }).join('');

            return formattedHtml;
        }

        function addChatMessage(role, text) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = 'flex gap-3 animate-fade-in';
            if (role === 'system') {
                div.innerHTML = `<div class="w-8 h-8 rounded-full bg-white border border-indigo-100 text-indigo-600 flex-shrink-0 flex items-center justify-center shadow-sm"><i class="fa-solid fa-robot"></i></div><div class="bg-white p-3.5 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 border border-slate-100 leading-relaxed"><p>${text.replace(/\n/g, '<br>')}</p></div>`;
            } else {
                div.innerHTML = `<div class="flex-1"></div><div class="bg-indigo-600 p-3.5 rounded-2xl rounded-tr-none shadow-sm text-sm text-white max-w-[85%] leading-relaxed"><p>${text}</p></div><div class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex-shrink-0 flex items-center justify-center font-bold text-xs">U</div>`;
            }
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        async function simulateAIGeneration() {
            if (isProcessing) return;

            const inputField = document.getElementById('ai-input');
            const userText = inputField.value.trim();
            const phase = document.getElementById('phase-selector').value;
            const lang = document.getElementById('global-lang-selector').value;

            if (!userText && phase !== 'outline') return; 

            isProcessing = true;
            if (userText) addChatMessage('user', userText);
            inputField.value = '';

            const loadingId = 'loading-' + Date.now();
            const history = document.getElementById('chat-history');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex gap-3 items-center text-slate-400 text-xs ml-12 my-2 animate-pulse';
            loadingDiv.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Gemini Thinking (${phase})...`;
            history.appendChild(loadingDiv);
            history.scrollTop = history.scrollHeight;

            // Prompt Construction
            let finalPrompt = userText || "Generate academic content for this phase.";
            if (lang === 'zh-TW') {
                finalPrompt += " (IMPORTANT: Please output in Traditional Chinese ç¹é«”ä¸­æ–‡).";
            } else {
                finalPrompt += " (IMPORTANT: Please output in English).";
            }

            const response = await callBackendAPI({
                action: "generate_content",
                phase: phase,
                user_prompt: finalPrompt
            });

            document.getElementById(loadingId).remove();
            isProcessing = false;

            if (response.status === 'success') {
                addChatMessage('system', `âœ… **${phase}** Generated.`);
                
                const editor = document.getElementById('editor');
                const timestamp = new Date().toLocaleTimeString();
                
                // â˜… ä½¿ç”¨æ–°çš„æ ¼å¼åŒ–å‡½å¼è§£æ±ºæ–‡å­—æ“ åœ¨ä¸€èµ·çš„å•é¡Œ â˜…
                let formattedContent = formatAIOutput(response.data);

                editor.innerHTML += `
                    <div class="mb-10 animate-fade-in group prose prose-slate max-w-none" data-phase="${phase}">
                        <div class="flex items-center gap-2 mb-4 border-b-2 border-indigo-50 pb-2 select-none not-prose">
                            <span class="text-[10px] font-bold text-white uppercase tracking-wider bg-indigo-500 px-2 py-1 rounded shadow-sm">Phase: ${phase}</span>
                            <span class="text-[10px] text-slate-400 font-mono">${timestamp}</span>
                        </div>
                        ${formattedContent}
                    </div>
                `;
                editor.scrollTop = editor.scrollHeight;
                updateWordCount(); 
            } else {
                addChatMessage('system', `âŒ Error: ${response.message}`);
            }
        }

        switchTab('setup');
    </script>
</body>
</html>
