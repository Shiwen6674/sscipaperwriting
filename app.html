<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScholarCraft | SSCI è«–æ–‡å¯«ä½œè¼”åŠ©ç³»çµ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .serif-font { font-family: 'Noto Serif TC', serif; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        .editor-area:focus { outline: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Typography Optimization */
        .prose h2 { font-size: 1.5em; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.8em; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.3em; }
        .prose h3 { font-size: 1.25em; font-weight: 600; margin-top: 1.2em; margin-bottom: 0.6em; color: #334155; }
        .prose p { margin-bottom: 1.2em; line-height: 1.8; text-align: justify; color: #374151; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1.2em; }
        .prose li { margin-bottom: 0.5em; line-height: 1.6; }
        .prose strong { color: #0f172a; font-weight: 600; }
        .prose blockquote { border-left: 4px solid #6366f1; padding-left: 1em; color: #4b5563; font-style: italic; margin-bottom: 1.2em; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-20 transition-all">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-graduation-cap text-indigo-400"></i>
                ScholarCraft
            </h1>
            <p class="text-xs text-slate-400 mt-1">SSCI Q1 Writing Coach</p>
        </div>

        <div class="px-4 pt-4">
            <div class="relative">
                <select id="global-lang-selector" onchange="changeUILanguage()" class="w-full bg-slate-800 text-xs text-slate-300 border border-slate-600 rounded px-2 py-1.5 focus:outline-none focus:border-indigo-500 cursor-pointer">
                    <option value="zh-TW">ğŸŒ ç¹é«”ä¸­æ–‡ (Traditional Chinese)</option>
                    <option value="en-US">ğŸŒ English (US)</option>
                </select>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('setup')" id="nav-setup" class="nav-item w-full text-left px-4 py-3 rounded-lg bg-indigo-600 text-white transition-all flex items-center gap-3 shadow-lg shadow-indigo-900/50">
                <i class="fa-solid fa-chess-board w-5 text-center"></i> <span data-i18n="nav_setup">1. ç ”ç©¶ä¸»é¡Œè¨­å®š</span>
            </button>
            <button onclick="switchTab('data')" id="nav-data" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 transition-all flex items-center gap-3">
                <i class="fa-solid fa-database w-5 text-center"></i> <span data-i18n="nav_data">2. æ–‡ç»è³‡æ–™è§£æ</span>
            </button>
            <button onclick="switchTab('write')" id="nav-write" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 transition-all flex items-center gap-3">
                <i class="fa-solid fa-pen-nib w-5 text-center"></i> <span data-i18n="nav_write">3. AIè¼”åŠ©å¯«ä½œ</span>
            </button>
        </nav>
        <div class="p-4 border-t border-slate-700">
            <div class="flex items-center gap-3 px-2">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center font-bold text-xs shadow-md">U</div>
                <div>
                    <p class="text-sm font-medium">Researcher</p>
                    <p class="text-xs text-slate-400">Connected</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 relative overflow-hidden flex flex-col">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-10">
            <h2 id="page-title" class="text-lg font-semibold text-slate-700" data-i18n="title_setup">ç ”ç©¶ä¸»é¡Œè¨­å®š</h2>
            <div class="flex gap-3">
                <span class="text-xs text-slate-400 flex items-center gap-1"><i class="fa-solid fa-circle text-green-500 text-[8px]"></i> System Ready</span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50 p-6 relative">
            <!-- Setup View -->
            <div id="view-setup" class="max-w-4xl mx-auto space-y-6 animate-fade-in">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-5 mb-8 border-b border-slate-100 pb-6">
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl shadow-inner"><i class="fa-solid fa-sliders"></i></div>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800" data-i18n="setup_canvas_title">ç ”ç©¶è®Šé …è¦ç•« (Variable Canvas)</h3>
                            <p class="text-slate-500 text-sm mt-1" data-i18n="setup_canvas_desc">é‡æ¸…ç ”ç©¶è®Šé …æ˜¯ SSCI è«–æ–‡å¯«ä½œçš„é‡è¦é—œéµã€‚</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-3">
                            <label class="text-sm font-bold text-slate-700 flex justify-between"><span data-i18n="setup_iv">è‡ªè®Šé … (Independent Variable)</span><span class="text-xs font-normal text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">Intervention</span></label>
                            <input type="text" id="iv-input" placeholder="e.g., Generative AI in PBL" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all outline-none text-slate-700">
                        </div>
                        <div class="space-y-3">
                            <label class="text-sm font-bold text-slate-700 flex justify-between"><span data-i18n="setup_dv">ä¾è®Šé … (Ddpendent Variable)</span><span class="text-xs font-normal text-teal-600 bg-teal-50 px-2 py-0.5 rounded">Outcome</span></label>
                            <input type="text" id="dv-input" placeholder="e.g., Argumentation Quality" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all outline-none text-slate-700">
                        </div>
                    </div>

                    <!-- â˜… æ–°å¢ï¼šé€²éšè®Šé …å€å¡Š (Advanced Variables) â˜… -->
                    <div class="mt-4 pt-4 border-t border-slate-100">
                        <button onclick="toggleAdvancedVars()" class="flex items-center gap-2 text-sm text-indigo-600 font-semibold hover:text-indigo-800 transition-colors focus:outline-none">
                            <i id="adv-icon" class="fa-solid fa-chevron-right text-xs transition-transform"></i>
                            <span data-i18n="setup_advanced">é€²éšè®Šé …è¨­å®š (ä¸­ä»‹è®Šé …/èª¿ç¯€è®Šé …)</span>
                        </button>
                        
                        <div id="advanced-vars" class="hidden mt-4 pl-4 border-l-2 border-indigo-100 grid grid-cols-1 md:grid-cols-2 gap-6 transition-all">
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-600 uppercase tracking-wider"><span data-i18n="setup_mediator">ä¸­ä»‹è®Šé … (Mediator)</span></label>
                                <input type="text" id="mediator-input" placeholder="e.g., Learning Motivation" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:ring-1 focus:ring-indigo-500 transition-all outline-none text-sm text-slate-700">
                                <p class="text-[10px] text-slate-400">è§£é‡‹è‡ªè®Šé …(IV)å¦‚ä½•å½±éŸ¿ä¾è®Šé …(DV) (Mechanism)</p>
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-600 uppercase tracking-wider"><span data-i18n="setup_moderator">èª¿ç¯€è®Šé … (Moderator)</span></label>
                                <input type="text" id="moderator-input" placeholder="e.g., Gender, Prior Knowledge" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:ring-1 focus:ring-indigo-500 transition-all outline-none text-sm text-slate-700">
                                <p class="text-[10px] text-slate-400">å½±éŸ¿è‡ªè®Šé …(IV)èˆ‡ä¾è®Šé …(DV)é—œä¿‚å¼·å¼±çš„è®Šé …</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 space-y-3">
                        <label class="text-sm font-bold text-slate-700" data-i18n="setup_topic">ç ”ç©¶ä¸»é¡Œæˆ–æ–¹å‘ (Research Topic or Orientation)</label>
                        <input type="text" id="topic-input" placeholder="e.g., Effectiveness of Digital Tools in Science Education" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all outline-none text-slate-700">
                    </div>
                </div>
                <div class="flex justify-end pt-4">
                    <button onclick="switchTab('data')" class="group px-6 py-3 bg-slate-900 text-white rounded-xl hover:bg-indigo-600 transition-all shadow-lg font-medium flex items-center gap-2"><span data-i18n="btn_next_data">ä¸‹ä¸€æ­¥ï¼šä¸Šå‚³æ–‡ç»</span> <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i></button>
                </div>
            </div>

            <!-- Data View -->
            <div id="view-data" class="hidden max-w-6xl mx-auto space-y-6">
                <div class="bg-white p-10 rounded-2xl shadow-sm border border-slate-200 text-center transition-all">
                    <div id="upload-zone" class="border-2 border-dashed border-slate-300 rounded-xl p-12 hover:bg-indigo-50/50 hover:border-indigo-400 transition-all cursor-pointer group" onclick="document.getElementById('file-upload').click()">
                        <div class="w-16 h-16 bg-green-50 text-green-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-file-csv"></i></div>
                        <h3 class="text-xl font-bold text-slate-700 group-hover:text-indigo-700" data-i18n="data_upload_title">é»æ“Šä¸Šå‚³ WoS æ–‡ç»è³‡æ–™ (Excel/CSV)</h3>
                        <p class="text-slate-500 mt-3 max-w-md mx-auto" data-i18n="data_upload_desc">ç³»çµ±å°‡è‡ªå‹•è§£æï¼šAuthors, Year, Title, Journal, Volume, Issue, Pages DOI, Abstract</p>
                        <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleFileUpload(event)">
                    </div>
                </div>
                <div id="data-preview-container" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[600px]">
                    <div class="p-4 border-b border-slate-200 bg-slate-50/50 flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-slate-700" data-i18n="data_preview_title">æ–‡ç»è³‡æ–™é è¦½</h3>
                            <span class="text-xs font-mono bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full" id="record-count">0 records</span>
                        </div>
                        <span class="text-xs text-green-600 flex items-center gap-1"><i class="fa-solid fa-check-circle"></i> Cloud Synced</span>
                    </div>
                    <div class="overflow-auto custom-scrollbar flex-1">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 py-4 font-semibold w-10 text-center text-slate-400">No.</th>
                                    <th class="px-4 py-4 font-semibold min-w-[150px]">Authors</th>
                                    <th class="px-4 py-4 font-semibold w-16">Year</th>
                                    <th class="px-4 py-4 font-semibold min-w-[200px]">Title</th>
                                    <th class="px-4 py-4 font-semibold min-w-[150px] text-indigo-600">Journal</th>
                                    <th class="px-4 py-4 font-semibold w-24">Vol(Issue)</th>
                                    <th class="px-4 py-4 font-semibold w-24">Pages</th>
                                    <th class="px-4 py-4 font-semibold min-w-[150px]">DOI</th>
                                    <th class="px-4 py-4 font-semibold text-center w-20">Action</th>
                                </tr>
                            </thead>
                            <tbody id="literature-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
                <div class="flex justify-end pt-2">
                     <button onclick="switchTab('write')" class="group px-6 py-3 bg-slate-900 text-white rounded-xl hover:bg-indigo-600 transition-all shadow-lg font-medium flex items-center gap-2"><span data-i18n="btn_next_write">é€²å…¥å¯«ä½œæ¨¡å¼</span> <i class="fa-solid fa-pen-nib group-hover:rotate-12 transition-transform"></i></button>
                </div>
            </div>

            <!-- Write View -->
            <div id="view-write" class="hidden h-full flex flex-col animate-fade-in">
                <div class="flex gap-6 h-full pb-2">
                    <!-- Left AI Panel -->
                    <div class="w-[400px] flex flex-col glass-panel rounded-2xl shadow-sm overflow-hidden border border-indigo-100 shrink-0">
                        <div class="p-4 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white flex flex-col gap-3 shadow-md z-10">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-sm tracking-wide"><i class="fa-solid fa-robot mr-2"></i>SSCI AI Coach</span>
                                <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded text-white/90">Master Level</span>
                            </div>
                            <div class="relative">
                                <select id="phase-selector" onchange="updateWordCount()" class="w-full text-xs text-slate-800 bg-white rounded-lg pl-3 pr-8 py-2.5 outline-none font-medium appearance-none shadow-sm cursor-pointer hover:bg-indigo-50 transition-colors">
                                    <option value="outline">Phase 0: å¤§ç¶±ç”Ÿæˆ (Outline)</option>
                                    <option value="title">Phase 1: é¡Œç›®ç­–ç•¥ (Title)</option>
                                    <option value="abstract">Phase 2: æ‘˜è¦ (Abstract)</option>
                                    <option value="intro">Phase 3: ç·’è«– (Introduction)</option>
                                    <option value="lit_review">Phase 4: æ–‡ç»æ¢è¨ (Lit. Review)</option>
                                    <option value="method">Phase 5: ç ”ç©¶æ–¹æ³• (Methodology)</option>
                                    <option value="results">Phase 6: ç ”ç©¶ç™¼ç¾ (Findings)</option>
                                    <option value="discuss">Phase 7: è¨è«– (Discussion)</option>
                                    <option value="conclusion">Phase 8: çµè«– (Conclusions)</option>
                                </select>
                                <div class="absolute right-3 top-2.5 text-slate-500 pointer-events-none"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                            </div>
                        </div>
                        <div id="chat-history" class="flex-1 p-4 overflow-y-auto custom-scrollbar space-y-5 bg-slate-50/50">
                            <div class="flex gap-3 animate-fade-in">
                                <div class="w-8 h-8 rounded-full bg-white border border-indigo-100 text-indigo-600 flex-shrink-0 flex items-center justify-center shadow-sm"><i class="fa-solid fa-robot"></i></div>
                                <div class="bg-white p-3.5 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 border border-slate-100 leading-relaxed">
                                    <p data-i18n="ai_welcome">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ SSCI å¯«ä½œæ•™ç·´ã€‚è«‹é¸æ“‡ä¸Šæ–¹å¯«ä½œéšæ®µï¼Œä¸¦è¼¸å…¥æŒ‡ä»¤æˆ–ç›´æ¥æŒ‰Enteré–‹å§‹ã€‚</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-white border-t border-slate-100">
                            <div class="relative group">
                                <textarea id="ai-input" placeholder="è¼¸å…¥æŒ‡ä»¤æˆ–æŒ‰ Enter ç›´æ¥ç”Ÿæˆ..." class="w-full pl-4 pr-12 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none resize-none text-sm transition-all shadow-inner" rows="2" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); simulateAIGeneration(); }"></textarea>
                                <button onclick="simulateAIGeneration()" class="absolute right-2 bottom-2.5 p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 text-center flex items-center justify-center gap-1"><i class="fa-solid fa-bolt text-amber-400"></i> Powered by Gemini 2.0 Flash with RAG</p>
                        </div>
                    </div>

                    <!-- Right Panel: Editor -->
                    <div class="flex-1 flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-2 border-b border-slate-100 flex items-center gap-1 text-slate-600 bg-slate-50/50">
                            <button class="p-2 hover:bg-white hover:shadow-sm hover:text-indigo-600 rounded transition-all" title="Bold"><i class="fa-solid fa-bold"></i></button>
                            <button class="p-2 hover:bg-white hover:shadow-sm hover:text-indigo-600 rounded transition-all" title="Italic"><i class="fa-solid fa-italic"></i></button>
                            <button class="p-2 hover:bg-white hover:shadow-sm hover:text-indigo-600 rounded transition-all" title="List"><i class="fa-solid fa-list-ul"></i></button>
                            <div class="h-4 w-px bg-slate-300 mx-2"></div>
                            <div class="flex items-center gap-3 px-2 text-xs font-mono bg-white border border-slate-200 rounded-md py-1 shadow-sm">
                                <span class="text-indigo-600 font-bold" id="phase-word-count">Phase: 0</span>
                                <span class="text-slate-300">|</span>
                                <span class="text-slate-600" id="total-word-count">Total: 0</span>
                            </div>
                            <div class="flex-1"></div>
                            <button class="px-3 py-1 bg-indigo-50 text-indigo-600 text-xs rounded-full font-medium hover:bg-indigo-100 transition-colors"><i class="fa-solid fa-download mr-1"></i> <span data-i18n="btn_export">Export</span></button>
                        </div>
                        <div id="editor" contenteditable="true" oninput="updateWordCount()" class="editor-area flex-1 p-12 text-lg text-slate-800 leading-relaxed overflow-y-auto custom-scrollbar outline-none serif-font prose max-w-none">
                            <h1 class="text-3xl font-bold mb-6 text-slate-900 font-sans">Untitled Manuscript</h1>
                            <p class="text-slate-400 italic">åœ¨æ­¤é–‹å§‹å¯«ä½œï¼Œæˆ–ç­‰å¾…å·¦å´ AI æ•™ç·´ç”Ÿæˆå…§å®¹...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // CONFIG
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxzuSB40CJ_8VgEG5HsZR0QBqShK5TMKQAHHkQf_ww4gGy90uWZUoLjiuwbBpT4BkJoKQ/exec"; 
        
        let literatureData = [];
        let projectInfo = { iv: '', dv: '', topic: '', mediator: '', moderator: '' };
        let isProcessing = false;

        const translations = {
            'zh-TW': {
                'nav_setup': '1. ç ”ç©¶ä¸»é¡Œè¨­å®š', 'nav_data': '2. æ–‡ç»è³‡æ–™è§£æ', 'nav_write': '3. AIè¼”åŠ©å¯«ä½œ',
                'title_setup': 'ç ”ç©¶ä¸»é¡Œè¨­å®š (The Topic Orientation)', 'setup_canvas_title': 'ç ”ç©¶è®Šé …è¦ç•« (Variable Canvas)',
                'setup_canvas_desc': 'æ¸…æ™°é‡æ¸…ç ”ç©¶è®Šé …æ˜¯ SSCI è«–æ–‡å¯«ä½œçš„é‡è¦é—œéµã€‚ç³»çµ±å°‡ä¾æ­¤ä½œç‚º AI ä¸»è¦å¯«ä½œæ–¹å‘ã€‚',
                'setup_iv': 'è‡ªè®Šé … (IV)', 'setup_dv': 'ä¾è®Šé … (DV)', 'setup_topic': 'ç ”ç©¶ä¸»é¡Œæˆ–æ–¹å‘',
                'setup_advanced': 'é€²éšè®Šé …è¨­å®š (ä¸­ä»‹è®Šé …/èª¿ç¯€è®Šé …)', 'setup_mediator': 'ä¸­ä»‹è®Šé … (Mediator)', 'setup_moderator': 'èª¿ç¯€è®Šé … (Moderator)',
                'btn_next_data': 'ä¸‹ä¸€æ­¥ï¼šä¸Šå‚³æ–‡ç»', 'data_upload_title': 'é»æ“Šä¸Šå‚³ WoS æ–‡ç»è³‡æ–™',
                'data_upload_desc': 'ç³»çµ±å°‡è‡ªå‹•è§£æï¼šAuthors, Year, Title, Journal, DOI, Abstract',
                'data_preview_title': 'æ–‡ç»è³‡æ–™é è¦½', 'btn_next_write': 'é€²å…¥å¯«ä½œæ¨¡å¼',
                'ai_welcome': 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ SSCI å¯«ä½œæ•™ç·´ã€‚è«‹é¸æ“‡ä¸Šæ–¹å¯«ä½œéšæ®µï¼Œä¸¦è¼¸å…¥æŒ‡ä»¤æˆ–æŒ‰Enteré–‹å§‹ã€‚', 'btn_export': 'åŒ¯å‡º'
            },
            'en-US': {
                'nav_setup': '1. Setup', 'nav_data': '2. Analysis', 'nav_write': '3. Writing',
                'title_setup': 'Topic Orientation', 'setup_canvas_title': 'Variable Canvas',
                'setup_canvas_desc': 'Define variables clearly to guide AI.',
                'setup_iv': 'Independent Variable (IV)', 'setup_dv': 'Dependent Variable (DV)', 'setup_topic': 'Research Topic',
                'setup_advanced': 'Advanced Variables (Mediator/Moderator)', 'setup_mediator': 'Mediator', 'setup_moderator': 'Moderator',
                'btn_next_data': 'Next: Upload Data', 'data_upload_title': 'Upload WoS Data (Excel/CSV)',
                'data_upload_desc': 'Auto-parsing: Authors, Year, Title, Journal, DOI, Abstract',
                'data_preview_title': 'Literature Pool', 'btn_next_write': 'Start Writing',
                'ai_welcome': 'Hello! I am your SSCI Writing Coach. Select a phase and start.', 'btn_export': 'Export'
            }
        };

        function toggleAdvancedVars() {
            const adv = document.getElementById('advanced-vars');
            const icon = document.getElementById('adv-icon');
            if (adv.classList.contains('hidden')) {
                adv.classList.remove('hidden');
                icon.style.transform = 'rotate(90deg)';
            } else {
                adv.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        async function callBackendAPI(payload) {
            try {
                const response = await fetch(GAS_API_URL, {
                    method: "POST", body: JSON.stringify(payload),
                    headers: { "Content-Type": "text/plain;charset=utf-8" } 
                });
                return await response.json();
            } catch (error) { return { status: "error", message: "é€£ç·šå¤±æ•— (API Error)ã€‚" }; }
        }

        async function switchTab(tabId) {
            ['setup', 'data', 'write'].forEach(id => {
                document.getElementById(`view-${id}`).classList.add('hidden');
                document.getElementById(`nav-${id}`).classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
                document.getElementById(`nav-${id}`).classList.add('text-slate-300', 'hover:bg-slate-800');
            });
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.getElementById(`nav-${tabId}`).classList.remove('text-slate-300', 'hover:bg-slate-800');
            document.getElementById(`nav-${tabId}`).classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
            
            const titles = { 'setup': 'ç ”ç©¶ä¸»é¡Œè¨­å®š', 'data': 'æ–‡ç»è³‡æ–™è§£æ', 'write': 'AIè¼”åŠ©å¯«ä½œ' };
            document.getElementById('page-title').innerText = titles[tabId];

            if (tabId !== 'setup') {
                const newInfo = {
                    iv: document.getElementById('iv-input').value,
                    dv: document.getElementById('dv-input').value,
                    topic: document.getElementById('topic-input').value,
                    mediator: document.getElementById('mediator-input').value, // NEW
                    moderator: document.getElementById('moderator-input').value // NEW
                };
                if (JSON.stringify(newInfo) !== JSON.stringify(projectInfo)) {
                    projectInfo = newInfo;
                    callBackendAPI({ action: "save_settings", data: projectInfo });
                }
            }
        }

        function changeUILanguage() {
            const lang = document.getElementById('global-lang-selector').value;
            const texts = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (texts[key]) el.innerText = texts[key];
            });
            document.getElementById('ai-input').placeholder = lang === 'zh-TW' ? "è¼¸å…¥æŒ‡ä»¤..." : "Enter command...";
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const uploadZone = document.getElementById('upload-zone');
            const originalContent = uploadZone.innerHTML;
            uploadZone.innerHTML = `<div class="animate-pulse"><i class="fa-solid fa-spinner fa-spin text-4xl text-indigo-600 mb-4"></i><h3 class="text-lg font-bold text-slate-700">Processing...</h3></div>`;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    literatureData = jsonData;
                    document.getElementById('record-count').innerText = `${jsonData.length} records`;
                    document.getElementById('data-preview-container').classList.remove('hidden');
                    renderTablePreview(jsonData); 
                    const response = await callBackendAPI({ action: "upload_literature", data: jsonData });
                    addChatMessage('system', response.status === 'success' ? `âœ… Uploaded ${jsonData.length} references.` : `âŒ Failed: ${response.message}`);
                } catch (err) { alert("Parsing Error"); } finally { uploadZone.innerHTML = originalContent; }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderTablePreview(rows) {
            const tbody = document.getElementById('literature-table-body');
            tbody.innerHTML = '';
            rows.forEach((row, index) => {
                const author = (row['Author Full Names'] || row['Authors'] || 'Unknown').split(';')[0];
                const year = row['Publication Year'] || 'N/A';
                const title = row['Article Title'] || 'No Title';
                const journal = row['Source Title'] || 'Unknown';
                const volIssue = (row['Volume'] || '') + (row['Issue'] ? `(${row['Issue']})` : '');
                const pages = (row['Start Page'] && row['End Page']) ? `${row['Start Page']}-${row['End Page']}` : (row['Article Number'] || '');
                const doi = row['DOI'] || '';
                const abstract = row['Abstract'] || 'No Abstract';
                
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b border-slate-50 hover:bg-indigo-50/30 transition-colors cursor-pointer group';
                tr.onclick = () => toggleDetails(index);
                tr.innerHTML = `
                    <td class="px-4 py-4 font-mono text-center text-slate-400">${index + 1}</td>
                    <td class="px-4 py-4 font-medium truncate max-w-[150px]" title="${author}">${author} et al.</td>
                    <td class="px-4 py-4 text-slate-500">${year}</td>
                    <td class="px-4 py-4 truncate max-w-[200px] font-medium text-slate-700 group-hover:text-indigo-700" title="${title}">${title}</td>
                    <td class="px-4 py-4 truncate max-w-[150px] text-indigo-600 italic font-serif" title="${journal}">${journal}</td>
                    <td class="px-4 py-4 text-slate-600 whitespace-nowrap">${volIssue}</td>
                    <td class="px-4 py-4 text-slate-600 whitespace-nowrap">${pages}</td>
                    <td class="px-4 py-4 text-slate-600 truncate max-w-[150px]" title="${doi}">${doi}</td>
                    <td class="px-4 py-4 text-center"><button class="text-xs bg-slate-100 text-slate-500 px-3 py-1.5 rounded-full group-hover:bg-white">Detail</button></td>`;
                tbody.appendChild(tr);
                
                const trDetail = document.createElement('tr');
                trDetail.id = `detail-${index}`;
                trDetail.className = 'hidden bg-slate-50/50 border-b border-slate-100 shadow-inner';
                trDetail.innerHTML = `<td colspan="9" class="p-6"><div class="text-sm text-slate-700 bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><div class="font-bold mb-2 text-xs uppercase text-indigo-500">Abstract</div>${abstract}</div></td>`;
                tbody.appendChild(trDetail);
            });
        }

        function toggleDetails(index) {
            const row = document.getElementById(`detail-${index}`);
            row.classList.toggle('hidden');
        }

        function formatAIOutput(markdown) {
            let formatted = markdown
                .replace(/(^|\n)(æœŸåˆŠé©é…æ€§åˆ†æ|Journal Fit Analysis)/g, '\n\n### $2')
                .replace(/(^|\n)(Phase \d+[:ï¼š]?\s*è«–æ–‡å¤§ç¶±|Outline)/g, '\n\n### $2')
                .replace(/(^|\n)[*â€¢-]?\s*(é¡Œç›®|Title)\s*[:ï¼š\(]/g, '\n\n**é¡Œç›® (Title)**: ')
                .replace(/(^|\n)[*â€¢-]?\s*(æ‘˜è¦|Abstract)\s*[:ï¼š\(]/g, '\n\n**æ‘˜è¦ (Abstract)**: ')
                .replace(/(^|\n)[*â€¢-]?\s*(ç·’è«–|Introduction)\s*[:ï¼š]?/g, '\n\n### ç·’è«– (Introduction)')
                .replace(/(^|\n)[*â€¢-]?\s*(æ–‡ç»æ¢è¨|Literature Review)\s*[:ï¼š]?/g, '\n\n### æ–‡ç»æ¢è¨ (Literature Review)')
                .replace(/(^|\n)[*â€¢-]?\s*(ç ”ç©¶æ–¹æ³•|Methodology)\s*[:ï¼š]?/g, '\n\n### ç ”ç©¶æ–¹æ³• (Methodology)')
                .replace(/(^|\n)[*â€¢-]?\s*(ç ”ç©¶ç™¼ç¾|Findings)\s*[:ï¼š]?/g, '\n\n### ç ”ç©¶ç™¼ç¾ (Findings)')
                .replace(/(^|\n)[*â€¢-]?\s*(è¨è«–|Discussion)\s*[:ï¼š]?/g, '\n\n### è¨è«– (Discussion)')
                .replace(/(^|\n)[*â€¢-]?\s*(çµè«–|Conclusions?)\s*[:ï¼š]?/g, '\n\n### çµè«– (Conclusions)')
                .replace(/(^|\n)(æ³¨æ„äº‹é …|Note[s]?)\s*[:ï¼š]/g, '\n\n**æ³¨æ„äº‹é …:**');

            let html = formatted
                .replace(/^### (.*$)/gim, '<h3 class="text-xl font-bold mt-10 mb-4 text-indigo-700 border-b border-indigo-100 pb-2">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-2xl font-bold mt-12 mb-6 text-slate-800">$1</h2>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong class="font-bold text-slate-900">$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em class="italic text-slate-600">$1</em>')
                .replace(/^\* (.*$)/gim, '<li class="ml-6 list-disc mb-2 pl-1">$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li class="ml-6 list-decimal mb-2 pl-1">$1</li>');

            return html.split(/\n\n+/).map(para => {
                para = para.trim();
                if (!para) return '';
                if (para.startsWith('<h') || para.startsWith('<li')) return para;
                return `<p class="mb-5 leading-relaxed text-justify text-slate-700">${para.replace(/\n/g, '<br>')}</p>`;
            }).join('');
        }

        function updateWordCount() {
            const editor = document.getElementById('editor');
            const totalCount = (editor.innerText || "").trim().split(/\s+/).length;
            document.getElementById('total-word-count').innerText = `Total: ${totalCount}`;
            
            const phase = document.getElementById('phase-selector').value;
            let phaseCount = 0;
            editor.querySelectorAll(`div[data-phase="${phase}"]`).forEach(d => phaseCount += d.innerText.trim().split(/\s+/).length);
            document.getElementById('phase-word-count').innerText = `Phase: ${phaseCount}`;
        }

        function addChatMessage(role, text) {
            const div = document.createElement('div');
            div.className = 'flex gap-3 animate-fade-in';
            div.innerHTML = role === 'system' 
                ? `<div class="w-8 h-8 rounded-full bg-white border border-indigo-100 text-indigo-600 flex-shrink-0 flex items-center justify-center shadow-sm"><i class="fa-solid fa-robot"></i></div><div class="bg-white p-3.5 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 border border-slate-100 leading-relaxed"><p>${text.replace(/\n/g, '<br>')}</p></div>`
                : `<div class="flex-1"></div><div class="bg-indigo-600 p-3.5 rounded-2xl rounded-tr-none shadow-sm text-sm text-white max-w-[85%] leading-relaxed"><p>${text}</p></div><div class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex-shrink-0 flex items-center justify-center font-bold text-xs">U</div>`;
            document.getElementById('chat-history').appendChild(div);
            document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
        }

        async function simulateAIGeneration() {
            if (isProcessing) return;
            const input = document.getElementById('ai-input');
            const text = input.value.trim();
            const phase = document.getElementById('phase-selector').value;
            const lang = document.getElementById('global-lang-selector').value;

            if (!text && phase !== 'outline') return;
            isProcessing = true;
            if (text) addChatMessage('user', text);
            input.value = '';

            const loading = document.createElement('div');
            loading.innerHTML = `<div class="flex gap-3 items-center text-slate-400 text-xs ml-12 my-2 animate-pulse"><i class="fa-solid fa-circle-notch fa-spin"></i> Gemini Thinking (${phase})...</div>`;
            document.getElementById('chat-history').appendChild(loading);

            let prompt = text || "Generate content.";
            prompt += lang === 'zh-TW' ? " (Output in Traditional Chinese)." : " (Output in English).";

            const res = await callBackendAPI({ action: "generate_content", phase: phase, user_prompt: prompt });
            loading.remove();
            isProcessing = false;

            if (res.status === 'success') {
                addChatMessage('system', `âœ… **${phase}** Generated.`);
                const formatted = formatAIOutput(res.data);
                document.getElementById('editor').innerHTML += `<div class="mb-10 animate-fade-in group prose prose-slate max-w-none" data-phase="${phase}"><div class="flex items-center gap-2 mb-4 border-b-2 border-indigo-50 pb-2 select-none not-prose"><span class="text-[10px] font-bold text-white uppercase tracking-wider bg-indigo-500 px-2 py-1 rounded shadow-sm">Phase: ${phase}</span><span class="text-[10px] text-slate-400 font-mono">${new Date().toLocaleTimeString()}</span></div>${formatted}</div>`;
                document.getElementById('editor').scrollTop = document.getElementById('editor').scrollHeight;
                updateWordCount();
            } else {
                addChatMessage('system', `âŒ Error: ${res.message}`);
            }
        }

        switchTab('setup');
    </script>
</body>
</html>
