<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ScholarCraft v2 | SSCI 論文寫作輔助工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- xlsx for WoS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .serif { font-family: 'Noto Serif TC', serif; }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
    .scroll-thin::-webkit-scrollbar { width: 6px; }
    .scroll-thin::-webkit-scrollbar-thumb { background:#cbd5e1;border-radius:3px; }
    .scroll-thin::-webkit-scrollbar-thumb:hover { background:#94a3b8; }
    .prose-area p { margin-bottom: 0.75rem; line-height: 1.8; text-align: justify; }
    .prose-area h2 { margin-top: 1.5rem; margin-bottom: 0.75rem; font-size: 1.1rem; font-weight: 700; }
    .prose-area h3 { margin-top: 1.25rem; margin-bottom: 0.5rem; font-size: 1rem; font-weight: 600; color:#4338ca;}
  </style>
</head>
<body class="bg-slate-100 h-screen flex overflow-hidden">

<!-- Sidebar -->
<aside class="w-72 bg-slate-900 text-slate-100 flex flex-col">
  <div class="px-5 py-4 border-b border-slate-700 flex items-center justify-between">
    <div>
      <div class="flex items-center gap-2">
        <i class="fa-solid fa-graduation-cap text-indigo-400"></i>
        <span class="font-semibold tracking-wide">ScholarCraft v2</span>
      </div>
      <p class="text-xs text-slate-400 mt-1">SSCI Q1 Writing Workstation</p>
    </div>
    <div class="text-[10px] px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">
      BETA
    </div>
  </div>

  <!-- Project / Journal quick info -->
  <div class="px-4 py-3 border-b border-slate-800 text-xs space-y-2">
    <div>
      <label class="text-slate-400">目前專案</label>
      <div id="sidebar-project-name" class="font-semibold truncate">未命名專案</div>
    </div>
    <div class="flex items-center justify-between">
      <div>
        <span class="text-slate-400">目標期刊</span>
        <div id="sidebar-journal" class="text-[11px] text-indigo-300 truncate">未設定</div>
      </div>
      <div class="flex flex-col items-end">
        <span class="text-slate-400">語氣風格</span>
        <select id="style-preset" class="mt-0.5 bg-slate-800 text-[11px] px-2 py-1 rounded border border-slate-600 focus:outline-none"
                onchange="updateStylePreset()">
          <option value="conservative">保守</option>
          <option value="balanced" selected>平衡</option>
          <option value="assertive">較強</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Nav -->
  <nav class="flex-1 overflow-y-auto scroll-thin px-3 py-3 space-y-1 text-sm">
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="project" onclick="switchTab('project')">
      <i class="fa-solid fa-diagram-project w-4 text-center"></i><span>1. 專案＆期刊</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="design" onclick="switchTab('design')">
      <i class="fa-solid fa-flask w-4 text-center"></i><span>2. 研究設計</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="literature" onclick="switchTab('literature')">
      <i class="fa-solid fa-book-open w-4 text-center"></i><span>3. 文獻＆引用</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="data" onclick="switchTab('data')">
      <i class="fa-solid fa-chart-column w-4 text-center"></i><span>4. 數據＆分析</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="writing" onclick="switchTab('writing')">
      <i class="fa-solid fa-pen-nib w-4 text-center"></i><span>5. 寫作＆Reviewer</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="submission" onclick="switchTab('submission')">
      <i class="fa-solid fa-envelope-open-text w-4 text-center"></i><span>6. 投稿包</span>
    </button>
  </nav>

  <!-- User -->
  <div class="px-4 py-3 border-t border-slate-800 flex items-center gap-3 text-xs">
    <div id="user-avatar" class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-fuchsia-500 flex items-center justify-center font-bold text-[11px]">
      U
    </div>
    <div class="flex-1">
      <div id="user-name" class="font-semibold">SSCI 作者</div>
      <div id="user-meta" class="text-slate-400 text-[11px]">Local project · Auto-save</div>
    </div>
  </div>
</aside>

<!-- Main -->
<main class="flex-1 flex flex-col">

  <!-- Header -->
  <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6">
    <div>
      <h1 id="main-title" class="text-sm font-semibold text-slate-700">專案＆期刊設定</h1>
      <p id="main-subtitle" class="text-xs text-slate-400">從期刊開始，決定整篇論文的遊戲規則。</p>
    </div>
    <div class="flex items-center gap-3 text-[11px]">
      <button class="px-3 py-1 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100"
              onclick="runManuscriptFitCheck()">
        <i class="fa-solid fa-magnifying-glass-chart mr-1"></i>期刊適配檢查
      </button>
      <button class="px-3 py-1 rounded-full border border-emerald-400 text-emerald-600 hover:bg-emerald-50"
              onclick="runQualityCheck()">
        <i class="fa-solid fa-shield-heart mr-1"></i>品質＆倫理檢查
      </button>
      <!-- 多語選單：新增區塊 -->
      <div class="flex items-center gap-1">
        <span id="lang-label" class="text-slate-400">語言</span>
        <select id="lang-select"
                class="px-2 py-1 rounded-full border border-slate-300 text-slate-600 bg-white focus:outline-none">
          <!-- 選項由 JS 動態填入 -->
        </select>
      </div>
    </div>
  </header>

  <!-- Content Tabs -->
  <section class="flex-1 overflow-hidden">
    <div class="h-full overflow-y-auto scroll-thin p-4 space-y-4">

      <!-- TAB: Project -->
      <div id="tab-project" class="space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-diagram-project text-indigo-500"></i> 專案基本資訊
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">專案名稱</label>
              <input id="project-title" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     placeholder="例如：Generative AI in PBL for SSI Argumentation"
                     oninput="updateProjectMeta()">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">領域</label>
              <input id="project-field" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     placeholder="Science education / AI in education"
                     oninput="updateProjectMeta()">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">預定投稿年份</label>
              <input id="project-year" type="number"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     value="2025" oninput="updateProjectMeta()">
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-newspaper text-indigo-500"></i> 目標期刊設定
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">目標期刊</label>
              <select id="journal-select"
                      class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                      onchange="updateJournalProfile()">
              </select>
              <p class="text-[11px] text-slate-400 mt-1">
                可在程式中擴充 journalProfiles 物件，加入常用期刊。
              </p>
            </div>
            <div class="text-xs space-y-1" id="journal-profile-summary">
              <!-- filled by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Design -->
      <div id="tab-design" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-flask text-emerald-500"></i> 研究設計總覽
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">研究類型</label>
              <select id="design-type" class="w-full px-2 py-1.5 rounded border border-slate-300"
                      onchange="updateResearchDesign()">
                <option value="">請選擇</option>
                <option value="quant">量化實證</option>
                <option value="qual">質性研究</option>
                <option value="mixed">混合方法</option>
                <option value="review">系統性回顧/文獻分析</option>
              </select>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">研究情境 / 場域</label>
              <input id="design-context" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：台灣國中理化課室"
                     oninput="updateResearchDesign()">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">樣本概況（N、年級）</label>
              <input id="design-sample" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：兩校共 200 名國二學生"
                     oninput="updateResearchDesign()">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">研究工具 / 量表</label>
              <input id="design-instruments" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：論證能力量表、AI 使用問卷"
                     oninput="updateResearchDesign()">
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-question-circle text-indigo-500"></i> 研究問題 & 假設
            </h2>
            <div class="space-x-1 text-[11px]">
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                      onclick="addRQ()">+ RQ</button>
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                      onclick="addHypothesis()">+ H</button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
            <div>
              <h3 class="font-semibold text-slate-700 text-xs mb-1">Research Questions</h3>
              <div id="rq-list" class="space-y-1"></div>
            </div>
            <div>
              <h3 class="font-semibold text-slate-700 text-xs mb-1">Hypotheses</h3>
              <div id="hypo-list" class="space-y-1"></div>
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-sitemap text-fuchsia-500"></i> 變項＆分析對應
            </h2>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="generateMethodDraft()">
              <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成方法草稿（AI）
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">自變項 (IV)</label>
              <input id="design-iv" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     oninput="updateResearchDesign()">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">依變項 (DV)</label>
              <input id="design-dv" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     oninput="updateResearchDesign()">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">中介 / 調節</label>
              <input id="design-medmod" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="Learning motivation (M), Gender (Mod)…"
                     oninput="updateResearchDesign()">
            </div>
          </div>
          <div class="mt-3">
            <h3 class="font-semibold text-slate-700 text-xs mb-1">每個 RQ 對應的分析方法</h3>
            <div id="analysis-plan" class="space-y-2 text-xs"></div>
          </div>
        </div>
      </div>

      <!-- TAB: Literature -->
      <div id="tab-literature" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 flex flex-col md:flex-row gap-4">
          <!-- Upload & summary -->
          <div class="md:w-1/2 space-y-3 text-xs">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-file-import text-emerald-500"></i> 文獻庫（WoS/Scopus 匯入）
            </h2>
            <label class="block">
              <span class="text-slate-500 mb-1 block">上傳 Excel/CSV</span>
              <input id="lit-file" type="file" accept=".xlsx,.xls,.csv"
                     class="text-xs" onchange="handleLiteratureUpload(event)">
            </label>
            <p class="text-[11px] text-slate-500">
              系統會解析 Author, Year, Title, Journal, DOI 等欄位，形成文獻庫。
            </p>
            <div class="flex items-center gap-2">
              <span class="text-slate-500">目前文獻數：</span>
              <span id="lit-count" class="px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 text-[11px]">0</span>
            </div>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="syncLiteratureToBackend()">
              <i class="fa-solid fa-cloud-arrow-up mr-1"></i>同步文獻庫到後端
            </button>
          </div>

          <!-- Citation search / insert -->
          <div class="md:w-1/2 space-y-2 text-xs">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-quote-right text-fuchsia-500"></i> 引文搜尋＆插入
            </h2>
            <input id="lit-search" type="text"
                   class="w-full px-2 py-1.5 rounded border border-slate-300"
                   placeholder="輸入 author / keyword 搜尋"
                   oninput="renderLiteratureList()">
            <div id="lit-list" class="max-h-52 overflow-y-auto scroll-thin border border-slate-200 rounded p-2 bg-slate-50 text-[11px]">
              <!-- items -->
            </div>
            <button class="mt-2 px-3 py-1 rounded-full bg-emerald-600 text-white text-[11px] hover:bg-emerald-700"
                    onclick="generateReferencesSection()">
              <i class="fa-solid fa-list-check mr-1"></i>生成 References（僅限實際引用）
            </button>
            <p class="text-[10px] text-slate-400">
              引文會在正文以 (Author, Year) 插入，並記錄於 usedCitations。
            </p>
          </div>
        </div>

        <!-- Preview -->
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-database text-slate-500"></i> 文獻庫預覽（前 20 筆）
          </h2>
          <div class="max-h-60 overflow-y-auto scroll-thin border border-slate-200 rounded bg-white">
            <table class="w-full text-[11px]">
              <thead class="bg-slate-50 text-slate-500">
              <tr>
                <th class="px-2 py-1 text-left">#</th>
                <th class="px-2 py-1 text-left">Author</th>
                <th class="px-2 py-1 text-left">Year</th>
                <th class="px-2 py-1 text-left">Title</th>
                <th class="px-2 py-1 text-left">Journal</th>
              </tr>
              </thead>
              <tbody id="lit-preview-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB: Data -->
      <div id="tab-data" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-chart-column text-indigo-500"></i> 數據檔案＆分析輸出
            </h2>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="generateResultsDraft()">
              <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成結果草稿（AI）
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="block text-slate-500 mb-1">上傳原始數據（選用）</label>
              <input id="data-raw-file" type="file" accept=".xlsx,.csv,.sav" class="text-[11px]">
              <p class="text-[10px] text-slate-400 mt-1">建議仍以本地統計軟體分析，本系統偏向協助撰寫。</p>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">上傳分析輸出（表格/結果摘要）</label>
              <input id="data-output-file" type="file" accept=".xlsx,.csv,.txt,.docx,.pdf" class="text-[11px]">
              <p class="text-[10px] text-slate-400 mt-1">可上傳整理後的分析表格，後端可進一步解析。</p>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">分析摘要備註</label>
              <textarea id="data-notes" rows="3"
                        class="w-full px-2 py-1.5 rounded border border-slate-300"
                        placeholder="簡要說明你做了哪些統計分析，例如：2x2 混合設計 ANOVA, MLR, LCA…"
                        oninput="updateDataMeta()"></textarea>
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-diagram-next text-emerald-500"></i> 每個 RQ 對應的分析計畫
          </h2>
          <p class="text-[11px] text-slate-500 mb-2">
            下方內容會自動從「研究設計」頁的 RQ 產生，你可以為每個 RQ 選一種主要分析方法。
          </p>
          <div id="analysis-plan-data" class="space-y-2"></div>
        </div>
      </div>

      <!-- TAB: Writing -->
      <div id="tab-writing" class="hidden space-y-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-[calc(100vh-6rem)]">
          <!-- AI Coach -->
          <div class="glass rounded-xl border border-slate-200 flex flex-col text-xs">
            <div class="px-3 py-2 border-b border-slate-200 bg-gradient-to-r from-indigo-600 to-indigo-700 text-slate-50">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i class="fa-solid fa-robot"></i>
                  <span class="font-semibold text-[12px]">SSCI AI Coach / Reviewer</span>
                </div>
                <span id="current-chapter-label" class="text-[11px] bg-slate-900/30 px-2 py-0.5 rounded-full">
                  Intro
                </span>
              </div>
            </div>
            <div class="p-2 border-b border-slate-200 bg-slate-50 text-[11px]" id="chapter-checklist">
              <!-- filled by JS -->
            </div>
            <div id="chat-panel" class="flex-1 overflow-y-auto scroll-thin p-2 space-y-2 bg-slate-50">
              <!-- chat messages -->
            </div>
            <div class="border-t border-slate-200 p-2 space-y-1">
              <div class="flex items-center gap-1 mb-1">
                <button class="flex-1 px-2 py-1 rounded bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                        onclick="generateChapterDraft()">
                  <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成本章草稿
                </button>
                <button class="px-2 py-1 rounded border border-rose-400 text-rose-600 text-[11px] hover:bg-rose-50"
                        onclick="runReviewerMode()">
                  <i class="fa-solid fa-gavel mr-1"></i>Reviewer 模式
                </button>
              </div>
              <div class="relative">
                <textarea id="ai-input" rows="2"
                          class="w-full px-2 pr-8 py-1.5 rounded border border-slate-300 text-[11px]"
                          placeholder="輸入額外指令（可留白，直接生成）"
                          onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendAIMessage();}">
                </textarea>
                <button class="absolute right-1 bottom-1.5 p-1.5 rounded bg-indigo-600 text-white text-[10px]"
                        onclick="sendAIMessage()">
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Chapter / Editor -->
          <div class="lg:col-span-2 glass rounded-xl border border-slate-200 flex flex-col">
            <div class="px-3 py-2 border-b border-slate-200 flex items-center gap-2 text-[11px]">
              <label class="text-slate-500">章節</label>
              <select id="chapter-select" class="px-2 py-1 rounded border border-slate-300"
                      onchange="switchChapter()">
                <option value="outline">0. 論文大綱</option>
                <option value="intro">1. 緒論</option>
                <option value="lit_review">2. 文獻探討</option>
                <option value="method">3. 研究方法</option>
                <option value="results">4. 研究結果</option>
                <option value="discussion">5. 討論</option>
                <option value="conclusion">6. 結論</option>
                <option value="implications">7. 教育意涵</option>
                <option value="limitations">8. 限制與未來研究</option>
                <option value="abstract">9. 摘要</option>
                <option value="fullpaper">10. 全文整合</option>
              </select>
              <div class="flex-1"></div>
              <div class="flex items-center gap-2">
                <span id="chapter-word-count" class="text-slate-500">本章字數：0</span>
                <span id="total-word-count" class="text-slate-400">全文字數：0</span>
              </div>
