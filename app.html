<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ScholarCraft v3 | AI 輔助 SSCI 論文寫作系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- xlsx for WoS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .serif { font-family: 'Noto Serif TC', serif; }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
    .scroll-thin::-webkit-scrollbar { width: 6px; }
    .scroll-thin::-webkit-scrollbar-thumb { background:#cbd5e1;border-radius:3px; }
    .scroll-thin::-webkit-scrollbar-thumb:hover { background:#94a3b8; }
  </style>
</head>
<body class="bg-slate-100 h-screen flex overflow-hidden">

<!-- Sidebar -->
<aside class="w-72 bg-slate-900 text-slate-100 flex flex-col">
  <div class="px-5 py-4 border-b border-slate-700 flex items-center justify-between">
    <div>
      <div class="flex items-center gap-2">
        <i class="fa-solid fa-graduation-cap text-indigo-400"></i>
        <span class="font-semibold tracking-wide">ScholarCraft v3</span>
      </div>
      <p class="text-xs text-slate-400 mt-1">SSCI Q1 Writing Workstation</p>
    </div>
    <div class="text-[10px] px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">
      BETA
    </div>
  </div>

  <!-- Project / Journal quick info -->
  <div class="px-4 py-3 border-b border-slate-800 text-xs space-y-2">
    <div>
      <label class="text-slate-400">目前專案</label>
      <div id="sidebar-project-name" class="font-semibold truncate">未命名專案</div>
    </div>
    <div class="flex items-center justify-between">
      <div>
        <span class="text-slate-400">目標期刊</span>
        <div id="sidebar-journal" class="text-[11px] text-indigo-300 truncate">未設定</div>
      </div>
      <div class="flex flex-col items-end">
        <span class="text-slate-400">語氣風格</span>
        <select id="style-preset" class="mt-0.5 bg-slate-800 text-[11px] px-2 py-1 rounded border border-slate-600 focus:outline-none"
                onchange="updateStylePreset()">
          <option value="conservative">保守</option>
          <option value="balanced" selected>平衡</option>
          <option value="assertive">較強</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Nav -->
  <nav class="flex-1 overflow-y-auto scroll-thin px-3 py-3 space-y-1 text-sm">
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="project" onclick="switchTab('project')">
      <i class="fa-solid fa-diagram-project w-4 text-center"></i><span>1. 專案＆期刊</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="design" onclick="switchTab('design')">
      <i class="fa-solid fa-flask w-4 text-center"></i><span>2. 研究設計</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="literature" onclick="switchTab('literature')">
      <i class="fa-solid fa-book-open w-4 text-center"></i><span>3. 文獻＆引用</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="data" onclick="switchTab('data')">
      <i class="fa-solid fa-chart-column w-4 text-center"></i><span>4. 數據＆分析</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="writing" onclick="switchTab('writing')">
      <i class="fa-solid fa-pen-nib w-4 text-center"></i><span>5. 寫作＆Reviewer</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="submission" onclick="switchTab('submission')">
      <i class="fa-solid fa-envelope-open-text w-4 text-center"></i><span>6. 投稿包</span>
    </button>
  </nav>

  <!-- User -->
  <div class="px-4 py-3 border-t border-slate-800 flex items-center gap-3 text-xs">
    <div id="user-avatar" class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-fuchsia-500 flex items-center justify-center font-bold text-[11px]">
      U
    </div>
    <div class="flex-1">
      <div id="user-name" class="font-semibold">SSCI 作者</div>
      <div id="user-meta" class="text-slate-400 text-[11px]">Local project · Auto-save</div>
    </div>
  </div>
</aside>

<!-- Main -->
<main class="flex-1 flex flex-col">

  <!-- Header -->
  <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6">
    <div>
      <h1 id="main-title" class="text-sm font-semibold text-slate-700">專案＆期刊設定</h1>
      <p id="main-subtitle" class="text-xs text-slate-400">從期刊開始，決定整篇論文的遊戲規則。</p>
    </div>
    <div class="flex items-center gap-3 text-[11px]">
      <button class="px-3 py-1 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100"
              onclick="runManuscriptFitCheck()">
        <i class="fa-solid fa-magnifying-glass-chart mr-1"></i>期刊適配檢查
      </button>
      <button class="px-3 py-1 rounded-full border border-emerald-400 text-emerald-600 hover:bg-emerald-50"
              onclick="runQualityCheck()">
        <i class="fa-solid fa-shield-heart mr-1"></i>品質＆倫理檢查
      </button>
      <!-- 多語選單：生成語言 -->
      <div class="flex items-center gap-1">
        <span id="lang-label" class="text-slate-400">生成語言</span>
        <select id="lang-select"
                class="px-2 py-1 rounded-full border border-slate-300 text-slate-600 bg-white focus:outline-none">
        </select>
      </div>
    </div>
  </header>

  <!-- Content Tabs -->
  <section class="flex-1 overflow-hidden">
    <div class="h-full overflow-y-auto scroll-thin p-4 space-y-4">

      <!-- TAB: Project -->
      <div id="tab-project" class="space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-diagram-project text-indigo-500"></i> 專案基本資訊
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">專案名稱</label>
              <input id="project-title" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     placeholder="例如：Generative AI in PBL for SSI Argumentation"
                     oninput="updateProjectMeta(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">領域</label>
              <input id="project-field" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     placeholder="Science education / AI in education"
                     oninput="updateProjectMeta(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">預定投稿年份</label>
              <input id="project-year" type="number"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     value="2025" oninput="updateProjectMeta(); scheduleSaveState();">
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-newspaper text-indigo-500"></i> 目標期刊設定
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">目標期刊</label>
              <select id="journal-select"
                      class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                      onchange="updateJournalProfile(); scheduleSaveState();">
              </select>
              <p class="text-[11px] text-slate-400 mt-1">
                可在程式中擴充 journalProfiles 物件，加入常用期刊。
              </p>
            </div>
            <div class="text-xs space-y-1" id="journal-profile-summary">
              <!-- filled by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Design -->
      <div id="tab-design" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-flask text-emerald-500"></i> 研究設計總覽
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">研究類型</label>
              <select id="design-type" class="w-full px-2 py-1.5 rounded border border-slate-300"
                      onchange="updateResearchDesign(); scheduleSaveState();">
                <option value="">請選擇</option>
                <option value="quant">量化實證</option>
                <option value="qual">質性研究</option>
                <option value="mixed">混合方法</option>
                <option value="review">系統性回顧/文獻分析</option>
              </select>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">研究情境 / 場域</label>
              <input id="design-context" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：台灣國中理化課室"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">樣本概況（N、年級）</label>
              <input id="design-sample" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：兩校共 200 名國二學生"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">研究工具 / 量表</label>
              <input id="design-instruments" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：論證能力量表、AI 使用問卷"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-question-circle text-indigo-500"></i> 研究問題 & 假設
            </h2>
            <div class="space-x-1 text-[11px]">
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                      onclick="addRQ()">+ RQ</button>
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                      onclick="addHypothesis()">+ H</button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
            <div>
              <h3 class="font-semibold text-slate-700 text-xs mb-1">Research Questions</h3>
              <div id="rq-list" class="space-y-2"></div>
            </div>
            <div>
              <h3 class="font-semibold text-slate-700 text-xs mb-1">Hypotheses</h3>
              <div id="hypo-list" class="space-y-2"></div>
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-sitemap text-fuchsia-500"></i> 變項＆分析對應
            </h2>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="generateMethodDraft()">
              <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成方法草稿（AI）
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">自變項 (IV)</label>
              <input id="design-iv" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">依變項 (DV)</label>
              <input id="design-dv" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">中介 / 調節</label>
              <input id="design-medmod" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="Learning motivation (M), Gender (Mod)…"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
          </div>
          <div class="mt-3">
            <h3 class="font-semibold text-slate-700 text-xs mb-1">每個 RQ 對應的分析方法</h3>
            <div id="analysis-plan" class="space-y-2 text-xs"></div>
          </div>
        </div>
      </div>

      <!-- TAB: Literature -->
      <div id="tab-literature" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 flex flex-col md:flex-row gap-4">
          <!-- Upload & summary -->
          <div class="md:w-1/2 space-y-3 text-xs">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-file-import text-emerald-500"></i> 文獻庫（WoS/Scopus 匯入）
            </h2>
            <label class="block">
              <span class="text-slate-500 mb-1 block">上傳 Excel/CSV</span>
              <input id="lit-file" type="file" accept=".xlsx,.xls,.csv"
                     class="text-xs" onchange="handleLiteratureUpload(event)">
            </label>
            <p class="text-[11px] text-slate-500">
              系統會解析 Author, Year, Title, Journal, DOI 等欄位，形成文獻庫。
            </p>
            <div class="flex items-center gap-2">
              <span class="text-slate-500">目前文獻數：</span>
              <span id="lit-count" class="px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 text-[11px]">0</span>
            </div>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="syncLiteratureToBackend()">
              <i class="fa-solid fa-cloud-arrow-up mr-1"></i>同步文獻庫到後端
            </button>
          </div>

          <!-- Citation search / insert -->
          <div class="md:w-1/2 space-y-2 text-xs">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-quote-right text-fuchsia-500"></i> 引文搜尋＆插入
            </h2>
            <input id="lit-search" type="text"
                   class="w-full px-2 py-1.5 rounded border border-slate-300"
                   placeholder="輸入 author / keyword 搜尋"
                   oninput="renderLiteratureList()">
            <div id="lit-list" class="max-h-52 overflow-y-auto scroll-thin border border-slate-200 rounded p-2 bg-slate-50 text-[11px]">
            </div>
            <button class="mt-2 px-3 py-1 rounded-full bg-emerald-600 text-white text-[11px] hover:bg-emerald-700"
                    onclick="generateReferencesSection()">
              <i class="fa-solid fa-list-check mr-1"></i>生成 References（僅限實際引用）
            </button>
            <p class="text-[10px] text-slate-400">
              引文會在正文以 (Author, Year) 插入，並記錄於 usedCitations。
            </p>
          </div>
        </div>

        <!-- Preview -->
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-database text-slate-500"></i> 文獻庫預覽（前 20 筆）
          </h2>
          <div class="max-h-60 overflow-y-auto scroll-thin border border-slate-200 rounded bg-white">
            <table class="w-full text-[11px]">
              <thead class="bg-slate-50 text-slate-500">
              <tr>
                <th class="px-2 py-1 text-left">#</th>
                <th class="px-2 py-1 text-left">Author</th>
                <th class="px-2 py-1 text-left">Year</th>
                <th class="px-2 py-1 text-left">Title</th>
                <th class="px-2 py-1 text-left">Journal</th>
              </tr>
              </thead>
              <tbody id="lit-preview-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB: Data -->
      <div id="tab-data" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-chart-column text-indigo-500"></i> 數據檔案＆分析輸出
            </h2>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="generateResultsDraft()">
              <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成結果草稿（AI）
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="block text-slate-500 mb-1">上傳原始數據（選用）</label>
              <input id="data-raw-file" type="file" accept=".xlsx,.csv,.sav" class="text-[11px]"
                     onchange="handleDataRawUpload(event)">
              <p class="text-[10px] text-slate-400 mt-1">建議仍以本地統計軟體分析，本系統偏向協助撰寫。</p>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">上傳分析輸出（表格/結果摘要）</label>
              <input id="data-output-file" type="file" accept=".xlsx,.csv,.txt" class="text-[11px]"
                     onchange="handleDataOutputUpload(event)">
              <p class="text-[10px] text-slate-400 mt-1">可上傳整理後的分析表格，後端可進一步解析。</p>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">分析摘要備註</label>
              <textarea id="data-notes" rows="3"
                        class="w-full px-2 py-1.5 rounded border border-slate-300"
                        placeholder="簡要說明你做了哪些統計分析，例如：2x2 混合設計 ANOVA, MLR, LCA…"
                        oninput="updateDataMeta(); scheduleSaveState()"></textarea>
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-diagram-next text-emerald-500"></i> 每個 RQ 對應的分析計畫
          </h2>
          <p class="text-[11px] text-slate-500 mb-2">
            下方內容會自動從「研究設計」頁的 RQ 產生，你可以為每個 RQ 選一種主要分析方法。
          </p>
          <div id="analysis-plan-data" class="space-y-2"></div>
        </div>
      </div>

      <!-- TAB: Writing -->
      <div id="tab-writing" class="hidden space-y-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-[calc(100vh-6rem)]">
          <!-- AI Coach -->
          <div class="glass rounded-xl border border-slate-200 flex flex-col text-xs">
            <div class="px-3 py-2 border-b border-slate-200 bg-gradient-to-r from-indigo-600 to-indigo-700 text-slate-50">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i class="fa-solid fa-robot"></i>
                  <span class="font-semibold text-[12px]">SSCI AI Coach / Reviewer</span>
                </div>
                <span id="current-chapter-label" class="text-[11px] bg-slate-900/30 px-2 py-0.5 rounded-full">
                  Intro
                </span>
              </div>
            </div>
            <div class="p-2 border-b border-slate-200 bg-slate-50 text-[11px]" id="chapter-checklist">
            </div>
            <div id="chat-panel" class="flex-1 overflow-y-auto scroll-thin p-2 space-y-2 bg-slate-50">
            </div>
            <div class="border-t border-slate-200 p-2 space-y-1">
              <div class="flex items-center gap-1 mb-1">
                <button class="flex-1 px-2 py-1 rounded bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                        onclick="generateChapterDraft()">
                  <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成本章草稿
                </button>
                <button class="px-2 py-1 rounded border border-rose-400 text-rose-600 text-[11px] hover:bg-rose-50"
                        onclick="runReviewerMode()">
                  <i class="fa-solid fa-gavel mr-1"></i>Reviewer 模式
                </button>
              </div>
              <div class="flex items-center gap-1 mb-1">
                <button class="flex-1 px-2 py-1 rounded border border-emerald-500 text-emerald-700 text-[11px] hover:bg-emerald-50"
                        onclick="runAutoCitationForCurrentChapter()">
                  <i class="fa-solid fa-bookmark mr-1"></i>AI 自動配文獻（僅用 referencePool）
                </button>
              </div>
              <div class="flex items-center justify-between mb-1 text-[10px]">
                <span class="text-slate-500">快照 / 版本</span>
                <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                        onclick="createSnapshot()">
                  <i class="fa-solid fa-camera mr-1"></i>儲存快照
                </button>
              </div>
              <div id="snapshot-list" class="max-h-20 overflow-y-auto scroll-thin text-[10px] space-y-1">
              </div>
              <div class="relative mt-1">
                <textarea id="ai-input" rows="2"
                          class="w-full px-2 pr-8 py-1.5 rounded border border-slate-300 text-[11px]"
                          placeholder="輸入額外指令（可留白，直接生成）"
                          onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendAIMessage();}">
                </textarea>
                <button class="absolute right-1 bottom-1.5 p-1.5 rounded bg-indigo-600 text-white text-[10px]"
                        onclick="sendAIMessage()">
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Chapter / Editor -->
          <div class="lg:col-span-2 glass rounded-xl border border-slate-200 flex flex-col">
            <div class="px-3 py-2 border-b border-slate-200 flex items-center gap-2 text-[11px]">
              <label class="text-slate-500">章節</label>
              <select id="chapter-select" class="px-2 py-1 rounded border border-slate-300"
                      onchange="switchChapter()">
                <option value="outline">0. 論文大綱</option>
                <option value="intro">1. 緒論</option>
                <option value="lit_review">2. 文獻探討</option>
                <option value="method">3. 研究方法</option>
                <option value="results">4. 研究結果</option>
                <option value="discussion">5. 討論</option>
                <option value="conclusion">6. 結論</option>
                <option value="implications">7. 教育意涵</option>
                <option value="limitations">8. 限制與未來研究</option>
                <option value="abstract">9. 摘要</option>
                <option value="fullpaper">10. 全文整合</option>
              </select>
              <div class="flex-1"></div>
              <div class="flex flex-col items-end gap-0.5">
                <span id="chapter-word-count" class="text-slate-500">本章字數：0</span>
                <span id="total-word-count" class="text-slate-400">全文字數：0</span>
              </div>
            </div>

            <div id="chapter-editors" class="flex-1 overflow-hidden">
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin"
                data-chapter="outline"
                oninput="onChapterInput('outline', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="intro"
                oninput="onChapterInput('intro', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="lit_review"
                oninput="onChapterInput('lit_review', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="method"
                oninput="onChapterInput('method', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="results"
                oninput="onChapterInput('results', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="discussion"
                oninput="onChapterInput('discussion', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="conclusion"
                oninput="onChapterInput('conclusion', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="implications"
                oninput="onChapterInput('implications', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="limitations"
                oninput="onChapterInput('limitations', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="abstract"
                oninput="onChapterInput('abstract', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="fullpaper"
                oninput="onChapterInput('fullpaper', this.value)"
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Submission -->
      <div id="tab-submission" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-envelope-open-text text-indigo-500"></i> 投稿包總覽
          </h2>
          <p class="text-[11px] text-slate-600 mb-2">
            在這裡彙整 cover letter、投稿信模板、回覆 reviewer 信件草稿與期刊投稿注意事項，可搭配上方寫作區的全文內容與 References 一起輸出。
          </p>
          <p class="text-[10px] text-slate-500">
            （此區功能可依實際工作流程擴充，如：儲存多版本投稿信模板、對應 R1/R2 審查意見等）
          </p>
        </div>
      </div>

    </div>
  </section>
</main>

<script>
  /**********************
   * 後端設定與共用工具 *
   **********************/
  const BACKEND_CONFIG = {
    // 實際使用時請改成你的 Apps Script 或其他後端 Web API URL
    API_BASE_URL: '', // 例如："https://script.google.com/macros/s/XXX/exec"
    USE_MOCK: true    // 開發階段用 mock；要打真後端時改成 false 並設定 API_BASE_URL
  };

  async function callBackend(endpoint, payload) {
    // 若未設定 API_BASE_URL 或仍在 mock 模式，就回傳假的結果，至少 UI 不會掛
    if (!BACKEND_CONFIG.API_BASE_URL || BACKEND_CONFIG.USE_MOCK) {
      console.warn('[ScholarCraft] 使用 mock 後端：', endpoint, payload);
      await new Promise(r => setTimeout(r, 400)); // 模擬延遲
      if (endpoint === '/generateChapter') {
        return {
          ok: true,
          data: {
            text: (payload.chapterText || '') + '\n\n[Mock AI] 這是示意草稿，請接上真實後端以取得正式內容。'
          }
        };
      }
      if (endpoint === '/reviewChapter') {
        return {
          ok: true,
          data: {
            summary: 'Mock Reviewer：整體結構大致合理，但請補強理論脈絡與方法論嚴謹度。',
            comments: [
              '1. 建議在開頭更清楚界定研究問題與研究貢獻。',
              '2. 文獻整合部分可以增加近五年的 SSCI 研究。',
              '3. 結果與討論應更緊密對應研究問題。'
            ]
          }
        };
      }
      if (endpoint === '/autoCiteChapter') {
        return {
          ok: true,
          data: {
            text: payload.chapterText + '\n\n[Mock AI] 已示意性標記引用，實際配文獻請由真實後端完成。'
          }
        };
      }
      if (endpoint === '/resultsDraft') {
        return {
          ok: true,
          data: { text: '[Mock AI] 這裡會根據你上傳的分析輸出，生成結果敘述草稿。' }
        };
      }
      if (endpoint === '/methodDraft') {
        return {
          ok: true,
          data: { text: '[Mock AI] 這裡會根據研究設計與 RQ，生成方法章節草稿。' }
        };
      }
      if (endpoint === '/syncReferences') {
        return { ok: true, data: { message: 'Mock：文獻庫已同步（實際未寫入後端）。' } };
      }
      return { ok: true, data: {} };
    }

    try {
      const res = await fetch(BACKEND_CONFIG.API_BASE_URL + endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload || {})
      });
      if (!res.ok) {
        console.error('Backend HTTP error', res.status, await res.text());
        return { ok: false, error: 'HTTP ' + res.status };
      }
      const data = await res.json();
      return { ok: true, data };
    } catch (err) {
      console.error('Backend fetch error', err);
      return { ok: false, error: err.message || String(err) };
    }
  }

  function escapeHtml(str) {
    return (str || '').replace(/[&<>"']/g, function(m) {
      return ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m];
    });
  }

  /**********************
   * 全域狀態：v3       *
   **********************/
  const STORAGE_KEY = 'scholarcraft_v3_project';
  let saveTimer = null;

  const state = {
    projectId: 'default',
    lang: 'zh-TW',
    stylePreset: 'balanced',
    projectMeta: {
      title: '',
      field: '',
      year: '2025',
      journalKey: ''
    },
    referencePool: [],
    usedCitationIds: new Set(),
    chapters: {
      outline: '',
      intro: '',
      lit_review: '',
      method: '',
      results: '',
      discussion: '',
      conclusion: '',
      implications: '',
      limitations: '',
      abstract: '',
      fullpaper: ''
    },
    // 研究設計
    design: {
      type: '',
      context: '',
      sample: '',
      instruments: '',
      iv: '',
      dv: '',
      medmod: ''
    },
    rqs: [],          // [{id:'RQ1', text:'...'}]
    hypotheses: [],   // [{id:'H1', text:'...'}]
    analysisPlan: {}, // { 'RQ1': { method:'ANOVA', note:'...' } }
    // 數據
    dataMeta: {
      notes: '',
      rawFileName: '',
      outputFileName: ''
    },
    // 文獻
    litFilesMeta: {
      sourceFileName: ''
    },
    // 快照
    snapshots: []     // [{id, label, createdAt, chapters}]
  };

  document.addEventListener('DOMContentLoaded', () => {
    loadStateFromStorage();
    initNav();
    initLangSelect();
    initJournalSelect();
    initChecklist();
    renderRQList();
    renderHypothesisList();
    renderAnalysisPlan();
    renderAnalysisPlanData();
    renderSnapshotList();
    updateProjectMeta();
    switchTab('project');
    switchChapter(); // 初始化章節
    renderLiteratureList();
    renderLiteraturePreview();
  });

  function scheduleSaveState() {
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(saveStateToStorage, 500);
  }

  function saveStateToStorage() {
    try {
      const safeState = {
        projectId: state.projectId,
        lang: state.lang,
        stylePreset: state.stylePreset,
        projectMeta: state.projectMeta,
        chapters: state.chapters,
        design: state.design,
        rqs: state.rqs,
        hypotheses: state.hypotheses,
        analysisPlan: state.analysisPlan,
        dataMeta: state.dataMeta,
        litFilesMeta: state.litFilesMeta,
        snapshots: state.snapshots,
        referencePool: state.referencePool
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(safeState));
    } catch (e) {
      console.warn('儲存到 localStorage 失敗：', e);
    }
  }

  function loadStateFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const saved = JSON.parse(raw);
      if (!saved || typeof saved !== 'object') return;

      // 合併回 state
      Object.assign(state, {
        projectId: saved.projectId || 'default',
        lang: saved.lang || 'zh-TW',
        stylePreset: saved.stylePreset || 'balanced',
        projectMeta: Object.assign({}, state.projectMeta, saved.projectMeta || {}),
        chapters: Object.assign({}, state.chapters, saved.chapters || {}),
        design: Object.assign({}, state.design, saved.design || {}),
        rqs: saved.rqs || [],
        hypotheses: saved.hypotheses || [],
        analysisPlan: saved.analysisPlan || {},
        dataMeta: Object.assign({}, state.dataMeta, saved.dataMeta || {}),
        litFilesMeta: Object.assign({}, state.litFilesMeta, saved.litFilesMeta || {}),
        snapshots: saved.snapshots || [],
        referencePool: saved.referencePool || []
      });

      // 回填 UI
      document.getElementById('project-title').value = state.projectMeta.title || '';
      document.getElementById('project-field').value = state.projectMeta.field || '';
      document.getElementById('project-year').value = state.projectMeta.year || '2025';
      document.getElementById('design-type').value = state.design.type || '';
      document.getElementById('design-context').value = state.design.context || '';
      document.getElementById('design-sample').value = state.design.sample || '';
      document.getElementById('design-instruments').value = state.design.instruments || '';
      document.getElementById('design-iv').value = state.design.iv || '';
      document.getElementById('design-dv').value = state.design.dv || '';
      document.getElementById('design-medmod').value = state.design.medmod || '';
      document.getElementById('data-notes').value = state.dataMeta.notes || '';
      document.getElementById('style-preset').value = state.stylePreset || 'balanced';

      // 語言選單會在 initLangSelect 中設定 value
    } catch (e) {
      console.warn('讀取 localStorage 失敗：', e);
    }
  }

  /**********************
   * UI 初始化與導覽     *
   **********************/

  function initNav() {
    const firstNav = document.querySelector('.nav-btn[data-tab="project"]');
    if (firstNav) firstNav.classList.add('bg-slate-800');
  }

  function initLangSelect() {
    const sel = document.getElementById('lang-select');
    if (!sel) return;
    const options = [
      { value: 'zh-TW', label: '繁體中文' },
      { value: 'en', label: 'English' }
    ];
    sel.innerHTML = '';
    options.forEach(opt => {
      const o = document.createElement('option');
      o.value = opt.value;
      o.textContent = opt.label;
      sel.appendChild(o);
    });
    sel.value = state.lang || 'zh-TW';
    sel.addEventListener('change', () => {
      state.lang = sel.value;
      scheduleSaveState();
    });
  }

  function initJournalSelect() {
    const sel = document.getElementById('journal-select');
    if (!sel) return;
    sel.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = '請選擇目標期刊';
    sel.appendChild(placeholder);

    Object.entries(state.journalProfiles || {}).forEach(([key, jp]) => {
      const o = document.createElement('option');
      o.value = key;
      o.textContent = `${jp.name} (${jp.abbr})`;
      sel.appendChild(o);
    });

    if (state.projectMeta.journalKey) {
      sel.value = state.projectMeta.journalKey;
      updateJournalProfile();
    }
  }

  function initChecklist() {
    const checklist = document.getElementById('chapter-checklist');
    if (!checklist) return;
    // 動態依章節切換的 checklist 在 switchChapter() 裡更新
    updateChecklistForChapter(state.currentChapter || 'outline');
  }

  function switchTab(tabId) {
    state.currentTab = tabId;
    const tabs = ['project', 'design', 'literature', 'data', 'writing', 'submission'];
    tabs.forEach(id => {
      const el = document.getElementById('tab-' + id);
      if (el) el.classList.toggle('hidden', id !== tabId);
    });
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.classList.toggle('bg-slate-800', btn.dataset.tab === tabId);
    });

    const title = document.getElementById('main-title');
    const subtitle = document.getElementById('main-subtitle');
    if (!title || !subtitle) return;

    const map = {
      project: ['專案＆期刊設定', '從期刊開始，決定整篇論文的遊戲規則。'],
      design: ['研究設計', '在此整理研究問題、假設、變項與分析方法。'],
      literature: ['文獻＆引用管理', '所有引用一律來自上傳之文獻池（referencePool）。'],
      data: ['數據＆分析', '整理統計結果，準備撰寫結果與討論。'],
      writing: ['寫作＆Reviewer', '分章撰寫，並由 AI 協助檢視與評論。'],
      submission: ['投稿包', '將稿件、cover letter 與回覆信整合成投稿套餐。']
    };
    if (map[tabId]) {
      title.textContent = map[tabId][0];
      subtitle.textContent = map[tabId][1];
    }
  }

  /**********************
   * 章節切換與字數計算 *
   **********************/

  state.currentChapter = 'outline';

  function switchChapter() {
    const sel = document.getElementById('chapter-select');
    if (!sel) return;
    const chapterKey = sel.value;
    state.currentChapter = chapterKey;

    const editors = document.querySelectorAll('.chapter-editor');
    editors.forEach(ed => {
      const isCurrent = ed.dataset.chapter === chapterKey;
      ed.classList.toggle('hidden', !isCurrent);
      if (isCurrent) {
        ed.value = state.chapters[chapterKey] || '';
      }
    });

    const label = document.getElementById('current-chapter-label');
    if (label) {
      label.textContent = sel.options[sel.selectedIndex].textContent || chapterKey;
    }
    updateChecklistForChapter(chapterKey);
    updateWordCounts();
  }

  function onChapterInput(chapterKey, text) {
    state.chapters[chapterKey] = text;
    updateWordCounts();
    scheduleSaveState();
  }

  function getCurrentEditor() {
    return document.querySelector('.chapter-editor[data-chapter="' + state.currentChapter + '"]');
  }

  function getWordStats(text) {
    if (!text) return { cjkChars: 0, enWords: 0, total: 0 };
    const trimmed = text.trim();
    if (!trimmed) return { cjkChars: 0, enWords: 0, total: 0 };

    const rawTokens = trimmed.split(/\s+/).filter(Boolean);
    let cjkChars = 0;
    let enWords = 0;

    rawTokens.forEach(tok => {
      const cjkMatches = tok.match(/[\u4e00-\u9fff]/g);
      if (cjkMatches && cjkMatches.length > 0) {
        cjkChars += cjkMatches.length;
      } else {
        // 非 CJK token 當作 1 個英文單字
        enWords += 1;
      }
    });

    return {
      cjkChars,
      enWords,
      total: cjkChars + enWords
    };
  }

  function countWords(text) {
    return getWordStats(text).total;
  }

  function updateWordCounts() {
    const chapterText = state.chapters[state.currentChapter] || '';
    const chapterStats = getWordStats(chapterText);

    let totalStats = { cjkChars: 0, enWords: 0, total: 0 };
    Object.values(state.chapters).forEach(t => {
      const stats = getWordStats(t || '');
      totalStats.cjkChars += stats.cjkChars;
      totalStats.enWords += stats.enWords;
      totalStats.total += stats.total;
    });

    const chapterSpan = document.getElementById('chapter-word-count');
    const totalSpan = document.getElementById('total-word-count');
    if (chapterSpan) {
      chapterSpan.textContent =
        `本章字數：約 ${chapterStats.total}（中：${chapterStats.cjkChars} 字 / 英：${chapterStats.enWords} words）`;
    }
    if (totalSpan) {
      totalSpan.textContent =
        `全文字數：約 ${totalStats.total}（中：${totalStats.cjkChars} 字 / 英：${totalStats.enWords} words）`;
    }
  }

  /**********************
   * 專案與期刊設定     *
   **********************/

  state.journalProfiles = {
    taper: {
      name: 'Asia-Pacific Education Researcher',
      abbr: 'TAPER',
      scope: 'Education · Asia-Pacific · empirical and theoretical studies',
      wordLimit: '約 8,000–10,000 英文字',
      style: 'APA 7th edition',
      note: '偏向實證研究與區域性教育議題。'
    },
    se: {
      name: 'Science Education',
      abbr: 'SciEd',
      scope: 'Science education · conceptual and empirical research',
      wordLimit: '約 10,000 英文字以內',
      style: 'APA 7th edition',
      note: '高度理論整合與方法論嚴謹度要求。'
    }
  };

  function updateProjectMeta() {
    const title = document.getElementById('project-title')?.value || '';
    const field = document.getElementById('project-field')?.value || '';
    const year = document.getElementById('project-year')?.value || '';

    state.projectMeta.title = title;
    state.projectMeta.field = field;
    state.projectMeta.year = year || '2025';

    const sidebarName = document.getElementById('sidebar-project-name');
    if (sidebarName) sidebarName.textContent = title || '未命名專案';

    const meta = document.getElementById('user-meta');
    if (meta) {
      meta.textContent = field && year
        ? field + ' · Target ' + year
        : 'Local project · Auto-save';
    }
  }

  function updateJournalProfile() {
    const sel = document.getElementById('journal-select');
    if (!sel) return;
    const key = sel.value;
    state.projectMeta.journalKey = key;
    const profile = state.journalProfiles[key];
    const box = document.getElementById('journal-profile-summary');
    if (!box) return;

    const sidebarJournal = document.getElementById('sidebar-journal');
    if (sidebarJournal) {
      sidebarJournal.textContent = profile ? profile.name : '未設定';
    }

    if (!profile) {
      box.innerHTML = '<p class="text-slate-500">尚未選擇期刊。</p>';
      return;
    }

    box.innerHTML = `
      <div><span class="text-slate-400">期刊名稱：</span><span class="font-semibold">${profile.name} (${profile.abbr})</span></div>
      <div><span class="text-slate-400">範疇：</span><span>${profile.scope}</span></div>
      <div><span class="text-slate-400">字數限制：</span><span>${profile.wordLimit}</span></div>
      <div><span class="text-slate-400">寫作體例：</span><span>${profile.style}</span></div>
      <div><span class="text-slate-400">備註：</span><span>${profile.note}</span></div>
    `;
  }

  function updateStylePreset() {
    const sel = document.getElementById('style-preset');
    if (!sel) return;
    state.stylePreset = sel.value;
    scheduleSaveState();
  }

  /**********************
   * 研究設計 / RQ / H *
   **********************/

  function updateResearchDesign() {
    state.design.type = document.getElementById('design-type').value || '';
    state.design.context = document.getElementById('design-context').value || '';
    state.design.sample = document.getElementById('design-sample').value || '';
    state.design.instruments = document.getElementById('design-instruments').value || '';
    state.design.iv = document.getElementById('design-iv').value || '';
    state.design.dv = document.getElementById('design-dv').value || '';
    state.design.medmod = document.getElementById('design-medmod').value || '';
    renderAnalysisPlan();
    renderAnalysisPlanData();
  }

  function addRQ() {
    const id = 'RQ' + (state.rqs.length + 1);
    state.rqs.push({ id, text: '' });
    renderRQList();
    renderAnalysisPlan();
    renderAnalysisPlanData();
    scheduleSaveState();
  }

  function updateRQText(id, text) {
    const rq = state.rqs.find(r => r.id === id);
    if (rq) rq.text = text;
    scheduleSaveState();
  }

  function removeRQ(id) {
    state.rqs = state.rqs.filter(r => r.id !== id);
    delete state.analysisPlan[id];
    renderRQList();
    renderAnalysisPlan();
    renderAnalysisPlanData();
    scheduleSaveState();
  }

  function renderRQList() {
    const list = document.getElementById('rq-list');
    if (!list) return;
    list.innerHTML = '';
    if (!state.rqs.length) {
      list.innerHTML = '<p class="text-[11px] text-slate-400">尚未新增 RQ。</p>';
      return;
    }
    state.rqs.forEach(rq => {
      const div = document.createElement('div');
      div.className = 'border border-slate-200 rounded p-1.5 bg-white';
      div.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="text-slate-500 font-semibold">${rq.id}</span>
          <button class="text-[10px] text-rose-500 hover:underline" onclick="removeRQ('${rq.id}')">
            刪除
          </button>
        </div>
        <textarea class="w-full border border-slate-300 rounded px-1 py-0.5 text-[11px]" rows="2"
          placeholder="撰寫研究問題"
          oninput="updateRQText('${rq.id}', this.value)">${escapeHtml(rq.text || '')}</textarea>
      `;
      list.appendChild(div);
    });
  }

  function addHypothesis() {
    const id = 'H' + (state.hypotheses.length + 1);
    state.hypotheses.push({ id, text: '' });
    renderHypothesisList();
    scheduleSaveState();
  }

  function updateHypothesisText(id, text) {
    const h = state.hypotheses.find(x => x.id === id);
    if (h) h.text = text;
    scheduleSaveState();
  }

  function removeHypothesis(id) {
    state.hypotheses = state.hypotheses.filter(h => h.id !== id);
    renderHypothesisList();
    scheduleSaveState();
  }

  function renderHypothesisList() {
    const list = document.getElementById('hypo-list');
    if (!list) return;
    list.innerHTML = '';
    if (!state.hypotheses.length) {
      list.innerHTML = '<p class="text-[11px] text-slate-400">尚未新增假設。</p>';
      return;
    }
    state.hypotheses.forEach(h => {
      const div = document.createElement('div');
      div.className = 'border border-slate-200 rounded p-1.5 bg-white';
      div.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="text-slate-500 font-semibold">${h.id}</span>
          <button class="text-[10px] text-rose-500 hover:underline" onclick="removeHypothesis('${h.id}')">
            刪除
          </button>
        </div>
        <textarea class="w-full border border-slate-300 rounded px-1 py-0.5 text-[11px]" rows="2"
          placeholder="撰寫研究假設"
          oninput="updateHypothesisText('${h.id}', this.value)">${escapeHtml(h.text || '')}</textarea>
      `;
      list.appendChild(div);
    });
  }

  function setAnalysisMethod(rqId, method) {
    if (!state.analysisPlan[rqId]) state.analysisPlan[rqId] = {};
    state.analysisPlan[rqId].method = method;
    renderAnalysisPlanData();
    scheduleSaveState();
  }

  function setAnalysisNote(rqId, note) {
    if (!state.analysisPlan[rqId]) state.analysisPlan[rqId] = {};
    state.analysisPlan[rqId].note = note;
    scheduleSaveState();
  }

  function renderAnalysisPlan() {
    const box = document.getElementById('analysis-plan');
    if (!box) return;
    box.innerHTML = '';
    if (!state.rqs.length) {
      box.innerHTML = '<p class="text-[11px] text-slate-400">尚未設定 RQ，無法建立分析對應。</p>';
      return;
    }
    state.rqs.forEach(rq => {
      const plan = state.analysisPlan[rq.id] || {};
      const div = document.createElement('div');
      div.className = 'border border-slate-200 rounded p-2 bg-white';
      div.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="text-slate-600 font-semibold">${rq.id}</span>
          <span class="text-[10px] text-slate-400">主要分析方法</span>
        </div>
        <div class="flex items-center gap-2 mb-1">
          <select class="px-2 py-1 rounded border border-slate-300 text-[11px]"
                  onchange="setAnalysisMethod('${rq.id}', this.value)">
            <option value="">未指定</option>
            <option value="t-test" ${plan.method==='t-test'?'selected':''}>t-test</option>
            <option value="ANOVA" ${plan.method==='ANOVA'?'selected':''}>ANOVA / ANCOVA</option>
            <option value="MLR" ${plan.method==='MLR'?'selected':''}>多元迴歸 (MLR)</option>
            <option value="SEM" ${plan.method==='SEM'?'selected':''}>結構方程 (SEM)</option>
            <option value="LMM" ${plan.method==='LMM'?'selected':''}>線性混合模式 (LMM)</option>
            <option value="LCA" ${plan.method==='LCA'?'selected':''}>潛在類別分析 (LCA)</option>
            <option value="Qual" ${plan.method==='Qual'?'selected':''}>質性主題分析</option>
          </select>
        </div>
        <textarea class="w-full border border-slate-300 rounded px-1 py-0.5 text-[11px]" rows="2"
          placeholder="補充：主要 DV / 統計控制變項 / 重要備註"
          oninput="setAnalysisNote('${rq.id}', this.value)">${escapeHtml(plan.note || '')}</textarea>
      `;
      box.appendChild(div);
    });
  }

  function renderAnalysisPlanData() {
    const box = document.getElementById('analysis-plan-data');
    if (!box) return;
    box.innerHTML = '';
    if (!state.rqs.length) {
      box.innerHTML = '<p class="text-[11px] text-slate-400">尚未設定 RQ。</p>';
      return;
    }
    state.rqs.forEach(rq => {
      const plan = state.analysisPlan[rq.id] || {};
      const div = document.createElement('div');
      div.className = 'border border-slate-200 rounded p-2 bg-white';
      div.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="font-semibold text-slate-700">${rq.id}</span>
          <span class="text-[10px] text-slate-400">${plan.method || '分析方法未設定'}</span>
        </div>
        <p class="text-[11px] text-slate-600 mb-1">${escapeHtml(rq.text || '尚未撰寫 RQ 內容')}</p>
        <p class="text-[10px] text-slate-500">
          ${plan.note ? escapeHtml(plan.note) : '尚未補充分析備註。'}
        </p>
      `;
      box.appendChild(div);
    });
  }

  /**********************
   * 文獻庫 referencePool
   **********************/

  function handleLiteratureUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    state.litFilesMeta.sourceFileName = file.name;
    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet);

      const pool = [];
      rows.forEach((row, idx) => {
        const authorsRaw =
          row.Author ||
          row.Authors ||
          row['Authors'] ||
          row.AU ||
          row['AU'] ||
          '';
        const yearRaw =
          row.Year ||
          row.PY ||
          row['PY'] ||
          '';
        const titleRaw =
          row.Title ||
          row['Article Title'] ||
          row['Document Title'] ||
          row.TI ||
          row['TI'] ||
          '';
        const journalRaw =
          row.Journal ||
          row['Source Title'] ||
          row['Journal Name'] ||
          row.SO ||
          row['SO'] ||
          '';
        const doiRaw =
          row.DOI ||
          row.Doi ||
          row['DOI'] ||
          row.DI ||
          row['DI'] ||
          '';

        const authors = (authorsRaw || '').toString().trim();
        const year = (yearRaw || '').toString().trim();
        const title = (titleRaw || '').toString().trim();
        const journal = (journalRaw || '').toString().trim();
        const doi = (doiRaw || '').toString().trim();

        if (!authors && !year && !title && !journal) {
          console.warn('文獻第 ' + (idx+1) + ' 筆欄位皆為空，已略過。');
          return;
        }

        pool.push({
          id: 'ref-' + (idx + 1),
          authors,
          year,
          title,
          journal,
          doi
        });
      });

      state.referencePool = pool;
      const litCount = document.getElementById('lit-count');
      if (litCount) litCount.textContent = state.referencePool.length;

      renderLiteratureList();
      renderLiteraturePreview();
      scheduleSaveState();
    };
    reader.readAsArrayBuffer(file);
  }

  function renderLiteratureList() {
    const box = document.getElementById('lit-list');
    const input = document.getElementById('lit-search');
    if (!box) return;
    const keyword = (input?.value || '').toLowerCase();

    box.innerHTML = '';
    if (!state.referencePool.length) {
      box.innerHTML = '<p class="text-slate-400 text-[11px]">尚未上傳文獻庫。</p>';
      return;
    }

    state.referencePool
      .filter(ref => {
        if (!keyword) return true;
        const s = (ref.authors + ' ' + ref.title + ' ' + ref.journal).toLowerCase();
        return s.includes(keyword);
      })
      .slice(0, 50)
      .forEach(ref => {
        const div = document.createElement('div');
        div.className = 'flex items-start justify-between gap-2 py-1 border-b border-slate-200/70';
        div.innerHTML = `
          <div class="flex-1">
            <div class="font-semibold text-[11px]">${escapeHtml(ref.authors || 'Unknown')} (${escapeHtml(ref.year || 'n.d.')})</div>
            <div class="text-[10px] text-slate-600">${escapeHtml(ref.title || '')}</div>
            <div class="text-[10px] text-slate-400 italic">${escapeHtml(ref.journal || '')}</div>
          </div>
          <button class="px-2 py-1 rounded bg-emerald-600 text-white text-[10px] hover:bg-emerald-700"
                  onclick="insertCitation('${ref.id}')">
            插入
          </button>
        `;
        box.appendChild(div);
      });
  }

  function renderLiteraturePreview() {
    const body = document.getElementById('lit-preview-body');
    if (!body) return;
    body.innerHTML = '';
    state.referencePool.slice(0, 20).forEach((ref, idx) => {
      const tr = document.createElement('tr');
      tr.className = idx % 2 === 0 ? 'bg-white' : 'bg-slate-50/60';
      tr.innerHTML = `
        <td class="px-2 py-1">${idx + 1}</td>
        <td class="px-2 py-1">${escapeHtml(ref.authors || '')}</td>
        <td class="px-2 py-1">${escapeHtml(ref.year || '')}</td>
        <td class="px-2 py-1">${escapeHtml(ref.title || '')}</td>
        <td class="px-2 py-1">${escapeHtml(ref.journal || '')}</td>
      `;
      body.appendChild(tr);
    });
  }

  async function syncLiteratureToBackend() {
    if (!state.referencePool.length) {
      alert('請先上傳文獻庫（referencePool）。');
      return;
    }
    const result = await callBackend('/syncReferences', {
      projectId: state.projectId,
      referencePool: state.referencePool
    });
    if (!result.ok) {
      alert('同步到後端失敗：' + (result.error || '未知錯誤'));
      return;
    }
    alert(result.data.message || '文獻庫已送出後端處理。');
  }

  /**********************
   * 引文插入與 References
   **********************/

  function insertCitation(refId) {
    const ref = state.referencePool.find(r => r.id === refId);
    if (!ref) {
      alert('此文獻不在 referencePool 中，禁止引用。');
      return;
    }
    const editor = getCurrentEditor();
    if (!editor) {
      alert('找不到目前章節的編輯器。');
      return;
    }

    // 取第一位作者姓氏＋年份，APA 形式 (Author, Year)
    let firstAuthorRaw = (ref.authors || '').split(/[;&|]/)[0] || ref.authors || '';
    firstAuthorRaw = firstAuthorRaw.trim();

    let authorSurname = firstAuthorRaw;
    if (firstAuthorRaw.includes(',')) {
      authorSurname = firstAuthorRaw.split(',')[0].trim();
    } else {
      const parts = firstAuthorRaw.split(/\s+/).filter(Boolean);
      if (parts.length > 1) {
        authorSurname = parts[parts.length - 1];
      }
    }

    const yearStr = (ref.year || '').toString();
    const yearMatch = yearStr.match(/\d{4}[a-z]?/i);
    const year = yearMatch ? yearMatch[0] : (yearStr || 'n.d.');

    const citationText = `(${authorSurname}, ${year})`;

    const start = editor.selectionStart ?? editor.value.length;
    const end = editor.selectionEnd ?? editor.value.length;
    const value = editor.value || '';

    editor.value = value.slice(0, start) + citationText + value.slice(end);
    editor.focus();
    const pos = start + citationText.length;
    editor.selectionStart = editor.selectionEnd = pos;

    const chapterKey = state.currentChapter;
    state.chapters[chapterKey] = editor.value;
    updateWordCounts();
    scheduleSaveState();

    state.usedCitationIds.add(ref.id);
  }

  function extractAPACitations(text) {
    const regex = /\(([A-Z][A-Za-z\-]+(?:\s+(?:et al\.|&\s+[A-Z][A-Za-z\-]+))?),\s*(\d{4}[a-z]?)\)/g;
    const result = [];
    let match;
    while ((match = regex.exec(text)) !== null) {
      result.push({
        author: match[1],
        year: match[2]
      });
    }
    return result;
  }

  function normalizeName(name) {
    return (name || '')
      .toLowerCase()
      .replace(/[^a-z\u4e00-\u9fff]/g, '');
  }

  function findRefByAuthorYear(author, year) {
    const targetLast = normalizeName((author.split(/[,\s]/)[0] || author));
    return state.referencePool.find(ref => {
      const firstAuthor = (ref.authors || '').split(/[;&]/)[0] || ref.authors || '';
      let refSurname = firstAuthor.trim();
      if (refSurname.includes(',')) {
        refSurname = refSurname.split(',')[0].trim();
      } else {
        const parts = refSurname.split(/\s+/).filter(Boolean);
        if (parts.length > 1) {
          refSurname = parts[parts.length - 1];
        }
      }
      const refLast = normalizeName(refSurname);
      const refYear = (ref.year || '').toString();
      return refLast && refLast === targetLast && (!year || refYear.startsWith(year));
    }) || null;
  }

  function formatReferenceAPA(ref) {
    const authors = ref.authors || '';
    const yearStr = (ref.year || '').toString();
    const yearMatch = yearStr.match(/\d{4}[a-z]?/i);
    const year = yearMatch ? yearMatch[0] : (yearStr || 'n.d.');
    const title = ref.title || '';
    const journal = ref.journal || '';
    const doi = ref.doi
      ? 'https://doi.org/' + ref.doi.replace(/^https?:\/\/(doi\.org\/)?/i, '').trim()
      : '';
    let line = `${authors} (${year}). ${title}. ${journal}.`;
    if (doi) line += ' ' + doi;
    return line;
  }

  function scanAllCitationsAndUpdateUsed() {
    const unmatched = [];
    const matchedIds = new Set();

    Object.entries(state.chapters).forEach(([chapterKey, text]) => {
      if (!text) return;
      const citations = extractAPACitations(text);
      citations.forEach(cit => {
        const ref = findRefByAuthorYear(cit.author, cit.year);
        if (ref) {
          matchedIds.add(ref.id);
        } else {
          unmatched.push({
            chapterKey,
            rawAuthor: cit.author,
            year: cit.year
          });
        }
      });
    });

    state.usedCitationIds = matchedIds;
    return { matchedIds, unmatched };
  }

  function generateReferencesSection() {
    if (!state.referencePool.length) {
      alert('請先上傳文獻庫（referencePool）。');
      return;
    }

    const report = scanAllCitationsAndUpdateUsed();
    if (!report.matchedIds.size) {
      alert('尚未偵測到任何符合 APA 格式且存在於 referencePool 的引文。');
      return;
    }

    const refs = state.referencePool.filter(ref => report.matchedIds.has(ref.id));
    refs.sort((a, b) => {
      const aKey = (a.authors || '') + (a.year || '');
      const bKey = (b.authors || '') + (b.year || '');
      return aKey.localeCompare(bKey);
    });

    const lines = refs.map(formatReferenceAPA);
    const sectionText = 'References\n' + lines.join('\n');

    const fullEditor = document.querySelector('.chapter-editor[data-chapter="fullpaper"]');
    if (!fullEditor) {
      console.log(sectionText);
      alert('找不到「全文整合」章節編輯器，已在 console 中輸出 References。');
      return;
    }

    const current = fullEditor.value || '';
    const withoutOld = current.replace(/\s*References[\s\S]*$/i, '').trimEnd();
    fullEditor.value = (withoutOld ? withoutOld + '\n\n' : '') + sectionText;
    state.chapters.fullpaper = fullEditor.value;
    updateWordCounts();
    scheduleSaveState();

    if (report.unmatched.length) {
      const sample = report.unmatched.slice(0, 5).map(u =>
        `${u.chapterKey}: (${u.rawAuthor}, ${u.year})`
      ).join('\n');
      alert(
        '已忽略 ' + report.unmatched.length +
        ' 筆不在 referencePool 的引文，未納入 References。\n\n前幾筆範例：\n' +
        sample
      );
    } else {
      alert('已依照實際引用，從 referencePool 產生 References 區段。');
    }
  }

  /**********************
   * Data / 結果草稿    *
   **********************/

  function handleDataRawUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    state.dataMeta.rawFileName = file.name;
    scheduleSaveState();
  }

  function handleDataOutputUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    state.dataMeta.outputFileName = file.name;
    scheduleSaveState();
  }

  function updateDataMeta() {
    state.dataMeta.notes = document.getElementById('data-notes').value || '';
  }

  async function generateResultsDraft() {
    const chapterKey = 'results';
    const existing = state.chapters[chapterKey] || '';
    const payload = {
      projectId: state.projectId,
      lang: state.lang,
      stylePreset: state.stylePreset,
      projectMeta: state.projectMeta,
      design: state.design,
      rqs: state.rqs,
      analysisPlan: state.analysisPlan,
      dataMeta: state.dataMeta,
      chapterKey,
      chapterText: existing
    };
    appendChatSystem('[結果草稿] 正在呼叫後端生成結果章節草稿…');
    const res = await callBackend('/resultsDraft', payload);
    if (!res.ok) {
      appendChatSystem('[結果草稿] 生成失敗：' + (res.error || '未知錯誤'));
      alert('生成結果草稿失敗：' + (res.error || '未知錯誤'));
      return;
    }
    const text = res.data.text || '';
    state.chapters[chapterKey] = text;
    if (state.currentChapter === chapterKey) {
      const editor = getCurrentEditor();
      if (editor) editor.value = text;
    }
    updateWordCounts();
    scheduleSaveState();
    appendChatSystem('[結果草稿] 已更新結果章節內容。');
  }

  /**********************
   * AI 寫作 / Reviewer *
   **********************/

  function updateChecklistForChapter(chapterKey) {
    const checklist = document.getElementById('chapter-checklist');
    if (!checklist) return;
    let items = [];
    switch (chapterKey) {
      case 'intro':
        items = [
          '是否清楚說明研究背景與研究動機？',
          '是否界定研究問題與研究目的？',
          '是否交代理論與實證缺口（research gap）？'
        ];
        break;
      case 'lit_review':
        items = [
          '是否整合而非逐篇摘要文獻？',
          '是否涵蓋近五年核心 SSCI 文獻？',
          '是否清楚連結到研究問題與假設？'
        ];
        break;
      case 'method':
        items = [
          '研究設計、對象、工具、程序是否交代完整？',
          '統計方法是否與 RQ / 假設一致？',
          '是否說明信效度與研究倫理？'
        ];
        break;
      case 'results':
        items = [
          '是否依 RQ 順序呈現結果？',
          '是否區分描述統計與推論統計？',
          '表格與文字敘述是否一致，避免重複？'
        ];
        break;
      case 'discussion':
        items = [
          '是否回到研究問題與理論架構進行討論？',
          '是否連結既有文獻，說明相同或相異之處？',
          '是否避免只重述結果，而有真正的解釋？'
        ];
        break;
      default:
        items = [
          '本章是否清楚回應研究問題與目的？',
          '是否適當整合文獻並避免大段抄寫？',
          '是否有清楚標示與 APA 7th 一致的引文？'
        ];
    }
    checklist.innerHTML = `
      <div class="flex items-center justify-between mb-1">
        <span>本章寫作重點快速檢核</span>
      </div>
      <ul class="space-y-1">
        ${items.map((txt, i) => `
          <li class="flex items-start gap-2">
            <span class="mt-0.5 w-1.5 h-1.5 rounded-full ${
              i===0 ? 'bg-emerald-500' : i===1 ? 'bg-indigo-500' : 'bg-amber-500'
            }"></span>
            <span>${txt}</span>
          </li>
        `).join('')}
      </ul>
    `;
  }

  function appendChatSystem(text) {
    const panel = document.getElementById('chat-panel');
    if (!panel) return;
    const div = document.createElement('div');
    div.className = 'bg-slate-100 border border-slate-200 rounded px-2 py-1 text-[11px] text-slate-700';
    div.textContent = text;
    panel.appendChild(div);
    panel.scrollTop = panel.scrollHeight;
  }

  function appendChatAI(text) {
    const panel = document.getElementById('chat-panel');
    if (!panel) return;
    const div = document.createElement('div');
    div.className = 'bg-white border border-indigo-200 rounded px-2 py-1 text-[11px]';
    div.textContent = text;
    panel.appendChild(div);
    panel.scrollTop = panel.scrollHeight;
  }

  function appendChatUser(text) {
    const panel = document.getElementById('chat-panel');
    if (!panel) return;
    const div = document.createElement('div');
    div.className = 'bg-indigo-600 text-white rounded px-2 py-1 text-[11px] ml-4';
    div.textContent = text;
    panel.appendChild(div);
    panel.scrollTop = panel.scrollHeight;
  }

  async function generateChapterDraft() {
    const chapterKey = state.currentChapter;
    const existing = state.chapters[chapterKey] || '';
    appendChatSystem(`[${chapterKey}] 正在呼叫後端生成本章草稿…`);

    const payload = {
      projectId: state.projectId,
      lang: state.lang,
      stylePreset: state.stylePreset,
      projectMeta: state.projectMeta,
      design: state.design,
      rqs: state.rqs,
      hypotheses: state.hypotheses,
      analysisPlan: state.analysisPlan,
      chapterKey,
      chapterText: existing
    };
    const res = await callBackend('/generateChapter', payload);
    if (!res.ok) {
      appendChatSystem('生成本章草稿失敗：' + (res.error || '未知錯誤'));
      alert('生成本章草稿失敗：' + (res.error || '未知錯誤'));
      return;
    }
    const text = res.data.text || '';
    state.chapters[chapterKey] = text;
    if (state.currentChapter === chapterKey) {
      const editor = getCurrentEditor();
      if (editor) editor.value = text;
    }
    updateWordCounts();
    scheduleSaveState();
    appendChatAI('本章草稿已更新於編輯區，請進一步人工調整。');
  }

  async function runReviewerMode() {
    const chapterKey = state.currentChapter;
    const text = state.chapters[chapterKey] || '';
    if (!text.trim()) {
      alert('本章尚無內容，無法進行 Reviewer 模式。');
      return;
    }
    appendChatSystem(`[${chapterKey}] 正在呼叫 Reviewer 模式進行批改與評論…`);

    const payload = {
      projectId: state.projectId,
      lang: state.lang,
      stylePreset: state.stylePreset,
      projectMeta: state.projectMeta,
      design: state.design,
      rqs: state.rqs,
      hypotheses: state.hypotheses,
      analysisPlan: state.analysisPlan,
      chapterKey,
      chapterText: text
    };
    const res = await callBackend('/reviewChapter', payload);
    if (!res.ok) {
      appendChatSystem('Reviewer 模式失敗：' + (res.error || '未知錯誤'));
      alert('Reviewer 模式失敗：' + (res.error || '未知錯誤'));
      return;
    }
    const data = res.data || {};
    if (data.summary) appendChatAI('總評：' + data.summary);
    if (Array.isArray(data.comments)) {
      data.comments.forEach(c => appendChatAI(c));
    }
  }

  async function runAutoCitationForCurrentChapter() {
    if (!state.referencePool.length) {
      alert('請先在「文獻＆引用」頁上傳文獻庫（referencePool）。');
      return;
    }
    const chapterKey = state.currentChapter;
    const text = state.chapters[chapterKey] || '';
    if (!text.trim()) {
      alert('本章尚未有文字內容。');
      return;
    }
    appendChatSystem(`[${chapterKey}] 正在呼叫後端進行自動配文獻…`);

    const payload = {
      projectId: state.projectId,
      lang: state.lang,
      chapterKey,
      chapterText: text,
      referencePool: state.referencePool
    };
    const res = await callBackend('/autoCiteChapter', payload);
    if (!res.ok) {
      appendChatSystem('AI 自動配文獻失敗：' + (res.error || '未知錯誤'));
      alert('AI 自動配文獻失敗：' + (res.error || '未知錯誤'));
      return;
    }
    const newText = res.data.text || '';
    state.chapters[chapterKey] = newText;
    if (state.currentChapter === chapterKey) {
      const editor = getCurrentEditor();
      if (editor) editor.value = newText;
    }
    updateWordCounts();
    scheduleSaveState();
    appendChatAI('已根據 referencePool 自動配文獻，請人工檢查 APA 格式與內容。');
  }

  async function sendAIMessage() {
    const input = document.getElementById('ai-input');
    const text = (input.value || '').trim();
    if (!text) {
      alert('請輸入指令，或直接使用「生成本章草稿」按鈕。');
      return;
    }
    appendChatUser(text);
    input.value = '';

    const chapterKey = state.currentChapter;
    const payload = {
      projectId: state.projectId,
      lang: state.lang,
      stylePreset: state.stylePreset,
      projectMeta: state.projectMeta,
      design: state.design,
      rqs: state.rqs,
      hypotheses: state.hypotheses,
      analysisPlan: state.analysisPlan,
      chapterKey,
      chapterText: state.chapters[chapterKey] || '',
      userInstruction: text
    };
    const res = await callBackend('/chapterChat', payload);
    if (!res.ok) {
      appendChatSystem('AI 回應失敗：' + (res.error || '未知錯誤'));
      return;
    }
    appendChatAI(res.data.reply || '[後端尚未實作 chapterChat 回應。]');
  }

  /**********************
   * 快照 / 版本管理     *
   **********************/

  function createSnapshot() {
    const ts = new Date();
    const id = 'snap-' + ts.getTime();
    const label = ts.toLocaleString('zh-TW');
    const snapshot = {
      id,
      label,
      createdAt: ts.toISOString(),
      chapters: Object.assign({}, state.chapters)
    };
    state.snapshots.unshift(snapshot);
    if (state.snapshots.length > 20) {
      state.snapshots.pop();
    }
    renderSnapshotList();
    scheduleSaveState();
    appendChatSystem('已儲存目前全文內容為快照：' + label);
  }

  function renderSnapshotList() {
    const box = document.getElementById('snapshot-list');
    if (!box) return;
    box.innerHTML = '';
    if (!state.snapshots.length) {
      box.innerHTML = '<p class="text-[10px] text-slate-400">尚未建立任何快照。</p>';
      return;
    }
    state.snapshots.forEach(snap => {
      const div = document.createElement('div');
      div.className = 'flex items-center justify-between';
      div.innerHTML = `
        <span class="truncate">${escapeHtml(snap.label)}</span>
        <button class="text-[10px] text-indigo-600 hover:underline ml-2"
                onclick="restoreSnapshot('${snap.id}')">
          載入
        </button>
      `;
      box.appendChild(div);
    });
  }

  function restoreSnapshot(id) {
    const snap = state.snapshots.find(s => s.id === id);
    if (!snap) return;
    if (!confirm('確定要以此快照覆蓋目前全文內容？此動作無法還原。')) return;
    state.chapters = Object.assign({}, snap.chapters);
    const editor = getCurrentEditor();
    if (editor) {
      editor.value = state.chapters[state.currentChapter] || '';
    }
    updateWordCounts();
    scheduleSaveState();
    appendChatSystem('已載入快照：' + snap.label);
  }

  /**********************
   * 期刊適配 / 品質檢查 *
   **********************/

  async function runManuscriptFitCheck() {
    const payload = {
      projectId: state.projectId,
      projectMeta: state.projectMeta,
      design: state.design,
      rqs: state.rqs,
      hypotheses: state.hypotheses,
      analysisPlan: state.analysisPlan,
      journalProfile: state.journalProfiles[state.projectMeta.journalKey] || null,
      chapters: state.chapters
    };
    const res = await callBackend('/fitCheck', payload);
    if (!res.ok) {
      alert('期刊適配檢查失敗：' + (res.error || '未知錯誤'));
      return;
    }
    const msg = res.data.summary || '已送出期刊適配檢查，請在後端實作詳細規則。';
    alert(msg);
  }

  async function runQualityCheck() {
    const payload = {
      projectId: state.projectId,
      projectMeta: state.projectMeta,
      design: state.design,
      chapters: state.chapters,
      lang: state.lang
    };
    const res = await callBackend('/qualityCheck', payload);
    if (!res.ok) {
      alert('品質＆倫理檢查失敗：' + (res.error || '未知錯誤'));
      return;
    }
    const msg = res.data.summary || '已送出品質＆倫理檢查，請在後端實作詳細規則。';
    alert(msg);
  }

  async function generateMethodDraft() {
    const existing = state.chapters.method || '';
    const payload = {
      projectId: state.projectId,
      lang: state.lang,
      stylePreset: state.stylePreset,
      projectMeta: state.projectMeta,
      design: state.design,
      rqs: state.rqs,
      hypotheses: state.hypotheses,
      analysisPlan: state.analysisPlan,
      chapterKey: 'method',
      chapterText: existing
    };
    appendChatSystem('[Method] 正在呼叫後端生成方法章節草稿…');
    const res = await callBackend('/methodDraft', payload);
    if (!res.ok) {
      appendChatSystem('方法章節草稿生成失敗：' + (res.error || '未知錯誤'));
      alert('方法章節草稿生成失敗：' + (res.error || '未知錯誤'));
      return;
    }
    const text = res.data.text || '';
    state.chapters.method = text;
    if (state.currentChapter === 'method') {
      const editor = getCurrentEditor();
      if (editor) editor.value = text;
    }
    updateWordCounts();
    scheduleSaveState();
    appendChatAI('方法章節草稿已更新於編輯區。');
  }

</script>

</body>
</html>
