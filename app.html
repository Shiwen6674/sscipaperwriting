<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScholarCraft | SSCI è«–æ–‡å¯«ä½œè¼”åŠ©å·¥å…·</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .serif-font { font-family: 'Noto Serif TC', serif; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        .editor-area:focus { outline: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Typography */
        .prose { max-width: none; color: #334155; }
        .prose h1 { font-size: 1.8em; font-weight: 800; margin-bottom: 0.5em; color: #0f172a; }
        .prose h2 { font-size: 1.4em; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.8em; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.3em; line-height: 1.3; }
        .prose h3 { font-size: 1.2em; font-weight: 600; margin-top: 1.2em; margin-bottom: 0.6em; color: #4338ca; line-height: 1.4; }
        .prose p { margin-bottom: 1.2em; line-height: 1.8; text-align: justify; letter-spacing: 0.02em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1.2em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1.2em; }
        .prose li { margin-bottom: 0.5em; line-height: 1.6; }
        .prose strong { color: #0f172a; font-weight: 600; }
        .prose em { font-style: italic; color: #475569; }
        .prose blockquote { border-left: 4px solid #6366f1; padding-left: 1em; margin-left: 0; color: #4b5563; font-style: italic; background: #f8fafc; padding: 0.5em 1em; border-radius: 0 0.5em 0.5em 0; margin-bottom: 1.2em; }
        
        /* Sub-menu transition */
        .submenu { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .submenu.open { max-height: 500px; }
        
        /* Active Nav State */
        .nav-active { background-color: #4f46e5; color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.5); }
        .sub-nav-active { color: #818cf8; font-weight: 600; border-left: 2px solid #818cf8; padding-left: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-20 transition-all flex-shrink-0">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-graduation-cap text-indigo-400"></i>
                ScholarCraft
            </h1>
            <p class="text-xs text-slate-400 mt-1">SSCI Q1 Writing Coach</p>
        </div>

        <div class="px-4 pt-4">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none">
                    <i class="fa-solid fa-globe text-slate-400 text-xs"></i>
                </div>
                <select id="global-lang-selector" onchange="changeUILanguage()" class="w-full bg-slate-800 text-xs text-slate-300 border border-slate-600 rounded px-2 py-1.5 pl-7 focus:outline-none focus:border-indigo-500 cursor-pointer appearance-none hover:bg-slate-700 transition-colors">
                    <option value="zh-TW">ç¹é«”ä¸­æ–‡ (Traditional Chinese)</option>
                    <option value="en-US">English (US)</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                    <i class="fa-solid fa-chevron-down text-slate-400 text-[10px]"></i>
                </div>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
            <!-- Step 1: Setup -->
            <button onclick="switchTab('setup')" id="nav-setup" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 transition-all flex items-center gap-3">
                <i class="fa-solid fa-chess-board w-5 text-center"></i> <span data-i18n="nav_setup">1. ç ”ç©¶ä¸»é¡Œè¨­å®š</span>
            </button>
            
            <!-- Step 2: Literature -->
            <button onclick="switchTab('literature')" id="nav-literature" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 transition-all flex items-center gap-3">
                <i class="fa-solid fa-book w-5 text-center"></i> <span data-i18n="nav_literature">2. æ–‡ç»è³‡æ–™è§£æ</span>
            </button>

            <!-- Step 3: Data Upload (NEW) -->
            <button onclick="switchTab('data')" id="nav-data" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 transition-all flex items-center gap-3">
                <i class="fa-solid fa-chart-bar w-5 text-center"></i> <span data-i18n="nav_data_upload">3. æ•¸æ“šè³‡æ–™ä¸Šå‚³</span>
            </button>

            <!-- Step 4: Writing (With Submenu) -->
            <div>
                <button onclick="toggleWritingMenu()" id="nav-write" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 transition-all flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-pen-nib w-5 text-center"></i> 
                        <span data-i18n="nav_write">4. AI è¼”åŠ©å¯«ä½œ</span>
                    </div>
                    <i id="write-chevron" class="fa-solid fa-chevron-down text-xs transition-transform duration-300"></i>
                </button>
                
                <!-- 10 Writing Chapters -->
                <div id="writing-submenu" class="submenu pl-11 pr-2 space-y-1 mt-1">
                    <button onclick="switchChapter('outline')" class="sub-nav-item w-full text-left py-2 text-xs text-slate-400 hover:text-white transition-colors" id="sub-outline">1. è¨è«–å¤§ç¶±</button>
                    <button onclick="switchChapter('intro')" class="sub-nav-item w-full text-left py-2 text-xs text-slate-400 hover:text-white transition-colors" id="sub-intro">2. ç·’è«–æ’°å¯«</button>
                    <button onclick="switchChapter('lit_review')" class="sub-nav-item w-full text-left py-2 text-xs text-slate-400 hover:text-white transition-colors" id="sub-lit_review">3. æ–‡ç»æ¢è¨</button>
                    <button onclick="switchChapter('method')" class="sub-nav-item w-full text-left py-2 text-xs text-slate-400 hover:text-white transition-colors" id="sub-method">4. ç ”ç©¶æ–¹æ³•</button>
                    <button onclick="switchChapter('findings')" class="sub-nav-item w-full text-left py-2 text-xs text-slate-400 hover:text-white transition-colors" id="sub-findings">5. ç ”ç©¶ç™¼ç¾</button>
                    <button onclick="switchChapter('discuss')" class="sub-nav-item w-full text-left py-2 text-xs text-slate-400 hover:text-white transition-colors" id="sub-discuss">6. è¨è«–</button>
                    <button onclick="switchChapter('conclusion')" class="sub-nav-item w-full text-left py-2 text-xs text-slate-400 hover:text-white transition-colors" id="sub-conclusion">7. çµè«–</button>
                    <button onclick="switchChapter('references')" class="sub-nav-item w-full text-left py-2 text-xs text-slate-400 hover:text-white transition-colors" id="sub-references">8. åƒè€ƒæ–‡ç»</button>
                    <button onclick="switchChapter('abstract')" class="sub-nav-item w-full text-left py-2 text-xs text-slate-400 hover:text-white transition-colors" id="sub-abstract">9. ä¸­è‹±æ–‡æ‘˜è¦</button>
                    <button onclick="switchChapter('full_paper')" class="sub-nav-item w-full text-left py-2 text-xs text-slate-400 hover:text-white transition-colors" id="sub-full_paper">10. å…¨æ–‡ç”¢å‡º</button>
                </div>
            </div>
        </nav>
        
        <div class="p-4 border-t border-slate-700">
            <div class="flex items-center gap-3 px-2">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center font-bold text-xs shadow-md">U</div>
                <div>
                    <p class="text-sm font-medium">Researcher</p>
                    <p class="text-xs text-slate-400">Connected</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 relative overflow-hidden flex flex-col">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-10">
            <h2 id="page-title" class="text-lg font-semibold text-slate-700" data-i18n="title_setup">ç ”ç©¶ä¸»é¡Œè¨­å®š</h2>
            <div class="flex gap-3">
                <span class="text-xs text-slate-400 flex items-center gap-1"><i class="fa-solid fa-circle text-green-500 text-[8px]"></i> System Ready</span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50 p-6 relative">
            
            <!-- VIEW 1: SETUP -->
            <div id="view-setup" class="max-w-4xl mx-auto space-y-6 animate-fade-in">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-5 mb-8 border-b border-slate-100 pb-6">
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl shadow-inner"><i class="fa-solid fa-sliders"></i></div>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800" data-i18n="setup_canvas_title">ç ”ç©¶è®Šé …ç•«å¸ƒ (Variable Canvas)</h3>
                            <p class="text-slate-500 text-sm mt-1" data-i18n="setup_canvas_desc">æ¸…æ™°å®šç¾©è®Šé …æ˜¯ SSCI é¡Œç›®çš„æ ¸å¿ƒã€‚</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-3">
                            <label class="text-sm font-bold text-slate-700 flex justify-between"><span data-i18n="setup_iv">è‡ªè®Šé … (IV)</span><span class="text-xs font-normal text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">Intervention</span></label>
                            <input type="text" id="iv-input" placeholder="e.g., Generative AI in PBL" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all outline-none text-slate-700">
                        </div>
                        <div class="space-y-3">
                            <label class="text-sm font-bold text-slate-700 flex justify-between"><span data-i18n="setup_dv">ä¾è®Šé … (DV)</span><span class="text-xs font-normal text-teal-600 bg-teal-50 px-2 py-0.5 rounded">Outcome</span></label>
                            <input type="text" id="dv-input" placeholder="e.g., Argumentation Quality" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all outline-none text-slate-700">
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-100">
                        <button onclick="toggleAdvancedVars()" class="flex items-center gap-2 text-sm text-indigo-600 font-semibold hover:text-indigo-800 transition-colors focus:outline-none">
                            <i id="adv-icon" class="fa-solid fa-chevron-right text-xs transition-transform"></i>
                            <span data-i18n="setup_advanced">é€²éšè®Šé …è¨­å®š (ä¸­ä»‹/èª¿ç¯€)</span>
                        </button>
                        
                        <div id="advanced-vars" class="hidden mt-4 pl-4 border-l-2 border-indigo-100 grid grid-cols-1 md:grid-cols-2 gap-6 transition-all">
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-600 uppercase tracking-wider"><span data-i18n="setup_mediator">ä¸­ä»‹è®Šé … (Mediator)</span></label>
                                <input type="text" id="mediator-input" placeholder="e.g., Learning Motivation" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:ring-1 focus:ring-indigo-500 transition-all outline-none text-sm text-slate-700">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-600 uppercase tracking-wider"><span data-i18n="setup_moderator">èª¿ç¯€è®Šé … (Moderator)</span></label>
                                <input type="text" id="moderator-input" placeholder="e.g., Gender, Prior Knowledge" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:ring-1 focus:ring-indigo-500 transition-all outline-none text-sm text-slate-700">
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 space-y-3">
                        <label class="text-sm font-bold text-slate-700" data-i18n="setup_topic">å®Œæ•´ç ”ç©¶ä¸»é¡Œ (Research Topic)</label>
                        <input type="text" id="topic-input" placeholder="e.g., Effectiveness of Digital Tools in Science Education" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all outline-none text-slate-700">
                    </div>
                </div>
                <div class="flex justify-end pt-4">
                    <button onclick="switchTab('literature')" class="group px-6 py-3 bg-slate-900 text-white rounded-xl hover:bg-indigo-600 transition-all shadow-lg font-medium flex items-center gap-2">
                        <span data-i18n="btn_next_data">ä¸‹ä¸€æ­¥ï¼šæ–‡ç»è³‡æ–™è§£æ</span> <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>

            <!-- VIEW 2: LITERATURE (æ–‡ç») -->
            <div id="view-literature" class="hidden max-w-6xl mx-auto space-y-6">
                <div class="bg-white p-10 rounded-2xl shadow-sm border border-slate-200 text-center transition-all">
                    <div id="upload-zone" class="border-2 border-dashed border-slate-300 rounded-xl p-12 hover:bg-indigo-50/50 hover:border-indigo-400 transition-all cursor-pointer group" onclick="document.getElementById('file-upload').click()">
                        <div class="w-16 h-16 bg-green-50 text-green-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-file-csv"></i></div>
                        <h3 class="text-xl font-bold text-slate-700 group-hover:text-indigo-700" data-i18n="data_upload_title">é»æ“Šä¸Šå‚³ WoS æ–‡ç»è³‡æ–™ (Excel/CSV)</h3>
                        <p class="text-slate-500 mt-3 max-w-md mx-auto" data-i18n="data_upload_desc">ç³»çµ±å°‡è‡ªå‹•è§£æï¼šAuthors, Year, Title, Journal, DOI, Abstract</p>
                        <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleFileUpload(event)">
                    </div>
                </div>
                
                <div class="flex justify-center">
                    <button onclick="generateLiteratureSummary()" class="flex items-center gap-2 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200 transition-all font-bold shadow-sm">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        <span data-i18n="btn_smart_summary">âœ¨ æ™ºæ…§æ–‡ç»æ‘˜è¦ (Smart Summary)</span>
                    </button>
                </div>

                <div id="data-preview-container" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[600px]">
                    <div class="p-4 border-b border-slate-200 bg-slate-50/50 flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-slate-700" data-i18n="data_preview_title">æ–‡ç»æ± é è¦½</h3>
                            <span class="text-xs font-mono bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full" id="record-count">0 records</span>
                        </div>
                        <span class="text-xs text-green-600 flex items-center gap-1"><i class="fa-solid fa-check-circle"></i> Cloud Synced</span>
                    </div>
                    <div class="overflow-auto custom-scrollbar flex-1">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 py-4 font-semibold w-10 text-center text-slate-400">No.</th>
                                    <th class="px-4 py-4 font-semibold min-w-[150px]">Authors</th>
                                    <th class="px-4 py-4 font-semibold w-16">Year</th>
                                    <th class="px-4 py-4 font-semibold min-w-[200px]">Title</th>
                                    <th class="px-4 py-4 font-semibold min-w-[150px] text-indigo-600">Journal</th>
                                    <th class="px-4 py-4 font-semibold w-24">Vol(Issue)</th>
                                    <th class="px-4 py-4 font-semibold w-24">Pages</th>
                                    <th class="px-4 py-4 font-semibold min-w-[150px]">DOI</th>
                                    <th class="px-4 py-4 font-semibold text-center w-20">Action</th>
                                </tr>
                            </thead>
                            <tbody id="literature-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
                <div class="flex justify-end pt-2">
                     <button onclick="switchTab('data')" class="group px-6 py-3 bg-slate-900 text-white rounded-xl hover:bg-indigo-600 transition-all shadow-lg font-medium flex items-center gap-2">
                        <span data-i18n="btn_next_data_upload">ä¸‹ä¸€æ­¥ï¼šæ•¸æ“šè³‡æ–™ä¸Šå‚³</span> <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>

            <!-- VIEW 3: DATA UPLOAD (New) -->
            <div id="view-data" class="hidden max-w-6xl mx-auto space-y-6 animate-fade-in">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-5 mb-6">
                        <div class="w-14 h-14 bg-teal-50 text-teal-600 rounded-2xl flex items-center justify-center text-2xl shadow-inner"><i class="fa-solid fa-chart-pie"></i></div>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800" data-i18n="data_upload_stat_title">é‡åŒ–/è³ªæ€§æ•¸æ“šä¸Šå‚³ (Data Upload)</h3>
                            <p class="text-slate-500 text-sm mt-1" data-i18n="data_upload_stat_desc">è«‹ä¸Šå‚³æ‚¨çš„ç ”ç©¶æ•¸æ“šï¼ŒAI å°‡å”åŠ©æ‚¨é€²è¡Œçµæœåˆ†æèˆ‡æ’°å¯«ã€‚</p>
                        </div>
                    </div>

                    <div class="border-2 border-dashed border-slate-300 rounded-xl p-12 flex flex-col items-center justify-center text-slate-500 hover:bg-teal-50/30 hover:border-teal-400 transition-all cursor-pointer group" onclick="alert('æ­¤åŠŸèƒ½éœ€é€£æ¥å¾Œç«¯å„²å­˜ç©ºé–“ (Google Drive API)ï¼Œç›®å‰ç‚ºæ¼”ç¤ºä»‹é¢ã€‚')">
                        <i class="fa-solid fa-cloud-arrow-up text-4xl mb-4 text-teal-500 group-hover:scale-110 transition-transform"></i>
                        <p class="font-bold text-lg text-slate-700">æ‹–æ”¾æª”æ¡ˆè‡³æ­¤ï¼Œæˆ–é»æ“Šä¸Šå‚³</p>
                        <p class="text-xs text-slate-400 mt-2">æ”¯æ´æ ¼å¼ï¼šExcel (.xlsx), SPSS (.sav), CSV (.csv)</p>
                    </div>

                    <div class="mt-6">
                        <h4 class="text-sm font-bold text-slate-700 mb-3">å·²ä¸Šå‚³æª”æ¡ˆ (Uploaded Files)</h4>
                        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 text-center text-sm text-slate-400 italic">
                            ç›®å‰å°šç„¡æª”æ¡ˆ (No files uploaded)
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-2">
                     <button onclick="switchTab('write')" class="group px-6 py-3 bg-slate-900 text-white rounded-xl hover:bg-indigo-600 transition-all shadow-lg font-medium flex items-center gap-2">
                        <span data-i18n="btn_next_write">ä¸‹ä¸€æ­¥ï¼šAI è¼”åŠ©å¯«ä½œ</span> <i class="fa-solid fa-pen-nib group-hover:rotate-12 transition-transform"></i>
                    </button>
                </div>
            </div>

            <!-- VIEW 4: WRITE (With 10 Chapters) -->
            <div id="view-write" class="hidden h-full flex flex-col animate-fade-in">
                <div class="flex gap-6 h-full pb-2">
                    
                    <!-- Left AI Panel (Coach) -->
                    <div class="w-[400px] flex flex-col glass-panel rounded-2xl shadow-sm overflow-hidden border border-indigo-100 shrink-0">
                        <div class="p-4 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white flex flex-col gap-3 shadow-md z-10">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-sm tracking-wide"><i class="fa-solid fa-robot mr-2"></i>SSCI AI Coach</span>
                                <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded text-white/90">Master Level</span>
                            </div>
                            
                            <!-- ç« ç¯€é¡¯ç¤º (Current Chapter Indicator) -->
                            <div class="bg-white/10 rounded-lg p-2 flex items-center justify-between text-xs">
                                <span>Current:</span>
                                <span id="current-chapter-display" class="font-bold text-amber-300">1. è¨è«–å¤§ç¶±</span>
                            </div>
                        </div>
                        
                        <div id="chat-history" class="flex-1 p-4 overflow-y-auto custom-scrollbar space-y-5 bg-slate-50/50">
                            <div class="flex gap-3 animate-fade-in">
                                <div class="w-8 h-8 rounded-full bg-white border border-indigo-100 text-indigo-600 flex-shrink-0 flex items-center justify-center shadow-sm"><i class="fa-solid fa-robot"></i></div>
                                <div class="bg-white p-3.5 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 border border-slate-100 leading-relaxed">
                                    <p data-i18n="ai_welcome">ä½ å¥½ï¼è«‹é¸æ“‡å·¦å´çš„å¯«ä½œç« ç¯€ (1-10)ï¼Œæˆ‘å°‡å¼•å°æ‚¨å®Œæˆè©²éƒ¨åˆ†çš„æ’°å¯«ã€‚</p>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-white border-t border-slate-100">
                            <div class="relative group">
                                <textarea id="ai-input" placeholder="è¼¸å…¥æŒ‡ä»¤æˆ–æŒ‰ Enter ç›´æ¥ç”Ÿæˆ..." class="w-full pl-4 pr-12 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none resize-none text-sm transition-all shadow-inner" rows="2" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); simulateAIGeneration(); }"></textarea>
                                <button onclick="simulateAIGeneration()" class="absolute right-2 bottom-2.5 p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 text-center flex items-center justify-center gap-1"><i class="fa-solid fa-bolt text-amber-400"></i> Powered by Gemini 2.0 Flash with RAG</p>
                        </div>
                    </div>

                    <!-- Right Panel: Editor -->
                    <div class="flex-1 flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-2 border-b border-slate-100 flex items-center gap-1 text-slate-600 bg-slate-50/50">
                            <button class="p-2 hover:bg-white hover:shadow-sm hover:text-indigo-600 rounded transition-all" title="Bold"><i class="fa-solid fa-bold"></i></button>
                            <button class="p-2 hover:bg-white hover:shadow-sm hover:text-indigo-600 rounded transition-all" title="Italic"><i class="fa-solid fa-italic"></i></button>
                            <button class="p-2 hover:bg-white hover:shadow-sm hover:text-indigo-600 rounded transition-all" title="List"><i class="fa-solid fa-list-ul"></i></button>
                            <div class="h-4 w-px bg-slate-300 mx-2"></div>
                            
                            <button onclick="polishStyle()" class="flex items-center gap-1 px-3 py-1 bg-purple-50 text-purple-600 text-xs rounded-full font-medium hover:bg-purple-100 transition-colors shadow-sm border border-purple-200 ml-2">
                                <i class="fa-solid fa-feather"></i> <span data-i18n="btn_polish_style">âœ¨ æ½¤é£¾</span>
                            </button>

                            <div class="flex-1"></div>
                            
                            <div class="flex items-center gap-3 px-2 text-xs font-mono bg-white border border-slate-200 rounded-md py-1 shadow-sm">
                                <span class="text-indigo-600 font-bold" id="phase-word-count">Phase: 0</span>
                                <span class="text-slate-300">|</span>
                                <span class="text-slate-600" id="total-word-count">Total: 0</span>
                            </div>
                            
                            <button class="ml-2 px-3 py-1 bg-indigo-50 text-indigo-600 text-xs rounded-full font-medium hover:bg-indigo-100 transition-colors"><i class="fa-solid fa-download mr-1"></i> <span data-i18n="btn_export">Export Word</span></button>
                        </div>
                        
                        <div id="editor" contenteditable="true" oninput="updateWordCount()" class="editor-area flex-1 p-12 text-lg text-slate-800 leading-relaxed overflow-y-auto custom-scrollbar outline-none serif-font prose max-w-none">
                            <h1 class="text-3xl font-bold mb-6 text-slate-900 font-sans">SSCIè«–æ–‡åˆç¨¿ (Draft)</h1>
                            <p class="text-slate-400 italic">è«‹å¾å·¦å´é¸å–®é¸æ“‡ç« ç¯€é–‹å§‹å¯«ä½œ...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // CONFIG
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxzuSB40CJ_8VgEG5HsZR0QBqShK5TMKQAHHkQf_ww4gGy90uWZUoLjiuwbBpT4BkJoKQ/exec"; 
        
        let literatureData = [];
        let projectInfo = { iv: '', dv: '', topic: '', mediator: '', moderator: '' };
        let isProcessing = false;
        // è¨˜éŒ„ç›®å‰åœ¨å“ªä¸€ç«  (1-10)
        let currentChapter = 'outline'; 

        const translations = {
            'zh-TW': {
                'nav_setup': '1. ç ”ç©¶ä¸»é¡Œè¨­å®š', 'nav_data': '2. æ–‡ç»è³‡æ–™è§£æ', 'nav_data_upload': '3. æ•¸æ“šè³‡æ–™ä¸Šå‚³', 'nav_write': '4. AI è¼”åŠ©å¯«ä½œ',
                'title_setup': 'ç ”ç©¶ä¸»é¡Œè¨­å®š',
                'setup_canvas_title': 'ç ”ç©¶è®Šé …è¦ç•«', 'setup_canvas_desc': 'æ¸…æ™°é‡æ¸…ç ”ç©¶è®Šé …æ˜¯ SSCI è«–æ–‡å¯«ä½œçš„é‡è¦é—œéµã€‚',
                'setup_iv': 'è‡ªè®Šé … (IV)', 'setup_dv': 'ä¾è®Šé … (DV)', 'setup_topic': 'ç ”ç©¶ä¸»é¡Œæˆ–æ–¹å‘',
                'setup_advanced': 'é€²éšè®Šé …è¨­å®š', 'setup_mediator': 'ä¸­ä»‹è®Šé …', 'setup_moderator': 'èª¿ç¯€è®Šé …',
                'btn_next_data': 'ä¸‹ä¸€æ­¥ï¼šæ–‡ç»è§£æ', 'btn_next_data_upload': 'ä¸‹ä¸€æ­¥ï¼šæ•¸æ“šä¸Šå‚³', 'btn_next_write': 'é€²å…¥å¯«ä½œæ¨¡å¼',
                'data_upload_title': 'ä¸Šå‚³ WoS æ–‡ç»è³‡æ–™', 'data_upload_desc': 'ç³»çµ±å°‡è‡ªå‹•è§£ææ–‡ç»æ ¼å¼',
                'data_upload_stat_title': 'é‡åŒ–/è³ªæ€§æ•¸æ“šä¸Šå‚³', 'data_upload_stat_desc': 'è«‹ä¸Šå‚³æ‚¨çš„ç ”ç©¶æ•¸æ“šï¼ŒAI å°‡å”åŠ©åˆ†æã€‚',
                'data_preview_title': 'æ–‡ç»æ± é è¦½', 
                'ai_welcome': 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ SSCI å¯«ä½œæ•™ç·´ã€‚è«‹å¾å·¦å´é¸å–®é¸æ“‡ç« ç¯€ (1-10) é–‹å§‹ã€‚', 
                'btn_export': 'åŒ¯å‡º Word', 'btn_smart_summary': 'âœ¨ æ™ºæ…§æ–‡ç»æ‘˜è¦', 'btn_polish_style': 'âœ¨ æ½¤é£¾'
            },
            'en-US': {
                'nav_setup': '1. Setup', 'nav_data': '2. Literature', 'nav_data_upload': '3. Data Upload', 'nav_write': '4. Writing',
                'title_setup': 'Topic Setup',
                'setup_canvas_title': 'Variable Canvas', 'setup_canvas_desc': 'Define variables clearly.',
                'setup_iv': 'Independent Variable (IV)', 'setup_dv': 'Dependent Variable (DV)', 'setup_topic': 'Research Topic',
                'setup_advanced': 'Advanced Vars', 'setup_mediator': 'Mediator', 'setup_moderator': 'Moderator',
                'btn_next_data': 'Next: Literature', 'btn_next_data_upload': 'Next: Data Upload', 'btn_next_write': 'Start Writing',
                'data_upload_title': 'Upload WoS Data', 'data_upload_desc': 'Auto-parsing enabled',
                'data_upload_stat_title': 'Data Upload', 'data_upload_stat_desc': 'Upload stats files (SPSS/Excel).',
                'data_preview_title': 'Literature Pool', 
                'ai_welcome': 'Hello! Select a chapter (1-10) from the left menu to start.', 
                'btn_export': 'Export Word', 'btn_smart_summary': 'âœ¨ Summary', 'btn_polish_style': 'âœ¨ Polish'
            }
        };

        function toggleAdvancedVars() {
            const adv = document.getElementById('advanced-vars');
            const icon = document.getElementById('adv-icon');
            if (adv.classList.contains('hidden')) { adv.classList.remove('hidden'); icon.style.transform = 'rotate(90deg)'; }
            else { adv.classList.add('hidden'); icon.style.transform = 'rotate(0deg)'; }
        }

        function toggleWritingMenu() {
            const menu = document.getElementById('writing-submenu');
            const icon = document.getElementById('write-chevron');
            if (menu.classList.contains('open')) {
                menu.classList.remove('open');
                icon.style.transform = 'rotate(0deg)';
            } else {
                menu.classList.add('open');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function switchChapter(chapterId) {
            currentChapter = chapterId;
            // Update UI active state
            document.querySelectorAll('.sub-nav-item').forEach(el => el.classList.remove('sub-nav-active', 'text-white'));
            const activeBtn = document.getElementById(`sub-${chapterId}`);
            if(activeBtn) {
                activeBtn.classList.add('sub-nav-active', 'text-white');
                activeBtn.classList.remove('text-slate-400');
            }
            
            // Update AI Coach Header
            const chapterName = document.getElementById(`sub-${chapterId}`).innerText;
            document.getElementById('current-chapter-display').innerText = chapterName;
            
            // Scroll editor to that section if exists
            const section = document.querySelector(`div[data-phase="${chapterId}"]`);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                addChatMessage('system', `å·²åˆ‡æ›è‡³ **${chapterName}**ã€‚è«‹è¼¸å…¥æŒ‡ä»¤æˆ–æŒ‰ Enter é–‹å§‹ç”Ÿæˆæ­¤ç« ç¯€ã€‚`);
            }
        }

        async function callBackendAPI(payload) {
            const maxRetries = 3; 
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(GAS_API_URL, {
                        method: "POST", body: JSON.stringify(payload),
                        headers: { "Content-Type": "text/plain;charset=utf-8" } 
                    });
                    const json = await response.json();
                    if (json.status === 'error' && json.message && json.message.includes('Resource exhausted')) throw new Error("QuotaLimit");
                    return json;
                } catch (error) {
                    attempt++;
                    console.warn(`API Attempt ${attempt} failed:`, error);
                    if (attempt >= maxRetries) return { status: "error", message: "é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚" };
                    await new Promise(resolve => setTimeout(resolve, 2000 * Math.pow(2, attempt - 1)));
                }
            }
        }

        async function switchTab(tabId) {
            ['setup', 'literature', 'data', 'write'].forEach(id => {
                document.getElementById(`view-${id}`).classList.add('hidden');
                const nav = document.getElementById(`nav-${id}`);
                if(nav) {
                    nav.classList.remove('nav-active');
                    nav.classList.add('text-slate-300', 'hover:bg-slate-800');
                }
            });
            
            const targetView = document.getElementById(`view-${tabId}`);
            if(targetView) targetView.classList.remove('hidden');
            
            const targetNav = document.getElementById(`nav-${tabId}`);
            if(targetNav) {
                targetNav.classList.remove('text-slate-300', 'hover:bg-slate-800');
                targetNav.classList.add('nav-active');
            }

            const titles = { 'setup': 'ç ”ç©¶ä¸»é¡Œè¨­å®š', 'literature': 'æ–‡ç»è³‡æ–™è§£æ', 'data': 'æ•¸æ“šè³‡æ–™ä¸Šå‚³', 'write': 'AI è¼”åŠ©å¯«ä½œ' };
            document.getElementById('page-title').innerText = titles[tabId];

            if (tabId === 'write') {
                // Auto open submenu
                const menu = document.getElementById('writing-submenu');
                if (!menu.classList.contains('open')) toggleWritingMenu();
                // Default to chapter 1
                if(currentChapter === 'outline') switchChapter('outline');
            }

            // Auto save logic
            if (tabId !== 'setup') {
                const newInfo = {
                    iv: document.getElementById('iv-input').value,
                    dv: document.getElementById('dv-input').value,
                    topic: document.getElementById('topic-input').value,
                    mediator: document.getElementById('mediator-input').value,
                    moderator: document.getElementById('moderator-input').value
                };
                if (JSON.stringify(newInfo) !== JSON.stringify(projectInfo)) {
                    projectInfo = newInfo;
                    callBackendAPI({ action: "save_settings", data: projectInfo });
                }
            }
        }

        function changeUILanguage() {
            const lang = document.getElementById('global-lang-selector').value;
            const texts = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (texts[key]) el.innerText = texts[key];
            });
            document.getElementById('ai-input').placeholder = lang === 'zh-TW' ? "è¼¸å…¥æŒ‡ä»¤..." : "Enter command...";
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const uploadZone = document.getElementById('upload-zone');
            const originalContent = uploadZone.innerHTML;
            uploadZone.innerHTML = `<div class="animate-pulse"><i class="fa-solid fa-spinner fa-spin text-4xl text-indigo-600 mb-4"></i><h3 class="text-lg font-bold text-slate-700">Processing...</h3></div>`;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    literatureData = jsonData;
                    document.getElementById('record-count').innerText = `${jsonData.length} records`;
                    document.getElementById('data-preview-container').classList.remove('hidden');
                    renderTablePreview(jsonData); 
                    const response = await callBackendAPI({ action: "upload_literature", data: jsonData });
                    addChatMessage('system', response.status === 'success' ? `âœ… Uploaded ${jsonData.length} references.` : `âŒ Failed: ${response.message}`);
                } catch (err) { alert("Parsing Error"); } finally { uploadZone.innerHTML = originalContent; }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderTablePreview(rows) {
            const tbody = document.getElementById('literature-table-body');
            tbody.innerHTML = '';
            rows.forEach((row, index) => {
                const author = (row['Author Full Names'] || row['Authors'] || 'Unknown').split(';')[0];
                const year = row['Publication Year'] || 'N/A';
                const title = row['Article Title'] || 'No Title';
                const journal = row['Source Title'] || 'Unknown';
                const volIssue = (row['Volume'] || '') + (row['Issue'] ? `(${row['Issue']})` : '');
                const pages = (row['Start Page'] && row['End Page']) ? `${row['Start Page']}-${row['End Page']}` : (row['Article Number'] || '');
                const doi = row['DOI'] || '';
                const abstract = row['Abstract'] || 'No Abstract';
                
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b border-slate-50 hover:bg-indigo-50/30 transition-colors cursor-pointer group';
                tr.onclick = () => toggleDetails(index);
                tr.innerHTML = `
                    <td class="px-4 py-4 font-mono text-center text-slate-400">${index + 1}</td>
                    <td class="px-4 py-4 font-medium truncate max-w-[150px]" title="${author}">${author} et al.</td>
                    <td class="px-4 py-4 text-slate-500">${year}</td>
                    <td class="px-4 py-4 truncate max-w-[200px] font-medium text-slate-700 group-hover:text-indigo-700" title="${title}">${title}</td>
                    <td class="px-4 py-4 truncate max-w-[150px] text-indigo-600 italic font-serif" title="${journal}">${journal}</td>
                    <td class="px-4 py-4 text-slate-600 whitespace-nowrap">${volIssue}</td>
                    <td class="px-4 py-4 text-slate-600 whitespace-nowrap">${pages}</td>
                    <td class="px-4 py-4 text-slate-600 truncate max-w-[150px]" title="${doi}">${doi}</td>
                    <td class="px-4 py-4 text-center"><button class="text-xs bg-slate-100 text-slate-500 px-3 py-1.5 rounded-full group-hover:bg-white">Detail</button></td>`;
                tbody.appendChild(tr);
                const trDetail = document.createElement('tr');
                trDetail.id = `detail-${index}`;
                trDetail.className = 'hidden bg-slate-50/50 border-b border-slate-100 shadow-inner';
                trDetail.innerHTML = `<td colspan="9" class="p-6"><div class="text-sm text-slate-700 bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><div class="font-bold mb-2 text-xs uppercase text-indigo-500">Abstract</div>${abstract}</div></td>`;
                tbody.appendChild(trDetail);
            });
        }

        function toggleDetails(index) {
            const row = document.getElementById(`detail-${index}`);
            row.classList.toggle('hidden');
        }

        function formatAIOutput(markdown) {
            if (!markdown) return ""; 
            let formatted = markdown
                .replace(/(^|\n)(æœŸåˆŠé©é…æ€§åˆ†æ|Journal Fit Analysis)/g, '\n\n### $2')
                .replace(/(^|\n)(Phase \d+[:ï¼š]?\s*è«–æ–‡å¤§ç¶±|Outline)/g, '\n\n### $2')
                .replace(/(^|\n)[*â€¢-]?\s*(é¡Œç›®|Title)\s*[:ï¼š\(]/g, '\n\n**é¡Œç›® (Title)**: ')
                .replace(/(^|\n)[*â€¢-]?\s*(æ‘˜è¦|Abstract)\s*[:ï¼š\(]/g, '\n\n**æ‘˜è¦ (Abstract)**: ')
                .replace(/(^|\n)[*â€¢-]?\s*(ç·’è«–|Introduction)\s*[:ï¼š]?/g, '\n\n### ç·’è«– (Introduction)')
                .replace(/(^|\n)[*â€¢-]?\s*(æ–‡ç»æ¢è¨|Literature Review)\s*[:ï¼š]?/g, '\n\n### æ–‡ç»æ¢è¨ (Literature Review)')
                .replace(/(^|\n)[*â€¢-]?\s*(ç ”ç©¶æ–¹æ³•|Methodology)\s*[:ï¼š]?/g, '\n\n### ç ”ç©¶æ–¹æ³• (Methodology)')
                .replace(/(^|\n)[*â€¢-]?\s*(ç ”ç©¶ç™¼ç¾|Findings)\s*[:ï¼š]?/g, '\n\n### ç ”ç©¶ç™¼ç¾ (Findings)')
                .replace(/(^|\n)[*â€¢-]?\s*(è¨è«–|Discussion)\s*[:ï¼š]?/g, '\n\n### è¨è«– (Discussion)')
                .replace(/(^|\n)[*â€¢-]?\s*(çµè«–|Conclusions?)\s*[:ï¼š]?/g, '\n\n### çµè«– (Conclusions)')
                .replace(/(^|\n)(æ³¨æ„äº‹é …|Note[s]?)\s*[:ï¼š]/g, '\n\n**æ³¨æ„äº‹é …:**');
            
            let html = formatted
                .replace(/^### (.*$)/gim, '<h3 class="text-xl font-bold mt-10 mb-4 text-indigo-700 border-b border-indigo-100 pb-2">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-2xl font-bold mt-12 mb-6 text-slate-800">$1</h2>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong class="font-bold text-slate-900">$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em class="italic text-slate-600">$1</em>')
                .replace(/^\* (.*$)/gim, '<li class="ml-6 list-disc mb-2 pl-1">$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li class="ml-6 list-decimal mb-2 pl-1">$1</li>');
            
            return html.split(/\n\n+/).map(para => {
                para = para.trim();
                if (!para) return '';
                if (para.startsWith('<h') || para.startsWith('<li')) return para;
                return `<p class="mb-5 leading-relaxed text-justify text-slate-700">${para.replace(/\n/g, '<br>')}</p>`;
            }).join('');
        }

        function updateWordCount() {
            const editor = document.getElementById('editor');
            const totalCount = (editor.innerText || "").trim().split(/\s+/).length;
            document.getElementById('total-word-count').innerText = `Total: ${totalCount}`;
            
            const phase = currentChapter; // Use global variable
            let phaseCount = 0;
            editor.querySelectorAll(`div[data-phase="${phase}"]`).forEach(d => phaseCount += d.innerText.trim().split(/\s+/).length);
            document.getElementById('phase-word-count').innerText = `Phase: ${phaseCount}`;
        }

        function addChatMessage(role, text) {
            const div = document.createElement('div');
            div.className = 'flex gap-3 animate-fade-in';
            div.innerHTML = role === 'system' 
                ? `<div class="w-8 h-8 rounded-full bg-white border border-indigo-100 text-indigo-600 flex-shrink-0 flex items-center justify-center shadow-sm"><i class="fa-solid fa-robot"></i></div><div class="bg-white p-3.5 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 border border-slate-100 leading-relaxed"><p>${text.replace(/\n/g, '<br>')}</p></div>`
                : `<div class="flex-1"></div><div class="bg-indigo-600 p-3.5 rounded-2xl rounded-tr-none shadow-sm text-sm text-white max-w-[85%] leading-relaxed"><p>${text}</p></div><div class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex-shrink-0 flex items-center justify-center font-bold text-xs">U</div>`;
            document.getElementById('chat-history').appendChild(div);
            document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
        }

        // --- Features ---
        async function generateLiteratureSummary() {
            if (isProcessing) return;
            isProcessing = true;
            const loadingId = 'loading-summary-' + Date.now();
            const history = document.getElementById('chat-history');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex gap-3 items-center text-slate-400 text-xs ml-12 my-2 animate-pulse';
            loadingDiv.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles fa-spin"></i> Summarizing...`;
            
            // Auto switch to writing view to show result
            switchTab('write'); 
            history.appendChild(loadingDiv);
            
            const lang = document.getElementById('global-lang-selector').value;
            let prompt = "Please analyze the uploaded literature and provide a comprehensive summary.";
            prompt += lang === 'zh-TW' ? " (Output in Traditional Chinese)." : " (Output in English).";

            const res = await callBackendAPI({ action: "generate_content", phase: "lit_review", user_prompt: prompt });
            document.getElementById(loadingId).remove();
            isProcessing = false;

            if (res.status === 'success') {
                addChatMessage('system', `âœ¨ **Literature Summary** Generated.`);
                const formatted = formatAIOutput(res.data);
                document.getElementById('editor').innerHTML += `<div class="mb-10 animate-fade-in group prose prose-slate max-w-none bg-indigo-50/30 p-6 rounded-xl border border-indigo-100" data-phase="lit_summary"><div class="flex items-center gap-2 mb-4 border-b-2 border-indigo-200 pb-2 select-none not-prose"><span class="text-[10px] font-bold text-white uppercase tracking-wider bg-purple-500 px-2 py-1 rounded shadow-sm">Smart Summary</span><span class="text-[10px] text-slate-400 font-mono">${new Date().toLocaleTimeString()}</span></div>${formatted}</div>`;
                document.getElementById('editor').scrollTop = document.getElementById('editor').scrollHeight;
            } else {
                addChatMessage('system', `âŒ Error: ${res.message}`);
            }
        }

        async function polishStyle() {
            const selection = window.getSelection().toString().trim();
            if (!selection) { alert("Please select text to polish."); return; }
            if (isProcessing) return;
            isProcessing = true;
            const loadingId = 'loading-polish-' + Date.now();
            const history = document.getElementById('chat-history');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex gap-3 items-center text-slate-400 text-xs ml-12 my-2 animate-pulse';
            loadingDiv.innerHTML = `<i class="fa-solid fa-feather fa-spin"></i> Polishing...`;
            history.appendChild(loadingDiv);
            const lang = document.getElementById('global-lang-selector').value;
            let prompt = `Rewrite to be more academic for SSCI journal:\n"${selection}"`;
            prompt += lang === 'zh-TW' ? " (Output in Traditional Chinese)." : " (Output in English).";
            const res = await callBackendAPI({ action: "generate_content", phase: "polish", user_prompt: prompt });
            document.getElementById(loadingId).remove();
            isProcessing = false;
            if (res.status === 'success') {
                addChatMessage('system', `âœ¨ **Style Polished**.\nğŸ“ Suggestion:\n${res.data}`);
            } else {
                addChatMessage('system', `âŒ Error: ${res.message}`);
            }
        }

        async function simulateAIGeneration() {
            if (isProcessing) return;
            const input = document.getElementById('ai-input');
            const text = input.value.trim();
            const lang = document.getElementById('global-lang-selector').value;
            const phase = currentChapter; // Use the selected chapter

            // Always allow generation if triggered (since buttons switch phase)
            isProcessing = true;
            if (text) addChatMessage('user', text);
            input.value = '';

            const loadingId = 'loading-' + Date.now();
            const history = document.getElementById('chat-history');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex gap-3 items-center text-slate-400 text-xs ml-12 my-2 animate-pulse';
            loadingDiv.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Gemini Thinking (${phase})...`;
            history.appendChild(loadingDiv);
            history.scrollTop = history.scrollHeight;

            let prompt = text;
            if (!prompt) {
                prompt = `Please generate detailed academic content for the chapter: ${phase}, based on the research topic and literature.`;
            }
            prompt += lang === 'zh-TW' ? " (Output in Traditional Chinese)." : " (Output in English).";

            const res = await callBackendAPI({ action: "generate_content", phase: phase, user_prompt: prompt });
            document.getElementById(loadingId).remove();
            isProcessing = false;

            if (res.status === 'success') {
                if (!res.data || res.data.trim() === "") { addChatMessage('system', `âš ï¸ Empty content.`); return; }
                addChatMessage('system', `âœ… **${phase}** Generated.`);
                const formatted = formatAIOutput(res.data);
                const editor = document.getElementById('editor');
                editor.innerHTML += `<div class="mb-10 animate-fade-in group prose prose-slate max-w-none bg-indigo-50/30 p-6 rounded-xl border border-indigo-100" data-phase="${phase}"><div class="flex items-center gap-2 mb-4 border-b-2 border-indigo-200 pb-2 select-none not-prose"><span class="text-[10px] font-bold text-white uppercase tracking-wider bg-indigo-500 px-2 py-1 rounded shadow-sm">Phase: ${phase}</span><span class="text-[10px] text-slate-400 font-mono">${new Date().toLocaleTimeString()}</span></div>${formatted}</div>`;
                editor.scrollTop = editor.scrollHeight;
                updateWordCount();
            } else {
                let msg = res.message;
                if (msg && msg.includes('Resource exhausted')) msg = "AI Quota exceeded. Wait 1 min.";
                addChatMessage('system', `âŒ Error: ${msg}`);
            }
        }

        switchTab('setup');
    </script>
</body>
</html>
