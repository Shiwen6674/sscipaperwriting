<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ScholarCraft v3 | AI 輔助 SSCI 論文寫作系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- xlsx for WoS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .serif { font-family: 'Noto Serif TC', serif; }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
    .scroll-thin::-webkit-scrollbar { width: 6px; }
    .scroll-thin::-webkit-scrollbar-thumb { background:#cbd5e1;border-radius:3px; }
    .scroll-thin::-webkit-scrollbar-thumb:hover { background:#94a3b8; }
  </style>
</head>
<body class="bg-slate-100 h-screen flex overflow-hidden">

<!-- Sidebar -->
<aside class="w-72 bg-slate-900 text-slate-100 flex flex-col">
  <div class="px-5 py-4 border-b border-slate-700 flex items-center justify-between">
    <div>
      <div class="flex items-center gap-2">
        <i class="fa-solid fa-graduation-cap text-indigo-400"></i>
        <span class="font-semibold tracking-wide">ScholarCraft v3</span>
      </div>
      <p class="text-xs text-slate-400 mt-1">SSCI Q1 Writing Workstation</p>
    </div>
    <div class="text-[10px] px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">
      BETA
    </div>
  </div>

  <!-- Project / Journal quick info -->
  <div class="px-4 py-3 border-b border-slate-800 text-xs space-y-2">
    <div>
      <label class="text-slate-400">目前專案</label>
      <div id="sidebar-project-name" class="font-semibold truncate">未命名專案</div>
    </div>
    <div class="flex items-center justify-between">
      <div>
        <span class="text-slate-400">目標期刊</span>
        <div id="sidebar-journal" class="text-[11px] text-indigo-300 truncate">未設定</div>
      </div>
      <div class="flex flex-col items-end">
        <span class="text-slate-400">語氣風格</span>
        <select id="style-preset" class="mt-0.5 bg-slate-800 text-[11px] px-2 py-1 rounded border border-slate-600 focus:outline-none"
                onchange="updateStylePreset()">
          <option value="conservative">保守</option>
          <option value="balanced" selected>平衡</option>
          <option value="assertive">較強</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Nav -->
  <nav class="flex-1 overflow-y-auto scroll-thin px-3 py-3 space-y-1 text-sm">
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="project" onclick="switchTab('project')">
      <i class="fa-solid fa-diagram-project w-4 text-center"></i><span>1. 專案＆期刊</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="design" onclick="switchTab('design')">
      <i class="fa-solid fa-flask w-4 text-center"></i><span>2. 研究設計</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="literature" onclick="switchTab('literature')">
      <i class="fa-solid fa-book-open w-4 text-center"></i><span>3. 文獻＆引用</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="data" onclick="switchTab('data')">
      <i class="fa-solid fa-chart-column w-4 text-center"></i><span>4. 數據＆分析</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="writing" onclick="switchTab('writing')">
      <i class="fa-solid fa-pen-nib w-4 text-center"></i><span>5. 寫作＆Reviewer</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="submission" onclick="switchTab('submission')">
      <i class="fa-solid fa-envelope-open-text w-4 text-center"></i><span>6. 投稿包</span>
    </button>
  </nav>

  <!-- User -->
  <div class="px-4 py-3 border-t border-slate-800 flex items-center gap-3 text-xs">
    <div id="user-avatar" class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-fuchsia-500 flex items-center justify-center font-bold text-[11px]">
      U
    </div>
    <div class="flex-1">
      <div id="user-name" class="font-semibold">SSCI 作者</div>
      <div id="user-meta" class="text-slate-400 text-[11px]">Local project · Auto-save</div>
    </div>
  </div>
</aside>

<!-- Main -->
<main class="flex-1 flex flex-col">

  <!-- Header -->
  <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6">
    <div>
      <h1 id="main-title" class="text-sm font-semibold text-slate-700">專案＆期刊設定</h1>
      <p id="main-subtitle" class="text-xs text-slate-400">從期刊開始，決定整篇論文的遊戲規則。</p>
    </div>
    <div class="flex items-center gap-3 text-[11px]">
      <button class="px-3 py-1 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100"
              onclick="runManuscriptFitCheck()">
        <i class="fa-solid fa-magnifying-glass-chart mr-1"></i>期刊適配檢查
      </button>
      <button class="px-3 py-1 rounded-full border border-emerald-400 text-emerald-600 hover:bg-emerald-50"
              onclick="runQualityCheck()">
        <i class="fa-solid fa-shield-heart mr-1"></i>品質＆倫理檢查
      </button>
      <!-- 多語選單：生成語言 -->
      <div class="flex items-center gap-1">
        <span id="lang-label" class="text-slate-400">生成語言</span>
        <select id="lang-select"
                class="px-2 py-1 rounded-full border border-slate-300 text-slate-600 bg-white focus:outline-none">
        </select>
      </div>
    </div>
  </header>

  <!-- Content Tabs -->
  <section class="flex-1 overflow-hidden">
    <div class="h-full overflow-y-auto scroll-thin p-4 space-y-4">

      <!-- TAB: Project -->
      <div id="tab-project" class="space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-diagram-project text-indigo-500"></i> 專案基本資訊
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">專案名稱</label>
              <input id="project-title" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     placeholder="例如：Generative AI in PBL for SSI Argumentation"
                     oninput="updateProjectMeta(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">領域</label>
              <input id="project-field" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     placeholder="Science education / AI in education"
                     oninput="updateProjectMeta(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">預定投稿年份</label>
              <input id="project-year" type="number"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     value="2025" oninput="updateProjectMeta(); scheduleSaveState();">
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-newspaper text-indigo-500"></i> 目標期刊設定
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">目標期刊</label>
              <select id="journal-select"
                      class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                      onchange="updateJournalProfile(); scheduleSaveState();">
              </select>
              <p class="text-[11px] text-slate-400 mt-1">
                可在程式中擴充 journalProfiles 物件，加入常用期刊。
              </p>
            </div>
            <div class="text-xs space-y-1" id="journal-profile-summary">
              <!-- filled by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Design -->
      <div id="tab-design" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-flask text-emerald-500"></i> 研究設計總覽
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">研究類型</label>
              <select id="design-type" class="w-full px-2 py-1.5 rounded border border-slate-300"
                      onchange="updateResearchDesign(); scheduleSaveState();">
                <option value="">請選擇</option>
                <option value="quant">量化實證</option>
                <option value="qual">質性研究</option>
                <option value="mixed">混合方法</option>
                <option value="review">系統性回顧/文獻分析</option>
              </select>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">研究情境 / 場域</label>
              <input id="design-context" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：台灣國中理化課室"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">樣本概況（N、年級）</label>
              <input id="design-sample" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：兩校共 200 名國二學生"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">研究工具 / 量表</label>
              <input id="design-instruments" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：論證能力量表、AI 使用問卷"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-question-circle text-indigo-500"></i> 研究問題 & 假設
            </h2>
            <div class="space-x-1 text-[11px]">
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                      onclick="addRQ()">+ RQ</button>
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                      onclick="addHypothesis()">+ H</button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
            <div>
              <h3 class="font-semibold text-slate-700 text-xs mb-1">Research Questions</h3>
              <div id="rq-list" class="space-y-2"></div>
            </div>
            <div>
              <h3 class="font-semibold text-slate-700 text-xs mb-1">Hypotheses</h3>
              <div id="hypo-list" class="space-y-2"></div>
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-sitemap text-fuchsia-500"></i> 變項＆分析對應
            </h2>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="generateMethodDraft()">
              <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成方法草稿（AI）
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">自變項 (IV)</label>
              <input id="design-iv" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">依變項 (DV)</label>
              <input id="design-dv" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">中介 / 調節</label>
              <input id="design-medmod" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="Learning motivation (M), Gender (Mod)…"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
          </div>
          <div class="mt-3">
            <h3 class="font-semibold text-slate-700 text-xs mb-1">每個 RQ 對應的分析方法</h3>
            <div id="analysis-plan" class="space-y-2 text-xs"></div>
          </div>
        </div>
      </div>

      <!-- TAB: Literature -->
      <div id="tab-literature" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 flex flex-col md:flex-row gap-4">
          <!-- Upload & summary -->
          <div class="md:w-1/2 space-y-3 text-xs">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-file-import text-emerald-500"></i> 文獻庫（WoS/Scopus 匯入）
            </h2>
            <label class="block">
              <span class="text-slate-500 mb-1 block">上傳 Excel/CSV</span>
              <input id="lit-file" type="file" accept=".xlsx,.xls,.csv"
                     class="text-xs" onchange="handleLiteratureUpload(event)">
            </label>
            <p class="text-[11px] text-slate-500">
              系統會解析 Author, Year, Title, Journal, DOI 等欄位，形成文獻庫。
            </p>
            <div class="flex items-center gap-2">
              <span class="text-slate-500">目前文獻數：</span>
              <span id="lit-count" class="px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 text-[11px]">0</span>
            </div>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="syncLiteratureToBackend()">
              <i class="fa-solid fa-cloud-arrow-up mr-1"></i>同步文獻庫到後端
            </button>
          </div>

          <!-- Citation search / insert -->
          <div class="md:w-1/2 space-y-2 text-xs">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-quote-right text-fuchsia-500"></i> 引文搜尋＆插入
            </h2>
            <input id="lit-search" type="text"
                   class="w-full px-2 py-1.5 rounded border border-slate-300"
                   placeholder="輸入 author / keyword 搜尋"
                   oninput="renderLiteratureList()">
            <div id="lit-list" class="max-h-52 overflow-y-auto scroll-thin border border-slate-200 rounded p-2 bg-slate-50 text-[11px]">
            </div>
            <button class="mt-2 px-3 py-1 rounded-full bg-emerald-600 text-white text-[11px] hover:bg-emerald-700"
                    onclick="generateReferencesSection()">
              <i class="fa-solid fa-list-check mr-1"></i>生成 References（僅限實際引用）
            </button>
            <p class="text-[10px] text-slate-400">
              引文會在正文以 (Author, Year) 插入，並記錄於 usedCitations。
            </p>
          </div>
        </div>

        <!-- Preview -->
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-database text-slate-500"></i> 文獻庫預覽
          </h2>
          <div class="max-h-60 overflow-y-auto scroll-thin border border-slate-200 rounded bg-white">
            <table class="w-full text-[11px]">
              <thead class="bg-slate-50 text-slate-500">
              <tr>
                <th class="px-2 py-1 text-left">#</th>
                <th class="px-2 py-1 text-left">Author</th>
                <th class="px-2 py-1 text-left">Year</th>
                <th class="px-2 py-1 text-left">Title</th>
                <th class="px-2 py-1 text-left">Journal</th>
              </tr>
              </thead>
              <tbody id="lit-preview-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB: Data -->
      <div id="tab-data" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-chart-column text-indigo-500"></i> 數據檔案＆分析輸出
            </h2>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="generateResultsDraft()">
              <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成結果草稿（AI）
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="block text-slate-500 mb-1">上傳原始數據（選用）</label>
              <input id="data-raw-file" type="file" accept=".xlsx,.csv,.sav" class="text-[11px]"
                     onchange="handleDataRawUpload(event)">
              <p class="text-[10px] text-slate-400 mt-1">建議仍以本地統計軟體分析，本系統偏向協助撰寫。</p>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">上傳分析輸出（表格/結果摘要）</label>
              <input id="data-output-file" type="file" accept=".xlsx,.csv,.txt" class="text-[11px]"
                     onchange="handleDataOutputUpload(event)">
              <p class="text-[10px] text-slate-400 mt-1">可上傳整理後的分析表格，後端可進一步解析。</p>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">分析摘要備註</label>
              <textarea id="data-notes" rows="3"
                        class="w-full px-2 py-1.5 rounded border border-slate-300"
                        placeholder="簡要說明你做了哪些統計分析，例如：2x2 混合設計 ANOVA, MLR, LCA…"
                        oninput="updateDataMeta(); scheduleSaveState()"></textarea>
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-diagram-next text-emerald-500"></i> 每個 RQ 對應的分析計畫
          </h2>
          <p class="text-[11px] text-slate-500 mb-2">
            下方內容會自動從「研究設計」頁的 RQ 產生，你可以為每個 RQ 選一種主要分析方法。
          </p>
          <div id="analysis-plan-data" class="space-y-2"></div>
        </div>
      </div>

      <!-- TAB: Writing -->
      <div id="tab-writing" class="hidden space-y-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-[calc(100vh-6rem)]">
          <!-- AI Coach -->
          <div class="glass rounded-xl border border-slate-200 flex flex-col text-xs">
            <div class="px-3 py-2 border-b border-slate-200 bg-gradient-to-r from-indigo-600 to-indigo-700 text-slate-50">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i class="fa-solid fa-robot"></i>
                  <span class="font-semibold text-[12px]">SSCI AI Coach / Reviewer</span>
                </div>
                <span id="current-chapter-label" class="text-[11px] bg-slate-900/30 px-2 py-0.5 rounded-full">
                  Intro
                </span>
              </div>
            </div>
            <div class="p-2 border-b border-slate-200 bg-slate-50 text-[11px]" id="chapter-checklist">
            </div>
            <div id="chat-panel" class="flex-1 overflow-y-auto scroll-thin p-2 space-y-2 bg-slate-50">
            </div>
            <div class="border-t border-slate-200 p-2 space-y-1">
              <div class="flex items-center gap-1 mb-1">
                <button class="flex-1 px-2 py-1 rounded bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                        onclick="generateChapterDraft()">
                  <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成本章草稿
                </button>
                <button class="px-2 py-1 rounded border border-rose-400 text-rose-600 text-[11px] hover:bg-rose-50"
                        onclick="runReviewerMode()">
                  <i class="fa-solid fa-gavel mr-1"></i>Reviewer 模式
                </button>
              </div>
              <div class="flex items-center gap-1 mb-1">
                <button class="flex-1 px-2 py-1 rounded border border-emerald-500 text-emerald-700 text-[11px] hover:bg-emerald-50"
                        onclick="runAutoCitationForCurrentChapter()">
                  <i class="fa-solid fa-bookmark mr-1"></i>AI 自動配文獻（僅用 referencePool）
                </button>
              </div>
              <div class="flex items-center justify-between mb-1 text-[10px]">
                <span class="text-slate-500">快照 / 版本</span>
                <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                        onclick="createSnapshot()">
                  <i class="fa-solid fa-camera mr-1"></i>儲存快照
                </button>
              </div>
              <div id="snapshot-list" class="max-h-20 overflow-y-auto scroll-thin text-[10px] space-y-1">
              </div>
              <div class="relative mt-1">
                <textarea id="ai-input" rows="2"
                          class="w-full px-2 pr-8 py-1.5 rounded border border-slate-300 text-[11px]"
                          placeholder="輸入額外指令（可留白，直接生成）"
                          onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendAIMessage();}">
                </textarea>
                <button class="absolute right-1 bottom-1.5 p-1.5 rounded bg-indigo-600 text-white text-[10px]"
                        onclick="sendAIMessage()">
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Chapter / Editor -->
          <div class="lg:col-span-2 glass rounded-xl border border-slate-200 flex flex-col">
            <div class="px-3 py-2 border-b border-slate-200 flex items-center gap-2 text-[11px]">
              <label class="text-slate-500">章節</label>
              <select id="chapter-select" class="px-2 py-1 rounded border border-slate-300"
                      onchange="switchChapter()">
                <option value="outline">0. 論文大綱</option>
                <option value="intro">1. 緒論</option>
                <option value="lit_review">2. 文獻探討</option>
                <option value="method">3. 研究方法</option>
                <option value="results">4. 研究結果</option>
                <option value="discussion">5. 討論</option>
                <option value="conclusion">6. 結論</option>
                <option value="implications">7. 教育意涵</option>
                <option value="limitations">8. 限制與未來研究</option>
                <option value="abstract">9. 摘要</option>
                <option value="fullpaper">10. 全文整合</option>
              </select>
              <div class="flex-1"></div>
              <div class="flex flex-col items-end gap-0.5">
                <span id="chapter-word-count" class="text-slate-500">本章字數：0</span>
                <span id="total-word-count" class="text-slate-400">全文字數：0</span>
              </div>
            </div>

            <div id="chapter-editors" class="flex-1 overflow-hidden">
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin"
                data-chapter="outline"
                oninput="onChapterInput('outline', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="intro"
                oninput="onChapterInput('intro', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="lit_review"
                oninput="onChapterInput('lit_review', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="method"
                oninput="onChapterInput('method', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="results"
                oninput="onChapterInput('results', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="discussion"
                oninput="onChapterInput('discussion', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="conclusion"
                oninput="onChapterInput('conclusion', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="implications"
                oninput="onChapterInput('implications', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="limitations"
                oninput="onChapterInput('limitations', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="abstract"
                oninput="onChapterInput('abstract', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="fullpaper"
                oninput="onChapterInput('fullpaper', this.value)"
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Submission -->
      <div id="tab-submission" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs space-y-3">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-envelope-open-text text-indigo-500"></i> 投稿包總覽
          </h2>
          <p class="text-[11px] text-slate-600 mb-2">
            在這裡彙整 cover letter、投稿信模板、回覆 reviewer 信件草稿與期刊投稿注意事項，可搭配上方寫作區的全文內容與 References 一起輸出。
          </p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="flex flex-col">
              <label class="text-slate-500 mb-1">Cover Letter 草稿</label>
              <textarea id="sub-cover-letter" rows="8"
                        class="w-full px-2 py-1.5 rounded border border-slate-300 scroll-thin"></textarea>
              <button class="mt-1 px-2 py-1 rounded bg-indigo-600 text-white text-[11px]"
                      onclick="generateCoverLetter()">
                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>AI 生成 Cover Letter
              </button>
            </div>
            <div class="flex flex-col">
              <label class="text-slate-500 mb-1">Response to Reviewers 草稿</label>
              <textarea id="sub-response" rows="8"
                        class="w-full px-2 py-1.5 rounded border border-slate-300 scroll-thin"
                        placeholder="可貼上 reviewers 意見，請 AI 協助草擬逐點回覆。"></textarea>
              <button class="mt-1 px-2 py-1 rounded bg-indigo-600 text-white text-[11px]"
                      onclick="generateResponseToReviewers()">
                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>AI 生成回覆草稿
              </button>
            </div>
            <div class="flex flex-col">
              <label class="text-slate-500 mb-1">投稿備註 / Checklist</label>
              <textarea id="sub-notes" rows="8"
                        class="w-full px-2 py-1.5 rounded border border-slate-300 scroll-thin"
                        placeholder="例如：字數、表格數量、IRB 編號、開放資料聲明等。"></textarea>
              <button class="mt-1 px-2 py-1 rounded border border-slate-300 text-[11px]"
                      onclick="appendSubmissionSummaryToChat()">
                <i class="fa-solid fa-paperclip mr-1"></i>送到 AI 面板做總檢查
              </button>
            </div>
          </div>
          <p class="text-[10px] text-slate-500">
            （此區資料會一起存入 localStorage，未連線後端時也不會遺失。） 
          </p>
        </div>
      </div>

    </div>
  </section>
</main>

<script>
// =======================
// 後端設定與共用工具
// =======================
const BACKEND_CONFIG = {
  // 等一下你貼 code.gs 時，只要把下面 URL 換成你的 GAS deploy URL
  API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxzuSB40CJ_8VgEG5HsZR0QBqShK5TMKQAHHkQf_ww4gGy90uWZUoLjiuwbBpT4BkJoKQ/exec',
  USE_MOCK: true // 先給你 mock 測試，確認前端完全正常，再改成 false 接真後端
};

async function callBackend(endpoint, payload) {
  if (!BACKEND_CONFIG.API_BASE_URL || BACKEND_CONFIG.USE_MOCK) {
    console.warn('[ScholarCraft] 使用 mock 後端：', endpoint, payload);
    await new Promise(r => setTimeout(r, 400)); // 模擬延遲

    // ---- Mock：期刊適配檢查 ----
    if (endpoint === '/fitCheck') {
      const journal = payload.journalProfile || { abbr: 'NA', name: '未設定期刊' };
      const field = payload.projectMeta.field || '未填寫領域';
      let score = 70;
      if (journal.abbr === 'L&I' || journal.abbr === 'IJSME' || journal.abbr === 'TAPER') score += 10;
      if (payload.design.type === 'quant' || payload.design.type === 'mixed') score += 5;

      const wordStats = getWordStats(Object.values(payload.chapters || {}).join(' '));
      return {
        ok: true,
        data: {
          summary:
            `【Mock】期刊適配檢查\n\n` +
            `專案領域：${field}\n` +
            `目標期刊：${journal.name} (${journal.abbr})\n\n` +
            `綜合適配分數：${score}/100\n\n` +
            `1. 領域契合度：與期刊 scope 大致相符，可加強與近期專題的連結。\n` +
            `2. 研究設計：${payload.design.type || '未指定'}；請在 Method 中明確說明樣本與統計方法。\n` +
            `3. 字數預估：約 ${wordStats.total}（中/日：${wordStats.cjkChars}，英：${wordStats.enWords}），目前仍在可接受範圍內。\n`
        }
      };
    }

    // ---- Mock：品質＆倫理檢查 ----
    if (endpoint === '/qualityCheck') {
      const full = payload.chapters.fullpaper || '';
      const wordStats = getWordStats(full);
      const tooShort = wordStats.total < 1500;

      return {
        ok: true,
        data: {
          summary:
            `【Mock】品質＆倫理檢查\n\n` +
            `1. 結構完整度：${tooShort ? '目前全文字數偏少，建議補齊各章節內容。' : '章節結構大致完整，可進一步優化過渡與論證深度。'}\n` +
            `2. 方法與結果透明度：請在 Method 中補上量表信度、IRB/倫理審查資訊，以及在 Results 報告完整統計量（M, SD, F, p, η² 等）。\n` +
            `3. 研究倫理：若涉及學生或弱勢族群，需在稿件中清楚說明同意程序與資料匿名化處理方式。\n`
        }
      };
    }

    // ---- Mock：章節生成 ----
    if (endpoint === '/generateChapter') {
      return {
        ok: true,
        data: {
          text: (payload.chapterText || '') +
            '\n\n[Mock AI]（示意）此處會根據你的研究設計與文獻池，自動擴充本章內容。接上真實後端後即可產生正式草稿。'
        }
      };
    }

    // ---- Mock：Reviewer 模式 ----
    if (endpoint === '/reviewChapter') {
      return {
        ok: true,
        data: {
          summary: 'Mock Reviewer：整體結構大致合理，但仍有幾點可加強。',
          comments: [
            '1. 建議在段落開頭更清楚界定研究問題與理論落點。',
            '2. 可補充近五年 SSCI 期刊中相關主題的實證研究，以強化文獻連結。',
            '3. 結果與討論之間的對應關係可以再更緊密，避免僅重述統計數字。'
          ]
        }
      };
    }

    // ---- Mock：AI 自動配文獻 ----
    if (endpoint === '/autoCiteChapter') {
      return {
        ok: true,
        data: {
          text: (payload.chapterText || '') +
            '\n\n[Mock AI] 已示意性加入幾處 (Author, Year) 引用標記；接真實後端後會依 referencePool 精準配對。'
        }
      };
    }

    // ---- Mock：結果章節草稿 ----
    if (endpoint === '/resultsDraft') {
      return {
        ok: true,
        data: {
          text: '[Mock AI] 這裡會根據你上傳的分析輸出與 dataNotes，自動撰寫 Results 章節的敘述草稿。'
        }
      };
    }

    // ---- Mock：方法章節草稿 ----
    if (endpoint === '/methodDraft') {
      return {
        ok: true,
        data: {
          text: '[Mock AI] 這裡會利用研究設計（樣本、工具、RQ、分析方法）生成 Method 章節骨架與敘述。'
        }
      };
    }

    // ---- Mock：同步文獻 ----
    if (endpoint === '/syncReferences') {
      return { ok: true, data: { message: `Mock：已接收 ${payload.referencePool?.length || 0} 筆文獻（未實際寫入後端）。` } };
    }

    // ---- Mock：投稿包相關 ----
    if (endpoint === '/generateCoverLetter') {
      return {
        ok: true,
        data: {
          text: '[Mock AI] 根據你的專案資訊與目標期刊，這裡會生成一封正式且符合期刊風格的 Cover Letter 草稿。'
        }
      };
    }

    if (endpoint === '/generateResponseToReviewers') {
      return {
        ok: true,
        data: {
          text: '[Mock AI] 這裡會根據你貼上的 reviewers 意見與稿件內容，建立逐點回覆的 Response to Reviewers 草稿。'
        }
      };
    }

    // ---- Mock：自由聊天 ----
    if (endpoint === '/chat') {
      return {
        ok: true,
        data: {
          reply: '[Mock AI] 這是示意回覆。接上真實後端後，我會依你的指令與目前章節內容給出具體建議。'
        }
      };
    }

    return { ok: true, data: {} };
  }

  try {
    const res = await fetch(BACKEND_CONFIG.API_BASE_URL + endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload || {})
    });
    if (!res.ok) {
      console.error('Backend HTTP error', res.status, await res.text());
      return { ok: false, error: 'HTTP ' + res.status };
    }
    const data = await res.json();
    return { ok: true, data };
  } catch (err) {
    console.error('Backend fetch error', err);
    return { ok: false, error: err.message || String(err) };
  }
}

function escapeHtml(str) {
  return (str || '').replace(/[&<>"']/g, function (m) {
    return ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m];
  });
}

// =======================
// 多語系字典
// =======================

const UI_I18N = {
  'zh-TW': {
    langLabel: '生成語言',
    nav: {
      project: '1. 專案＆期刊',
      design: '2. 研究設計',
      literature: '3. 文獻＆引用',
      data: '4. 數據＆分析',
      writing: '5. 寫作＆Reviewer',
      submission: '6. 投稿包'
    }
  },
  'zh-CN': {
    langLabel: '生成语言',
    nav: {
      project: '1. 项目与期刊',
      design: '2. 研究设计',
      literature: '3. 文献与引用',
      data: '4. 数据与分析',
      writing: '5. 写作与审稿人',
      submission: '6. 投稿包'
    }
  },
  'en': {
    langLabel: 'Generation language',
    nav: {
      project: '1. Project & Journal',
      design: '2. Research design',
      literature: '3. Literature & citations',
      data: '4. Data & analysis',
      writing: '5. Writing & reviewer',
      submission: '6. Submission package'
    }
  },
  'ja': {
    langLabel: '生成言語',
    nav: {
      project: '1. プロジェクトとジャーナル',
      design: '2. 研究デザイン',
      literature: '3. 文献と引用',
      data: '4. データと分析',
      writing: '5. 執筆と査読者',
      submission: '6. 投稿パッケージ'
    }
  },
  'vi': {
    langLabel: 'Ngôn ngữ sinh văn',
    nav: {
      project: '1. Dự án & tạp chí',
      design: '2. Thiết kế nghiên cứu',
      literature: '3. Tài liệu & trích dẫn',
      data: '4. Dữ liệu & phân tích',
      writing: '5. Viết bài & phản biện',
      submission: '6. Gói gửi bài'
    }
  },
  'id': {
    langLabel: 'Bahasa keluaran',
    nav: {
      project: '1. Proyek & jurnal',
      design: '2. Desain penelitian',
      literature: '3. Literatur & sitasi',
      data: '4. Data & analisis',
      writing: '5. Penulisan & reviewer',
      submission: '6. Paket submit'
    }
  },
  'th': {
    langLabel: 'ภาษาที่ใช้สร้าง',
    nav: {
      project: '1. โปรเจกต์และวารสาร',
      design: '2. การออกแบบวิจัย',
      literature: '3. เอกสารและการอ้างอิง',
      data: '4. ข้อมูลและการวิเคราะห์',
      writing: '5. การเขียนและผู้ประเมิน',
      submission: '6. ชุดส่งบทความ'
    }
  }
};

const TAB_I18N = {
  'zh-TW': {
    project: {
      title: '專案＆期刊設定',
      subtitle: '從期刊開始，決定整篇論文的遊戲規則。'
    },
    design: {
      title: '研究設計',
      subtitle: '在此整理研究問題、假設、變項與分析方法。'
    },
    literature: {
      title: '文獻＆引用管理',
      subtitle: '所有引用一律來自上傳之文獻池（referencePool）。'
    },
    data: {
      title: '數據＆分析',
      subtitle: '整理統計結果，準備撰寫結果與討論。'
    },
    writing: {
      title: '寫作＆Reviewer',
      subtitle: '分章撰寫，並由 AI 協助檢視與評論。'
    },
    submission: {
      title: '投稿包',
      subtitle: '將稿件、cover letter 與回覆信整合成投稿套餐。'
    }
  },
  'en': {
    project: {
      title: 'Project & journal setup',
      subtitle: 'Start from the target journal to decide the rules of the whole paper.'
    },
    design: {
      title: 'Research design',
      subtitle: 'Organise research questions, hypotheses, variables, and analysis methods here.'
    },
    literature: {
      title: 'Literature & citation management',
      subtitle: 'All citations must come from the uploaded reference pool (referencePool) only.'
    },
    data: {
      title: 'Data & analysis',
      subtitle: 'Organise statistical results and prepare to write Results and Discussion.'
    },
    writing: {
      title: 'Writing & reviewer',
      subtitle: 'Write each section and let the AI help you review and comment.'
    },
    submission: {
      title: 'Submission package',
      subtitle: 'Combine manuscript, cover letter, and response letters into one submission package.'
    }
  },
  // 其他語系為了簡短這裡就不重覆翻譯，會回退到 zh-TW 或 en
};

// =======================
// 全域狀態
// =======================
const STORAGE_KEY = 'scholarcraft_v3_project';

const state = {
  projectId: 'default',
  currentTab: 'project',
  currentChapter: 'outline',
  lang: 'zh-TW',
  stylePreset: 'balanced',
  projectMeta: {
    title: '',
    field: '',
    year: '2025',
    journalKey: ''
  },
  referencePool: [],
  usedCitationIds: new Set(),
  chapters: {
    outline: '',
    intro: '',
    lit_review: '',
    method: '',
    results: '',
    discussion: '',
    conclusion: '',
    implications: '',
    limitations: '',
    abstract: '',
    fullpaper: ''
  },
  design: {
    type: '',
    context: '',
    sample: '',
    instruments: '',
    iv: '',
    dv: '',
    medmod: ''
  },
  rqs: [],
  hypotheses: [],
  analysisPlan: {},
  dataMeta: {
    notes: '',
    rawFileName: '',
    outputFileName: ''
  },
  litFilesMeta: {
    sourceFileName: ''
  },
  snapshots: [],
  submission: {
    coverLetter: '',
    response: '',
    notes: ''
  },
  journalProfiles: {}
};

let saveTimer = null;

// =======================
// 初始化
// =======================
document.addEventListener('DOMContentLoaded', () => {
  state.journalProfiles = mapJournalData();
  loadStateFromStorage();
  initNav();
  initLangSelect();
  initJournalSelect();
  initChecklist();
  renderRQList();
  renderHypothesisList();
  renderAnalysisPlan();
  renderAnalysisPlanData();
  renderSnapshotList();
  updateProjectMeta();
  switchTab(state.currentTab);
  switchChapter();
  renderLiteratureList();
  renderLiteraturePreview();
  updateWordCounts();
  restoreSubmissionUI();
});

// =======================
// LocalStorage
// =======================
function scheduleSaveState() {
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(saveStateToStorage, 500);
}

function saveStateToStorage() {
  try {
    const safeState = {
      projectId: state.projectId,
      currentTab: state.currentTab,
      currentChapter: state.currentChapter,
      lang: state.lang,
      stylePreset: state.stylePreset,
      projectMeta: state.projectMeta,
      referencePool: state.referencePool,
      chapters: state.chapters,
      design: state.design,
      rqs: state.rqs,
      hypotheses: state.hypotheses,
      analysisPlan: state.analysisPlan,
      dataMeta: state.dataMeta,
      litFilesMeta: state.litFilesMeta,
      snapshots: state.snapshots,
      submission: state.submission,
      journalProfiles: state.journalProfiles
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(safeState));
  } catch (e) {
    console.warn('儲存到 localStorage 失敗：', e);
  }
}

function loadStateFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const saved = JSON.parse(raw);
    if (!saved || typeof saved !== 'object') return;

    state.projectId = saved.projectId || 'default';
    state.currentTab = saved.currentTab || 'project';
    state.currentChapter = saved.currentChapter || 'outline';
    state.lang = saved.lang || 'zh-TW';
    state.stylePreset = saved.stylePreset || 'balanced';
    state.projectMeta = Object.assign({}, state.projectMeta, saved.projectMeta || {});
    state.referencePool = saved.referencePool || [];
    state.chapters = Object.assign({}, state.chapters, saved.chapters || {});
    state.design = Object.assign({}, state.design, saved.design || {});
    state.rqs = saved.rqs || [];
    state.hypotheses = saved.hypotheses || [];
    state.analysisPlan = saved.analysisPlan || {};
    state.dataMeta = Object.assign({}, state.dataMeta, saved.dataMeta || {});
    state.litFilesMeta = Object.assign({}, state.litFilesMeta, saved.litFilesMeta || {});
    state.snapshots = saved.snapshots || [];
    state.submission = Object.assign({}, state.submission, saved.submission || {});
    if (saved.journalProfiles) state.journalProfiles = saved.journalProfiles;

    // 回填 UI
    const pt = document.getElementById('project-title');
    const pf = document.getElementById('project-field');
    const py = document.getElementById('project-year');
    if (pt) pt.value = state.projectMeta.title || '';
    if (pf) pf.value = state.projectMeta.field || '';
    if (py) py.value = state.projectMeta.year || '2025';

    const dt = document.getElementById('design-type');
    const dc = document.getElementById('design-context');
    const ds = document.getElementById('design-sample');
    const di = document.getElementById('design-instruments');
    const div = document.getElementById('design-iv');
    const ddv = document.getElementById('design-dv');
    const dmm = document.getElementById('design-medmod');
    const dn = document.getElementById('data-notes');
    const sp = document.getElementById('style-preset');
    if (dt) dt.value = state.design.type || '';
    if (dc) dc.value = state.design.context || '';
    if (ds) ds.value = state.design.sample || '';
    if (di) di.value = state.design.instruments || '';
    if (div) div.value = state.design.iv || '';
    if (ddv) ddv.value = state.design.dv || '';
    if (dmm) dmm.value = state.design.medmod || '';
    if (dn) dn.value = state.dataMeta.notes || '';
    if (sp) sp.value = state.stylePreset || 'balanced';
  } catch (e) {
    console.warn('讀取 localStorage 失敗：', e);
  }
}

// =======================
// 語系與導覽
// =======================
function applyLanguage(lang) {
  const langCode = lang || state.lang || 'zh-TW';
  const uiPack = UI_I18N[langCode] || UI_I18N['zh-TW'];

  if (document.documentElement) {
    document.documentElement.lang = langCode;
  }

  const langLabel = document.getElementById('lang-label');
  if (langLabel && uiPack.langLabel) {
    langLabel.textContent = uiPack.langLabel;
  }

  if (uiPack.nav) {
    const navProject = document.querySelector('.nav-btn[data-tab="project"] span');
    const navDesign = document.querySelector('.nav-btn[data-tab="design"] span');
    const navLiterature = document.querySelector('.nav-btn[data-tab="literature"] span');
    const navData = document.querySelector('.nav-btn[data-tab="data"] span');
    const navWriting = document.querySelector('.nav-btn[data-tab="writing"] span');
    const navSubmission = document.querySelector('.nav-btn[data-tab="submission"] span');
    if (navProject && uiPack.nav.project) navProject.textContent = uiPack.nav.project;
    if (navDesign && uiPack.nav.design) navDesign.textContent = uiPack.nav.design;
    if (navLiterature && uiPack.nav.literature) navLiterature.textContent = uiPack.nav.literature;
    if (navData && uiPack.nav.data) navData.textContent = uiPack.nav.data;
    if (navWriting && uiPack.nav.writing) navWriting.textContent = uiPack.nav.writing;
    if (navSubmission && uiPack.nav.submission) navSubmission.textContent = uiPack.nav.submission;
  }

  // 讓目前 tab 的 header title / subtitle 也換語言
  switchTab(state.currentTab || 'project');
}

function initNav() {
  const firstNav = document.querySelector('.nav-btn[data-tab="project"]');
  if (firstNav) firstNav.classList.add('bg-slate-800');
}

function initLangSelect() {
  const sel = document.getElementById('lang-select');
  if (!sel) return;

  const options = [
    { value: 'zh-TW', label: '繁體中文' },
    { value: 'en', label: 'English' },
    { value: 'ja', label: '日本語' },
    { value: 'zh-CN', label: '簡體中文' },
    { value: 'vi', label: 'Tiếng Việt' },
    { value: 'id', label: 'Bahasa Indonesia' },
    { value: 'th', label: 'ภาษาไทย' }
  ];

  sel.innerHTML = '';
  options.forEach(opt => {
    const o = document.createElement('option');
    o.value = opt.value;
    o.textContent = opt.label;
    sel.appendChild(o);
  });

  const currentLang = state.lang || 'zh-TW';
  sel.value = currentLang;
  applyLanguage(currentLang);

  sel.addEventListener('change', () => {
    state.lang = sel.value || 'zh-TW';
    scheduleSaveState();
    applyLanguage(state.lang);
  });
}

function switchTab(tabId) {
  state.currentTab = tabId;

  const tabs = ['project', 'design', 'literature', 'data', 'writing', 'submission'];
  tabs.forEach(id => {
    const el = document.getElementById('tab-' + id);
    if (el) el.classList.toggle('hidden', id !== tabId);
  });

  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.toggle('bg-slate-800', btn.dataset.tab === tabId);
  });

  const title = document.getElementById('main-title');
  const subtitle = document.getElementById('main-subtitle');
  const langCode = state.lang || 'zh-TW';
  const langPack = TAB_I18N[langCode] || TAB_I18N['zh-TW'] || TAB_I18N['en'];
  const tabPack = langPack[tabId];

  if (tabPack && title && subtitle) {
    title.textContent = tabPack.title;
    subtitle.textContent = tabPack.subtitle;
  }

  scheduleSaveState();
}

// =======================
// 期刊列表
// =======================
function mapJournalData() {
  const list = [
    { id: 'ijse', name: 'International Journal of Science Education', abbr: 'IJSE', category: 'Science & Mathematics Education', scope: '科學教育理論與實證研究，含各學段與議題。', wordLimit: '約 7,000–8,000 字', note: '重視理論與方法嚴謹度。' },
    { id: 'rise', name: 'Research in Science Education', abbr: 'RISE', category: 'Science & Mathematics Education', scope: '科學教育實證研究與課程改革。', wordLimit: '約 8,000 字', note: '常見亞太區研究。' },
    { id: 'ijsme', name: 'International Journal of Science and Mathematics Education', abbr: 'IJSME', category: 'Science & Mathematics Education', scope: '科學與數學教育整合研究。', wordLimit: '約 7,000–9,000 字', note: '適合 PISA、STEM、課室研究。' },
    { id: 'siced', name: 'Science Education', abbr: 'SciEd', category: 'Science & Mathematics Education', scope: '頂尖科學教育期刊，重理論貢獻。', wordLimit: '約 9,000–10,000 字', note: '審查嚴格，偏理論與大型研究。' },
    { id: 'lni', name: 'Learning and Instruction', abbr: 'L&I', category: 'Educational Psychology & Measurement', scope: '學習與教學機制之實證研究。', wordLimit: '約 7,500–9,000 字', note: '適合精緻實驗與準實驗設計。' },
    { id: 'taper', name: 'Asia-Pacific Education Researcher', abbr: 'TAPER', category: 'General Education & Policy', scope: '亞太教育研究，含教師教育、課程與評量等。', wordLimit: '約 6,000–8,000 字', note: '適合區域實證研究與比較研究。' },
    { id: 'tte', name: 'Teaching and Teacher Education', abbr: 'TTE', category: 'Teacher, Special, Diverse Education', scope: '教師專業發展、教學研究。', wordLimit: '約 7,000–8,000 字', note: '常見教師 AI 素養、TPACK 等主題。' },
    { id: 'ce', name: 'Computers & Education', abbr: 'C&E', category: 'Educational Technology & Higher Education', scope: '教育科技整合之實證研究。', wordLimit: '約 7,000–9,000 字', note: '對研究設計與統計要求高。' }
  ];
  const obj = {};
  list.forEach(j => {
    obj[j.id] = {
      name: j.name,
      abbr: j.abbr,
      category: j.category,
      scope: j.scope,
      wordLimit: j.wordLimit,
      note: j.note
    };
  });
  return obj;
}

function initJournalSelect() {
  const sel = document.getElementById('journal-select');
  if (!sel) return;
  sel.innerHTML = '';

  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = '請選擇目標期刊';
  sel.appendChild(placeholder);

  Object.entries(state.journalProfiles).forEach(([key, jp]) => {
    const o = document.createElement('option');
    o.value = key;
    o.textContent = `${jp.name} (${jp.abbr})`;
    sel.appendChild(o);
  });

  if (state.projectMeta.journalKey) {
    sel.value = state.projectMeta.journalKey;
    updateJournalProfile();
  }
}

function updateJournalProfile() {
  const sel = document.getElementById('journal-select');
  if (!sel) return;
  const key = sel.value;
  state.projectMeta.journalKey = key || '';
  const jp = state.journalProfiles[key] || null;

  const box = document.getElementById('journal-profile-summary');
  if (box) {
    if (!jp) {
      box.innerHTML = '<p class="text-slate-400 text-[11px]">尚未選擇期刊。</p>';
    } else {
      box.innerHTML = `
        <p><span class="font-semibold">期刊名稱：</span>${escapeHtml(jp.name)} (${escapeHtml(jp.abbr)})</p>
        <p><span class="font-semibold">範疇：</span>${escapeHtml(jp.scope)}</p>
        <p><span class="font-semibold">字數限制：</span>${escapeHtml(jp.wordLimit)}</p>
        <p><span class="font-semibold">備註：</span>${escapeHtml(jp.note)}</p>
      `;
    }
  }

  const sidebarJournal = document.getElementById('sidebar-journal');
  if (sidebarJournal) {
    sidebarJournal.textContent = jp ? `${jp.name} (${jp.abbr})` : '未設定';
  }

  scheduleSaveState();
}

// =======================
// 字數與章節
// =======================
function getWordStats(text) {
  if (!text) return { cjkChars: 0, enWords: 0, total: 0 };
  const trimmed = text.trim();
  if (!trimmed) return { cjkChars: 0, enWords: 0, total: 0 };

  const rawTokens = trimmed.split(/\s+/).filter(Boolean);
  let cjkChars = 0;
  let enWords = 0;

  rawTokens.forEach(tok => {
    const cjkMatches = tok.match(/[\u4e00-\u9fff\u3040-\u30ff\u31f0-\u31ff]/g);
    if (cjkMatches && cjkMatches.length > 0) {
      cjkChars += cjkMatches.length;
    } else {
      enWords += 1;
    }
  });

  return {
    cjkChars,
    enWords,
    total: cjkChars + enWords
  };
}

function getCurrentEditor() {
  return document.querySelector('.chapter-editor[data-chapter="' + state.currentChapter + '"]');
}

function switchChapter() {
  const sel = document.getElementById('chapter-select');
  if (!sel) return;
  const chapterKey = sel.value;
  state.currentChapter = chapterKey;

  const editors = document.querySelectorAll('.chapter-editor');
  editors.forEach(ed => {
    const isCurrent = ed.dataset.chapter === chapterKey;
    ed.classList.toggle('hidden', !isCurrent);
    if (isCurrent) {
      ed.value = state.chapters[chapterKey] || '';
    }
  });

  const label = document.getElementById('current-chapter-label');
  if (label) {
    label.textContent = sel.options[sel.selectedIndex].textContent || chapterKey;
  }
  updateChecklistForChapter(chapterKey);
  updateWordCounts();
  scheduleSaveState();
}

function onChapterInput(chapterKey, text) {
  state.chapters[chapterKey] = text;
  if (chapterKey === state.currentChapter) updateWordCounts();
  scheduleSaveState();
}

function updateWordCounts() {
  const chapterText = state.chapters[state.currentChapter] || '';
  const chapterStats = getWordStats(chapterText);

  let totalStats = { cjkChars: 0, enWords: 0, total: 0 };
  Object.values(state.chapters).forEach(t => {
    const st = getWordStats(t || '');
    totalStats.cjkChars += st.cjkChars;
    totalStats.enWords += st.enWords;
    totalStats.total += st.total;
  });

  const chapterSpan = document.getElementById('chapter-word-count');
  const totalSpan = document.getElementById('total-word-count');
  if (chapterSpan) {
    chapterSpan.textContent =
      `本章字數：約 ${chapterStats.total}（中/日：${chapterStats.cjkChars} 字 / 英：${chapterStats.enWords} words）`;
  }
  if (totalSpan) {
    totalSpan.textContent =
      `全文字數：約 ${totalStats.total}（中/日：${totalStats.cjkChars} 字 / 英：${totalStats.enWords} words）`;
  }
}

// =======================
// 專案資訊
// =======================
function updateProjectMeta() {
  const titleEl = document.getElementById('project-title');
  const fieldEl = document.getElementById('project-field');
  const yearEl = document.getElementById('project-year');

  state.projectMeta.title = titleEl ? titleEl.value.trim() : '';
  state.projectMeta.field = fieldEl ? fieldEl.value.trim() : '';
  state.projectMeta.year = yearEl ? String(yearEl.value || '2025') : '2025';

  const sidebarTitle = document.getElementById('sidebar-project-name');
  if (sidebarTitle) {
    sidebarTitle.textContent = state.projectMeta.title || '未命名專案';
  }

  scheduleSaveState();
}

function updateStylePreset() {
  const sel = document.getElementById('style-preset');
  if (!sel) return;
  state.stylePreset = sel.value || 'balanced';
  scheduleSaveState();
}

// =======================
// 研究設計／RQ／分析
// =======================
function updateResearchDesign() {
  state.design.type = (document.getElementById('design-type') || {}).value || '';
  state.design.context = (document.getElementById('design-context') || {}).value || '';
  state.design.sample = (document.getElementById('design-sample') || {}).value || '';
  state.design.instruments = (document.getElementById('design-instruments') || {}).value || '';
  state.design.iv = (document.getElementById('design-iv') || {}).value || '';
  state.design.dv = (document.getElementById('design-dv') || {}).value || '';
  state.design.medmod = (document.getElementById('design-medmod') || {}).value || '';
  renderAnalysisPlan();
  renderAnalysisPlanData();
  scheduleSaveState();
}

function addRQ() {
  const id = 'RQ' + (state.rqs.length + 1);
  state.rqs.push({ id, text: '' });
  renderRQList();
  renderAnalysisPlan();
  renderAnalysisPlanData();
  scheduleSaveState();
}

function updateRQText(id, text) {
  const rq = state.rqs.find(r => r.id === id);
  if (rq) rq.text = text;
  scheduleSaveState();
}

function removeRQ(id) {
  state.rqs = state.rqs.filter(r => r.id !== id);
  delete state.analysisPlan[id];
  renderRQList();
  renderAnalysisPlan();
  renderAnalysisPlanData();
  scheduleSaveState();
}

function renderRQList() {
  const box = document.getElementById('rq-list');
  if (!box) return;
  box.innerHTML = '';
  if (state.rqs.length === 0) {
    box.innerHTML = '<p class="text-slate-400 text-[11px]">目前尚未新增 RQ。</p>';
    return;
  }
  state.rqs.forEach(rq => {
    const row = document.createElement('div');
    row.className = 'flex items-start gap-1';
    row.innerHTML = `
      <span class="mt-1 text-[11px] text-slate-500">${rq.id}</span>
      <textarea class="flex-1 px-2 py-1 rounded border border-slate-300 text-[11px] resize-none" rows="2">${escapeHtml(rq.text)}</textarea>
      <button class="px-1.5 py-1 rounded text-rose-500 text-[11px]" title="刪除"
        ><i class="fa-solid fa-trash-can"></i></button>
    `;
    const textarea = row.querySelector('textarea');
    textarea.addEventListener('input', () => updateRQText(rq.id, textarea.value));
    const btn = row.querySelector('button');
    btn.addEventListener('click', () => removeRQ(rq.id));
    box.appendChild(row);
  });
}

function addHypothesis() {
  const id = 'H' + (state.hypotheses.length + 1);
  state.hypotheses.push({ id, text: '' });
  renderHypothesisList();
  scheduleSaveState();
}

function updateHypothesisText(id, text) {
  const h = state.hypotheses.find(x => x.id === id);
  if (h) h.text = text;
  scheduleSaveState();
}

function removeHypothesis(id) {
  state.hypotheses = state.hypotheses.filter(h => h.id !== id);
  renderHypothesisList();
  scheduleSaveState();
}

function renderHypothesisList() {
  const box = document.getElementById('hypo-list');
  if (!box) return;
  box.innerHTML = '';
  if (state.hypotheses.length === 0) {
    box.innerHTML = '<p class="text-slate-400 text-[11px]">尚未新增假設。</p>';
    return;
  }
  state.hypotheses.forEach(h => {
    const row = document.createElement('div');
    row.className = 'flex items-start gap-1';
    row.innerHTML = `
      <span class="mt-1 text-[11px] text-slate-500">${h.id}</span>
      <textarea class="flex-1 px-2 py-1 rounded border border-slate-300 text-[11px] resize-none" rows="2">${escapeHtml(h.text)}</textarea>
      <button class="px-1.5 py-1 rounded text-rose-500 text-[11px]" title="刪除"
        ><i class="fa-solid fa-trash-can"></i></button>
    `;
    const textarea = row.querySelector('textarea');
    textarea.addEventListener('input', () => updateHypothesisText(h.id, textarea.value));
    const btn = row.querySelector('button');
    btn.addEventListener('click', () => removeHypothesis(h.id));
    box.appendChild(row);
  });
}

function renderAnalysisPlan() {
  const box = document.getElementById('analysis-plan');
  if (!box) return;
  box.innerHTML = '';
  if (state.rqs.length === 0) {
    box.innerHTML = '<p class="text-slate-400 text-[11px]">新增 RQ 後，可為每題指定分析方法。</p>';
    return;
  }
  state.rqs.forEach(rq => {
    if (!state.analysisPlan[rq.id]) {
      state.analysisPlan[rq.id] = { method: '', note: '' };
    }
    const conf = state.analysisPlan[rq.id];
    const row = document.createElement('div');
    row.className = 'border border-slate-200 rounded px-2 py-1.5 bg-white';
    row.innerHTML = `
      <div class="text-[11px] font-semibold mb-1">${escapeHtml(rq.id)}：${escapeHtml(rq.text || '')}</div>
      <div class="flex items-center gap-2 mb-1">
        <select class="px-2 py-1 rounded border border-slate-300 text-[11px]">
          <option value="">選擇分析方法</option>
          <option value="t-test">t test</option>
          <option value="anova">ANOVA</option>
          <option value="ancova">ANCOVA</option>
          <option value="mlr">多元迴歸 (MLR)</option>
          <option value="sem">SEM / 路徑分析</option>
          <option value="lmm">LMM / HLM</option>
          <option value="lca">LCA / LPA</option>
          <option value="qual">質性主題分析</option>
          <option value="mixed">混合方法</option>
        </select>
        <input type="text" class="flex-1 px-2 py-1 rounded border border-slate-300 text-[11px]"
               placeholder="補充說明（例如：2x2 混合設計 ANOVA）">
      </div>
    `;
    const sel = row.querySelector('select');
    const noteInput = row.querySelector('input');
    sel.value = conf.method || '';
    noteInput.value = conf.note || '';
    sel.addEventListener('change', () => {
      state.analysisPlan[rq.id].method = sel.value;
      scheduleSaveState();
    });
    noteInput.addEventListener('input', () => {
      state.analysisPlan[rq.id].note = noteInput.value;
      scheduleSaveState();
    });
    box.appendChild(row);
  });
}

function renderAnalysisPlanData() {
  const box = document.getElementById('analysis-plan-data');
  if (!box) return;
  box.innerHTML = '';
  if (state.rqs.length === 0) {
    box.innerHTML = '<p class="text-slate-400 text-[11px]">目前尚未設定 RQ。</p>';
    return;
  }
  state.rqs.forEach(rq => {
    const conf = state.analysisPlan[rq.id] || { method: '', note: '' };
    const row = document.createElement('div');
    row.className = 'border border-dashed border-slate-300 rounded px-2 py-1.5 bg-slate-50';
    row.innerHTML = `
      <div class="text-[11px] font-semibold mb-0.5">${escapeHtml(rq.id)}</div>
      <div class="text-[11px] text-slate-700 mb-0.5">${escapeHtml(rq.text || '')}</div>
      <div class="text-[11px] text-slate-500">
        分析方法：${conf.method || '尚未指定'}
        ${conf.note ? '｜備註：' + escapeHtml(conf.note) : ''}
      </div>
    `;
    box.appendChild(row);
  });
}

// =======================
// 數據區
// =======================
function handleDataRawUpload(e) {
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  state.dataMeta.rawFileName = file.name;
  scheduleSaveState();
}

function handleDataOutputUpload(e) {
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  state.dataMeta.outputFileName = file.name;
  scheduleSaveState();
}

function updateDataMeta() {
  const dn = document.getElementById('data-notes');
  state.dataMeta.notes = dn ? dn.value : '';
  scheduleSaveState();
}

// =======================
// 文獻上傳與顯示
// =======================
function handleLiteratureUpload(event) {
  const file = event.target.files && event.target.files[0];
  if (!file) return;

  const fileName = file.name || '';
  state.litFilesMeta.sourceFileName = fileName;

  const ext = fileName.split('.').pop().toLowerCase();
  const reader = new FileReader();

  reader.onload = function (ev) {
    try {
      const data = new Uint8Array(ev.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      if (!rows || rows.length < 2) {
        alert('無法解析文獻檔案：內容為空。');
        return;
      }

      const header = rows[0].map(x => String(x || '').trim().toLowerCase());
      const idxAuthor = header.findIndex(h => ['author', 'authors', 'au'].includes(h));
      const idxYear = header.findIndex(h => ['year', 'py'].includes(h));
      const idxTitle = header.findIndex(h => ['title', 'ti'].includes(h));
      const idxJournal = header.findIndex(h => ['journal', 'source', 'so'].includes(h));
      const idxDOI = header.findIndex(h => h === 'doi');

      const refs = [];
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i] || [];
        const author = idxAuthor >= 0 ? String(row[idxAuthor] || '').trim() : '';
        const year = idxYear >= 0 ? String(row[idxYear] || '').trim() : '';
        const title = idxTitle >= 0 ? String(row[idxTitle] || '').trim() : '';
        const journal = idxJournal >= 0 ? String(row[idxJournal] || '').trim() : '';
        const doi = idxDOI >= 0 ? String(row[idxDOI] || '').trim() : '';
        if (!author && !title) continue;
        refs.push({
          id: 'L' + (refs.length + 1),
          author,
          year,
          title,
          journal,
          doi
        });
      }

      state.referencePool = refs;
      const cnt = document.getElementById('lit-count');
      if (cnt) cnt.textContent = String(refs.length);
      renderLiteratureList();
      renderLiteraturePreview();
      scheduleSaveState();
    } catch (err) {
      console.error(err);
      alert('解析文獻檔案時發生錯誤：' + (err.message || err));
    }
  };

  reader.readAsArrayBuffer(file);
}

function renderLiteratureList() {
  const box = document.getElementById('lit-list');
  if (!box) return;
  const searchEl = document.getElementById('lit-search');
  const keyword = (searchEl ? searchEl.value : '').toLowerCase().trim();

  let refs = state.referencePool;
  if (keyword) {
    refs = refs.filter(r => {
      const s = (r.author + ' ' + r.title + ' ' + r.journal + ' ' + r.year).toLowerCase();
      return s.includes(keyword);
    });
  }

  box.innerHTML = '';
  if (!refs.length) {
    box.innerHTML = '<p class="text-slate-400 text-[11px]">尚無文獻或無符合搜尋結果。</p>';
    return;
  }

  refs.forEach(r => {
    const div = document.createElement('div');
    div.className = 'mb-1 pb-1 border-b border-slate-200 last:border-b-0 last:pb-0';
    const citeLabel = r.author ? `${r.author} (${r.year || 'n.d.'})` : `(${r.year || 'n.d.'})`;
    div.innerHTML = `
      <div class="flex items-start gap-1">
        <div class="flex-1">
          <div class="font-semibold text-[11px]">${escapeHtml(citeLabel)}</div>
          <div class="text-[11px] text-slate-700">${escapeHtml(r.title || '')}</div>
          <div class="text-[10px] text-slate-500">${escapeHtml(r.journal || '')}${r.doi ? '｜DOI: ' + escapeHtml(r.doi) : ''}</div>
        </div>
        <button class="ml-1 px-2 py-1 rounded bg-emerald-600 text-white text-[10px] h-fit"
          onclick="insertCitation('${r.id}')">
          引用
        </button>
      </div>
    `;
    box.appendChild(div);
  });
}

function renderLiteraturePreview() {
  const tbody = document.getElementById('lit-preview-body');
  if (!tbody) return;
  tbody.innerHTML = '';
  state.referencePool.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.className = idx % 2 === 0 ? 'bg-white' : 'bg-slate-50';
    tr.innerHTML = `
      <td class="px-2 py-1 align-top">${idx + 1}</td>
      <td class="px-2 py-1 align-top">${escapeHtml(r.author || '')}</td>
      <td class="px-2 py-1 align-top">${escapeHtml(r.year || '')}</td>
      <td class="px-2 py-1 align-top">${escapeHtml(r.title || '')}</td>
      <td class="px-2 py-1 align-top">${escapeHtml(r.journal || '')}</td>
    `;
    tbody.appendChild(tr);
  });
}

function insertCitation(refId) {
  const ref = state.referencePool.find(r => r.id === refId);
  if (!ref) return;
  const cite = ref.author ? `${ref.author.split(',')[0]} (${ref.year || 'n.d.'})` : `(${ref.year || 'n.d.'})`;

  const ed = getCurrentEditor();
  if (!ed) return;
  const start = ed.selectionStart;
  const end = ed.selectionEnd;
  const text = ed.value;
  const insertText = ` (${cite})`;
  ed.value = text.slice(0, start) + insertText + text.slice(end);
  ed.focus();
  const caret = start + insertText.length;
  ed.setSelectionRange(caret, caret);

  onChapterInput(state.currentChapter, ed.value);
  state.usedCitationIds.add(refId);
  scheduleSaveState();
}

function generateReferencesSection() {
  if (!state.usedCitationIds.size) {
    alert('目前尚未在正文插入任何引用。');
    return;
  }
  const selectedIds = Array.from(state.usedCitationIds);
  const selected = state.referencePool.filter(r => selectedIds.includes(r.id));

  selected.sort((a, b) => {
    const aKey = (a.author || '') + (a.year || '');
    const bKey = (b.author || '') + (b.year || '');
    return aKey.localeCompare(bKey);
  });

  const lines = selected.map(r => {
    const parts = [];
    if (r.author) parts.push(r.author);
    if (r.year) parts.push(`(${r.year}).`);
    if (r.title) parts.push(r.title + '.');
    if (r.journal) parts.push(r.journal + '.');
    if (r.doi) parts.push('https://doi.org/' + r.doi);
    return parts.join(' ');
  });

  const sectionText = '\n\nReferences\n' + lines.join('\n');
  state.chapters.fullpaper = (state.chapters.fullpaper || '') + sectionText;

  if (state.currentChapter === 'fullpaper') {
    const ed = getCurrentEditor();
    if (ed) ed.value = state.chapters.fullpaper;
  }

  updateWordCounts();
  scheduleSaveState();
  alert('已將 References 追加至「全文整合」章節的末尾。');
}

async function syncLiteratureToBackend() {
  const res = await callBackend('/syncReferences', {
    projectId: state.projectId,
    referencePool: state.referencePool
  });
  if (!res.ok) {
    alert('同步失敗：' + (res.error || '未知錯誤'));
    return;
  }
  const msg = res.data && res.data.message ? res.data.message : '已送出文獻庫。';
  alert(msg);
}

// =======================
// 快照 / 版本
// =======================
function createSnapshot() {
  const id = 'S' + Date.now();
  const label = new Date().toLocaleString('zh-TW', { hour12: false });
  const snapshot = {
    id,
    label,
    chapter: state.currentChapter,
    createdAt: Date.now(),
    chapters: Object.assign({}, state.chapters)
  };
  state.snapshots.unshift(snapshot);
  if (state.snapshots.length > 20) {
    state.snapshots.pop();
  }
  renderSnapshotList();
  scheduleSaveState();
}

function renderSnapshotList() {
  const box = document.getElementById('snapshot-list');
  if (!box) return;
  box.innerHTML = '';
  if (!state.snapshots.length) {
    box.innerHTML = '<p class="text-slate-400 text-[10px]">尚未建立快照。</p>';
    return;
  }
  state.snapshots.forEach(s => {
    const btn = document.createElement('button');
    btn.className = 'w-full text-left px-2 py-0.5 rounded border border-slate-200 bg-white hover:bg-slate-100';
    btn.textContent = `${s.label}｜章節：${s.chapter}`;
    btn.addEventListener('click', () => restoreSnapshot(s.id));
    box.appendChild(btn);
  });
}

function restoreSnapshot(id) {
  const s = state.snapshots.find(x => x.id === id);
  if (!s) return;
  state.chapters = Object.assign({}, s.chapters || {});
  const sel = document.getElementById('chapter-select');
  if (sel) {
    sel.value = s.chapter || 'outline';
  }
  state.currentChapter = s.chapter || 'outline';
  switchChapter();
  updateWordCounts();
  scheduleSaveState();
}

// =======================
// Checklist（章節待辦）
// =======================
function initChecklist() {
  updateChecklistForChapter(state.currentChapter || 'outline');
}

function updateChecklistForChapter(chKey) {
  const box = document.getElementById('chapter-checklist');
  if (!box) return;
  const itemsByChapter = {
    outline: [
      '列出研究背景、核心問題與章節架構。',
      '確認與目標期刊 scope 的對應關係。'
    ],
    intro: [
      '清楚說明研究情境與問題重要性。',
      '交代理論與實務 gap，收束到本研究目的。',
      '適度引用近五年 SSCI 文獻支持問題意義。'
    ],
    lit_review: [
      '分段整理理論脈絡、重要概念與實證研究。',
      '強調各研究的貢獻與限制，導出研究缺口。',
      '文內引用全部來自系統文獻池（referencePool）。'
    ],
    method: [
      '交代研究設計、對象、工具、程序與分析方法。',
      '說明信效度與研究倫理（IRB / 同意程序）。',
      '分析方法需能回應每一題 RQ 與假設。'
    ],
    results: [
      '依序回應各 RQ，呈現主要統計指標。',
      '表格與文字敘述一致，標註 N、M、SD、p 等。',
      '避免把討論內容提前寫入本節。'
    ],
    discussion: [
      '將結果與研究問題與既有文獻連結。',
      '說明意外結果與可能原因。',
      '加入理論層面的詮釋與實務意涵。'
    ]
  };
  const list = itemsByChapter[chKey] || itemsByChapter.outline;
  box.innerHTML = list.map(t => `<div class="flex items-start gap-1 text-[11px] text-slate-700">
    <span class="mt-0.5 text-emerald-500"><i class="fa-regular fa-square"></i></span>
    <span>${escapeHtml(t)}</span>
  </div>`).join('');
}

// =======================
// AI 功能（寫作／Reviewer）
// =======================
function appendChatMessage(role, text) {
  const panel = document.getElementById('chat-panel');
  if (!panel) return;
  const div = document.createElement('div');
  const baseClass = 'px-2 py-1.5 rounded text-[11px] whitespace-pre-wrap';
  if (role === 'user') {
    div.className = baseClass + ' bg-slate-200 text-slate-800';
  } else if (role === 'assistant') {
    div.className = baseClass + ' bg-indigo-50 text-slate-800 border border-indigo-200';
  } else {
    div.className = baseClass + ' bg-amber-50 text-slate-800 border border-amber-200';
  }
  div.textContent = text;
  panel.appendChild(div);
  panel.scrollTop = panel.scrollHeight;
}

async function generateChapterDraft() {
  const chapterKey = state.currentChapter;
  const res = await callBackend('/generateChapter', {
    lang: state.lang,
    stylePreset: state.stylePreset,
    chapterKey,
    chapterText: state.chapters[chapterKey] || '',
    projectMeta: state.projectMeta,
    design: state.design,
    rqs: state.rqs,
    hypotheses: state.hypotheses,
    analysisPlan: state.analysisPlan,
    referencePool: state.referencePool
  });
  if (!res.ok) {
    appendChatMessage('system', '生成章節草稿失敗：' + (res.error || '未知錯誤'));
    return;
  }
  const text = (res.data && res.data.text) || '';
  state.chapters[chapterKey] = text;
  const ed = getCurrentEditor();
  if (ed) ed.value = text;
  updateWordCounts();
  scheduleSaveState();
  appendChatMessage('assistant', '已更新本章草稿（Mock/或後端生成結果已寫回 editor）。');
}

async function runReviewerMode() {
  const chapterKey = state.currentChapter;
  const res = await callBackend('/reviewChapter', {
    lang: state.lang,
    stylePreset: state.stylePreset,
    chapterKey,
    chapterText: state.chapters[chapterKey] || '',
    projectMeta: state.projectMeta,
    design: state.design
  });
  if (!res.ok) {
    appendChatMessage('system', 'Reviewer 模式失敗：' + (res.error || '未知錯誤'));
    return;
  }
  const data = res.data || {};
  const lines = [];
  if (data.summary) lines.push(data.summary);
  if (Array.isArray(data.comments)) lines.push('', ...data.comments);
  appendChatMessage('assistant', lines.join('\n'));
}

async function runAutoCitationForCurrentChapter() {
  const chapterKey = state.currentChapter;
  const res = await callBackend('/autoCiteChapter', {
    lang: state.lang,
    chapterKey,
    chapterText: state.chapters[chapterKey] || '',
    referencePool: state.referencePool
  });
  if (!res.ok) {
    appendChatMessage('system', '自動配文獻失敗：' + (res.error || '未知錯誤'));
    return;
  }
  const text = (res.data && res.data.text) || '';
  state.chapters[chapterKey] = text;
  const ed = getCurrentEditor();
  if (ed) ed.value = text;
  updateWordCounts();
  scheduleSaveState();
  appendChatMessage('assistant', '已對本章進行示意性的引用標記。');
}

async function sendAIMessage() {
  const input = document.getElementById('ai-input');
  if (!input) return;
  const prompt = input.value.trim();
  if (!prompt) {
    // 若沒輸入，自動視為請 AI 給本章改寫建議
    input.value = '';
    return generateChapterDraft();
  }
  appendChatMessage('user', prompt);
  input.value = '';

  const res = await callBackend('/chat', {
    lang: state.lang,
    stylePreset: state.stylePreset,
    chapterKey: state.currentChapter,
    chapterText: state.chapters[state.currentChapter] || '',
    projectMeta: state.projectMeta,
    design: state.design,
    prompt
  });
  if (!res.ok) {
    appendChatMessage('system', 'AI 回覆失敗：' + (res.error || '未知錯誤'));
    return;
  }
  const reply = (res.data && res.data.reply) || '[AI 無回應內容]';
  appendChatMessage('assistant', reply);
}

// =======================
// AI：Method / Results
// =======================
async function generateMethodDraft() {
  const res = await callBackend('/methodDraft', {
    lang: state.lang,
    stylePreset: state.stylePreset,
    design: state.design,
    rqs: state.rqs,
    hypotheses: state.hypotheses,
    analysisPlan: state.analysisPlan
  });
  if (!res.ok) {
    alert('生成方法章節失敗：' + (res.error || '未知錯誤'));
    return;
  }
  const text = (res.data && res.data.text) || '';
  state.chapters.method = (state.chapters.method || '') + '\n\n' + text;
  if (state.currentChapter === 'method') {
    const ed = getCurrentEditor();
    if (ed) ed.value = state.chapters.method;
  }
  updateWordCounts();
  scheduleSaveState();
}

async function generateResultsDraft() {
  const res = await callBackend('/resultsDraft', {
    lang: state.lang,
    stylePreset: state.stylePreset,
    design: state.design,
    dataMeta: state.dataMeta,
    chapters: state.chapters
  });
  if (!res.ok) {
    alert('生成結果章節失敗：' + (res.error || '未知錯誤'));
    return;
  }
  const text = (res.data && res.data.text) || '';
  state.chapters.results = (state.chapters.results || '') + '\n\n' + text;
  if (state.currentChapter === 'results') {
    const ed = getCurrentEditor();
    if (ed) ed.value = state.chapters.results;
  }
  updateWordCounts();
  scheduleSaveState();
}

// =======================
// 期刊適配＆品質倫理檢查
// =======================
async function runManuscriptFitCheck() {
  const jp = state.journalProfiles[state.projectMeta.journalKey] || null;
  const res = await callBackend('/fitCheck', {
    lang: state.lang,
    projectMeta: state.projectMeta,
    design: state.design,
    chapters: state.chapters,
    journalProfile: jp
  });
  if (!res.ok) {
    alert('期刊適配檢查失敗：' + (res.error || '未知錯誤'));
    return;
  }
  const summary = (res.data && res.data.summary) || '無回傳內容。';
  appendChatMessage('system', summary);
}

async function runQualityCheck() {
  const res = await callBackend('/qualityCheck', {
    lang: state.lang,
    projectMeta: state.projectMeta,
    design: state.design,
    chapters: state.chapters
  });
  if (!res.ok) {
    alert('品質＆倫理檢查失敗：' + (res.error || '未知錯誤'));
    return;
  }
  const summary = (res.data && res.data.summary) || '無回傳內容。';
  appendChatMessage('system', summary);
}

// =======================
// 投稿包區塊
// =======================
function restoreSubmissionUI() {
  const c = document.getElementById('sub-cover-letter');
  const r = document.getElementById('sub-response');
  const n = document.getElementById('sub-notes');
  if (c) c.value = state.submission.coverLetter || '';
  if (r) r.value = state.submission.response || '';
  if (n) n.value = state.submission.notes || '';

  if (c) c.addEventListener('input', () => {
    state.submission.coverLetter = c.value;
    scheduleSaveState();
  });
  if (r) r.addEventListener('input', () => {
    state.submission.response = r.value;
    scheduleSaveState();
  });
  if (n) n.addEventListener('input', () => {
    state.submission.notes = n.value;
    scheduleSaveState();
  });
}

async function generateCoverLetter() {
  const res = await callBackend('/generateCoverLetter', {
    lang: state.lang,
    stylePreset: state.stylePreset,
    projectMeta: state.projectMeta,
    journalProfile: state.journalProfiles[state.projectMeta.journalKey] || null
  });
  if (!res.ok) {
    alert('生成 Cover Letter 失敗：' + (res.error || '未知錯誤'));
    return;
  }
  const text = (res.data && res.data.text) || '';
  state.submission.coverLetter = text;
  const c = document.getElementById('sub-cover-letter');
  if (c) c.value = text;
  scheduleSaveState();
}

async function generateResponseToReviewers() {
  const res = await callBackend('/generateResponseToReviewers', {
    lang: state.lang,
    stylePreset: state.stylePreset,
    projectMeta: state.projectMeta,
    journalProfile: state.journalProfiles[state.projectMeta.journalKey] || null,
    responseDraft: state.submission.response || ''
  });
  if (!res.ok) {
    alert('生成 Response to Reviewers 失敗：' + (res.error || '未知錯誤'));
    return;
  }
  const text = (res.data && res.data.text) || '';
  state.submission.response = text;
  const r = document.getElementById('sub-response');
  if (r) r.value = text;
  scheduleSaveState();
}

function appendSubmissionSummaryToChat() {
  const parts = [];
  parts.push('投稿包總覽：');
  if (state.submission.coverLetter) parts.push('\n[Cover Letter]\n' + state.submission.coverLetter.slice(0, 800) + (state.submission.coverLetter.length > 800 ? '\n……' : ''));
  if (state.submission.response) parts.push('\n[Response to Reviewers]\n' + state.submission.response.slice(0, 800) + (state.submission.response.length > 800 ? '\n……' : ''));
  if (state.submission.notes) parts.push('\n[投稿備註]\n' + state.submission.notes);
  appendChatMessage('user', parts.join('\n'));
}

// =======================
// 完成
// =======================
</script>
</body>
</html>
