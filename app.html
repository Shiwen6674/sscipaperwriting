<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ScholarCraft v2 | SSCI 論文寫作神器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- xlsx for WoS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .serif { font-family: 'Noto Serif TC', serif; }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
    .scroll-thin::-webkit-scrollbar { width: 6px; }
    .scroll-thin::-webkit-scrollbar-thumb { background:#cbd5e1;border-radius:3px; }
    .scroll-thin::-webkit-scrollbar-thumb:hover { background:#94a3b8; }
    .prose-area p { margin-bottom: 0.75rem; line-height: 1.8; text-align: justify; }
    .prose-area h2 { margin-top: 1.5rem; margin-bottom: 0.75rem; font-size: 1.1rem; font-weight: 700; }
    .prose-area h3 { margin-top: 1.25rem; margin-bottom: 0.5rem; font-size: 1rem; font-weight: 600; color:#4338ca;}
  </style>
</head>
<body class="bg-slate-100 h-screen flex overflow-hidden">

<!-- Sidebar -->
<aside class="w-72 bg-slate-900 text-slate-100 flex flex-col">
  <div class="px-5 py-4 border-b border-slate-700 flex items-center justify-between">
    <div>
      <div class="flex items-center gap-2">
        <i class="fa-solid fa-graduation-cap text-indigo-400"></i>
        <span class="font-semibold tracking-wide">ScholarCraft v2</span>
      </div>
      <p class="text-xs text-slate-400 mt-1">SSCI Q1 Writing Workstation</p>
    </div>
    <div class="text-[10px] px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">
      BETA
    </div>
  </div>

  <!-- Project / Journal quick info -->
  <div class="px-4 py-3 border-b border-slate-800 text-xs space-y-2">
    <div>
      <label class="text-slate-400">目前專案</label>
      <div id="sidebar-project-name" class="font-semibold truncate">未命名專案</div>
    </div>
    <div class="flex items-center justify-between">
      <div>
        <span class="text-slate-400">目標期刊</span>
        <div id="sidebar-journal" class="text-[11px] text-indigo-300 truncate">未設定</div>
      </div>
      <div class="flex flex-col items-end">
        <span class="text-slate-400">語氣風格</span>
        <select id="style-preset" class="mt-0.5 bg-slate-800 text-[11px] px-2 py-1 rounded border border-slate-600 focus:outline-none"
                onchange="updateStylePreset()">
          <option value="conservative">保守</option>
          <option value="balanced" selected>平衡</option>
          <option value="assertive">較強</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Nav -->
  <nav class="flex-1 overflow-y-auto scroll-thin px-3 py-3 space-y-1 text-sm">
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="project" onclick="switchTab('project')">
      <i class="fa-solid fa-diagram-project w-4 text-center"></i><span>1. 專案＆期刊</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="design" onclick="switchTab('design')">
      <i class="fa-solid fa-flask w-4 text-center"></i><span>2. 研究設計</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="literature" onclick="switchTab('literature')">
      <i class="fa-solid fa-book-open w-4 text-center"></i><span>3. 文獻＆引用</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="data" onclick="switchTab('data')">
      <i class="fa-solid fa-chart-column w-4 text-center"></i><span>4. 數據＆分析</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="writing" onclick="switchTab('writing')">
      <i class="fa-solid fa-pen-nib w-4 text-center"></i><span>5. 寫作＆Reviewer</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="submission" onclick="switchTab('submission')">
      <i class="fa-solid fa-envelope-open-text w-4 text-center"></i><span>6. 投稿包</span>
    </button>
  </nav>

  <!-- User -->
  <div class="px-4 py-3 border-t border-slate-800 flex items-center gap-3 text-xs">
    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-fuchsia-500 flex items-center justify-center font-bold text-[11px]">
      U
    </div>
    <div class="flex-1">
      <div class="font-semibold">SSCI 作者</div>
      <div class="text-slate-400 text-[11px]">Local project · Auto-save</div>
    </div>
  </div>
</aside>

<!-- Main -->
<main class="flex-1 flex flex-col">

  <!-- Header -->
  <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6">
    <div>
      <h1 id="main-title" class="text-sm font-semibold text-slate-700">專案＆期刊設定</h1>
      <p id="main-subtitle" class="text-xs text-slate-400">從期刊開始，決定整篇論文的遊戲規則。</p>
    </div>
    <div class="flex items-center gap-3 text-[11px]">
      <button class="px-3 py-1 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100"
              onclick="runManuscriptFitCheck()">
        <i class="fa-solid fa-magnifying-glass-chart mr-1"></i>期刊適配檢查
      </button>
      <button class="px-3 py-1 rounded-full border border-emerald-400 text-emerald-600 hover:bg-emerald-50"
              onclick="runQualityCheck()">
        <i class="fa-solid fa-shield-heart mr-1"></i>品質＆倫理檢查
      </button>
    </div>
  </header>

  <!-- Content Tabs -->
  <section class="flex-1 overflow-hidden">
    <div class="h-full overflow-y-auto scroll-thin p-4 space-y-4">

      <!-- TAB: Project -->
      <div id="tab-project" class="space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-diagram-project text-indigo-500"></i> 專案基本資訊
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">專案名稱</label>
              <input id="project-title" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     placeholder="例如：Generative AI in PBL for SSI Argumentation"
                     oninput="updateProjectMeta()">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">領域</label>
              <input id="project-field" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     placeholder="Science education / AI in education"
                     oninput="updateProjectMeta()">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">預定投稿年份</label>
              <input id="project-year" type="number"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     value="2025" oninput="updateProjectMeta()">
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-newspaper text-indigo-500"></i> 目標期刊設定
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">目標期刊</label>
              <select id="journal-select"
                      class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                      onchange="updateJournalProfile()">
              </select>
              <p class="text-[11px] text-slate-400 mt-1">
                可在程式中擴充 journalProfiles 物件，加入常用期刊。
              </p>
            </div>
            <div class="text-xs space-y-1" id="journal-profile-summary">
              <!-- filled by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Design -->
      <div id="tab-design" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-flask text-emerald-500"></i> 研究設計總覽
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">研究類型</label>
              <select id="design-type" class="w-full px-2 py-1.5 rounded border border-slate-300"
                      onchange="updateResearchDesign()">
                <option value="">請選擇</option>
                <option value="quant">量化實證</option>
                <option value="qual">質性研究</option>
                <option value="mixed">混合方法</option>
                <option value="review">系統性回顧/文獻分析</option>
              </select>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">研究情境 / 場域</label>
              <input id="design-context" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：台灣國中理化課室"
                     oninput="updateResearchDesign()">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">樣本概況（N、年級）</label>
              <input id="design-sample" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：兩校共 200 名國二學生"
                     oninput="updateResearchDesign()">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">研究工具 / 量表</label>
              <input id="design-instruments" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：論證能力量表、AI 使用問卷"
                     oninput="updateResearchDesign()">
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-question-circle text-indigo-500"></i> 研究問題 & 假設
            </h2>
            <div class="space-x-1 text-[11px]">
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                      onclick="addRQ()">+ RQ</button>
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                      onclick="addHypothesis()">+ H</button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
            <div>
              <h3 class="font-semibold text-slate-700 text-xs mb-1">Research Questions</h3>
              <div id="rq-list" class="space-y-1"></div>
            </div>
            <div>
              <h3 class="font-semibold text-slate-700 text-xs mb-1">Hypotheses</h3>
              <div id="hypo-list" class="space-y-1"></div>
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-sitemap text-fuchsia-500"></i> 變項＆分析對應
            </h2>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="generateMethodDraft()">
              <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成方法草稿（AI）
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">自變項 (IV)</label>
              <input id="design-iv" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     oninput="updateResearchDesign()">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">依變項 (DV)</label>
              <input id="design-dv" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     oninput="updateResearchDesign()">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">中介 / 調節</label>
              <input id="design-medmod" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="Learning motivation (M), Gender (Mod)…"
                     oninput="updateResearchDesign()">
            </div>
          </div>
          <div class="mt-3">
            <h3 class="font-semibold text-slate-700 text-xs mb-1">每個 RQ 對應的分析方法</h3>
            <div id="analysis-plan" class="space-y-2 text-xs"></div>
          </div>
        </div>
      </div>

      <!-- TAB: Literature -->
      <div id="tab-literature" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 flex flex-col md:flex-row gap-4">
          <!-- Upload & summary -->
          <div class="md:w-1/2 space-y-3 text-xs">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-file-import text-emerald-500"></i> 文獻庫（WoS/Scopus 匯入）
            </h2>
            <label class="block">
              <span class="text-slate-500 mb-1 block">上傳 Excel/CSV</span>
              <input id="lit-file" type="file" accept=".xlsx,.xls,.csv"
                     class="text-xs" onchange="handleLiteratureUpload(event)">
            </label>
            <p class="text-[11px] text-slate-500">
              系統會解析 Author, Year, Title, Journal, DOI 等欄位，形成文獻庫。
            </p>
            <div class="flex items-center gap-2">
              <span class="text-slate-500">目前文獻數：</span>
              <span id="lit-count" class="px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 text-[11px]">0</span>
            </div>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="syncLiteratureToBackend()">
              <i class="fa-solid fa-cloud-arrow-up mr-1"></i>同步文獻庫到後端
            </button>
          </div>

          <!-- Citation search / insert -->
          <div class="md:w-1/2 space-y-2 text-xs">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-quote-right text-fuchsia-500"></i> 引文搜尋＆插入
            </h2>
            <input id="lit-search" type="text"
                   class="w-full px-2 py-1.5 rounded border border-slate-300"
                   placeholder="輸入 author / keyword 搜尋"
                   oninput="renderLiteratureList()">
            <div id="lit-list" class="max-h-52 overflow-y-auto scroll-thin border border-slate-200 rounded p-2 bg-slate-50 text-[11px]">
              <!-- items -->
            </div>
            <button class="mt-2 px-3 py-1 rounded-full bg-emerald-600 text-white text-[11px] hover:bg-emerald-700"
                    onclick="generateReferencesSection()">
              <i class="fa-solid fa-list-check mr-1"></i>生成 References（僅限實際引用）
            </button>
            <p class="text-[10px] text-slate-400">
              引文會在正文以 (Author, Year) 插入，並記錄於 usedCitations。
            </p>
          </div>
        </div>

        <!-- Preview -->
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-database text-slate-500"></i> 文獻庫預覽（前 20 筆）
          </h2>
          <div class="max-h-60 overflow-y-auto scroll-thin border border-slate-200 rounded bg-white">
            <table class="w-full text-[11px]">
              <thead class="bg-slate-50 text-slate-500">
              <tr>
                <th class="px-2 py-1 text-left">#</th>
                <th class="px-2 py-1 text-left">Author</th>
                <th class="px-2 py-1 text-left">Year</th>
                <th class="px-2 py-1 text-left">Title</th>
                <th class="px-2 py-1 text-left">Journal</th>
              </tr>
              </thead>
              <tbody id="lit-preview-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB: Data -->
      <div id="tab-data" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-chart-column text-indigo-500"></i> 數據檔案＆分析輸出
            </h2>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="generateResultsDraft()">
              <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成結果草稿（AI）
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="block text-slate-500 mb-1">上傳原始數據（選用）</label>
              <input id="data-raw-file" type="file" accept=".xlsx,.csv,.sav" class="text-[11px]">
              <p class="text-[10px] text-slate-400 mt-1">建議仍以本地統計軟體分析，本系統偏向協助撰寫。</p>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">上傳分析輸出（表格/結果摘要）</label>
              <input id="data-output-file" type="file" accept=".xlsx,.csv,.txt,.docx,.pdf" class="text-[11px]">
              <p class="text-[10px] text-slate-400 mt-1">可上傳整理後的分析表格，後端可進一步解析。</p>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">分析摘要備註</label>
              <textarea id="data-notes" rows="3"
                        class="w-full px-2 py-1.5 rounded border border-slate-300"
                        placeholder="簡要說明你做了哪些統計分析，例如：2x2 混合設計 ANOVA, MLR, LCA…"
                        oninput="updateDataMeta()"></textarea>
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-diagram-next text-emerald-500"></i> 每個 RQ 對應的分析計畫
          </h2>
          <p class="text-[11px] text-slate-500 mb-2">
            下方內容會自動從「研究設計」頁的 RQ 產生，你可以為每個 RQ 選一種主要分析方法。
          </p>
          <div id="analysis-plan-data" class="space-y-2"></div>
        </div>
      </div>

      <!-- TAB: Writing -->
      <div id="tab-writing" class="hidden space-y-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-[calc(100vh-6rem)]">
          <!-- AI Coach -->
          <div class="glass rounded-xl border border-slate-200 flex flex-col text-xs">
            <div class="px-3 py-2 border-b border-slate-200 bg-gradient-to-r from-indigo-600 to-indigo-700 text-slate-50">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i class="fa-solid fa-robot"></i>
                  <span class="font-semibold text-[12px]">SSCI AI Coach / Reviewer</span>
                </div>
                <span id="current-chapter-label" class="text-[11px] bg-slate-900/30 px-2 py-0.5 rounded-full">
                  Intro
                </span>
              </div>
            </div>
            <div class="p-2 border-b border-slate-200 bg-slate-50 text-[11px]" id="chapter-checklist">
              <!-- filled by JS -->
            </div>
            <div id="chat-panel" class="flex-1 overflow-y-auto scroll-thin p-2 space-y-2 bg-slate-50">
              <!-- chat messages -->
            </div>
            <div class="border-t border-slate-200 p-2 space-y-1">
              <div class="flex items-center gap-1 mb-1">
                <button class="flex-1 px-2 py-1 rounded bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                        onclick="generateChapterDraft()">
                  <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成本章草稿
                </button>
                <button class="px-2 py-1 rounded border border-rose-400 text-rose-600 text-[11px] hover:bg-rose-50"
                        onclick="runReviewerMode()">
                  <i class="fa-solid fa-gavel mr-1"></i>Reviewer 模式
                </button>
              </div>
              <div class="relative">
                <textarea id="ai-input" rows="2"
                          class="w-full px-2 pr-8 py-1.5 rounded border border-slate-300 text-[11px]"
                          placeholder="輸入額外指令（可留白，直接生成）"
                          onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendAIMessage();}">
                </textarea>
                <button class="absolute right-1 bottom-1.5 p-1.5 rounded bg-indigo-600 text-white text-[10px]"
                        onclick="sendAIMessage()">
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Chapter / Editor -->
          <div class="lg:col-span-2 glass rounded-xl border border-slate-200 flex flex-col">
            <div class="px-3 py-2 border-b border-slate-200 flex items-center gap-2 text-[11px]">
              <label class="text-slate-500">章節</label>
              <select id="chapter-select" class="px-2 py-1 rounded border border-slate-300"
                      onchange="switchChapter()">
                <option value="outline">0. 論文大綱</option>
                <option value="intro">1. 緒論</option>
                <option value="lit_review">2. 文獻探討</option>
                <option value="method">3. 研究方法</option>
                <option value="results">4. 研究結果</option>
                <option value="discussion">5. 討論</option>
                <option value="conclusion">6. 結論</option>
                <option value="implications">7. 教育意涵</option>
                <option value="limitations">8. 限制與未來研究</option>
                <option value="abstract">9. 摘要</option>
                <option value="fullpaper">10. 全文整合</option>
              </select>
              <div class="flex-1"></div>
              <div class="flex items-center gap-2">
                <span id="chapter-word-count" class="text-slate-500">本章字數：0</span>
                <span id="total-word-count" class="text-slate-400">全文字數：0</span>
              </div>
              <button class="px-2 py-1 rounded-full border border-slate-300 text-[11px] hover:bg-slate-100"
                      onclick="exportAsDocx()">
                <i class="fa-solid fa-download mr-1"></i>匯出 Word
              </button>
            </div>
            <div id="chapter-editor" class="flex-1 overflow-y-auto scroll-thin p-4 prose-area serif"
                 contenteditable="true" oninput="updateWordCounts()">
              <!-- 章節內容會以 projectState.chapters[...] 初始化 -->
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Submission -->
      <div id="tab-submission" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs space-y-3">
          <h2 class="font-semibold text-slate-800 text-sm mb-1 flex items-center gap-2">
            <i class="fa-solid fa-envelope-open-text text-indigo-500"></i> 投稿包生成器
          </h2>
          <p class="text-[11px] text-slate-500">
            這裡針對整篇稿件與期刊 profile，生成 cover letter、highlight、response template 等必備文件。
          </p>
          <div class="flex flex-wrap gap-2">
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="generateCoverLetter()">
              <i class="fa-solid fa-file-signature mr-1"></i>Cover Letter
            </button>
            <button class="px-3 py-1 rounded-full bg-emerald-600 text-white text-[11px] hover:bg-emerald-700"
                    onclick="generateHighlights()">
              <i class="fa-solid fa-lightbulb mr-1"></i>Highlights
            </button>
            <button class="px-3 py-1 rounded-full bg-fuchsia-600 text-white text-[11px] hover:bg-fuchsia-700"
                    onclick="generateResponseTemplate()">
              <i class="fa-solid fa-reply-all mr-1"></i>Response to Reviewers
            </button>
          </div>
        </div>
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2">生成結果</h2>
          <textarea id="submission-output" rows="18"
                    class="w-full px-2 py-1.5 rounded border border-slate-300 font-mono text-[11px]"
                    placeholder="生成的 cover letter / highlights / response template 將顯示於此，可自行複製編修。"></textarea>
        </div>
      </div>

      <!-- Fit & Quality panel (結果在這裡顯示) -->
      <div id="fit-quality-panel" class="hidden glass rounded-xl border border-slate-200 p-4 text-xs">
        <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
          <i class="fa-solid fa-triangle-exclamation text-amber-500"></i> 品質＆期刊適配報告
        </h2>
        <div id="fit-quality-body" class="space-y-1 text-[11px]"></div>
      </div>

    </div>
  </section>
</main>

<script>
  // ========= CONFIG =========
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxzuSB40CJ_8VgEG5HsZR0QBqShK5TMKQAHHkQf_ww4gGy90uWZUoLjiuwbBpT4BkJoKQ/exec";

  // ========= STATE =========
  const journalProfiles = {
    "TAPER": {
      id: "TAPER",
      name: "Asia-Pacific Education Researcher",
      scope: "Education research, particularly Asia-Pacific context.",
      wordLimit: 8000,
      style: "APA7",
      notes: "偏重實證與理論連結，強調方法嚴謹。"
    },
    "PalliativeMed": {
      id: "PalliativeMed",
      name: "Palliative Medicine",
      scope: "Palliative care, good death, end-of-life research.",
      wordLimit: 5000,
      style: "Vancouver / modified",
      notes: "重視臨床與文化敏感度，方法與倫理敘述需完整。"
    },
    "SciEduc": {
      id: "SciEduc",
      name: "Science Education",
      scope: "High-impact science education research.",
      wordLimit: 10000,
      style: "APA7",
      notes: "理論含量要求高，對方法與統計報告極為嚴格。"
    }
  };

  const defaultChapters = {
    outline: "",
    intro: "",
    lit_review: "",
    method: "",
    results: "",
    discussion: "",
    conclusion: "",
    implications: "",
    limitations: "",
    abstract: "",
    fullpaper: ""
  };

  const chapterChecklists = {
    outline: [
      "清楚列出主要段落與邏輯順序？",
      "每個章節是否對應一組清楚的研究目的／問題？"
    ],
    intro: [
      "是否說明了宏觀問題與具體情境？",
      "是否界定清楚研究缺口與必要性？",
      "是否明確寫出研究目的與研究問題？"
    ],
    lit_review: [
      "是否以主題（非逐篇）整合文獻？",
      "是否清楚連結到研究缺口與本研究定位？",
      "是否適當引用目標期刊相關研究？"
    ],
    method: [
      "是否交代研究設計、樣本、工具、程序、分析？",
      "是否對信效度與倫理做出足夠交代？"
    ],
    results: [
      "是否依 RQ 結構報告結果？",
      "是否報告 effect size 與必要統計資訊？"
    ],
    discussion: [
      "是否回到研究問題逐一討論？",
      "是否與關鍵文獻對話，而非只重述結果？"
    ],
    conclusion: [
      "是否聚焦於最核心的結論，而非重寫摘要？",
      "是否避免過度推論與誇大？"
    ],
    implications: [
      "是否分別就理論／實務／政策提出具體意涵？",
      "是否避免與討論重複，而是深化、延伸？"
    ],
    limitations: [
      "是否誠實指出樣本、方法、工具等限制？",
      "是否提出具有可操作性的未來研究建議？"
    ],
    abstract: [
      "是否包含背景、目的、方法、主要結果、結論？",
      "字數是否符合期刊要求？"
    ],
    fullpaper: [
      "全文是否前後一致（RQ、方法、結果、討論）？",
      "是否符合目標期刊字數與結構要求？"
    ]
  };

  let projectState = {
    id: "proj_" + Date.now(),
    projectMeta: {
      title: "",
      field: "",
      year: 2025
    },
    journalProfileId: "TAPER",
    stylePreset: "balanced",
    researchDesign: {
      type: "",
      context: "",
      sample: "",
      instruments: "",
      iv: "",
      dv: "",
      medmod: "",
      rqs: [],
      hypos: [],
      analysisPlan: [] // {rqId, method}
    },
    dataMeta: {
      notes: ""
    },
    literatureLibrary: [], // {id, author, year, title, journal, doi}
    usedCitations: new Set(),
    chapters: JSON.parse(JSON.stringify(defaultChapters))
  };

  let currentTab = "project";
  let currentChapter = "intro";
  let literatureUploadRaw = [];

  // ========= UTIL =========
  function saveToLocal() {
    localStorage.setItem("scholarcraft_v2_project", JSON.stringify(projectState));
    updateSidebarMeta();
  }

  function loadFromLocal() {
    const str = localStorage.getItem("scholarcraft_v2_project");
    if (!str) return;
    try {
      const obj = JSON.parse(str);
      // basic sanity
      if (!obj.chapters) obj.chapters = JSON.parse(JSON.stringify(defaultChapters));
      projectState = obj;
    } catch(e) {
      console.warn("Load failed", e);
    }
  }

  async function callBackend(payload) {
    try {
      const res = await fetch(GAS_API_URL, {
        method: "POST",
        headers: {"Content-Type": "text/plain;charset=utf-8"},
        body: JSON.stringify(payload)
      });
      return await res.json();
    } catch (e) {
      console.error(e);
      return {status: "error", message: "連線失敗"};
    }
  }

  // ========= INIT =========
  function initJournalSelect() {
    const sel = document.getElementById("journal-select");
    sel.innerHTML = "";
    Object.values(journalProfiles).forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
    sel.value = projectState.journalProfileId || "TAPER";
    renderJournalProfile();
  }

  function renderJournalProfile() {
    const p = journalProfiles[projectState.journalProfileId];
    const div = document.getElementById("journal-profile-summary");
    if (!p) {
      div.innerHTML = "<p class='text-slate-400'>尚未選擇期刊。</p>";
      return;
    }
    div.innerHTML = `
      <div><span class="text-slate-500">名稱：</span><span class="font-semibold">${p.name}</span></div>
      <div><span class="text-slate-500">Scope：</span><span>${p.scope}</span></div>
      <div><span class="text-slate-500">字數建議：</span><span>${p.wordLimit} 字左右</span></div>
      <div><span class="text-slate-500">引用格式：</span><span>${p.style}</span></div>
      <div><span class="text-slate-500">主編碎念：</span><span>${p.notes}</span></div>
    `;
  }

  function updateSidebarMeta() {
    document.getElementById("sidebar-project-name").textContent =
      projectState.projectMeta.title || "未命名專案";
    const jp = journalProfiles[projectState.journalProfileId];
    document.getElementById("sidebar-journal").textContent = jp ? jp.name : "未設定";
  }

  function initRQandHypoUI() {
    const rqList = document.getElementById("rq-list");
    const hypoList = document.getElementById("hypo-list");
    rqList.innerHTML = "";
    hypoList.innerHTML = "";

    projectState.researchDesign.rqs.forEach(rq => {
      const div = document.createElement("div");
      div.className = "flex items-start gap-1";
      div.innerHTML = `
        <span class="mt-1 text-slate-400">RQ${rq.index}:</span>
        <textarea class="flex-1 px-2 py-1 rounded border border-slate-300 text-[11px]"
                  rows="2"
                  oninput="onRQChange('${rq.id}', this.value)">${rq.text || ""}</textarea>
        <button class="text-rose-500 text-[11px]" onclick="removeRQ('${rq.id}')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      `;
      rqList.appendChild(div);
    });

    projectState.researchDesign.hypos.forEach(h => {
      const div = document.createElement("div");
      div.className = "flex items-start gap-1";
      div.innerHTML = `
        <span class="mt-1 text-slate-400">H${h.index}:</span>
        <textarea class="flex-1 px-2 py-1 rounded border border-slate-300 text-[11px]"
                  rows="2"
                  oninput="onHypoChange('${h.id}', this.value)">${h.text || ""}</textarea>
        <button class="text-rose-500 text-[11px]" onclick="removeHypo('${h.id}')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      `;
      hypoList.appendChild(div);
    });

    renderAnalysisPlanUI();
    renderAnalysisPlanDataTab();
  }

  function renderAnalysisPlanUI() {
    const container = document.getElementById("analysis-plan");
    container.innerHTML = "";
    projectState.researchDesign.rqs.forEach(rq => {
      const plan = projectState.researchDesign.analysisPlan.find(p => p.rqId === rq.id) || {method: ""};
      const row = document.createElement("div");
      row.className = "flex items-center gap-2";
      row.innerHTML = `
        <span class="text-slate-500">RQ${rq.index}</span>
        <select class="flex-1 px-2 py-1 rounded border border-slate-300 text-[11px]"
                onchange="onAnalysisPlanChange('${rq.id}', this.value)">
          <option value="">選擇分析方法</option>
          <option value="ttest" ${plan.method==="ttest"?"selected":""}>t-test</option>
          <option value="anova" ${plan.method==="anova"?"selected":""}>ANOVA / ANCOVA</option>
          <option value="regression" ${plan.method==="regression"?"selected":""}>Regression / MLR</option>
          <option value="sem" ${plan.method==="sem"?"selected":""}>SEM / CFA</option>
          <option value="lca" ${plan.method==="lca"?"selected":""}>LCA / LPA</option>
          <option value="chi" ${plan.method==="chi"?"selected":""}>Chi-square</option>
          <option value="qual" ${plan.method==="qual"?"selected":""}>質性主題分析</option>
        </select>
      `;
      container.appendChild(row);
    });
  }

  function renderAnalysisPlanDataTab() {
    const container = document.getElementById("analysis-plan-data");
    container.innerHTML = "";
    projectState.researchDesign.rqs.forEach(rq => {
      const plan = projectState.researchDesign.analysisPlan.find(p => p.rqId === rq.id) || {method: ""};
      const mLabel = plan.method || "尚未設定分析方法";
      const div = document.createElement("div");
      div.className = "border border-slate-200 rounded px-2 py-1.5 bg-white flex items-center justify-between";
      div.innerHTML = `
        <div>
          <div class="font-semibold text-slate-700">RQ${rq.index}</div>
          <div class="text-slate-500 text-[11px]">${rq.text || ""}</div>
        </div>
        <div class="text-right">
          <div class="text-slate-400 text-[11px]">分析方法：</div>
          <div class="font-semibold text-indigo-600 text-[11px]">${mLabel}</div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function switchTab(tabId) {
    currentTab = tabId;
    document.querySelectorAll("[id^='tab-']").forEach(div => div.classList.add("hidden"));
    document.getElementById(`tab-${tabId}`).classList.remove("hidden");

    document.querySelectorAll(".nav-btn").forEach(btn => {
      if (btn.dataset.tab === tabId) {
        btn.classList.add("bg-slate-800");
      } else {
        btn.classList.remove("bg-slate-800");
      }
    });

    const titleMap = {
      project: ["專案＆期刊設定", "從期刊開始，決定整篇論文的遊戲規則。"],
      design: ["研究設計建構器", "把 RQ、變項、方法全部結構化，避免前後不一致。"],
      literature: ["文獻庫＆引用引擎", "先確保你引用的每一篇文獻都是真的、用得對。"],
      data: ["數據＆分析計畫", "讓每個 RQ 都有對應的分析方法與結果描述策略。"],
      writing: ["寫作＆Reviewer 模式", "AI 幫你寫，但 Reviewer 幫你毒舌挑錯。"],
      submission: ["投稿包生成器", "Cover letter、highlight、response 一次備齊。"]
    };
    const [t, s] = titleMap[tabId];
    document.getElementById("main-title").textContent = t;
    document.getElementById("main-subtitle").textContent = s;
  }

  function switchChapter() {
    const sel = document.getElementById("chapter-select");
    const newChapter = sel.value;
    // save current text
    const editor = document.getElementById("chapter-editor");
    projectState.chapters[currentChapter] = editor.innerHTML;
    currentChapter = newChapter;
    // load new text
    editor.innerHTML = projectState.chapters[currentChapter] || "";
    updateWordCounts();
    renderChapterChecklist();
    document.getElementById("current-chapter-label").textContent = sel.options[sel.selectedIndex].text;
    saveToLocal();
  }

  function renderChapterChecklist() {
    const list = chapterChecklists[currentChapter] || [];
    const div = document.getElementById("chapter-checklist");
    if (!list.length) {
      div.innerHTML = `<p class="text-slate-500">此章未定義 checklist，可自行發揮。但別寫廢話。</p>`;
      return;
    }
    div.innerHTML = `
      <div class="font-semibold text-slate-700 mb-1 flex items-center gap-1">
        <i class="fa-solid fa-list-check text-indigo-500"></i><span>本章必答問題檢查清單</span>
      </div>
      <ul class="list-disc list-inside space-y-0.5">
        ${list.map(t => `<li>${t}</li>`).join("")}
      </ul>
    `;
  }

  function updateWordCounts() {
    const totalText = Object.values(projectState.chapters).join(" ");
    const totalWords = totalText.replace(/<[^>]+>/g," ").trim().split(/\s+/).filter(Boolean).length;
    const currentText = document.getElementById("chapter-editor").innerText || "";
    const currentWords = currentText.trim().split(/\s+/).filter(Boolean).length;
    document.getElementById("total-word-count").textContent = "全文字數：" + totalWords;
    document.getElementById("chapter-word-count").textContent = "本章字數：" + currentWords;
  }

  // ========= PROJECT HANDLERS =========
  function updateProjectMeta() {
    projectState.projectMeta.title = document.getElementById("project-title").value;
    projectState.projectMeta.field = document.getElementById("project-field").value;
    projectState.projectMeta.year = parseInt(document.getElementById("project-year").value || "2025",10);
    saveToLocal();
  }

  function updateJournalProfile() {
    const sel = document.getElementById("journal-select");
    projectState.journalProfileId = sel.value;
    renderJournalProfile();
    saveToLocal();
  }

  function updateStylePreset() {
    const val = document.getElementById("style-preset").value;
    projectState.stylePreset = val;
    saveToLocal();
  }

  // ========= DESIGN HANDLERS =========
  function updateResearchDesign() {
    const rd = projectState.researchDesign;
    rd.type = document.getElementById("design-type").value;
    rd.context = document.getElementById("design-context").value;
    rd.sample = document.getElementById("design-sample").value;
    rd.instruments = document.getElementById("design-instruments").value;
    rd.iv = document.getElementById("design-iv").value;
    rd.dv = document.getElementById("design-dv").value;
    rd.medmod = document.getElementById("design-medmod").value;
    saveToLocal();
  }

  function addRQ() {
    const id = "rq_" + Date.now() + "_" + Math.random().toString(36).slice(2,6);
    projectState.researchDesign.rqs.push({
      id,
      index: projectState.researchDesign.rqs.length + 1,
      text: ""
    });
    initRQandHypoUI();
    saveToLocal();
  }

  function addHypothesis() {
    const id = "h_" + Date.now() + "_" + Math.random().toString(36).slice(2,6);
    projectState.researchDesign.hypos.push({
      id,
      index: projectState.researchDesign.hypos.length + 1,
      text: ""
    });
    initRQandHypoUI();
    saveToLocal();
  }

  function onRQChange(id, text) {
    const r = projectState.researchDesign.rqs.find(r => r.id === id);
    if (r) r.text = text;
    saveToLocal();
  }

  function onHypoChange(id, text) {
    const h = projectState.researchDesign.hypos.find(h => h.id === id);
    if (h) h.text = text;
    saveToLocal();
  }

  function removeRQ(id) {
    projectState.researchDesign.rqs = projectState.researchDesign.rqs.filter(r => r.id !== id);
    // re-index
    projectState.researchDesign.rqs.forEach((r,i)=>r.index=i+1);
    // remove analysis plan entries
    projectState.researchDesign.analysisPlan = projectState.researchDesign.analysisPlan.filter(p => p.rqId !== id);
    initRQandHypoUI();
    saveToLocal();
  }

  function removeHypo(id) {
    projectState.researchDesign.hypos = projectState.researchDesign.hypos.filter(h => h.id !== id);
    projectState.researchDesign.hypos.forEach((h,i)=>h.index=i+1);
    initRQandHypoUI();
    saveToLocal();
  }

  function onAnalysisPlanChange(rqId, method) {
    let plan = projectState.researchDesign.analysisPlan.find(p => p.rqId === rqId);
    if (!plan) {
      plan = {rqId, method};
      projectState.researchDesign.analysisPlan.push(plan);
    } else {
      plan.method = method;
    }
    renderAnalysisPlanDataTab();
    saveToLocal();
  }

  async function generateMethodDraft() {
    const payload = {
      action: "generate_method",
      project: projectState
    };
    const res = await callBackend(payload);
    if (res.status === "success" && res.data) {
      // 寫入 method 章節
      projectState.chapters.method = `<h2>3. 研究方法</h2>` + res.data;
      if (currentChapter === "method") {
        document.getElementById("chapter-editor").innerHTML = projectState.chapters.method;
        updateWordCounts();
      }
      saveToLocal();
      pushChat("system", "✅ 已根據研究設計生成「研究方法」草稿，請自行細修。");
    } else {
      pushChat("system", "❌ 無法生成方法草稿：" + (res.message || "未知錯誤"));
    }
  }

  // ========= LITERATURE / CITATION =========
  function handleLiteratureUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = new Uint8Array(ev.target.result);
        const wb = XLSX.read(data, {type:"array"});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);
        literatureUploadRaw = json;
        projectState.literatureLibrary = json.map((row, idx) => {
          const authorStr = (row["Author Full Names"] || row["Authors"] || "").split(";")[0] || "Unknown";
          const year = row["Publication Year"] || row["Year"] || "";
          const title = row["Article Title"] || row["Title"] || "";
          const journal = row["Source Title"] || row["Journal"] || "";
          const doi = row["DOI"] || "";
          return {
            id: "lit_" + idx,
            author: authorStr.trim(),
            year: String(year),
            title: title.trim(),
            journal: journal.trim(),
            doi: doi.trim()
          };
        });
        document.getElementById("lit-count").textContent = projectState.literatureLibrary.length;
        renderLiteratureList();
        renderLiteraturePreview();
        saveToLocal();
      } catch (err) {
        alert("解析文獻檔案失敗。");
        console.error(err);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function renderLiteraturePreview() {
    const body = document.getElementById("lit-preview-body");
    body.innerHTML = "";
    projectState.literatureLibrary.slice(0,20).forEach((ref, idx) => {
      const tr = document.createElement("tr");
      tr.className = "border-b border-slate-100";
      tr.innerHTML = `
        <td class="px-2 py-1">${idx+1}</td>
        <td class="px-2 py-1">${ref.author}</td>
        <td class="px-2 py-1">${ref.year}</td>
        <td class="px-2 py-1">${ref.title}</td>
        <td class="px-2 py-1">${ref.journal}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderLiteratureList() {
    const q = (document.getElementById("lit-search").value || "").toLowerCase();
    const listDiv = document.getElementById("lit-list");
    listDiv.innerHTML = "";
    projectState.literatureLibrary
      .filter(ref =>
        !q ||
        ref.author.toLowerCase().includes(q) ||
        ref.title.toLowerCase().includes(q) ||
        ref.journal.toLowerCase().includes(q)
      )
      .slice(0,40)
      .forEach(ref => {
        const div = document.createElement("div");
        div.className = "flex items-start justify-between gap-2 py-1 border-b border-slate-200 last:border-0";
        const shortTitle = ref.title.length > 80 ? ref.title.slice(0,77)+"..." : ref.title;
        div.innerHTML = `
          <div class="flex-1">
            <div class="font-semibold text-slate-700">${ref.author} (${ref.year})</div>
            <div class="text-slate-600">${shortTitle}</div>
            <div class="text-slate-400 italic">${ref.journal}</div>
          </div>
          <button class="ml-2 px-2 py-0.5 rounded bg-indigo-600 text-white text-[10px] hover:bg-indigo-700"
                  onclick="insertCitation('${ref.id}')">
            引
          </button>
        `;
        listDiv.appendChild(div);
      });
  }

  async function syncLiteratureToBackend() {
    if (!projectState.literatureLibrary.length) {
      alert("目前文獻庫為空。");
      return;
    }
    const res = await callBackend({
      action: "upload_literature",
      data: projectState.literatureLibrary,
      projectId: projectState.id
    });
    if (res.status === "success") {
      alert("已將文獻庫同步到後端。");
    } else {
      alert("同步失敗：" + (res.message || "未知錯誤"));
    }
  }

  function insertCitation(litId) {
    const ref = projectState.literatureLibrary.find(r => r.id === litId);
    if (!ref) return;
    const authorPart = ref.author.split(",")[0];
    const text = `(${authorPart}, ${ref.year})`;
    insertTextAtCursor(text);
    projectState.usedCitations.add(litId);
    saveToLocal();
  }

  function insertTextAtCursor(text) {
    const editor = document.getElementById("chapter-editor");
    editor.focus();
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    range.deleteContents();
    const node = document.createTextNode(text);
    range.insertNode(node);
    range.setStartAfter(node);
    range.collapse(true);
    sel.removeAllRanges();
    sel.addRange(range);
    updateWordCounts();
  }

  function generateReferencesSection() {
    if (!projectState.usedCitations.size) {
      alert("尚未插入任何引文。");
      return;
    }
    const used = Array.from(projectState.usedCitations).map(id =>
      projectState.literatureLibrary.find(r => r.id === id)
    ).filter(Boolean);

    used.sort((a,b)=>{
      const aKey = (a.author || "") + a.year;
      const bKey = (b.author || "") + b.year;
      return aKey.localeCompare(bKey);
    });

    const lines = used.map(ref => {
      // 非嚴格 APA，提供草稿，由你最後人工微調
      return `${ref.author} (${ref.year}). ${ref.title}. ${ref.journal}. ${ref.doi ? "https://doi.org/" + ref.doi : ""}`;
    });

    const html = `<h2>References</h2><p>${lines.join("<br>")}</p>`;
    projectState.chapters.fullpaper = (projectState.chapters.fullpaper || "") + html;
    if (currentChapter === "fullpaper") {
      document.getElementById("chapter-editor").innerHTML = projectState.chapters.fullpaper;
      updateWordCounts();
    }
    saveToLocal();
    alert("已將 References 草稿加入 fullpaper 章節。");
  }

  // ========= DATA HANDLERS =========
  function updateDataMeta() {
    projectState.dataMeta.notes = document.getElementById("data-notes").value;
    saveToLocal();
  }

  async function generateResultsDraft() {
    const payload = {
      action: "generate_results",
      project: projectState
    };
    const res = await callBackend(payload);
    if (res.status === "success" && res.data) {
      projectState.chapters.results = `<h2>4. 研究結果</h2>` + res.data;
      if (currentChapter === "results") {
        document.getElementById("chapter-editor").innerHTML = projectState.chapters.results;
        updateWordCounts();
      }
      saveToLocal();
      pushChat("system", "✅ 已根據分析計畫生成「研究結果」草稿，請核對統計數字。");
    } else {
      pushChat("system", "❌ 無法生成結果草稿：" + (res.message || "未知錯誤"));
    }
  }

  // ========= AI / CHAT / WRITING =========
  function pushChat(role, text) {
    const panel = document.getElementById("chat-panel");
    const div = document.createElement("div");
    if (role === "user") {
      div.className = "flex justify-end";
      div.innerHTML = `
        <div class="max-w-[80%] bg-indigo-600 text-white rounded-lg px-2.5 py-1.5 text-[11px]">
          ${text.replace(/\n/g,"<br>")}
        </div>
      `;
    } else {
      div.className = "flex";
      div.innerHTML = `
        <div class="max-w-[80%] bg-white border border-slate-200 rounded-lg px-2.5 py-1.5 text-[11px] text-slate-800">
          ${text.replace(/\n/g,"<br>")}
        </div>
      `;
    }
    panel.appendChild(div);
    panel.scrollTop = panel.scrollHeight;
  }

  async function generateChapterDraft() {
    // 儲存目前章節文字
    projectState.chapters[currentChapter] = document.getElementById("chapter-editor").innerHTML;
    saveToLocal();

    pushChat("system", "⏳ 正在根據專案設定＆研究設計生成本章草稿…");

    const payload = {
      action: "generate_content",
      phase: currentChapter,
      style: projectState.stylePreset,
      project: projectState
    };
    const res = await callBackend(payload);
    if (res.status === "success" && res.data) {
      projectState.chapters[currentChapter] = res.data;
      document.getElementById("chapter-editor").innerHTML = res.data;
      updateWordCounts();
      saveToLocal();
      pushChat("system", "✅ 已更新本章草稿，請以指導教授的標準狠心刪改。");
    } else {
      pushChat("system", "❌ 生成失敗：" + (res.message || "未知錯誤"));
    }
  }

  async function runReviewerMode() {
    // Reviewer 模式：毒舌審查目前章節
    projectState.chapters[currentChapter] = document.getElementById("chapter-editor").innerHTML;
    saveToLocal();
    const plain = document.getElementById("chapter-editor").innerText || "";
    pushChat("system", "⏳ Reviewer 模式啟動：準備對本章開火…");

    const payload = {
      action: "review_chapter",
      chapterId: currentChapter,
      chapterText: plain,
      project: projectState
    };
    const res = await callBackend(payload);
    if (res.status === "success" && res.data) {
      pushChat("system", "🧾 Reviewer 意見：\n" + res.data);
    } else {
      pushChat("system", "❌ Reviewer 模式失敗：" + (res.message || "未知錯誤"));
    }
  }

  async function sendAIMessage() {
    const ta = document.getElementById("ai-input");
    const text = ta.value.trim();
    if (!text) return;
    ta.value = "";
    pushChat("user", text);
    const payload = {
      action: "assistant_chat",
      phase: currentChapter,
      user_prompt: text,
      project: projectState
    };
    const res = await callBackend(payload);
    if (res.status === "success" && res.data) {
      pushChat("system", res.data);
    } else {
      pushChat("system", "❌ 回應失敗：" + (res.message || "未知錯誤"));
    }
  }

  // ========= FIT & QUALITY =========
  async function runManuscriptFitCheck() {
    // 整合所有章節純文字
    const text = Object.entries(projectState.chapters)
      .map(([k,v]) => `${k.toUpperCase()}:\n${(v || "").replace(/<[^>]+>/g," ")}`)
      .join("\n\n");
    const payload = {
      action: "journal_fit",
      project: projectState,
      manuscript: text
    };
    const res = await callBackend(payload);
    const panel = document.getElementById("fit-quality-panel");
    const body = document.getElementById("fit-quality-body");
    panel.classList.remove("hidden");
    if (res.status === "success" && res.data) {
      body.innerHTML = res.data.split("\n").map(l => `<div>• ${l}</div>`).join("");
    } else {
      body.innerHTML = `<div class="text-rose-600">期刊適配檢查失敗：${res.message || "未知錯誤"}</div>`;
    }
  }

  async function runQualityCheck() {
    const text = Object.values(projectState.chapters).join("\n");
    const payload = {
      action: "quality_check",
      project: projectState,
      manuscript: text
    };
    const res = await callBackend(payload);
    const panel = document.getElementById("fit-quality-panel");
    const body = document.getElementById("fit-quality-body");
    panel.classList.remove("hidden");
    if (res.status === "success" && res.data) {
      body.innerHTML = res.data.split("\n").map(l => `<div>• ${l}</div>`).join("");
    } else {
      body.innerHTML = `<div class="text-rose-600">品質檢查失敗：${res.message || "未知錯誤"}</div>`;
    }
  }

  // ========= SUBMISSION PACKAGE =========
  async function generateCoverLetter() {
    const text = Object.values(projectState.chapters).join("\n");
    const payload = {
      action: "generate_cover_letter",
      project: projectState,
      manuscript: text
    };
    const res = await callBackend(payload);
    document.getElementById("submission-output").value =
      res.status === "success" ? res.data :
        "生成 Cover Letter 失敗：" + (res.message || "未知錯誤");
  }

  async function generateHighlights() {
    const text = Object.values(projectState.chapters).join("\n");
    const payload = {
      action: "generate_highlights",
      project: projectState,
      manuscript: text
    };
    const res = await callBackend(payload);
    document.getElementById("submission-output").value =
      res.status === "success" ? res.data :
        "生成 Highlights 失敗：" + (res.message || "未知錯誤");
  }

  async function generateResponseTemplate() {
    const payload = {
      action: "generate_response_template",
      project: projectState
    };
    const res = await callBackend(payload);
    document.getElementById("submission-output").value =
      res.status === "success" ? res.data :
        "生成 Response Template 失敗：" + (res.message || "未知錯誤");
  }

  // ========= EXPORT =========
  function exportAsDocx() {
    alert("前端示範版僅匯出 HTML，可再用 Word 開啟／貼上。真 DOCX 可在後端以 Apps Script / Doc API 實作。");
    const blob = new Blob(
      [`<html><body>${Object.values(projectState.chapters).join("<hr>")}</body></html>`],
      {type:"text/html"}
    );
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = (projectState.projectMeta.title || "manuscript") + ".html";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // ========= INIT ALL =========
  function initUIFromState() {
    // Project
    document.getElementById("project-title").value = projectState.projectMeta.title || "";
    document.getElementById("project-field").value = projectState.projectMeta.field || "";
    document.getElementById("project-year").value = projectState.projectMeta.year || 2025;
    document.getElementById("style-preset").value = projectState.stylePreset || "balanced";

    // Design
    document.getElementById("design-type").value = projectState.researchDesign.type || "";
    document.getElementById("design-context").value = projectState.researchDesign.context || "";
    document.getElementById("design-sample").value = projectState.researchDesign.sample || "";
    document.getElementById("design-instruments").value = projectState.researchDesign.instruments || "";
    document.getElementById("design-iv").value = projectState.researchDesign.iv || "";
    document.getElementById("design-dv").value = projectState.researchDesign.dv || "";
    document.getElementById("design-medmod").value = projectState.researchDesign.medmod || "";

    document.getElementById("data-notes").value = projectState.dataMeta.notes || "";

    // Literature
    document.getElementById("lit-count").textContent = projectState.literatureLibrary.length;
    renderLiteratureList();
    renderLiteraturePreview();

    // Writing
    document.getElementById("chapter-select").value = currentChapter;
    document.getElementById("chapter-editor").innerHTML = projectState.chapters[currentChapter] || "";
    renderChapterChecklist();
    updateWordCounts();
    updateSidebarMeta();
  }

  // Boot
  loadFromLocal();
  window.addEventListener("load", () => {
    initJournalSelect();
    initRQandHypoUI();
    initUIFromState();
    switchTab("project");
    pushChat("system", "👋 歡迎使用 ScholarCraft v2。請先設定「目標期刊」與「研究設計」，再開始叫 AI 寫稿，不然寫出來一定四不像。");
  });
</script>
</body>
</html>
