<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ScholarCraft v3 | AI 輔助 SSCI 論文寫作系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- xlsx for WoS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .serif { font-family: 'Noto Serif TC', serif; }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
    .scroll-thin::-webkit-scrollbar { width: 6px; }
    .scroll-thin::-webkit-scrollbar-thumb { background:#cbd5e1;border-radius:3px; }
    .scroll-thin::-webkit-scrollbar-thumb:hover { background:#94a3b8; }
  </style>
</head>
<body class="bg-slate-100 h-screen flex overflow-hidden">

<!-- Sidebar -->
<aside class="w-72 bg-slate-900 text-slate-100 flex flex-col">
  <div class="px-5 py-4 border-b border-slate-700 flex items-center justify-between">
    <div>
      <div class="flex items-center gap-2">
        <i class="fa-solid fa-graduation-cap text-indigo-400"></i>
        <span class="font-semibold tracking-wide">ScholarCraft v3</span>
      </div>
      <p class="text-xs text-slate-400 mt-1">SSCI Q1 Writing Workstation</p>
    </div>
    <div class="text-[10px] px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">
      BETA
    </div>
  </div>

  <!-- Project / Journal quick info -->
  <div class="px-4 py-3 border-b border-slate-800 text-xs space-y-2">
    <div>
      <label class="text-slate-400">目前專案</label>
      <div id="sidebar-project-name" class="font-semibold truncate">未命名專案</div>
    </div>
    <div class="flex items-center justify-between">
      <div>
        <span class="text-slate-400">目標期刊</span>
        <div id="sidebar-journal" class="text-[11px] text-indigo-300 truncate">未設定</div>
      </div>
      <div class="flex flex-col items-end">
        <span class="text-slate-400">語氣風格</span>
        <select id="style-preset" class="mt-0.5 bg-slate-800 text-[11px] px-2 py-1 rounded border border-slate-600 focus:outline-none"
                onchange="updateStylePreset()">
          <option value="conservative">保守</option>
          <option value="balanced" selected>平衡</option>
          <option value="assertive">較強</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Nav -->
  <nav class="flex-1 overflow-y-auto scroll-thin px-3 py-3 space-y-1 text-sm">
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="project" onclick="switchTab('project')">
      <i class="fa-solid fa-diagram-project w-4 text-center"></i><span>1. 專案＆期刊</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="design" onclick="switchTab('design')">
      <i class="fa-solid fa-flask w-4 text-center"></i><span>2. 研究設計</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="literature" onclick="switchTab('literature')">
      <i class="fa-solid fa-book-open w-4 text-center"></i><span>3. 文獻＆引用</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="data" onclick="switchTab('data')">
      <i class="fa-solid fa-chart-column w-4 text-center"></i><span>4. 數據＆分析</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="writing" onclick="switchTab('writing')">
      <i class="fa-solid fa-pen-nib w-4 text-center"></i><span>5. 寫作＆Reviewer</span>
    </button>
    <button class="w-full flex items-center gap-2 px-3 py-2 rounded-md hover:bg-slate-800 nav-btn"
            data-tab="submission" onclick="switchTab('submission')">
      <i class="fa-solid fa-envelope-open-text w-4 text-center"></i><span>6. 投稿包</span>
    </button>
  </nav>

  <!-- User -->
  <div class="px-4 py-3 border-t border-slate-800 flex items-center gap-3 text-xs">
    <div id="user-avatar" class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-fuchsia-500 flex items-center justify-center font-bold text-[11px]">
      U
    </div>
    <div class="flex-1">
      <div id="user-name" class="font-semibold">SSCI 作者</div>
      <div id="user-meta" class="text-slate-400 text-[11px]">Local project · Auto-save</div>
    </div>
  </div>
</aside>

<!-- Main -->
<main class="flex-1 flex flex-col">

  <!-- Header -->
  <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6">
    <div>
      <h1 id="main-title" class="text-sm font-semibold text-slate-700">專案＆期刊設定</h1>
      <p id="main-subtitle" class="text-xs text-slate-400">從期刊開始，決定整篇論文的遊戲規則。</p>
    </div>
    <div class="flex items-center gap-3 text-[11px]">
      <button class="px-3 py-1 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100"
              onclick="runManuscriptFitCheck()">
        <i class="fa-solid fa-magnifying-glass-chart mr-1"></i>期刊適配檢查
      </button>
      <button class="px-3 py-1 rounded-full border border-emerald-400 text-emerald-600 hover:bg-emerald-50"
              onclick="runQualityCheck()">
        <i class="fa-solid fa-shield-heart mr-1"></i>品質＆倫理檢查
      </button>
      <!-- 多語選單：生成語言 -->
      <div class="flex items-center gap-1">
        <span id="lang-label" class="text-slate-400">生成語言</span>
        <select id="lang-select"
                class="px-2 py-1 rounded-full border border-slate-300 text-slate-600 bg-white focus:outline-none">
        </select>
      </div>
    </div>
  </header>

  <!-- Content Tabs -->
  <section class="flex-1 overflow-hidden">
    <div class="h-full overflow-y-auto scroll-thin p-4 space-y-4">

      <!-- TAB: Project -->
      <div id="tab-project" class="space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-diagram-project text-indigo-500"></i> 專案基本資訊
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">專案名稱</label>
              <input id="project-title" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     placeholder="例如：Generative AI in PBL for SSI Argumentation"
                     oninput="updateProjectMeta(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">領域</label>
              <input id="project-field" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     placeholder="Science education / AI in education"
                     oninput="updateProjectMeta(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">預定投稿年份</label>
              <input id="project-year" type="number"
                     class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                     value="2025" oninput="updateProjectMeta(); scheduleSaveState();">
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-newspaper text-indigo-500"></i> 目標期刊設定
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">目標期刊</label>
              <select id="journal-select"
                      class="w-full px-2 py-1.5 rounded border border-slate-300 text-xs"
                      onchange="updateJournalProfile(); scheduleSaveState();">
              </select>
              <p class="text-[11px] text-slate-400 mt-1">
                可在程式中擴充 journalProfiles 物件，加入常用期刊。
              </p>
            </div>
            <div class="text-xs space-y-1" id="journal-profile-summary">
              <!-- filled by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Design -->
      <div id="tab-design" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4">
          <h2 class="font-semibold text-slate-800 mb-2 text-sm flex items-center gap-2">
            <i class="fa-solid fa-flask text-emerald-500"></i> 研究設計總覽
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">研究類型</label>
              <select id="design-type" class="w-full px-2 py-1.5 rounded border border-slate-300"
                      onchange="updateResearchDesign(); scheduleSaveState();">
                <option value="">請選擇</option>
                <option value="quant">量化實證</option>
                <option value="qual">質性研究</option>
                <option value="mixed">混合方法</option>
                <option value="review">系統性回顧/文獻分析</option>
              </select>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">研究情境 / 場域</label>
              <input id="design-context" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：台灣國中理化課室"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">樣本概況（N、年級）</label>
              <input id="design-sample" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：兩校共 200 名國二學生"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">研究工具 / 量表</label>
              <input id="design-instruments" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="例如：論證能力量表、AI 使用問卷"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-question-circle text-indigo-500"></i> 研究問題 & 假設
            </h2>
            <div class="space-x-1 text-[11px]">
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                      onclick="addRQ()">+ RQ</button>
              <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                      onclick="addHypothesis()">+ H</button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
            <div>
              <h3 class="font-semibold text-slate-700 text-xs mb-1">Research Questions</h3>
              <div id="rq-list" class="space-y-2"></div>
            </div>
            <div>
              <h3 class="font-semibold text-slate-700 text-xs mb-1">Hypotheses</h3>
              <div id="hypo-list" class="space-y-2"></div>
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-sitemap text-fuchsia-500"></i> 變項＆分析對應
            </h2>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="generateMethodDraft()">
              <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成方法草稿（AI）
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
            <div>
              <label class="block text-slate-500 mb-1">自變項 (IV)</label>
              <input id="design-iv" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">依變項 (DV)</label>
              <input id="design-dv" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
            <div>
              <label class="block text-slate-500 mb-1">中介 / 調節</label>
              <input id="design-medmod" type="text"
                     class="w-full px-2 py-1.5 rounded border border-slate-300"
                     placeholder="Learning motivation (M), Gender (Mod)…"
                     oninput="updateResearchDesign(); scheduleSaveState();">
            </div>
          </div>
          <div class="mt-3">
            <h3 class="font-semibold text-slate-700 text-xs mb-1">每個 RQ 對應的分析方法</h3>
            <div id="analysis-plan" class="space-y-2 text-xs"></div>
          </div>
        </div>
      </div>

      <!-- TAB: Literature -->
      <div id="tab-literature" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 flex flex-col md:flex-row gap-4">
          <!-- Upload & summary -->
          <div class="md:w-1/2 space-y-3 text-xs">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-file-import text-emerald-500"></i> 文獻庫（WoS/Scopus 匯入）
            </h2>
            <label class="block">
              <span class="text-slate-500 mb-1 block">上傳 Excel/CSV</span>
              <input id="lit-file" type="file" accept=".xlsx,.xls,.csv"
                     class="text-xs" onchange="handleLiteratureUpload(event)">
            </label>
            <p class="text-[11px] text-slate-500">
              系統會解析 Author, Year, Title, Journal, DOI 等欄位，形成文獻庫。
            </p>
            <div class="flex items-center gap-2">
              <span class="text-slate-500">目前文獻數：</span>
              <span id="lit-count" class="px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 text-[11px]">0</span>
            </div>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="syncLiteratureToBackend()">
              <i class="fa-solid fa-cloud-arrow-up mr-1"></i>同步文獻庫到後端
            </button>
          </div>

          <!-- Citation search / insert -->
          <div class="md:w-1/2 space-y-2 text-xs">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-quote-right text-fuchsia-500"></i> 引文搜尋＆插入
            </h2>
            <input id="lit-search" type="text"
                   class="w-full px-2 py-1.5 rounded border border-slate-300"
                   placeholder="輸入 author / keyword 搜尋"
                   oninput="renderLiteratureList()">
            <div id="lit-list" class="max-h-52 overflow-y-auto scroll-thin border border-slate-200 rounded p-2 bg-slate-50 text-[11px]">
            </div>
            <button class="mt-2 px-3 py-1 rounded-full bg-emerald-600 text-white text-[11px] hover:bg-emerald-700"
                    onclick="generateReferencesSection()">
              <i class="fa-solid fa-list-check mr-1"></i>生成 References（僅限實際引用）
            </button>
            <p class="text-[10px] text-slate-400">
              引文會在正文以 (Author, Year) 插入，並記錄於 usedCitations。
            </p>
          </div>
        </div>

        <!-- Preview -->
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-database text-slate-500"></i> 文獻庫預覽
          </h2>
          <div class="max-h-60 overflow-y-auto scroll-thin border border-slate-200 rounded bg-white">
            <table class="w-full text-[11px]">
              <thead class="bg-slate-50 text-slate-500">
              <tr>
                <th class="px-2 py-1 text-left">#</th>
                <th class="px-2 py-1 text-left">Author</th>
                <th class="px-2 py-1 text-left">Year</th>
                <th class="px-2 py-1 text-left">Title</th>
                <th class="px-2 py-1 text-left">Journal</th>
              </tr>
              </thead>
              <tbody id="lit-preview-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB: Data -->
      <div id="tab-data" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold text-slate-800 text-sm flex items-center gap-2">
              <i class="fa-solid fa-chart-column text-indigo-500"></i> 數據檔案＆分析輸出
            </h2>
            <button class="px-3 py-1 rounded-full bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                    onclick="generateResultsDraft()">
              <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成結果草稿（AI）
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="block text-slate-500 mb-1">上傳原始數據（選用）</label>
              <input id="data-raw-file" type="file" accept=".xlsx,.csv,.sav" class="text-[11px]"
                     onchange="handleDataRawUpload(event)">
              <p class="text-[10px] text-slate-400 mt-1">建議仍以本地統計軟體分析，本系統偏向協助撰寫。</p>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">上傳分析輸出（表格/結果摘要）</label>
              <input id="data-output-file" type="file" accept=".xlsx,.csv,.txt" class="text-[11px]"
                     onchange="handleDataOutputUpload(event)">
              <p class="text-[10px] text-slate-400 mt-1">可上傳整理後的分析表格，後端可進一步解析。</p>
            </div>
            <div>
              <label class="block text-slate-500 mb-1">分析摘要備註</label>
              <textarea id="data-notes" rows="3"
                        class="w-full px-2 py-1.5 rounded border border-slate-300"
                        placeholder="簡要說明你做了哪些統計分析，例如：2x2 混合設計 ANOVA, MLR, LCA…"
                        oninput="updateDataMeta(); scheduleSaveState()"></textarea>
            </div>
          </div>
        </div>

        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-diagram-next text-emerald-500"></i> 每個 RQ 對應的分析計畫
          </h2>
          <p class="text-[11px] text-slate-500 mb-2">
            下方內容會自動從「研究設計」頁的 RQ 產生，你可以為每個 RQ 選一種主要分析方法。
          </p>
          <div id="analysis-plan-data" class="space-y-2"></div>
        </div>
      </div>

      <!-- TAB: Writing -->
      <div id="tab-writing" class="hidden space-y-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-[calc(100vh-6rem)]">
          <!-- AI Coach -->
          <div class="glass rounded-xl border border-slate-200 flex flex-col text-xs">
            <div class="px-3 py-2 border-b border-slate-200 bg-gradient-to-r from-indigo-600 to-indigo-700 text-slate-50">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i class="fa-solid fa-robot"></i>
                  <span class="font-semibold text-[12px]">SSCI AI Coach / Reviewer</span>
                </div>
                <span id="current-chapter-label" class="text-[11px] bg-slate-900/30 px-2 py-0.5 rounded-full">
                  Intro
                </span>
              </div>
            </div>
            <div class="p-2 border-b border-slate-200 bg-slate-50 text-[11px]" id="chapter-checklist">
            </div>
            <div id="chat-panel" class="flex-1 overflow-y-auto scroll-thin p-2 space-y-2 bg-slate-50">
            </div>
            <div class="border-t border-slate-200 p-2 space-y-1">
              <div class="flex items-center gap-1 mb-1">
                <button class="flex-1 px-2 py-1 rounded bg-indigo-600 text-white text-[11px] hover:bg-indigo-700"
                        onclick="generateChapterDraft()">
                  <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>生成本章草稿
                </button>
                <button class="px-2 py-1 rounded border border-rose-400 text-rose-600 text-[11px] hover:bg-rose-50"
                        onclick="runReviewerMode()">
                  <i class="fa-solid fa-gavel mr-1"></i>Reviewer 模式
                </button>
              </div>
              <div class="flex items-center gap-1 mb-1">
                <button class="flex-1 px-2 py-1 rounded border border-emerald-500 text-emerald-700 text-[11px] hover:bg-emerald-50"
                        onclick="runAutoCitationForCurrentChapter()">
                  <i class="fa-solid fa-bookmark mr-1"></i>AI 自動配文獻（僅用 referencePool）
                </button>
              </div>
              <div class="flex items-center justify-between mb-1 text-[10px]">
                <span class="text-slate-500">快照 / 版本</span>
                <button class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
                        onclick="createSnapshot()">
                  <i class="fa-solid fa-camera mr-1"></i>儲存快照
                </button>
              </div>
              <div id="snapshot-list" class="max-h-20 overflow-y-auto scroll-thin text-[10px] space-y-1">
              </div>
              <div class="relative mt-1">
                <textarea id="ai-input" rows="2"
                          class="w-full px-2 pr-8 py-1.5 rounded border border-slate-300 text-[11px]"
                          placeholder="輸入額外指令（可留白，直接生成）"
                          onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendAIMessage();}">
                </textarea>
                <button class="absolute right-1 bottom-1.5 p-1.5 rounded bg-indigo-600 text-white text-[10px]"
                        onclick="sendAIMessage()">
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Chapter / Editor -->
          <div class="lg:col-span-2 glass rounded-xl border border-slate-200 flex flex-col">
            <div class="px-3 py-2 border-b border-slate-200 flex items-center gap-2 text-[11px]">
              <label class="text-slate-500">章節</label>
              <select id="chapter-select" class="px-2 py-1 rounded border border-slate-300"
                      onchange="switchChapter()">
                <option value="outline">0. 論文大綱</option>
                <option value="intro">1. 緒論</option>
                <option value="lit_review">2. 文獻探討</option>
                <option value="method">3. 研究方法</option>
                <option value="results">4. 研究結果</option>
                <option value="discussion">5. 討論</option>
                <option value="conclusion">6. 結論</option>
                <option value="implications">7. 教育意涵</option>
                <option value="limitations">8. 限制與未來研究</option>
                <option value="abstract">9. 摘要</option>
                <option value="fullpaper">10. 全文整合</option>
              </select>
              <div class="flex-1"></div>
              <div class="flex flex-col items-end gap-0.5">
                <span id="chapter-word-count" class="text-slate-500">本章字數：0</span>
                <span id="total-word-count" class="text-slate-400">全文字數：0</span>
              </div>
            </div>

            <div id="chapter-editors" class="flex-1 overflow-hidden">
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin"
                data-chapter="outline"
                oninput="onChapterInput('outline', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="intro"
                oninput="onChapterInput('intro', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="lit_review"
                oninput="onChapterInput('lit_review', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="method"
                oninput="onChapterInput('method', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="results"
                oninput="onChapterInput('results', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="discussion"
                oninput="onChapterInput('discussion', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="conclusion"
                oninput="onChapterInput('conclusion', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="implications"
                oninput="onChapterInput('implications', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="limitations"
                oninput="onChapterInput('limitations', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="abstract"
                oninput="onChapterInput('abstract', this.value)"
              ></textarea>
              <textarea
                class="chapter-editor w-full h-full resize-none p-3 text-xs border-0 focus:outline-none bg-transparent scroll-thin hidden"
                data-chapter="fullpaper"
                oninput="onChapterInput('fullpaper', this.value)"
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Submission -->
      <div id="tab-submission" class="hidden space-y-4">
        <div class="glass rounded-xl border border-slate-200 p-4 text-xs">
          <h2 class="font-semibold text-slate-800 text-sm mb-2 flex items-center gap-2">
            <i class="fa-solid fa-envelope-open-text text-indigo-500"></i> 投稿包總覽
          </h2>
          <p class="text-[11px] text-slate-600 mb-2">
            在這裡彙整 cover letter、投稿信模板、回覆 reviewer 信件草稿與期刊投稿注意事項，可搭配上方寫作區的全文內容與 References 一起輸出。
          </p>
          <p class="text-[10px] text-slate-500">
            （此區功能可依實際工作流程擴充，如：儲存多版本投稿信模板、對應 R1/R2 審查意見等）
          </p>
        </div>
      </div>

    </div>
  </section>
</main>

<script>
  /**********************
   * 後端設定與共用工具 *
   **********************/
  const BACKEND_CONFIG = {
    // 實際使用時請改成你的 Apps Script 或其他後端 Web API URL
    API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxzuSB40CJ_8VgEG5HsZR0QBqShK5TMKQAHHkQf_ww4gGy90uWZUoLjiuwbBpT4BkJoKQ/exec', // 例如："https://script.google.com/macros/s/XXX/exec"
    USE_MOCK: false    // 開發階段用 mock；要打真後端時改成 false 並設定 API_BASE_URL
  };

  async function callBackend(endpoint, payload) {
    // 若未設定 API_BASE_URL 或仍在 mock 模式，就回傳假的結果，至少 UI 不會掛
    if (!BACKEND_CONFIG.API_BASE_URL || BACKEND_CONFIG.USE_MOCK) {
      console.warn('[ScholarCraft] 使用 mock 後端：', endpoint, payload);
      await new Promise(r => setTimeout(r, 400)); // 模擬延遲

      // --- 新增或修改的 Mock 邏輯 START ---

      if (endpoint === '/fitCheck') {
        const journal = payload.journalProfile || { abbr: '未設定', name: '目標期刊' };
        const field = payload.projectMeta.field || '未填寫領域';
        let score = 75;
        if (journal.abbr === 'L&I') score += 10;
        if (payload.design.type === 'quant') score += 5;
        return {
          ok: true,
          data: {
            summary: `[Mock] 期刊適配檢查結果：\n\n專案領域：${field}\n目標期刊：${journal.name} (${journal.abbr})\n\n**綜合適配分數：${score}/100**\n\n- 領域契合度：良好 (因應教育領域)\n- 研究方法：${payload.design.type || '未指定'}，若為量化研究，請加強理論貢獻。\n- 字數評估：目前預估字數（${getWordStats(Object.values(payload.chapters).join(' ')).total}）符合初審範圍。`
          }
        };
      }
      if (endpoint === '/qualityCheck') {
        const wordCount = getWordStats(payload.chapters.fullpaper || '').total;
        let ethicsMsg = '倫理聲明檢查：未見明顯倫理瑕疵（請確保問卷有 IRB）。';
        if (wordCount < 1000) ethicsMsg = '倫理聲明檢查：文章內容不足，無法進行深度品質檢核。';
        return {
          ok: true,
          data: {
            summary: `[Mock] 品質＆倫理檢查結果：\n\n1. 寫作嚴謹度：文獻探討完整度尚可，應在方法論（Method）部分補足研究設計細節。\n2. 數據透明度：請確保結果章節包含足夠的統計報告，例如 F, p, $\\eta^2$ 等。\n3. ${ethicsMsg}`
          }
        };
      }

      // --- 繼承自原程式碼的 Mock 邏輯 START ---

      if (endpoint === '/generateChapter') {
        return {
          ok: true,
          data: {
            text: (payload.chapterText || '') + '\n\n[Mock AI] 這是示意草稿，請接上真實後端以取得正式內容。'
          }
        };
      }
      if (endpoint === '/reviewChapter') {
        return {
          ok: true,
          data: {
            summary: 'Mock Reviewer：整體結構大致合理，但請補強理論脈絡與方法論嚴謹度。',
            comments: [
              '1. 建議在開頭更清楚界定研究問題與研究貢獻。',
              '2. 文獻整合部分可以增加近五年的 SSCI 研究。',
              '3. 結果與討論應更緊密對應研究問題。'
            ]
          }
        };
      }
      if (endpoint === '/autoCiteChapter') {
        return {
          ok: true,
          data: {
            text: payload.chapterText + '\n\n[Mock AI] 已示意性標記引用，實際配文獻請由真實後端完成。'
          }
        };
      }
      if (endpoint === '/resultsDraft') {
        return {
          ok: true,
          data: { text: '[Mock AI] 這裡會根據你上傳的分析輸出，生成結果敘述草稿。' }
        };
      }
      if (endpoint === '/methodDraft') {
        return {
          ok: true,
          data: { text: '[Mock AI] 這裡會根據研究設計與 RQ，生成方法章節草稿。' }
        };
      }
      if (endpoint === '/syncReferences') {
        return { ok: true, data: { message: 'Mock：文獻庫已同步（實際未寫入後端）。' } };
      }
      return { ok: true, data: {} };
    }

    try {
      const res = await fetch(BACKEND_CONFIG.API_BASE_URL + endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload || {})
      });
      if (!res.ok) {
        console.error('Backend HTTP error', res.status, await res.text());
        return { ok: false, error: 'HTTP ' + res.status };
      }
      const data = await res.json();
      return { ok: true, data };
    } catch (err) {
      console.error('Backend fetch error', err);
      return { ok: false, error: err.message || String(err) };
    }
  }

  function escapeHtml(str) {
    return (str || '').replace(/[&<>"']/g, function(m) {
      return ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m];
    });
  }
  /**********************
   * 多語系 UI 字典與切換 *
   **********************/

 // 主 UI 的語系字典（側欄 nav + 專案卡片 + 期刊卡片）
const UI_I18N = {
  'zh-TW': {
    langLabel: '生成語言',
    nav: {
      project: '1. 專案＆期刊',
      design: '2. 研究設計',
      literature: '3. 文獻＆引用',
      data: '4. 數據＆分析',
      writing: '5. 寫作＆Reviewer',
      submission: '6. 投稿包'
    },
    projectPanel: {
      cardTitle: '專案基本資訊',
      projectNameLabel: '專案名稱',
      projectNamePlaceholder: '例如：Generative AI in PBL',
      domainLabel: '領域',
      domainPlaceholder: '例如：Science education / AI in education',
      yearLabel: '預定投稿年份'
    },
    journalPanel: {
      cardTitle: '目標期刊設定',
      targetJournalLabel: '目標期刊',
      targetJournalHint: '可在程式中擴充 journalProfiles 物件，加入常用期刊。',
      metaNameLabel: '期刊名稱：',
      metaScopeLabel: '範疇：',
      metaWordLimitLabel: '字數限制：',
      metaStyleLabel: '寫作體例：',
      metaNoteLabel: '備註：'
    }
  },

  'zh-CN': {
    langLabel: '生成语言',
    nav: {
      project: '1. 项目与期刊',
      design: '2. 研究设计',
      literature: '3. 文献与引用',
      data: '4. 数据与分析',
      writing: '5. 写作与审稿人',
      submission: '6. 投稿包'
    },
    projectPanel: {
      cardTitle: '项目基本信息',
      projectNameLabel: '项目名称',
      projectNamePlaceholder: '例如：Generative AI in PBL',
      domainLabel: '领域',
      domainPlaceholder: '例如：科学教育 / AI 教育',
      yearLabel: '预计投稿年份'
    },
    journalPanel: {
      cardTitle: '目标期刊设置',
      targetJournalLabel: '目标期刊',
      targetJournalHint: '可以在代码中的 journalProfiles 对象里加入常用期刊。',
      metaNameLabel: '期刊名称：',
      metaScopeLabel: '范围：',
      metaWordLimitLabel: '字数限制：',
      metaStyleLabel: '写作体例：',
      metaNoteLabel: '备注：'
    }
  },

  'en': {
    langLabel: 'Generation language',
    nav: {
      project: '1. Project & Journal',
      design: '2. Research design',
      literature: '3. Literature & citations',
      data: '4. Data & analysis',
      writing: '5. Writing & reviewer',
      submission: '6. Submission package'
    },
    projectPanel: {
      cardTitle: 'Project basic information',
      projectNameLabel: 'Project title',
      projectNamePlaceholder: 'e.g., Generative AI in PBL',
      domainLabel: 'Field',
      domainPlaceholder: 'e.g., Science education / AI in education',
      yearLabel: 'Planned submission year'
    },
    journalPanel: {
      cardTitle: 'Target journal settings',
      targetJournalLabel: 'Target journal',
      targetJournalHint: 'You can define frequently used journals in the journalProfiles object.',
      metaNameLabel: 'Journal title:',
      metaScopeLabel: 'Scope:',
      metaWordLimitLabel: 'Word limit:',
      metaStyleLabel: 'Writing style:',
      metaNoteLabel: 'Notes:'
    }
  },

  'ja': {
    langLabel: '生成言語',
    nav: {
      project: '1. プロジェクトとジャーナル',
      design: '2. 研究デザイン',
      literature: '3. 文献と引用',
      data: '4. データと分析',
      writing: '5. 執筆と査読者',
      submission: '6. 投稿パッケージ'
    },
    projectPanel: {
      cardTitle: 'プロジェクトの基本情報',
      projectNameLabel: 'プロジェクト名',
      projectNamePlaceholder: '例：Generative AI in PBL',
      domainLabel: '分野',
      domainPlaceholder: '例：理科教育／AI in education',
      yearLabel: '投稿予定年'
    },
    journalPanel: {
      cardTitle: 'ターゲットジャーナルの設定',
      targetJournalLabel: 'ターゲットジャーナル',
      targetJournalHint: 'よく使うジャーナルはコード内の journalProfiles オブジェクトに定義できます。',
      metaNameLabel: 'ジャーナル名：',
      metaScopeLabel: '範囲：',
      metaWordLimitLabel: '語数：',
      metaStyleLabel: '執筆スタイル：',
      metaNoteLabel: '備考：'
    }
  },

  'vi': {
    langLabel: 'Ngôn ngữ sinh văn',
    nav: {
      project: '1. Dự án & tạp chí',
      design: '2. Thiết kế nghiên cứu',
      literature: '3. Tài liệu & trích dẫn',
      data: '4. Dữ liệu & phân tích',
      writing: '5. Viết bài & phản biện',
      submission: '6. Gói gửi bài'
    },
    projectPanel: {
      cardTitle: 'Thông tin cơ bản của đề án',
      projectNameLabel: 'Tên đề án',
      projectNamePlaceholder: 'Ví dụ: Generative AI in PBL',
      domainLabel: 'Lĩnh vực',
      domainPlaceholder: 'Ví dụ: Giáo dục khoa học / AI trong giáo dục',
      yearLabel: 'Năm dự kiến nộp bài'
    },
    journalPanel: {
      cardTitle: 'Thiết lập tạp chí mục tiêu',
      targetJournalLabel: 'Tạp chí mục tiêu',
      targetJournalHint: 'Có thể khai báo các tạp chí thường dùng trong đối tượng journalProfiles trong mã.',
      metaNameLabel: 'Tên tạp chí:',
      metaScopeLabel: 'Phạm vi:',
      metaWordLimitLabel: 'Giới hạn số từ:',
      metaStyleLabel: 'Chuẩn trình bày:',
      metaNoteLabel: 'Ghi chú:'
    }
  },

  'id': {
    langLabel: 'Bahasa keluaran',
    nav: {
      project: '1. Proyek & jurnal',
      design: '2. Desain penelitian',
      literature: '3. Literatur & sitasi',
      data: '4. Data & analisis',
      writing: '5. Penulisan & reviewer',
      submission: '6. Paket submit'
    },
    projectPanel: {
      cardTitle: 'Informasi dasar proyek',
      projectNameLabel: 'Judul proyek',
      projectNamePlaceholder: 'Mis.: Generative AI in PBL',
      domainLabel: 'Bidang',
      domainPlaceholder: 'Mis.: Pendidikan sains / AI dalam pendidikan',
      yearLabel: 'Tahun rencana submit'
    },
    journalPanel: {
      cardTitle: 'Pengaturan jurnal target',
      targetJournalLabel: 'Jurnal target',
      targetJournalHint: 'Jurnal yang sering dipakai dapat didefinisikan di objek journalProfiles pada kode.',
      metaNameLabel: 'Nama jurnal:',
      metaScopeLabel: 'Cakupan:',
      metaWordLimitLabel: 'Batas jumlah kata:',
      metaStyleLabel: 'Gaya penulisan:',
      metaNoteLabel: 'Catatan:'
    }
  },

  'th': {
    langLabel: 'ภาษาที่ใช้สร้าง',
    nav: {
      project: '1. โปรเจกต์และวารสาร',
      design: '2. การออกแบบวิจัย',
      literature: '3. เอกสารและการอ้างอิง',
      data: '4. ข้อมูลและการวิเคราะห์',
      writing: '5. การเขียนและผู้ประเมิน',
      submission: '6. ชุดส่งบทความ'
    },
    projectPanel: {
      cardTitle: 'ข้อมูลพื้นฐานของโครงการวิจัย',
      projectNameLabel: 'ชื่อโครงการ',
      projectNamePlaceholder: 'เช่น Generative AI in PBL',
      domainLabel: 'สาขา',
      domainPlaceholder: 'เช่น Science education / AI in education',
      yearLabel: 'ปีที่คาดว่าจะส่งตีพิมพ์'
    },
    journalPanel: {
      cardTitle: 'การตั้งค่าวารสารเป้าหมาย',
      targetJournalLabel: 'วารสารเป้าหมาย',
      targetJournalHint: 'สามารถเพิ่มวารสารที่ใช้บ่อยในออบเจ็กต์ journalProfiles ภายในโค้ดได้',
      metaNameLabel: 'ชื่อวารสาร:',
      metaScopeLabel: 'ขอบเขต:',
      metaWordLimitLabel: 'จำนวนคำที่กำหนด:',
      metaStyleLabel: 'รูปแบบการเขียน:',
      metaNoteLabel: 'หมายเหตุ:'
    }
  }
};

  // 每個分頁上方主標題與副標題的語系字典
  const TAB_I18N = {
    'zh-TW': {
      project: {
        title: '專案＆期刊設定',
        subtitle: '從期刊開始，決定整篇論文的遊戲規則。'
      },
      design: {
        title: '研究設計',
        subtitle: '在此整理研究問題、假設、變項與分析方法。'
      },
      literature: {
        title: '文獻＆引用管理',
        subtitle: '所有引用一律來自上傳之文獻池（referencePool）。'
      },
      data: {
        title: '數據＆分析',
        subtitle: '整理統計結果，準備撰寫結果與討論。'
      },
      writing: {
        title: '寫作＆Reviewer',
        subtitle: '分章撰寫，並由 AI 協助檢視與評論。'
      },
      submission: {
        title: '投稿包',
        subtitle: '將稿件、cover letter 與回覆信整合成投稿套餐。'
      }
    },
    'zh-CN': {
      project: {
        title: '项目与期刊设置',
        subtitle: '从目标期刊出发，决定整篇论文的游戏规则。'
      },
      design: {
        title: '研究设计',
        subtitle: '在这里整理研究问题、假设、变量与分析方法。'
      },
      literature: {
        title: '文献与引用管理',
        subtitle: '所有引用一律来自上传的文献池（referencePool）。'
      },
      data: {
        title: '数据与分析',
        subtitle: '整理统计结果，准备撰写结果与讨论。'
      },
      writing: {
        title: '写作与审稿',
        subtitle: '逐章撰写，并由 AI 协助检查与评论。'
      },
      submission: {
        title: '投稿包',
        subtitle: '将稿件、cover letter 与回信整合成投稿套装。'
      }
    },
    'en': {
      project: {
        title: 'Project & journal setup',
        subtitle: 'Start from the target journal to decide the rules of the whole paper.'
      },
      design: {
        title: 'Research design',
        subtitle: 'Organise research questions, hypotheses, variables, and analysis methods here.'
      },
      literature: {
        title: 'Literature & citation management',
        subtitle: 'All citations must come from the uploaded reference pool (referencePool) only.'
      },
      data: {
        title: 'Data & analysis',
        subtitle: 'Organise statistical results and prepare to write Results and Discussion.'
      },
      writing: {
        title: 'Writing & reviewer',
        subtitle: 'Write each section and let the AI help you review and comment.'
      },
      submission: {
        title: 'Submission package',
        subtitle: 'Combine manuscript, cover letter, and response letters into one submission package.'
      }
    },
    'ja': {
      project: {
        title: 'プロジェクトとジャーナルの設定',
        subtitle: 'ターゲットジャーナルから出発して，論文全体の「ルール」を決めます。'
      },
      design: {
        title: '研究デザイン',
        subtitle: 'ここで研究課題・仮説・変数と分析方法を整理します。'
      },
      literature: {
        title: '文献と引用管理',
        subtitle: 'すべての引用はアップロードした文献プール（referencePool）のみから使用します。'
      },
      data: {
        title: 'データと分析',
        subtitle: '統計結果を整理し，結果・考察章の執筆に備えます。'
      },
      writing: {
        title: '執筆と査読',
        subtitle: '章ごとに執筆し，AI によるチェックとコメントを受けます。'
      },
      submission: {
        title: '投稿パッケージ',
        subtitle: '原稿・カバーレター・査読者への返信をひとつの投稿パッケージとしてまとめます。'
      }
    },
    'vi': {
      project: {
        title: 'Thiết lập dự án & tạp chí',
        subtitle: 'Bắt đầu từ tạp chí mục tiêu để xác định “luật chơi” của toàn bài báo.'
      },
      design: {
        title: 'Thiết kế nghiên cứu',
        subtitle: 'Sắp xếp câu hỏi nghiên cứu, giả thuyết, biến số và phương pháp phân tích tại đây.'
      },
      literature: {
        title: 'Quản lý tài liệu & trích dẫn',
        subtitle: 'Mọi trích dẫn đều phải đến từ kho tài liệu đã tải lên (referencePool).'
      },
      data: {
        title: 'Dữ liệu & phân tích',
        subtitle: 'Tổng hợp kết quả thống kê, chuẩn bị viết phần Kết quả và Thảo luận.'
      },
      writing: {
        title: 'Viết bài & phản biện',
        subtitle: 'Viết từng chương và để AI hỗ trợ kiểm tra, phản biện.'
      },
      submission: {
        title: 'Gói gửi bài',
        subtitle: 'Tổng hợp bản thảo, thư gửi biên tập và thư trả lời phản biện thành một gói gửi bài.'
      }
    },
    'id': {
      project: {
        title: 'Pengaturan proyek & jurnal',
        subtitle: 'Mulai dari jurnal tujuan untuk menentukan “aturan main” artikel secara keseluruhan.'
      },
      design: {
        title: 'Desain penelitian',
        subtitle: 'Susun pertanyaan riset, hipotesis, variabel, dan metode analisis di sini.'
      },
      literature: {
        title: 'Manajemen literatur & sitasi',
        subtitle: 'Semua sitasi harus bersumber dari referencePool yang telah diunggah.'
      },
      data: {
        title: 'Data & analisis',
        subtitle: 'Ringkas hasil statistik dan bersiap menulis bagian Hasil dan Pembahasan.'
      },
      writing: {
        title: 'Penulisan & reviewer',
        subtitle: 'Tulis tiap bab dan biarkan AI membantu meninjau dan memberi komentar.'
      },
      submission: {
        title: 'Paket submit',
        subtitle: 'Gabungkan manuskrip, cover letter, dan surat balasan reviewer menjadi satu paket submit.'
      }
    },
    'th': {
      project: {
        title: 'ตั้งค่าโปรเจกต์และวารสาร',
        subtitle: 'เริ่มจากวารสารเป้าหมายเพื่อตั้ง “กติกา” ของบทความทั้งฉบับ.'
      },
      design: {
        title: 'การออกแบบวิจัย',
        subtitle: 'จัดระเบียบคำถามวิจัย สมมติฐาน ตัวแปร และวิธีวิเคราะห์ที่นี่.'
      },
      literature: {
        title: 'การจัดการเอกสารและการอ้างอิง',
        subtitle: 'การอ้างอิงทั้งหมดต้องมาจากคลังเอกสารที่อัปโหลดไว้ (referencePool) เท่านั้น.'
      },
      data: {
        title: 'ข้อมูลและการวิเคราะห์',
        subtitle: 'สรุปผลการวิเคราะห์ทางสถิติ และเตรียมเขียนส่วนผลการวิจัยและอภิปรายผล.'
      },
      writing: {
        title: 'การเขียนและผู้ประเมิน',
        subtitle: 'เขียนทีละบท และให้ AI ช่วยตรวจและให้ความเห็น.'
      },
      submission: {
        title: 'ชุดส่งบทความ',
        subtitle: 'รวมต้นฉบับ จดหมายปะหน้า และจดหมายตอบผู้ประเมินเป็นชุดส่งบทความเดียวกัน.'
      }
    }
  };

  // 套用語系到主要 UI（側欄 nav、header 標題等等）
// 依語系套用到 UI
function applyLanguage(lang) {
  const langCode = lang || state.lang || 'zh-TW';
  const uiPack = UI_I18N[langCode] || UI_I18N['zh-TW'];

  // <html lang="...">
  if (document.documentElement) {
    document.documentElement.lang = langCode;
  }

  // Header：生成語言 label
  const langLabel = document.getElementById('lang-label');
  if (langLabel && uiPack.langLabel) {
    langLabel.textContent = uiPack.langLabel;
  }

  // 側欄 nav 文字
  if (uiPack.nav) {
    const navProject = document.querySelector('.nav-btn[data-tab="project"] span');
    const navDesign = document.querySelector('.nav-btn[data-tab="design"] span');
    const navLiterature = document.querySelector('.nav-btn[data-tab="literature"] span');
    const navData = document.querySelector('.nav-btn[data-tab="data"] span');
    const navWriting = document.querySelector('.nav-btn[data-tab="writing"] span');
    const navSubmission = document.querySelector('.nav-btn[data-tab="submission"] span');

    if (navProject && uiPack.nav.project) navProject.textContent = uiPack.nav.project;
    if (navDesign && uiPack.nav.design) navDesign.textContent = uiPack.nav.design;
    if (navLiterature && uiPack.nav.literature) navLiterature.textContent = uiPack.nav.literature;
    if (navData && uiPack.nav.data) navData.textContent = uiPack.nav.data;
    if (navWriting && uiPack.nav.writing) navWriting.textContent = uiPack.nav.writing;
    if (navSubmission && uiPack.nav.submission) navSubmission.textContent = uiPack.nav.submission;
  }

  // 專案卡片標題 & 標籤
  if (uiPack.projectPanel) {
    const projectCardTitle = document.querySelector('#tab-project .glass:nth-child(1) h2');
    if (projectCardTitle && uiPack.projectPanel.cardTitle) {
      const icon = projectCardTitle.querySelector('i');
      projectCardTitle.innerHTML = '';
      if (icon) projectCardTitle.appendChild(icon);
      projectCardTitle.appendChild(document.createTextNode(' ' + uiPack.projectPanel.cardTitle));
    }

    const projLabels = document.querySelectorAll('#tab-project .glass:nth-child(1) label');
    if (projLabels.length >= 3) {
      if (uiPack.projectPanel.projectNameLabel) projLabels[0].textContent = uiPack.projectPanel.projectNameLabel;
      if (uiPack.projectPanel.domainLabel) projLabels[1].textContent = uiPack.projectPanel.domainLabel;
      if (uiPack.projectPanel.yearLabel) projLabels[2].textContent = uiPack.projectPanel.yearLabel;
    }

    const projTitleInput = document.getElementById('project-title');
    const projFieldInput = document.getElementById('project-field');
    if (projTitleInput && uiPack.projectPanel.projectNamePlaceholder) {
      projTitleInput.placeholder = uiPack.projectPanel.projectNamePlaceholder;
    }
    if (projFieldInput && uiPack.projectPanel.domainPlaceholder) {
      projFieldInput.placeholder = uiPack.projectPanel.domainPlaceholder;
    }
  }

  // 期刊卡片標題 & 標籤
  if (uiPack.journalPanel) {
    const journalCardTitle = document.querySelector('#tab-project .glass:nth-child(2) h2');
    if (journalCardTitle && uiPack.journalPanel.cardTitle) {
      const icon = journalCardTitle.querySelector('i');
      journalCardTitle.innerHTML = '';
      if (icon) journalCardTitle.appendChild(icon);
      journalCardTitle.appendChild(document.createTextNode(' ' + uiPack.journalPanel.cardTitle));
    }

    const journalLabels = document.querySelectorAll('#tab-project .glass:nth-child(2) label');
    if (journalLabels.length >= 1 && uiPack.journalPanel.targetJournalLabel) {
      journalLabels[0].textContent = uiPack.journalPanel.targetJournalLabel;
    }

    const journalHint = document.querySelector('#tab-project .glass:nth-child(2) p.text-[11px]');
    if (journalHint && uiPack.journalPanel.targetJournalHint) {
      journalHint.textContent = uiPack.journalPanel.targetJournalHint;
    }

    // journal-profile-summary 裡的 meta label
    const metaBox = document.getElementById('journal-profile-summary');
    if (metaBox) {
      // 這裡不重構 HTML，只在 updateJournalProfile() 內用 i18n label 會比較乾淨
      // 所以這裡先不直接動 meta 文字
    }
  }

  // main-title / main-subtitle 由 switchTab 依 TAB_I18N 控制
}


  /**********************
   * 全域狀態：v3       *
   **********************/
  const STORAGE_KEY = 'scholarcraft_v3_project';
  let saveTimer = null;

  const state = {
    projectId: 'default',
    lang: 'zh-TW',
    stylePreset: 'balanced',
    projectMeta: {
      title: '',
      field: '',
      year: '2025',
      journalKey: ''
    },
    referencePool: [],
    usedCitationIds: new Set(),
    chapters: {
      outline: '',
      intro: '',
      lit_review: '',
      method: '',
      results: '',
      discussion: '',
      conclusion: '',
      implications: '',
      limitations: '',
      abstract: '',
      fullpaper: ''
    },
    // 研究設計
    design: {
      type: '',
      context: '',
      sample: '',
      instruments: '',
      iv: '',
      dv: '',
      medmod: ''
    },
    rqs: [],          // [{id:'RQ1', text:'...'}]
    hypotheses: [],   // [{id:'H1', text:'...'}]
    analysisPlan: {}, // { 'RQ1': { method:'ANOVA', note:'...' } }
    // 數據
    dataMeta: {
      notes: '',
      rawFileName: '',
      outputFileName: ''
    },
    // 文獻
    litFilesMeta: {
      sourceFileName: ''
    },
    // 快照
    snapshots: []     // [{id, label, createdAt, chapters}]
  };

  document.addEventListener('DOMContentLoaded', () => {
    loadStateFromStorage();
    initNav();
    initLangSelect();
    initJournalSelect();
    initChecklist();
    renderRQList();
    renderHypothesisList();
    renderAnalysisPlan();
    renderAnalysisPlanData();
    renderSnapshotList();
    updateProjectMeta();
    switchChapter(); // 初始化章節
    renderLiteratureList();
    renderLiteraturePreview();
  });

  function scheduleSaveState() {
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(saveStateToStorage, 500);
  }

  function saveStateToStorage() {
    try {
      const safeState = {
        projectId: state.projectId,
        lang: state.lang,
        stylePreset: state.stylePreset,
        projectMeta: state.projectMeta,
        chapters: state.chapters,
        design: state.design,
        rqs: state.rqs,
        hypotheses: state.hypotheses,
        analysisPlan: state.analysisPlan,
        dataMeta: state.dataMeta,
        litFilesMeta: state.litFilesMeta,
        snapshots: state.snapshots,
        referencePool: state.referencePool
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(safeState));
    } catch (e) {
      console.warn('儲存到 localStorage 失敗：', e);
    }
  }

  function loadStateFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const saved = JSON.parse(raw);
      if (!saved || typeof saved !== 'object') return;

      // 合併回 state
      Object.assign(state, {
        projectId: saved.projectId || 'default',
        lang: saved.lang || 'zh-TW',
        stylePreset: saved.stylePreset || 'balanced',
        projectMeta: Object.assign({}, state.projectMeta, saved.projectMeta || {}),
        chapters: Object.assign({}, state.chapters, saved.chapters || {}),
        design: Object.assign({}, state.design, saved.design || {}),
        rqs: saved.rqs || [],
        hypotheses: saved.hypotheses || [],
        analysisPlan: saved.analysisPlan || {},
        dataMeta: Object.assign({}, state.dataMeta, saved.dataMeta || {}),
        litFilesMeta: Object.assign({}, state.litFilesMeta, saved.litFilesMeta || {}),
        snapshots: saved.snapshots || [],
        referencePool: saved.referencePool || []
      });

      // 回填 UI
      document.getElementById('project-title').value = state.projectMeta.title || '';
      document.getElementById('project-field').value = state.projectMeta.field || '';
      document.getElementById('project-year').value = state.projectMeta.year || '2025';
      document.getElementById('design-type').value = state.design.type || '';
      document.getElementById('design-context').value = state.design.context || '';
      document.getElementById('design-sample').value = state.design.sample || '';
      document.getElementById('design-instruments').value = state.design.instruments || '';
      document.getElementById('design-iv').value = state.design.iv || '';
      document.getElementById('design-dv').value = state.design.dv || '';
      document.getElementById('design-medmod').value = state.design.medmod || '';
      document.getElementById('data-notes').value = state.dataMeta.notes || '';
      document.getElementById('style-preset').value = state.stylePreset || 'balanced';

      // 語言選單會在 initLangSelect 中設定 value
    } catch (e) {
      console.warn('讀取 localStorage 失敗：', e);
    }
  }

  /**********************
   * UI 初始化與導覽     *
   **********************/

  function initNav() {
    const firstNav = document.querySelector('.nav-btn[data-tab="project"]');
    if (firstNav) firstNav.classList.add('bg-slate-800');
  }

  function initLangSelect() {
    const sel = document.getElementById('lang-select');
    const langLabel = document.getElementById('lang-label');
    if (!sel) return;

    const options = [
      { value: 'zh-TW', label: '繁體中文' },
      { value: 'en', label: 'English' },
      { value: 'ja', label: '日本語' },
      { value: 'zh-CN', label: '簡體中文' },
      { value: 'vi', label: '越南語' },
      { value: 'id', label: '印尼語' },
      { value: 'th', label: '泰語' }
    ];

    sel.innerHTML = '';
    options.forEach(opt => {
      const o = document.createElement('option');
      o.value = opt.value;
      o.textContent = opt.label;
      sel.appendChild(o);
    });

    // 從 state 還原語系，預設 zh-TW
    const currentLang = state.lang || 'zh-TW';
    sel.value = currentLang;

    // 先套一次目前語系到整個頁面
    applyLanguage(currentLang);
    // 也更新 header 的標題/副標題（需等 main-title/main-subtitle 都存在）
    if (state.currentTab) {
      switchTab(state.currentTab);
    } else {
      switchTab('project');
    }

    sel.addEventListener('change', () => {
      state.lang = sel.value || 'zh-TW';
      scheduleSaveState();

      // 套用新的語系到 UI
      applyLanguage(state.lang);

      // 讓目前所在分頁的主標題 / 副標題也一起換語言
      if (state.currentTab) {
        switchTab(state.currentTab);
      } else {
        switchTab('project');
      }
    });
  }


  function initJournalSelect() {
    const sel = document.getElementById('journal-select');
    if (!sel) return;
    sel.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = '請選擇目標期刊';
    sel.appendChild(placeholder);

    // 分組顯示
    const groupedJournals = {
      'Science & Mathematics Education': [],
      'General Education & Policy': [],
      'Educational Psychology & Measurement': [],
      'Educational Technology & Higher Education': [],
      'Teacher, Special, Diverse Education': []
    };
    Object.entries(state.journalProfiles).forEach(([key, jp]) => {
      if (jp.category && groupedJournals[jp.category]) {
        groupedJournals[jp.category].push({ key, jp });
      } else {
        // 預設分類
        groupedJournals['General Education & Policy'].push({ key, jp });
      }
    });

    Object.entries(groupedJournals).forEach(([category, journals]) => {
      if (journals.length > 0) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = `--- ${category} ---`;
        journals.forEach(({ key, jp }) => {
          const o = document.createElement('option');
          o.value = key;
          o.textContent = `${jp.name} (${jp.abbr})`;
          optgroup.appendChild(o);
        });
        sel.appendChild(optgroup);
      }
    });


    if (state.projectMeta.journalKey) {
      sel.value = state.projectMeta.journalKey;
      updateJournalProfile();
    }
  }

  function initChecklist() {
    const checklist = document.getElementById('chapter-checklist');
    if (!checklist) return;
    // 動態依章節切換的 checklist 在 switchChapter() 裡更新
    updateChecklistForChapter(state.currentChapter || 'outline');
  }

  state.currentChapter = 'outline';

  function switchTab(tabId) {
    state.currentTab = tabId;
    const tabs = ['project', 'design', 'literature', 'data', 'writing', 'submission'];
    tabs.forEach(id => {
      const el = document.getElementById('tab-' + id);
      if (el) el.classList.toggle('hidden', id !== tabId);
    });
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.classList.toggle('bg-slate-800', btn.dataset.tab === tabId);
    });

    const title = document.getElementById('main-title');
    const subtitle = document.getElementById('main-subtitle');
    if (!title || !subtitle) return;

    // 根據目前語系，從 TAB_I18N 取對應文字
    const langCode = state.lang || 'zh-TW';
    const langPack = TAB_I18N[langCode] || TAB_I18N['zh-TW'];
    const tabPack = langPack[tabId];

    if (tabPack) {
      title.textContent = tabPack.title;
      subtitle.textContent = tabPack.subtitle;
    }

    // 其餘和原本一樣：這裡不動 chapter / checklist 等邏輯
  }


  /**********************
   * 章節切換與字數計算 *
   **********************/

  state.currentChapter = 'outline';

  function switchChapter() {
    const sel = document.getElementById('chapter-select');
    if (!sel) return;
    const chapterKey = sel.value;
    state.currentChapter = chapterKey;

    const editors = document.querySelectorAll('.chapter-editor');
    editors.forEach(ed => {
      const isCurrent = ed.dataset.chapter === chapterKey;
      ed.classList.toggle('hidden', !isCurrent);
      if (isCurrent) {
        ed.value = state.chapters[chapterKey] || '';
      }
    });

    const label = document.getElementById('current-chapter-label');
    if (label) {
      label.textContent = sel.options[sel.selectedIndex].textContent || chapterKey;
    }
    updateChecklistForChapter(chapterKey);
    updateWordCounts();
  }

  function onChapterInput(chapterKey, text) {
    state.chapters[chapterKey] = text;
    updateWordCounts();
    scheduleSaveState();
  }

  function getCurrentEditor() {
    return document.querySelector('.chapter-editor[data-chapter="' + state.currentChapter + '"]');
  }

  function getWordStats(text) {
    if (!text) return { cjkChars: 0, enWords: 0, total: 0 };
    const trimmed = text.trim();
    if (!trimmed) return { cjkChars: 0, enWords: 0, total: 0 };

    const rawTokens = trimmed.split(/\s+/).filter(Boolean);
    let cjkChars = 0;
    let enWords = 0;

    rawTokens.forEach(tok => {
      const cjkMatches = tok.match(/[\u4e00-\u9fff\u3040-\u30ff\u31f0-\u31ff]/g); // 包含日文假名
      if (cjkMatches && cjkMatches.length > 0) {
        cjkChars += cjkMatches.length;
      } else {
        // 非 CJK token 當作 1 個英文單字
        enWords += 1;
      }
    });

    return {
      cjkChars,
      enWords,
      total: cjkChars + enWords
    };
  }

  function countWords(text) {
    return getWordStats(text).total;
  }

  function updateWordCounts() {
    const chapterText = state.chapters[state.currentChapter] || '';
    const chapterStats = getWordStats(chapterText);

    let totalStats = { cjkChars: 0, enWords: 0, total: 0 };
    Object.values(state.chapters).forEach(t => {
      const stats = getWordStats(t || '');
      totalStats.cjkChars += stats.cjkChars;
      totalStats.enWords += stats.enWords;
      totalStats.total += stats.total;
    });

    const chapterSpan = document.getElementById('chapter-word-count');
    const totalSpan = document.getElementById('total-word-count');
    if (chapterSpan) {
      chapterSpan.textContent =
        `本章字數：約 ${chapterStats.total}（中/日：${chapterStats.cjkChars} 字 / 英：${chapterStats.enWords} words）`;
    }
    if (totalSpan) {
      totalSpan.textContent =
        `全文字數：約 ${totalStats.total}（中/日：${totalStats.cjkChars} 字 / 英：${totalStats.enWords} words）`;
    }
  }

  /**********************
   * 專案與期刊設定     *
   **********************/

  // 擴充 journalProfiles: 包含 61 本期刊的完整列表
  state.journalProfiles = mapJournalData();


  function mapJournalData() {
    // 您的期刊列表數據，以方便轉換的格式儲存
    const journalList = [
      { id: 'se', name: 'Science Education', abbr: 'SciEd', category: 'Science & Mathematics Education', scope: '總體科學教育，所有層級的理論與實證研究。', wordLimit: '7,500 - 10,000 字', note: '理論性貢獻、廣泛影響力、批判性分析。' },
      { id: 'jrst', name: 'Journal of Research in Science Teaching', abbr: 'JRST', category: 'Science & Mathematics Education', scope: '科學教學與學習的原創實證研究、方法學嚴謹性。', wordLimit: '7,000 - 8,000 字', note: '嚴謹的方法論、對實踐和理論的具體貢獻。' },
      { id: 'ijse', name: 'International Journal of Science Education', abbr: 'IJSE', category: 'Science & Mathematics Education', scope: '國際視野下的科學教學與學習，鼓勵跨文化研究。', wordLimit: '7,000 - 8,000 字', note: '國際比較與情境化、研究結果應用性。' },
      { id: 'rise', name: 'Research in Science Education', abbr: 'RISE', category: 'Science & Mathematics Education', scope: '澳洲/亞太地區科學教育研究，涵蓋所有科學學科。', wordLimit: '8,000 字以內', note: '澳洲與亞太視角、實證性、跨學科議題、課程改革。' },
      { id: 'sise', name: 'Studies in Science Education', abbr: 'SISE', category: 'Science & Mathematics Education', scope: '對特定科學教育研究領域的批判性文獻回顧或理論建構。', wordLimit: '約 10,000 字', note: '文獻綜合與批判、理論建構 (不接受原始實證)。' },
      { id: 'jset', name: 'J Sci Edu Technol', abbr: 'JSET', category: 'Science & Mathematics Education', scope: '科學教育中的技術應用、教學干預與評估。', wordLimit: '6,000 - 8,000 字', note: '科技整合、實證數據、創新教學設計。' },
      { id: 'ijsme', name: 'IJSME', abbr: 'IJSME', category: 'Science & Mathematics Education', scope: '數學與科學教育的綜合研究，著重教學實踐。', wordLimit: '7,000 - 9,000 字', note: '跨學科整合 (STEM)、教學實踐與學習成效。' },
      { id: 'jrme', name: 'Journal for Research in Mathematics Education', abbr: 'JRME', category: 'Science & Mathematics Education', scope: '數學教育領域最頂尖的理論與實證研究。', wordLimit: '8,000 - 10,000 字', note: '深度理論探討、數學教育認知與教學法創新。' },
      { id: 'cie', name: 'Cultural Studies of Science Education', abbr: 'CSSE', category: 'Science & Mathematics Education', scope: '運用文化研究視角探討科學教育的社會、政治與文化面向。', wordLimit: '8,000 - 10,000 字', note: '社會文化、批判性理論、科學教育的公平性。' },
      { id: 'bse', name: 'Baltic Science Education', abbr: 'BSE', category: 'Science & Mathematics Education', scope: '波羅的海國家科學教育研究，專注科學、數學、技術教育。', wordLimit: '6,000 - 8,000 字', note: '波羅的海/東歐情境、實踐性、教育科技應用。' },
      { id: 'ejmste', name: 'Eurasia J of Math, Science and Tech Edu', abbr: 'EJMSTE', category: 'Science & Mathematics Education', scope: '數學、科學與技術教育的實踐與研究，國際性。', wordLimit: '6,000 - 8,000 字', note: '亞洲與歐洲的 STEM 教育研究、實證數據。' },
      { id: 'eer', name: 'Environmental Education Research', abbr: 'EER', category: 'Science & Mathematics Education', scope: '環境教育與永續發展教育的研究，與科學教育高度相關。', wordLimit: '7,000 - 9,000 字', note: '環境議題、教育政策與跨學科教學。' },

      { id: 'rer', name: 'Review of Educational Research', abbr: 'RER', category: 'General Education & Policy', scope: '教育領域的系統性、批判性文獻回顧或整合分析。', wordLimit: '10,000 - 15,000 字+', note: '頂尖文獻綜合、高影響力結論、理論建構。' },
      { id: 'aerj', name: 'American Educational Research Journal', abbr: 'AERJ', category: 'General Education & Policy', scope: '教育領域最高品質的原創實證研究（量化、質化、混合）。', wordLimit: '8,000 - 10,000 字', note: '最高標準的方法學嚴謹性、理論與實踐重大貢獻。' },
      { id: 'er', name: 'Educational Researcher', abbr: 'ER', category: 'General Education & Policy', scope: '廣泛教育議題的評論、政策、方法論文章與簡報。', wordLimit: '4,000 - 8,000 字 (依類型)', note: '時效性與政策相關性、對學術界影響廣泛。' },
      { id: 'aje', name: 'American Journal of Education', abbr: 'AJE', category: 'General Education & Policy', scope: '著重教育的歷史、社會學、政治學視角與社會正義。', wordLimit: '8,000 - 10,000 字', note: '批判性分析、歷史與文化情境化、社會公平。' },
      { id: 'berj', name: 'British Educational Research Journal', abbr: 'BERJ', category: 'General Education & Policy', scope: '英國教育研究協會刊物，國際性綜合教育研究。', wordLimit: '7,000 - 9,000 字', note: '國際化、涵蓋課程、政策、心理學等多領域。' },
      { id: 'eepa', name: 'Educational Evaluation and Policy Analysis', abbr: 'EEPA', category: 'General Education & Policy', scope: '教育政策的制定、執行、評估與問責制研究。', wordLimit: '7,000 - 9,000 字', note: '政策分析、大規模數據、嚴謹的量化方法。' },
      { id: 'ep', name: 'Educational Policy', abbr: 'EP', category: 'General Education & Policy', scope: '專注於教育政策的影響、改革、政治學分析。', wordLimit: '8,000 - 10,000 字', note: '政策理論、國際比較、宏觀層面分析。' },
      { id: 'cer', name: 'Comparative Education Review', abbr: 'CER', category: 'General Education & Policy', scope: '比較教育與國際教育發展議題研究。', wordLimit: '7,000 - 9,000 字', note: '跨國比較、全球教育趨勢、發展中國家教育。' },
      { id: 'ci', name: 'Curriculum Inquiry', abbr: 'CI', category: 'General Education & Policy', scope: '課程理論、課程社會學與哲學探討。', wordLimit: '8,000 - 10,000 字', note: '理論性與哲學探討、課程設計的批判性研究。' },
      { id: 'jcs', name: 'Journal of Curriculum Studies', abbr: 'JCS', category: 'General Education & Policy', scope: '國際性課程研究，涵蓋課程的理論與實踐。', wordLimit: '7,000 - 8,000 字', note: '課程實踐與理論的結合、國際課程比較。' },
      { id: 'tcr', name: 'Teachers College Record', abbr: 'TCR', category: 'General Education & Policy', scope: '跨學科教育研究，涵蓋歷史、哲學、社會學、政策。', wordLimit: '8,000 - 10,000 字', note: '廣泛議題、歷史/社會背景下的教育問題。' },
      { id: 'rre', name: 'Review of Research in Education', abbr: 'RRE', category: 'General Education & Policy', scope: '每年針對一個主題進行深入的綜合評論。', wordLimit: '10,000 - 15,000 字', note: '深度主題分析、對年度研究主題的綜合貢獻。' },
      { id: 'emald', name: 'Educational Management Administration & Leadership', abbr: 'EMAL', category: 'General Education & Policy', scope: '學校行政、管理與領導力研究。', wordLimit: '7,000 - 8,000 字', note: '領導者角色、學校效能、管理理論應用。' },
      { id: 'jec', name: 'Journal of Educational Change', abbr: 'JEC', category: 'General Education & Policy', scope: '專注於教育系統、機構、學校的變革與創新。', wordLimit: '7,000 - 9,000 字', note: '變革理論、教育創新實施、阻力與成功因素。' },
      { id: 'ijed', name: 'International J of Educational Development', abbr: 'IJED', category: 'General Education & Policy', scope: '專注於發展中國家教育與國際援助的議題。', wordLimit: '7,000 - 9,000 字', note: '發展性政策、國際教育援助、教育與發展。' },
      { id: 'err', name: 'Educational Research Review', abbr: 'ERR', category: 'General Education & Policy', scope: '高品質的教育研究文獻評論期刊 (非 RER)。', wordLimit: '8,000 - 10,000 字', note: '系統性回顧、某一研究領域的綜合分析。' },
      { id: 'ore', name: 'Oxford Review of Education', abbr: 'ORE', category: 'General Education & Policy', scope: '英國頂尖教育評論期刊，涵蓋政策、歷史、比較教育。', wordLimit: '8,000 - 10,000 字', note: '高品質評論、對教育學術界的貢ALI獻。' },

      { id: 'jep', name: 'Journal of Educational Psychology', abbr: 'JEP', category: 'Educational Psychology & Measurement', scope: '學習、記憶、動機、教學的心理學基礎。', wordLimit: '8,000 - 10,000 字', note: '實驗設計、高內部效度、嚴格的心理學實證。' },
      { id: 'li', name: 'Learning and Instruction', abbr: 'L&I', category: 'Educational Psychology & Measurement', scope: '學習與教學過程的實證研究，強調認知與情境。', wordLimit: '7,500 - 9,000 字', note: '教學干預、學習機制的認知與情境分析。' },
      { id: 'cep', name: 'Contemporary Educational Psychology', abbr: 'CEP', category: 'Educational Psychology & Measurement', scope: '學習、發展、動機與教學的實驗與實證研究。', wordLimit: '6,000 - 8,000 字', note: '實驗/準實驗設計、認知與動機機制。' },
      { id: 'epst', name: 'Educational Psychologist', abbr: 'EPst', category: 'Educational Psychology & Measurement', scope: '教育心理學的理論、評論與應用。', wordLimit: '7,000 - 9,000 字', note: '理論建構、教育心理學概念的綜合與批判。' },
      { id: 'ame', name: 'Applied Measurement in Education', abbr: 'AME', category: 'Educational Psychology & Measurement', scope: '教育測量與評估的應用研究，心理計量學。', wordLimit: '7,000 - 9,000 字', note: '測量理論、IRT、教育評估工具的開發與應用。' },
      { id: 'epm', name: 'Educational and Psychological Measurement', abbr: 'EPM', category: 'Educational Psychology & Measurement', scope: '專注於教育與心理測量的方法學與理論。', wordLimit: '8,000 - 10,000 字', note: '心理計量學理論與發展、測量工具的嚴謹度。' },
      { id: 'jee', name: 'Journal of Experimental Education', abbr: 'JEE', category: 'Educational Psychology & Measurement', scope: '實驗設計和教育評估方法，強調因果推論。', wordLimit: '7,000 - 9,000 字', note: '嚴格的實驗設計、量化方法學。' },
      { id: 'cije', name: 'Cognition and Instruction', abbr: 'C&I', category: 'Educational Psychology & Measurement', scope: '學習、認知與教學的交集，強調高階思維。', wordLimit: '8,000 - 10,000 字', note: '複雜認知過程、教學設計與認知負荷。' },
      { id: 'dp', name: 'Developmental Psychology', abbr: 'DP', category: 'Educational Psychology & Measurement', scope: '發展心理學研究，包括兒童在教育情境下的發展。', wordLimit: '8,000 - 10,000 字', note: '兒童與青少年發展、長期縱向研究。' },
      { id: 'esj', name: 'The Elementary School Journal', abbr: 'ESJ', category: 'Educational Psychology & Measurement', scope: '專注於 K-8 階段的課程、教學、教育心理學。', wordLimit: '7,000 - 9,000 字', note: '小學到初中教育、實證研究、政策相關性。' },

      { id: 'etrd', name: 'Educational Technology Research and Development', abbr: 'ETR&D', category: 'Educational Technology & Higher Education', scope: '教學設計、教育科技的發展、實施和評估。', wordLimit: '6,000 - 8,000 字', note: '設計與發展 (D&D) 研究、教學系統設計。' },
      { id: 'ce', name: 'Computers & Education', abbr: 'C&E', category: 'Educational Technology & Higher Education', scope: '電腦與數位工具在各級教育中的應用與影響。', wordLimit: '7,500 - 9,000 字', note: '技術效用、嚴謹的實證數據、對教學實踐的啟示。' },
      { id: 'bjet', name: 'British Journal of Educational Technology', abbr: 'BJET', category: 'Educational Technology & Higher Education', scope: '教育科技的理論、實踐與設計，英國或國際性視野。', wordLimit: '6,000 - 8,000 字', note: '科技整合理論、教育技術的創新設計。' },
      { id: 'ihe', name: 'The Internet and Higher Education', abbr: 'IHE', category: 'Educational Technology & Higher Education', scope: '網路與數位技術在高等教育中的應用和影響。', wordLimit: '7,000 - 8,000 字', note: '高等教育科技、線上學習、數位校園。' },
      { id: 'ile', name: 'Interactive Learning Environments', abbr: 'ILE', category: 'Educational Technology & Higher Education', scope: '互動學習環境的設計、技術與評估。', wordLimit: '7,000 - 9,000 字', note: 'AR/VR/沉浸式技術、人機互動與學習成效。' },
      { id: 'rhe', name: 'The Review of Higher Education', abbr: 'RHE', category: 'Educational Technology & Higher Education', scope: '高等教育的理論、研究與政策。', wordLimit: '8,000 - 10,000 字', note: '高等教育政策、行政管理、學生發展。' },
      { id: 'he', name: 'Higher Education', abbr: 'HE', category: 'Educational Technology & Higher Education', scope: '國際化的高等教育研究，涵蓋全球趨勢。', wordLimit: '7,000 - 9,000 字', note: '國際比較、高等教育系統分析、跨國合作。' },
      { id: 'jhe', name: 'Journal of Higher Education', abbr: 'JHE', category: 'Educational Technology & Higher Education', scope: '高等教育的機構、領導、財務與政策研究。', wordLimit: '8,000 - 10,000 字', note: '領導力與治理、高等教育的社會學分析。' },
      { id: 'alhe', name: 'Active Learning in Higher Education', abbr: 'ALHE', category: 'Educational Technology & Higher Education', scope: '專注於高等教育中的主動學習教學法與策略。', wordLimit: '6,000 - 8,000 字', note: '教學創新、學生參與、課程設計的實證研究。' },
      { id: 'jcal', name: 'Journal of Computer Assisted Learning', abbr: 'JCAL', category: 'Educational Technology & Higher Education', scope: '運用電腦輔助學習的實證研究，側重學習成效。', wordLimit: '7,000 - 9,000 字', note: '輔助學習機制、技術干預與認知負荷。' },
      { id: 'tihe', name: 'Teaching in Higher Education', abbr: 'TiHE', category: 'Educational Technology & Higher Education', scope: '高等教育中的教學實踐、課程與評估。', wordLimit: '6,000 - 8,000 字', note: '高等教育教學法、教師專業發展、教學創新。' },

      { id: 'tte', name: 'Teaching and Teacher Education', abbr: 'TTE', category: 'Teacher, Special, Diverse Education', scope: '教師的職前與在職教育、專業發展研究。', wordLimit: '7,000 - 8,000 字', note: '教師知能、專業發展模式、教師生命週期。' },
      { id: 'jte', name: 'Journal of Teacher Education', abbr: 'JTE', category: 'Teacher, Special, Diverse Education', scope: '教師教育的理論、政策與實踐。', wordLimit: '8,000 - 10,000 字', note: '教師教育課程設計、教育公平、政策影響。' },
      { id: 'ec', name: 'Exceptional Children', abbr: 'EC', category: 'Teacher, Special, Diverse Education', scope: '特殊教育與身心障礙兒童教育的原創實證研究。', wordLimit: '7,000 - 9,000 字', note: '干預與評估、對特殊教育實踐有直接影響。' },
      { id: 'jld', name: 'Journal of Learning Disabilities', abbr: 'JLD', category: 'Teacher, Special, Diverse Education', wordLimit: '7,000 - 9,000 字', scope: '學習障礙的識別、評估與干預研究。', note: '診斷工具、有效教學策略、神經學基礎。' },
      { id: 'gcq', name: 'Gifted Child Quarterly', abbr: 'GCQ', category: 'Teacher, Special, Diverse Education', scope: '資優教育的理論、研究與實踐。', wordLimit: '6,000 - 8,000 字', note: '資優生鑑定、資優課程設計與社會情感發展。' },
      { id: 'ijie', name: 'International Journal of Inclusive Education', abbr: 'IJIE', category: 'Teacher, Special, Diverse Education', scope: '融合教育的理論、政策與實踐。', wordLimit: '7,000 - 9,000 字', note: '融合教育模式、教育公平、多元文化教育。' },
      { id: 'aeq', name: 'Adult Education Quarterly', abbr: 'AEQ', category: 'Teacher, Special, Diverse Education', scope: '成人教育與終身學習研究。', wordLimit: '7,000 - 9,000 字', note: '成人學習理論、非正規教育、繼續教育。' },
      { id: 'jrce', name: 'Journal of Research in Childhood Education', abbr: 'JRCE', category: 'Teacher, Special, Diverse Education', scope: '專注於幼兒教育、早期學習與發展。', wordLimit: '6,000 - 8,000 字', note: '學前與幼兒教育、社會情感發展。' },
      { id: 'ted', name: 'Teaching Education', abbr: 'T Ed', category: 'Teacher, Special, Diverse Education', scope: '專注於教師教育的實踐與反思。', wordLimit: '7,000 - 8,000 字', note: '實踐社區、師資培訓模式、教師身份認同。' },
      { id: 'jle', name: 'Journal of Latinos and Education', abbr: 'JLE', category: 'Teacher, Special, Diverse Education', scope: '專注於拉丁裔學生的教育議題、公平與文化。', wordLimit: '7,000 - 9,000 字', note: '種族、文化與教育公平、多元文化教育。' },
      { id: 'gae', name: 'Gender and Education', abbr: 'G&E', category: 'Teacher, Special, Diverse Education', scope: '教育中的性別議題、公平與社會學分析。', wordLimit: '8,000 - 10,000 字', note: '性別理論、教育中的權力結構、女性主義教育。' },
      // 額外加入先前存在的 TSSCI/SSCI 範例
      { id: 'taper', name: 'Asia-Pacific Education Researcher', abbr: 'TAPER', category: 'General Education & Policy', scope: 'Education · Asia-Pacific · empirical and theoretical studies', wordLimit: '約 8,000–10,000 英文字', note: '偏向實證研究與區域性教育議題。' },
      { id: 'jer', name: '教育研究集刊', abbr: 'JES', category: 'General Education & Policy', scope: '教育學術研究，涵蓋各類教育議題', wordLimit: '約 2 萬字（中文）', note: '國內教育學界頂尖中文期刊，對理論深度與實務意涵要求高。' },
      { id: 'jsera', name: '中華民國教育學會學術論文集', abbr: 'JSERA', category: 'General Education & Policy', scope: '教育政策、哲學、社會學、心理學等', wordLimit: '約 1.5 萬字（中文）', note: '中文教育類核心期刊，接受多元研究取向。' }
    ];

    // 將陣列轉換為 {key: profile} 物件格式
    return journalList.reduce((acc, curr) => {
      acc[curr.id] = {
        name: curr.name,
        abbr: curr.abbr,
        scope: curr.scope,
        wordLimit: curr.wordLimit,
        style: 'APA 7th edition', // 預設使用 APA 7th
        note: curr.note,
        category: curr.category // 用於前端分組
      };
      return acc;
    }, {});
  }
  
  function updateProjectMeta() {
    const title = document.getElementById('project-title')?.value || '';
    const field = document.getElementById('project-field')?.value || '';
    const year = document.getElementById('project-year')?.value || '';

    state.projectMeta.title = title;
    state.projectMeta.field = field;
    state.projectMeta.year = year || '2025';

    const sidebarName = document.getElementById('sidebar-project-name');
    if (sidebarName) sidebarName.textContent = title || '未命名專案';

    const meta = document.getElementById('user-meta');
    if (meta) {
      meta.textContent = field && year
        ? field + ' · Target ' + year
        : 'Local project · Auto-save';
    }
  }

  function updateJournalProfile() {
    const sel = document.getElementById('journal-select');
    if (!sel) return;
    const key = sel.value;
    state.projectMeta.journalKey = key;
    const profile = state.journalProfiles[key];
    const box = document.getElementById('journal-profile-summary');
    if (!box) return;

    const sidebarJournal = document.getElementById('sidebar-journal');
    if (sidebarJournal) {
      sidebarJournal.textContent = profile ? profile.name : '未設定';
    }

    if (!profile) {
      box.innerHTML = '<p class="text-slate-500">尚未選擇期刊。</p>';
      return;
    }

    box.innerHTML = `
      <div><span class="text-slate-400">期刊名稱：</span><span class="font-semibold">${profile.name} (${profile.abbr})</span></div>
      <div><span class="text-slate-400">範疇：</span><span>${profile.scope}</span></div>
      <div><span class="text-slate-400">字數限制：</span><span>${profile.wordLimit}</span></div>
      <div><span class="text-slate-400">寫作體例：</span><span>${profile.style}</span></div>
      <div><span class="text-slate-400">備註：</span><span>${profile.note}</span></div>
    `;
  }

  function updateStylePreset() {
    const sel = document.getElementById('style-preset');
    if (!sel) return;
    state.stylePreset = sel.value;
    scheduleSaveState();
  }

  /**********************
   * 研究設計 / RQ / H *
   **********************/

  function updateResearchDesign() {
    state.design.type = document.getElementById('design-type').value || '';
    state.design.context = document.getElementById('design-context').value || '';
    state.design.sample = document.getElementById('design-sample').value || '';
    state.design.instruments = document.getElementById('design-instruments').value || '';
    state.design.iv = document.getElementById('design-iv').value || '';
    state.design.dv = document.getElementById('design-dv').value || '';
    state.design.medmod = document.getElementById('design-medmod').value || '';
    renderAnalysisPlan();
    renderAnalysisPlanData();
  }

  function addRQ() {
    const id = 'RQ' + (state.rqs.length + 1);
    state.rqs.push({ id, text: '' });
    renderRQList();
    renderAnalysisPlan();
    renderAnalysisPlanData();
    scheduleSaveState();
  }

  function updateRQText(id, text) {
    const rq = state.rqs.find(r => r.id === id);
    if (rq) rq.text = text;
    scheduleSaveState();
  }

  function removeRQ(id) {
    state.rqs = state.rqs.filter(r => r.id !== id);
    delete state.analysisPlan[id];
    renderRQList();
    renderAnalysisPlan();
    renderAnalysisPlanData();
    scheduleSaveState();
  }

  function renderRQList() {
    const list = document.getElementById('rq-list');
    if (!list) return;
    list.innerHTML = '';
    if (!state.rqs.length) {
      list.innerHTML = '<p class="text-[11px] text-slate-400">尚未新增 RQ。</p>';
      return;
    }
    state.rqs.forEach(rq => {
      const div = document.createElement('div');
      div.className = 'border border-slate-200 rounded p-1.5 bg-white';
      div.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="text-slate-500 font-semibold">${rq.id}</span>
          <button class="text-[10px] text-rose-500 hover:underline" onclick="removeRQ('${rq.id}')">
            刪除
          </button>
        </div>
        <textarea class="w-full border border-slate-300 rounded px-1 py-0.5 text-[11px]" rows="2"
          placeholder="撰寫研究問題"
          oninput="updateRQText('${rq.id}', this.value)">${escapeHtml(rq.text || '')}</textarea>
      `;
      list.appendChild(div);
    });
  }

  function addHypothesis() {
    const id = 'H' + (state.hypotheses.length + 1);
    state.hypotheses.push({ id, text: '' });
    renderHypothesisList();
    scheduleSaveState();
  }

  function updateHypothesisText(id, text) {
    const h = state.hypotheses.find(x => x.id === id);
    if (h) h.text = text;
    scheduleSaveState();
  }

  function removeHypothesis(id) {
    state.hypotheses = state.hypotheses.filter(h => h.id !== id);
    renderHypothesisList();
    scheduleSaveState();
  }

  function renderHypothesisList() {
    const list = document.getElementById('hypo-list');
    if (!list) return;
    list.innerHTML = '';
    if (!state.hypotheses.length) {
      list.innerHTML = '<p class="text-[11px] text-slate-400">尚未新增假設。</p>';
      return;
    }
    state.hypotheses.forEach(h => {
      const div = document.createElement('div');
      div.className = 'border border-slate-200 rounded p-1.5 bg-white';
      div.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="text-slate-500 font-semibold">${h.id}</span>
          <button class="text-[10px] text-rose-500 hover:underline" onclick="removeHypothesis('${h.id}')">
            刪除
          </button>
          </div>
        <textarea class="w-full border border-slate-300 rounded px-1 py-0.5 text-[11px]" rows="2"
          placeholder="撰寫研究假設"
          oninput="updateHypothesisText('${h.id}', this.value)">${escapeHtml(h.text || '')}</textarea>
      `;
      list.appendChild(div);
    });
  }

  function setAnalysisMethod(rqId, method) {
    if (!state.analysisPlan[rqId]) state.analysisPlan[rqId] = {};
    state.analysisPlan[rqId].method = method;
    renderAnalysisPlanData();
    scheduleSaveState();
  }

  function setAnalysisNote(rqId, note) {
    if (!state.analysisPlan[rqId]) state.analysisPlan[rqId] = {};
    state.analysisPlan[rqId].note = note;
    scheduleSaveState();
  }

  function renderAnalysisPlan() {
    const box = document.getElementById('analysis-plan');
    if (!box) return;
    box.innerHTML = '';
    if (!state.rqs.length) {
      box.innerHTML = '<p class="text-[11px] text-slate-400">尚未設定 RQ，無法建立分析對應。</p>';
      return;
    }
    state.rqs.forEach(rq => {
      const plan = state.analysisPlan[rq.id] || {};
      const div = document.createElement('div');
      div.className = 'border border-slate-200 rounded p-2 bg-white';
      div.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="text-slate-600 font-semibold">${rq.id}</span>
          <span class="text-[10px] text-slate-400">主要分析方法</span>
        </div>
        <div class="flex items-center gap-2 mb-1">
          <select class="px-2 py-1 rounded border border-slate-300 text-[11px]"
                  onchange="setAnalysisMethod('${rq.id}', this.value)">
            <option value="">未指定</option>
            <option value="t-test" ${plan.method==='t-test'?'selected':''}>t-test</option>
            <option value="ANOVA" ${plan.method==='ANOVA'?'selected':''}>ANOVA / ANCOVA</option>
            <option value="MLR" ${plan.method==='MLR'?'selected':''}>多元迴歸 (MLR)</option>
            <option value="SEM" ${plan.method==='SEM'?'selected':''}>結構方程 (SEM)</option>
            <option value="LMM" ${plan.method==='LMM'?'selected':''}>線性混合模式 (LMM)</option>
            <option value="LCA" ${plan.method==='LCA'?'selected':''}>潛在類別分析 (LCA)</option>
            <option value="Qual" ${plan.method==='Qual'?'selected':''}>質性主題分析</option>
          </select>
        </div>
        <textarea class="w-full border border-slate-300 rounded px-1 py-0.5 text-[11px]" rows="2"
          placeholder="補充：主要 DV / 統計控制變項 / 重要備註"
          oninput="setAnalysisNote('${rq.id}', this.value)">${escapeHtml(plan.note || '')}</textarea>
      `;
      box.appendChild(div);
    });
  }

  function renderAnalysisPlanData() {
    const box = document.getElementById('analysis-plan-data');
    if (!box) return;
    box.innerHTML = '';
    if (!state.rqs.length) {
      box.innerHTML = '<p class="text-[11px] text-slate-400">尚未設定 RQ。</p>';
      return;
    }
    state.rqs.forEach(rq => {
      const plan = state.analysisPlan[rq.id] || {};
      const div = document.createElement('div');
      div.className = 'border border-slate-200 rounded p-2 bg-white';
      div.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="font-semibold text-slate-700">${rq.id}</span>
          <span class="text-[10px] text-slate-400">${plan.method || '分析方法未設定'}</span>
        </div>
        <p class="text-[11px] text-slate-600 mb-1">${escapeHtml(rq.text || '尚未撰寫 RQ 內容')}</p>
        <p class="text-[10px] text-slate-500">
          ${plan.note ? escapeHtml(plan.note) : '尚未補充分析備註。'}
        </p>
      `;
      box.appendChild(div);
    });
  }

  /**********************
   * 文獻庫 referencePool
   **********************/

  function handleLiteratureUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    state.litFilesMeta.sourceFileName = file.name;
    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet);

      const pool = [];
      rows.forEach((row, idx) => {
        const authorsRaw =
          row.Author ||
          row.Authors ||
          row['Authors'] ||
          row.AU ||
          row['AU'] ||
          '';
        const yearRaw =
          row.Year ||
          row.PY ||
          row['PY'] ||
          '';
        const titleRaw =
          row.Title ||
          row['Article Title'] ||
          row['Document Title'] ||
          row.TI ||
          row['TI'] ||
          '';
        const journalRaw =
          row.Journal ||
          row['Source Title'] ||
          row['Journal Name'] ||
          row.SO ||
          row['SO'] ||
          '';
        const doiRaw =
          row.DOI ||
          row.Doi ||
          row['DOI'] ||
          row.DI ||
          row['DI'] ||
          '';

        const authors = (authorsRaw || '').toString().trim();
        const year = (yearRaw || '').toString().trim();
        const title = (titleRaw || '').toString().trim();
        const journal = (journalRaw || '').toString().trim();
        const doi = (doiRaw || '').toString().trim();

        if (!authors && !year && !title && !journal) {
          console.warn('文獻第 ' + (idx+1) + ' 筆欄位皆為空，已略過。');
          return;
        }

        pool.push({
          id: 'ref-' + (idx + 1),
          authors,
          year,
          title,
          journal,
          doi
        });
      });

      state.referencePool = pool;
      const litCount = document.getElementById('lit-count');
      if (litCount) litCount.textContent = state.referencePool.length;

      renderLiteratureList();
      renderLiteraturePreview();
      scheduleSaveState();
    };
    reader.readAsArrayBuffer(file);
  }

  function renderLiteratureList() {
    const box = document.getElementById('lit-list');
    const input = document.getElementById('lit-search');
    if (!box) return;
    const keyword = (input?.value || '').toLowerCase();

    box.innerHTML = '';
    if (!state.referencePool.length) {
      box.innerHTML = '<p class="text-slate-400 text-[11px]">尚未上傳文獻庫。</p>';
      return;
    }

    state.referencePool
      .filter(ref => {
        if (!keyword) return true;
        const s = (ref.authors + ' ' + ref.title + ' ' + ref.journal).toLowerCase();
        return s.includes(keyword);
      })
      .slice(0, 50)
      .forEach(ref => {
        const div = document.createElement('div');
        div.className = 'flex items-start justify-between gap-2 py-1 border-b border-slate-200/70';
        div.innerHTML = `
          <div class="flex-1">
            <div class="font-semibold text-[11px]">${escapeHtml(ref.authors || 'Unknown')} (${escapeHtml(ref.year || 'n.d.')})</div>
            <div class="text-[10px] text-slate-600">${escapeHtml(ref.title || '')}</div>
            <div class="text-[10px] text-slate-400 italic">${escapeHtml(ref.journal || '')}</div>
          </div>
          <button class="px-2 py-1 rounded bg-emerald-600 text-white text-[10px] hover:bg-emerald-700"
                  onclick="insertCitation('${ref.id}')">
            插入
          </button>
        `;
        box.appendChild(div);
      });
  }

function renderLiteraturePreview() {
  const tbody = document.getElementById('lit-preview-body');
  if (!tbody) return;
  tbody.innerHTML = '';

  const items = state.referencePool || [];
  items.forEach((item, idx) => {
    const tr = document.createElement('tr');
    tr.className = idx % 2 === 0 ? 'bg-white' : 'bg-slate-50';

    const author = item.author || item.Author || '';
    const year = item.year || item.Year || '';
    const title = item.title || item.Title || '';
    const journal = item.journal || item.Journal || '';

    tr.innerHTML = `
      <td class="px-2 py-1 align-top text-slate-400">${idx + 1}</td>
      <td class="px-2 py-1 align-top">${escapeHtml(author)}</td>
      <td class="px-2 py-1 align-top">${escapeHtml(String(year))}</td>
      <td class="px-2 py-1 align-top">${escapeHtml(title)}</td>
      <td class="px-2 py-1 align-top">${escapeHtml(journal)}</td>
    `;
    tbody.appendChild(tr);
  });

  const countBadge = document.getElementById('lit-count');
  if (countBadge) {
    countBadge.textContent = items.length;
  }
}


  async function syncLiteratureToBackend() {
    if (!state.referencePool.length) {
      alert('請先上傳文獻庫（referencePool）。');
      return;
    }
    const result = await callBackend('/syncReferences', {
      projectId: state.projectId,
      referencePool: state.referencePool
    });
    if (!result.ok) {
      alert('同步到後端失敗：' + (result.error || '未知錯誤'));
      return;
    }
    alert(result.data.message || '文獻庫已送出後端處理。');
  }

  /**********************
   * 引文插入與 References
   **********************/

   function insertCitation(refId) {
    const ref = state.referencePool.find(r => r.id === refId);
    if (!ref) {
      alert('此文獻不在 referencePool 中，禁止引用。');
      return;
    }

    const editor = getCurrentEditor();
    if (!editor) {
      alert('請先切換到要插入的章節編輯區。');
      return;
    }

    const citation = buildInTextCitation(ref);
    const start = editor.selectionStart || 0;
    const end = editor.selectionEnd || start;
    const original = editor.value || '';

    const before = original.slice(0, start);
    const after = original.slice(end);
    const needsSpaceBefore = before && !/\s$/.test(before);
    const needsSpaceAfter = after && !/^\s/.test(after);

    const insertText =
      (needsSpaceBefore ? ' ' : '') +
      citation +
      (needsSpaceAfter ? ' ' : '');

    const newValue = before + insertText + after;
    editor.value = newValue;

    // 更新 state & 字數
    state.chapters[state.currentChapter] = newValue;
    state.usedCitationIds.add(refId);
    updateWordCounts();
    scheduleSaveState();
  }

  // 產生內文括號引用 (Author, Year) / (Author et al., Year)
  function buildInTextCitation(ref) {
    const year = (ref.year || 'n.d.').toString().trim();
    let authors = (ref.authors || 'Author').toString().trim();

    // 先抓第一位作者
    let primary = authors.split(/;|,|&| and |、/i)[0].trim();
    primary = primary.replace(/\.$/, '');

    const hasMultiple =
      /;|&| and |、/.test(authors);

    if (!primary) primary = 'Author';

    return hasMultiple
      ? `(${primary} et al., ${year})`
      : `(${primary}, ${year})`;
  }

  /**********************
   * References 生成     *
   **********************/

  function generateReferencesSection() {
    if (!state.referencePool.length) {
      alert('尚未上傳文獻庫（referencePool）。');
      return;
    }
    if (!state.usedCitationIds || state.usedCitationIds.size === 0) {
      alert('目前尚未插入任何引用，無法生成 References。');
      return;
    }

    // 只取實際使用過的文獻
    const used = state.referencePool.filter(ref =>
      state.usedCitationIds.has(ref.id)
    );

    if (!used.length) {
      alert('目前 usedCitationIds 為空，請重新插入引文後再試。');
      return;
    }

    // 依作者 / 年排序
    used.sort((a, b) => {
      const aKey = (a.authors || '').toLowerCase();
      const bKey = (b.authors || '').toLowerCase();
      if (aKey < bKey) return -1;
      if (aKey > bKey) return 1;
      const ay = parseInt(a.year) || 0;
      const by = parseInt(b.year) || 0;
      return ay - by;
    });

    const lines = used.map(ref => {
      const authors = ref.authors || '';
      const year = ref.year || 'n.d.';
      const title = ref.title || '';
      const journal = ref.journal || '';
      const doi = (ref.doi || '').trim();

      let doiPart = '';
      if (doi) {
        // 不確定資料裡是不是完整網址，就簡單處理
        doiPart = doi.toLowerCase().startsWith('10.')
          ? ` https://doi.org/${doi}`
          : ` ${doi}`;
      }

      // 簡化版 APA；真正排版交給論文撰寫時再微調
      return `${authors} (${year}). ${title}. ${journal}.${doiPart}`;
    });

    const refText = 'References\n' + lines.join('\n');

    // 將 References 寫入 fullpaper 章節末端
    let fp = state.chapters.fullpaper || '';

    // 若已存在 "References" 標題，先砍掉舊的
    const refRegex = /References[\s\S]*$/i;
    if (refRegex.test(fp)) {
      fp = fp.replace(refRegex, '').trim();
    }

    fp = (fp ? fp + '\n\n' : '') + refText;
    state.chapters.fullpaper = fp;

    // 若目前正在編輯 fullpaper，就同步顯示
    const editors = document.querySelectorAll('.chapter-editor');
    editors.forEach(ed => {
      if (ed.dataset.chapter === 'fullpaper') {
        ed.value = fp;
      }
    });

    updateWordCounts();
    scheduleSaveState();
    alert('已根據實際引用的文獻生成 References，並寫入「10. 全文整合」章節。');
  }

  /**********************
   * 期刊適配 & 品質檢查 *
   **********************/

  function getJournalProfile() {
    const key = state.projectMeta.journalKey;
    if (!key) return null;
    return state.journalProfiles[key] || null;
  }

  async function runManuscriptFitCheck() {
    const payload = {
      projectId: state.projectId,
      projectMeta: state.projectMeta,
      design: state.design,
      rqs: state.rqs,
      hypotheses: state.hypotheses,
      chapters: state.chapters,
      journalProfile: getJournalProfile(),
      stylePreset: state.stylePreset,
      lang: state.lang
    };

    const result = await callBackend('/fitCheck', payload);
    if (!result.ok) {
      alert('期刊適配檢查失敗：' + (result.error || '未知錯誤'));
      return;
    }

    const summary = result.data && result.data.summary
      ? result.data.summary
      : '[後端未回傳摘要內容]';

    appendChatMessage('assistant', summary, '期刊適配檢查');
    switchTab('writing');
  }

  async function runQualityCheck() {
    const payload = {
      projectId: state.projectId,
      projectMeta: state.projectMeta,
      design: state.design,
      rqs: state.rqs,
      hypotheses: state.hypotheses,
      chapters: state.chapters,
      journalProfile: getJournalProfile(),
      stylePreset: state.stylePreset,
      lang: state.lang
    };

    const result = await callBackend('/qualityCheck', payload);
    if (!result.ok) {
      alert('品質與倫理檢查失敗：' + (result.error || '未知錯誤'));
      return;
    }

    const summary = result.data && result.data.summary
      ? result.data.summary
      : '[後端未回傳摘要內容]';

    appendChatMessage('assistant', summary, '品質＆倫理檢查');
    switchTab('writing');
  }

  /**********************
   * AI Coach / Chat 面板 *
   **********************/

  function appendChatMessage(role, text, tag) {
    const panel = document.getElementById('chat-panel');
    if (!panel) return;

    const wrapper = document.createElement('div');
    const isUser = role === 'user';

    wrapper.className = isUser
      ? 'flex justify-end'
      : 'flex justify-start';

    const bubble = document.createElement('div');
    bubble.className = isUser
      ? 'max-w-[90%] bg-indigo-600 text-white rounded-lg px-2.5 py-1.5 text-[11px] shadow-sm whitespace-pre-wrap'
      : 'max-w-[90%] bg-white text-slate-800 border border-slate-200 rounded-lg px-2.5 py-1.5 text-[11px] shadow-sm whitespace-pre-wrap';

    if (tag) {
      const label = document.createElement('div');
      label.className = 'text-[10px] font-semibold mb-0.5 ' + (isUser ? 'text-indigo-100' : 'text-slate-500');
      label.textContent = tag;
      bubble.appendChild(label);
    }

    const content = document.createElement('div');
    content.innerHTML = escapeHtml(text);
    bubble.appendChild(content);

    wrapper.appendChild(bubble);
    panel.appendChild(wrapper);

    scrollChatToBottom();
  }

  function scrollChatToBottom() {
    const panel = document.getElementById('chat-panel');
    if (!panel) return;
    panel.scrollTop = panel.scrollHeight;
  }

  // 簡易自由指令：目前僅記錄在聊天區，實際對話後端可自行擴充
  function sendAIMessage() {
    const input = document.getElementById('ai-input');
    if (!input) return;
    const text = (input.value || '').trim();
    if (!text) return;

    appendChatMessage('user', text);

    // 目前先給一個 placeholder 回覆，避免未串接後端時整個掛掉
    const reply =
      '目前「自由對話模式」尚未串接後端 API。\n' +
      '你仍可使用上方按鈕（生成本章草稿、Reviewer 模式、AI 自動配文獻、期刊適配檢查等）取得 AI 協助。';
    appendChatMessage('assistant', reply, '系統提示');

    input.value = '';
  }

  /**********************
   * 章節生成 / Reviewer *
   **********************/

  async function generateChapterDraft() {
    const chapterKey = state.currentChapter;
    const chapterText = state.chapters[chapterKey] || '';

    const payload = {
      projectId: state.projectId,
      chapterKey,
      chapterText,
      lang: state.lang,
      stylePreset: state.stylePreset,
      projectMeta: state.projectMeta,
      design: state.design,
      rqs: state.rqs,
      hypotheses: state.hypotheses,
      analysisPlan: state.analysisPlan,
      referencePool: state.referencePool
    };

    appendChatMessage('assistant', '正在生成本章草稿（mock / 後端）...', '系統');

    const result = await callBackend('/generateChapter', payload);
    if (!result.ok) {
      alert('生成章節草稿失敗：' + (result.error || '未知錯誤'));
      return;
    }

    const newText = (result.data && result.data.text) || '';
    state.chapters[chapterKey] = newText;

    const editor = getCurrentEditor();
    if (editor) editor.value = newText;

    updateWordCounts();
    scheduleSaveState();

    appendChatMessage('assistant', '本章草稿已更新至編輯區，請再依實際研究內容微調。', '章節生成');
  }

  async function runReviewerMode() {
    const chapterKey = state.currentChapter;
    const chapterText = state.chapters[chapterKey] || '';

    const payload = {
      projectId: state.projectId,
      chapterKey,
      chapterText,
      lang: state.lang,
      stylePreset: state.stylePreset,
      projectMeta: state.projectMeta,
      design: state.design,
      rqs: state.rqs,
      hypotheses: state.hypotheses,
      journalProfile: getJournalProfile()
    };

    appendChatMessage('assistant', '正在進行 Reviewer 模式檢視（mock / 後端）...', '系統');

    const result = await callBackend('/reviewChapter', payload);
    if (!result.ok) {
      alert('Reviewer 模式失敗：' + (result.error || '未知錯誤'));
      return;
    }

    const data = result.data || {};
    let text = (data.summary || '') + '\n\n';

    if (Array.isArray(data.comments) && data.comments.length) {
      text += data.comments.join('\n');
    }

    appendChatMessage('assistant', text, 'Reviewer 模式');
  }

  async function runAutoCitationForCurrentChapter() {
    const chapterKey = state.currentChapter;
    const chapterText = state.chapters[chapterKey] || '';

    if (!state.referencePool.length) {
      alert('尚未上傳文獻庫（referencePool），無法自動配文獻。');
      return;
    }

    const payload = {
      projectId: state.projectId,
      chapterKey,
      chapterText,
      lang: state.lang,
      stylePreset: state.stylePreset,
      referencePool: state.referencePool
    };

    appendChatMessage('assistant', '正在示意性自動配文獻（mock / 後端）...', '系統');

    const result = await callBackend('/autoCiteChapter', payload);
    if (!result.ok) {
      alert('AI 自動配文獻失敗：' + (result.error || '未知錯誤'));
      return;
    }

    const newText = (result.data && result.data.text) || chapterText;
    state.chapters[chapterKey] = newText;

    const editor = getCurrentEditor();
    if (editor) editor.value = newText;

    updateWordCounts();
    scheduleSaveState();

    appendChatMessage(
      'assistant',
      '本章文字已加入示意性引用標記。請再檢查每一筆引用是否真有對應文獻並調整。',
      '自動配文獻'
    );
  }

  /**********************
   * 結果 / 方法草稿生成 *
   **********************/

  async function generateResultsDraft() {
    const payload = {
      projectId: state.projectId,
      design: state.design,
      rqs: state.rqs,
      hypotheses: state.hypotheses,
      analysisPlan: state.analysisPlan,
      dataMeta: state.dataMeta,
      lang: state.lang,
      stylePreset: state.stylePreset
    };

    const result = await callBackend('/resultsDraft', payload);
    if (!result.ok) {
      alert('生成結果敘述草稿失敗：' + (result.error || '未知錯誤'));
      return;
    }

    const draft = (result.data && result.data.text) || '';
    // 直接寫入 results 章節（附加在後面）
    state.chapters.results = (state.chapters.results || '') +
      (state.chapters.results ? '\n\n' : '') +
      draft;

    if (state.currentChapter === 'results') {
      const ed = getCurrentEditor();
      if (ed) ed.value = state.chapters.results;
    }

    updateWordCounts();
    scheduleSaveState();
    appendChatMessage('assistant', '結果章節草稿已寫入「4. 研究結果」。', '結果草稿');
  }

  async function generateMethodDraft() {
    const payload = {
      projectId: state.projectId,
      design: state.design,
      rqs: state.rqs,
      hypotheses: state.hypotheses,
      analysisPlan: state.analysisPlan,
      lang: state.lang,
      stylePreset: state.stylePreset
    };

    const result = await callBackend('/methodDraft', payload);
    if (!result.ok) {
      alert('生成方法章節草稿失敗：' + (result.error || '未知錯誤'));
      return;
    }

    const draft = (result.data && result.data.text) || '';
    state.chapters.method = (state.chapters.method || '') +
      (state.chapters.method ? '\n\n' : '') +
      draft;

    if (state.currentChapter === 'method') {
      const ed = getCurrentEditor();
      if (ed) ed.value = state.chapters.method;
    }

    updateWordCounts();
    scheduleSaveState();
    appendChatMessage('assistant', '方法章節草稿已寫入「3. 研究方法」。', '方法草稿');
  }

  /**********************
   * 快照 / 版本管理      *
   **********************/

  function createSnapshot() {
    const id = 'snap-' + Date.now();
    const label = new Date().toLocaleString();
    const chaptersCopy = JSON.parse(JSON.stringify(state.chapters));

    state.snapshots.push({
      id,
      label,
      createdAt: Date.now(),
      currentChapter: state.currentChapter,
      chapters: chaptersCopy
    });

    // 最多保留 20 個快照
    if (state.snapshots.length > 20) {
      state.snapshots.shift();
    }

    renderSnapshotList();
    scheduleSaveState();
  }

  function restoreSnapshot(id) {
    const snap = state.snapshots.find(s => s.id === id);
    if (!snap) return;

    if (!confirm('確定要還原這個快照？目前章節內容將被覆蓋。')) return;

    state.chapters = JSON.parse(JSON.stringify(snap.chapters || state.chapters));

    // 更新編輯器顯示
    const editors = document.querySelectorAll('.chapter-editor');
    editors.forEach(ed => {
      const key = ed.dataset.chapter;
      ed.value = state.chapters[key] || '';
    });

    updateWordCounts();
    scheduleSaveState();
  }

  function renderSnapshotList() {
    const box = document.getElementById('snapshot-list');
    if (!box) return;

    box.innerHTML = '';
    if (!state.snapshots.length) {
      box.innerHTML = '<div class="text-[10px] text-slate-400">尚未建立任何快照。</div>';
      return;
    }

    state.snapshots
      .slice()
      .sort((a, b) => b.createdAt - a.createdAt)
      .forEach(snap => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between border border-slate-200 rounded px-1.5 py-0.5 bg-white';

        const left = document.createElement('div');
        left.className = 'flex-1 min-w-0';
        left.innerHTML =
          `<div class="truncate text-[10px] text-slate-700">${escapeHtml(snap.label)}</div>`;

        const btn = document.createElement('button');
        btn.className = 'ml-1 px-1.5 py-0.5 text-[10px] rounded border border-indigo-400 text-indigo-600 hover:bg-indigo-50';
        btn.textContent = '還原';
        btn.onclick = () => restoreSnapshot(snap.id);

        div.appendChild(left);
        div.appendChild(btn);
        box.appendChild(div);
      });
  }

  /**********************
   * Data meta / 上傳    *
   **********************/

  function handleDataRawUpload(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    state.dataMeta.rawFileName = file.name;
    scheduleSaveState();
  }

  function handleDataOutputUpload(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    state.dataMeta.outputFileName = file.name;
    scheduleSaveState();
  }

  function updateDataMeta() {
    const notes = document.getElementById('data-notes')?.value || '';
    state.dataMeta.notes = notes;
    scheduleSaveState();
  }

  /**********************
   * Checklist by chapter
   **********************/

  function updateChecklistForChapter(chapterKey) {
    const box = document.getElementById('chapter-checklist');
    if (!box) return;

    const map = {
      outline: [
        '是否明確列出緒論、文獻、方法、結果、討論、結論等章節？',
        '每個章節下是否有 2–4 個關鍵小節標題？',
        '大綱是否與目標期刊（例如 L&I / C&E）文章結構相似？'
      ],
      intro: [
        '是否清楚呈現研究背景與情境脈絡？',
        '研究動機與問題意識是否具備「理論缺口／實務缺口」？',
        '是否明確提出研究目的與研究問題（RQ）？'
      ],
      lit_review: [
        '是否依主題而非逐篇文獻逐一介紹？',
        '文獻是否以 SSCI / SCI 近五年研究為主，舊文獻作為理論基礎？',
        '是否在段落結尾點出「本研究將如何回應上述缺口」？'
      ],
      method: [
        '研究設計（量化／質性／混合）是否與 RQ 一一對應？',
        '樣本、工具、程序是否可再現？信效度是否交代清楚？',
        '統計方法或質性分析步驟是否對應到 analysis plan？'
      ],
      results: [
        '是否先以表格／圖形呈現，再輔以文字說明重點？',
        '結果敘述是否直接回應 RQ，而非重複方法或討論？',
        '統計值（t, F, p, η² 等）是否標示完整且格式一致？'
      ],
      discussion: [
        '是否分別對應每一個 RQ / 主要發現進行討論？',
        '是否與過去文獻進行對照，說明一致／不一致的原因？',
        '是否提出合理的理論解釋與情境詮釋，而非僅重述結果？'
      ],
      conclusion: [
        '是否用 2–3 段整理本研究最核心的結論？',
        '是否避免出現尚未在結果與討論中出現的新發現？',
        '是否緊扣研究問題與研究目的作收束？'
      ],
      implications: [
        '是否區分對「課室教學／教師培訓／政策」等不同層面的意涵？',
        '是否避免空泛建議，而是具體、可操作？',
        '是否與研究結果清楚連結，而非脫節？'
      ],
      limitations: [
        '是否誠實說明樣本、設計、測量上的限制？',
        '是否避免過度自貶或僅用一句話帶過？',
        '是否進一步指出未來研究方向與可改進之處？'
      ],
      abstract: [
        '是否包含背景、目的、方法、結果、結論四要素？',
        '字數是否符合目標期刊摘要規範？',
        '是否使用第三人稱、過去式與客觀語氣？'
      ],
      fullpaper: [
        '全文結構是否一致、段落銜接是否流暢？',
        '是否所有內文引用都有對應之 References？',
        '是否檢查語言風格（例如 state.stylePreset = "conservative" 時更保守）？'
      ]
    };

    const items = map[chapterKey] || map.outline;
    box.innerHTML =
      '<ul class="list-disc pl-4 space-y-0.5 text-[11px] text-slate-700">' +
      items.map(li => `<li>${escapeHtml(li)}</li>`).join('') +
      '</ul>';
  }

  /**********************
   * localStorage：補上 usedCitationIds
   **********************/

  // 覆寫前面定義的 saveStateToStorage / loadStateFromStorage（若你前面已加過，可略過此段）
  const _origSave = saveStateToStorage;
  saveStateToStorage = function () {
    try {
      const safeState = {
        projectId: state.projectId,
        lang: state.lang,
        stylePreset: state.stylePreset,
        projectMeta: state.projectMeta,
        chapters: state.chapters,
        design: state.design,
        rqs: state.rqs,
        hypotheses: state.hypotheses,
        analysisPlan: state.analysisPlan,
        dataMeta: state.dataMeta,
        litFilesMeta: state.litFilesMeta,
        snapshots: state.snapshots,
        referencePool: state.referencePool,
        usedCitationIds: Array.from(state.usedCitationIds || [])
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(safeState));
    } catch (e) {
      console.warn('儲存到 localStorage 失敗：', e);
    }
  };

  const _origLoad = loadStateFromStorage;
  loadStateFromStorage = function () {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const saved = JSON.parse(raw);
      if (!saved || typeof saved !== 'object') return;

      Object.assign(state, {
        projectId: saved.projectId || 'default',
        lang: saved.lang || 'zh-TW',
        stylePreset: saved.stylePreset || 'balanced',
        projectMeta: Object.assign({}, state.projectMeta, saved.projectMeta || {}),
        chapters: Object.assign({}, state.chapters, saved.chapters || {}),
        design: Object.assign({}, state.design, saved.design || {}),
        rqs: saved.rqs || [],
        hypotheses: saved.hypotheses || [],
        analysisPlan: saved.analysisPlan || {},
        dataMeta: Object.assign({}, state.dataMeta, saved.dataMeta || {}),
        litFilesMeta: Object.assign({}, state.litFilesMeta, saved.litFilesMeta || {}),
        snapshots: saved.snapshots || [],
        referencePool: saved.referencePool || []
      });

      state.usedCitationIds = new Set(saved.usedCitationIds || []);

      // 回填 UI（與原本版本一致）
      document.getElementById('project-title').value = state.projectMeta.title || '';
      document.getElementById('project-field').value = state.projectMeta.field || '';
      document.getElementById('project-year').value = state.projectMeta.year || '2025';
      document.getElementById('design-type').value = state.design.type || '';
      document.getElementById('design-context').value = state.design.context || '';
      document.getElementById('design-sample').value = state.design.sample || '';
      document.getElementById('design-instruments').value = state.design.instruments || '';
      document.getElementById('design-iv').value = state.design.iv || '';
      document.getElementById('design-dv').value = state.design.dv || '';
      document.getElementById('design-medmod').value = state.design.medmod || '';
      document.getElementById('data-notes').value = state.dataMeta.notes || '';
      document.getElementById('style-preset').value = state.stylePreset || 'balanced';
    } catch (e) {
      console.warn('讀取 localStorage 失敗：', e);
    }
  };
</script>
</body>
</html>
